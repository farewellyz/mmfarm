<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'IBM Plex Sans Thai', sans-serif; 
            touch-action: manipulation; 
            background: linear-gradient(to bottom, #a7f3d0, #f0fdf4);
        }
        .plot, .animal-slot { 
            transition: all 0.2s ease-in-out; 
            background-size: contain; 
            background-position: center; 
            background-repeat: no-repeat; 
            image-rendering: pixelated; /* For pixel art style */
        }
        .plot:hover, .animal-slot:hover { transform: scale(1.05); }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .modal-enter { animation: fadeIn 0.2s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.2s ease-out forwards; }

        @keyframes pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .pop-animation { animation: pop 0.3s ease-out; }

        @keyframes water-effect {
            0% { background-color: rgba(59, 130, 246, 0); }
            50% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: rgba(59, 130, 246, 0); }
        }
        .watered { animation: water-effect 0.5s ease-out; }

        @keyframes fertilize-effect {
            0% { box-shadow: 0 0 0 0px rgba(139, 69, 19, 0); }
            50% { box-shadow: 0 0 15px 5px rgba(139, 69, 19, 0.5); }
            100% { box-shadow: 0 0 0 0px rgba(139, 69, 19, 0); }
        }
        .fertilized { animation: fertilize-effect 0.6s ease-out; }

        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animal.happy { animation: hop 0.5s infinite; }

        body { padding-bottom: 80px; }
        .nav-btn.active { background-color: #15803d; color: white; border-top: 4px solid #facc15; }
        .quality-star { color: #facc15; text-shadow: 0 0 2px black; }

        /* Loading Screen */
        .loading-hidden {
            opacity: 0;
            pointer-events: none;
        }

    </style>
</head>
<body class="min-h-screen">
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-green-100 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-6xl animate-bounce">ü•ï</div>
        <p class="mt-4 text-2xl font-bold text-green-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°...</p>
    </div>

    <!-- All Modals -->
    <div id="modal-container">
        <!-- Name Change Modal -->
        <div id="name-modal" class="hidden fixed inset-0 bg-black/50 z-[52] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter">
                <h2 id="name-modal-title" class="text-2xl font-bold text-gray-800 mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</h2>
                <p class="text-gray-600 mb-4">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</p>
                <input type="text" id="name-input" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" maxlength="15">
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-name-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="save-name-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Context Menu Modal -->
        <div id="context-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div id="context-modal-content" class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-xs text-center">
                <h3 id="context-modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <div id="context-modal-actions" class="flex flex-col gap-3"></div>
                <button id="context-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
         <!-- Sub-menu Modal (for planting/fertilizing) -->
        <div id="submenu-modal" class="hidden fixed inset-0 bg-black/60 z-[51] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-xs">
                <h3 id="submenu-modal-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h3>
                <div id="submenu-modal-items" class="grid grid-cols-3 gap-3 text-center"></div>
                <button id="submenu-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
        </div>
    </div>

    <!-- Main Game Area -->
    <div id="game-container" class="w-full max-w-5xl mx-auto p-4 md:p-6 opacity-0 transition-opacity duration-500">
        <header class="text-center mb-4 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-4">
            <h1 class="text-3xl md:text-4xl font-bold text-green-800">‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üíö</h1>
            <div class="mt-3 flex flex-wrap justify-center items-center gap-x-4 gap-y-2 text-sm text-gray-600">
                <div class="flex items-center justify-center gap-2 bg-green-100 px-3 py-1 rounded-full">
                    <span>‡∏ä‡∏∑‡πà‡∏≠:</span>
                    <span id="player-name" class="font-bold text-green-900 cursor-pointer hover:underline" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠">...</span>
                </div>
                <span class="font-semibold bg-yellow-100 px-3 py-1 rounded-full">üí∞: <span id="money-display" class="font-bold text-yellow-800">0</span></span>
            </div>
             <div id="inventory-display" class="mt-3 flex flex-wrap justify-center items-center gap-x-3 gap-y-1 text-xs text-gray-500">
                <!-- Inventory items will be rendered here -->
             </div>
        </header>

        <main id="tab-content-area" class="bg-white/60 backdrop-blur-sm rounded-2xl shadow-inner p-4 min-h-[400px]">
            <div id="farm-view">
                <div id="farm-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-2 md:gap-4 flex-grow"></div>
            </div>
            <div id="animals-view" class="hidden">
                 <div id="animal-pen" class="grid grid-cols-3 sm:grid-cols-4 gap-2 md:gap-4"></div>
            </div>
            <div id="shop-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <div id="sell-box" class="mb-6 bg-yellow-100 p-4 rounded-xl border-2 border-dashed border-yellow-300">
                        <h3 class="text-xl font-bold text-yellow-800 mb-2 text-center">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡∏¢‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</h3>
                        <div id="sell-box-items" class="min-h-[50px] space-y-2">
                            <p class="text-center text-yellow-700">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏∞‡∏Ç‡∏≤‡∏¢</p>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="font-semibold text-lg">‡∏£‡∏ß‡∏°: <span id="sell-box-total" class="font-bold">0</span>üí∞</p>
                            <button id="sell-all-btn" disabled class="mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed">‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        </div>
                    </div>
                    <div id="shop-items" class="space-y-4"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Bottom Navigation Bar -->
    <footer id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-[0_-4px_12px_rgba(0,0,0,0.05)] z-40 flex justify-around opacity-0 transition-opacity duration-500">
        <button data-view="farm" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏ü‡∏≤‡∏£‡πå‡∏°</button>
        <button data-view="animals" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏Ñ‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
        <button data-view="shop" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyDAc4bOydh3x9OFMI-ocbAIXDQc61qRcnc",
          authDomain: "my-farm-game-556f5.firebaseapp.com",
          projectId: "my-farm-game-556f5",
          storageBucket: "my-farm-game-556f5.appspot.com",
          messagingSenderId: "725056841274",
          appId: "1:725056841274:web:a2b0d5b0cb913c2a10f703",
          measurementId: "G-R0DJJ5KWD0"
        };
        //  ++++++++++++++++++++++++++++++++++++++++++++++++++++

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const FARM_GRID_SIZE = 24;
        const ANIMAL_PEN_SIZE = 8;

        // --- MASTER GAME DATA ---
        // growTime & produceTime are in seconds
        const GAME_DATA = {
            'carrot_seed':   { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'seed', cost: 5, plantId: 'carrot', icon: 'ü•ï' },
            'carrot':        { name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'crop', growTime: 1200, produceId: 'carrot_produce', icon: 'ü•ï' },
            'carrot_produce':{ name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'produce', sellPrice: [8, 12, 16], icon: 'ü•ï' },
            
            'tomato_seed':   { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'seed', cost: 10, plantId: 'tomato', icon: 'üçÖ' },
            'tomato':        { name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'crop', growTime: 1800, produceId: 'tomato_produce', icon: 'üçÖ' },
            'tomato_produce':{ name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'produce', sellPrice: [18, 25, 35], icon: 'üçÖ' },

            'strawberry_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'seed', cost: 15, plantId: 'strawberry', icon: 'üçì' },
            'strawberry':      { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'crop', growTime: 2400, produceId: 'strawberry_produce', icon: 'üçì' },
            'strawberry_produce': { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'produce', sellPrice: [25, 35, 50], icon: 'üçì' },

            'grape_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'seed', cost: 20, plantId: 'grape', icon: 'üçá' },
            'grape':      { name: '‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'crop', growTime: 3000, produceId: 'grape_produce', icon: 'üçá' },
            'grape_produce': { name: '‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'produce', sellPrice: [35, 50, 70], icon: 'üçá' },

            'peach_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏µ‡∏ä', type: 'seed', cost: 25, plantId: 'peach', icon: 'üçë' },
            'peach':      { name: '‡∏û‡∏µ‡∏ä', type: 'crop', growTime: 3600, produceId: 'peach_produce', icon: 'üçë' },
            'peach_produce': { name: '‡∏û‡∏µ‡∏ä', type: 'produce', sellPrice: [45, 65, 90], icon: 'üçë' },

            'orange_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡πâ‡∏°', type: 'seed', cost: 30, plantId: 'orange', icon: 'üçä' },
            'orange':      { name: '‡∏™‡πâ‡∏°', type: 'crop', growTime: 4200, produceId: 'orange_produce', icon: 'üçä' },
            'orange_produce': { name: '‡∏™‡πâ‡∏°', type: 'produce', sellPrice: [55, 80, 110], icon: 'üçä' },

            'mango_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'seed', cost: 35, plantId: 'mango', icon: 'ü•≠' },
            'mango':      { name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'crop', growTime: 4800, produceId: 'mango_produce', icon: 'ü•≠' },
            'mango_produce': { name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'produce', sellPrice: [65, 95, 130], icon: 'ü•≠' },

            'pineapple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'seed', cost: 40, plantId: 'pineapple', icon: 'üçç' },
            'pineapple':      { name: '‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'crop', growTime: 5400, produceId: 'pineapple_produce', icon: 'üçç' },
            'pineapple_produce': { name: '‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'produce', sellPrice: [75, 110, 150], icon: 'üçç' },

            'guava_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'seed', cost: 18, plantId: 'guava', icon: 'üçà' },
            'guava':      { name: '‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'crop', growTime: 2800, produceId: 'guava_produce', icon: 'üçà' },
            'guava_produce': { name: '‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'produce', sellPrice: [30, 45, 65], icon: 'üçà' },

            'roseapple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'seed', cost: 22, plantId: 'roseapple', icon: 'üçê' },
            'roseapple':      { name: '‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'crop', growTime: 3200, produceId: 'roseapple_produce', icon: 'üçê' },
            'roseapple_produce': { name: '‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'produce', sellPrice: [40, 60, 85], icon: 'üçê' },

            'apple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'seed', cost: 28, plantId: 'apple', icon: 'üçé' },
            'apple':      { name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'crop', growTime: 4000, produceId: 'apple_produce', icon: 'üçé' },
            'apple_produce': { name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'produce', sellPrice: [50, 75, 105], icon: 'üçé' },

            'fertilizer_1': { name: '‡∏õ‡∏∏‡πã‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤', type: 'item', cost: 10, qualityBonus: 0.3, icon: 'üí©' },
            'fertilizer_2': { name: '‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ', type: 'item', cost: 25, qualityBonus: 0.6, icon: '‚ú®' },
            
            'chicken_deed': { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏Å‡πà', type: 'animal_deed', cost: 100, animalId: 'chicken', icon: 'üêî' },
            'chicken':      { name: '‡πÑ‡∏Å‡πà', type: 'animal_instance', produceTime: 600, produceId: 'egg', icon: 'üêî' },
            'egg':          { name: '‡πÑ‡∏Ç‡πà', type: 'produce', sellPrice: [12, 18, 25], icon: 'ü•ö' },

            'cow_deed':     { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡∏±‡∏ß', type: 'animal_deed', cost: 500, animalId: 'cow', icon: 'üêÑ' },
            'cow':          { name: '‡∏ß‡∏±‡∏ß', type: 'animal_instance', produceTime: 3600, produceId: 'milk', icon: 'üêÑ' },
            'milk':         { name: '‡∏ô‡∏°', type: 'produce', sellPrice: [50, 70, 90], icon: 'ü•õ' },

            'pig_deed':     { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏°‡∏π', type: 'animal_deed', cost: 300, animalId: 'pig', icon: 'üêñ' },
            'pig':          { name: '‡∏´‡∏°‡∏π', type: 'animal_instance', produceTime: 4800, produceId: 'truffle', icon: 'üêñ' },
            'truffle':      { name: '‡πÄ‡∏´‡πá‡∏î‡∏ó‡∏£‡∏±‡∏ü‡πÄ‡∏ü‡∏¥‡∏•', type: 'produce', sellPrice: [80, 110, 150], icon: 'üçÑ' },

            'duck_deed':    { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏î', type: 'animal_deed', cost: 120, animalId: 'duck', icon: 'ü¶Ü' },
            'duck':         { name: '‡πÄ‡∏õ‡πá‡∏î', type: 'animal_instance', produceTime: 900, produceId: 'duck_egg', icon: 'ü¶Ü' },
            'duck_egg':     { name: '‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏î', type: 'produce', sellPrice: [15, 22, 30], icon: 'ü•ö' },

            'goose_deed':   { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡πà‡∏≤‡∏ô', type: 'animal_deed', cost: 150, animalId: 'goose', icon: 'ü¶¢' },
            'goose':        { name: '‡∏´‡πà‡∏≤‡∏ô', type: 'animal_instance', produceTime: 1800, produceId: 'feather', icon: 'ü¶¢' },
            'feather':      { name: '‡∏Ç‡∏ô‡∏ô‡∏Å', type: 'produce', sellPrice: [25, 38, 55], icon: 'ü™∂' },

            'turtle_deed':  { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ï‡πà‡∏≤', type: 'animal_deed', cost: 1000, animalId: 'turtle', icon: 'üê¢' },
            'turtle':       { name: '‡πÄ‡∏ï‡πà‡∏≤', type: 'animal_instance', produceTime: 86400, produceId: 'gem', icon: 'üê¢' },
            'gem':          { name: '‡∏≠‡∏±‡∏ç‡∏°‡∏ì‡∏µ', type: 'produce', sellPrice: [200, 300, 500], icon: 'üíé' },
        };

        // --- Game State ---
        let userId = null;
        let farmState = { plots: [], animals: [] };
        let playerState = { money: 20, inventory: {}, produceBin: [], nickname: '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà' };
        
        // --- UI Elements ---
        const playerNameEl = document.getElementById('player-name');
        
        // --- Helper Functions ---
        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            let parts = [];
            if (h > 0) parts.push(`${h} ‡∏ä‡∏°.`);
            if (m > 0) parts.push(`${m} ‡∏ô‡∏≤‡∏ó‡∏µ`);
            if (s > 0 || parts.length === 0) parts.push(`${s} ‡∏ß‡∏¥`);
            return parts.join(' ');
        }
        
        // --- State Management ---
        async function updateFarmState(newState) {
             if (!userId) return;
             farmState = newState;
             const farmDocRef = doc(db, "publicFarmData", "farmState");
             await setDoc(farmDocRef, farmState, { merge: true });
        }
        async function updatePlayerState(newState) {
             if (!userId) return;
             playerState = newState;
             const playerDocRef = doc(db, "players", userId);
             await setDoc(playerDocRef, newState, { merge: true });
        }
        
        // --- Rendering ---
        function renderAll() {
            renderFarm();
            renderAnimals();
            renderPlayerUI();
            renderShop();
            renderSellBox();
        }
        
        function renderFarm() {
            const farmGrid = document.getElementById('farm-grid');
            farmGrid.innerHTML = '';
            farmState.plots.forEach((plot, index) => {
                const plotEl = document.createElement('div');
                plotEl.className = 'plot aspect-square rounded-lg shadow-inner cursor-pointer flex items-center justify-center text-3xl relative';
                plotEl.style.backgroundColor = 'rgba(139, 69, 19, 0.4)';
                
                if (plot.plantId) {
                    const plantData = GAME_DATA[plot.plantId];
                    const progress = Math.min(plot.growth / plantData.growTime, 1);
                    plotEl.style.backgroundImage = `linear-gradient(to top, rgba(96, 165, 250, ${plot.water/10}) 0%, rgba(96, 165, 250, ${plot.water/10}) ${progress*100}%, transparent ${progress*100}%)`;
                    
                    const content = document.createElement('div');
                    if (plantData.imageUrl) {
                        content.style.backgroundImage = `url(${plantData.imageUrl})`;
                        content.style.opacity = 0.5 + (progress * 0.5);
                        content.className = 'w-full h-full bg-contain bg-no-repeat bg-center';
                    } else {
                        content.textContent = plantData.icon;
                        content.style.transform = `scale(${0.5 + (progress * 0.5)})`;
                    }
                    plotEl.appendChild(content);

                    if (plot.quality > 0) {
                        const qualityEl = document.createElement('div');
                        qualityEl.className = 'absolute top-1 right-1 text-xs quality-star';
                        qualityEl.textContent = '‚òÖ'.repeat(plot.quality);
                        plotEl.appendChild(qualityEl);
                    }
                }
                
                plotEl.onclick = () => showContextMenu('plot', index);
                farmGrid.appendChild(plotEl);
            });
        }

        function renderAnimals() {
             const animalPen = document.getElementById('animal-pen');
             animalPen.innerHTML = '';
             farmState.animals.forEach((animal, index) => {
                const slotEl = document.createElement('div');
                slotEl.className = 'animal-slot aspect-square rounded-2xl shadow-inner cursor-pointer flex flex-col items-center justify-center p-1 bg-green-200/50';
                
                if (animal.animalId) {
                    const animalData = GAME_DATA[animal.animalId];
                    const content = document.createElement('div');
                    content.className = 'text-4xl';
                    if (animalData.imageUrl) {
                         content.style.backgroundImage = `url(${animalData.imageUrl})`;
                         content.className = 'w-full h-full bg-contain bg-no-repeat bg-center';
                    } else {
                         content.textContent = animalData.icon;
                    }

                    const progressEl = document.createElement('div');
                    progressEl.className = 'w-full h-1 bg-gray-300 rounded-full mt-1';
                    const progressFill = document.createElement('div');
                    const progress = (Date.now() - animal.startTime) / (animalData.produceTime * 1000);
                    progressFill.className = 'h-1 bg-yellow-400 rounded-full';
                    progressFill.style.width = `${Math.min(progress, 1) * 100}%`;
                    progressEl.appendChild(progressFill);

                    slotEl.appendChild(content);
                    slotEl.appendChild(progressEl);

                    if (progress >= 1) {
                        slotEl.classList.add('animate-bounce');
                    }
                } else {
                    slotEl.textContent = '+';
                    slotEl.className += ' text-3xl text-gray-400';
                }

                slotEl.onclick = () => showContextMenu('animal', index);
                animalPen.appendChild(slotEl);
             });
        }

        function renderPlayerUI() {
            playerNameEl.textContent = playerState.nickname;
            document.getElementById('money-display').textContent = playerState.money || 0;
            const inventoryDisplay = document.getElementById('inventory-display');
            inventoryDisplay.innerHTML = '';
            Object.entries(playerState.inventory).forEach(([itemId, count]) => {
                if (count > 0) {
                    const itemData = GAME_DATA[itemId];
                    const itemEl = document.createElement('span');
                    itemEl.className = 'bg-white px-2 py-1 rounded-md shadow-sm';
                    itemEl.textContent = `${itemData.icon} ${count}`;
                    inventoryDisplay.appendChild(itemEl);
                }
            });
        }

        function renderShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            ['seed', 'item', 'animal_deed'].forEach(category => {
                const categoryEl = document.createElement('div');
                const title = {seed:'‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', item:'‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°', animal_deed:'‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á'}[category];
                categoryEl.innerHTML = `<h3 class="text-xl font-bold text-green-700 mb-2">${title}</h3>`;
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-2';

                Object.entries(GAME_DATA).filter(([_, data]) => data.type === category).forEach(([id, data]) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-white/80 p-3 rounded-xl shadow-md flex flex-col items-center gap-2';
                    itemEl.innerHTML = `
                        <div class="text-3xl">${data.icon}</div>
                        <div class="font-semibold text-center text-sm">${data.name}</div>
                        <button data-itemid="${id}" class="buy-btn bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-1 px-4 rounded-full w-full">‡∏ã‡∏∑‡πâ‡∏≠ ${data.cost}üí∞</button>
                    `;
                    grid.appendChild(itemEl);
                });
                categoryEl.appendChild(grid);
                shopItems.appendChild(categoryEl);
            });
        }

        function renderSellBox() {
            const itemsEl = document.getElementById('sell-box-items');
            const totalEl = document.getElementById('sell-box-total');
            const sellBtn = document.getElementById('sell-all-btn');
            
            if (!playerState.produceBin || playerState.produceBin.length === 0) {
                itemsEl.innerHTML = `<p class="text-center text-yellow-700">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏∞‡∏Ç‡∏≤‡∏¢</p>`;
                totalEl.textContent = '0';
                sellBtn.disabled = true;
                return;
            }

            itemsEl.innerHTML = '';
            let totalValue = 0;
            const groupedProduce = playerState.produceBin.reduce((acc, item) => {
                const key = `${item.id}_q${item.quality}`;
                if (!acc[key]) {
                    acc[key] = { ...item, count: 0 };
                }
                acc[key].count++;
                return acc;
            }, {});

            Object.values(groupedProduce).forEach(item => {
                const itemData = GAME_DATA[item.id];
                const sellPrice = itemData.sellPrice[item.quality];
                totalValue += sellPrice * item.count;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white/50 p-2 rounded';
                itemDiv.innerHTML = `
                    <div>
                        <span class="text-lg">${itemData.icon}</span>
                        <span>${itemData.name}</span>
                        <span class="quality-star">${'‚òÖ'.repeat(item.quality)}</span>
                        <span class="text-gray-600 text-sm">x${item.count}</span>
                    </div>
                    <span class="font-semibold">${sellPrice * item.count}üí∞</span>
                `;
                itemsEl.appendChild(itemDiv);
            });

            totalEl.textContent = totalValue;
            sellBtn.disabled = false;
        }

        // --- Context Menu Logic ---
        function showContextMenu(type, index) {
            const modal = document.getElementById('context-modal');
            const contentEl = document.getElementById('context-modal-content');
            const titleEl = document.getElementById('context-modal-title');
            const actionsEl = document.getElementById('context-modal-actions');
            actionsEl.innerHTML = '';

            contentEl.querySelectorAll('.context-details').forEach(el => el.remove());

            const detailsEl = document.createElement('div');
            detailsEl.className = 'context-details text-sm text-gray-600 mb-4 border-t pt-4 mt-4';

            const createButton = (text, action, disabled = false) => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `w-full font-bold py-2 px-4 rounded-lg transition ${disabled ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 text-white'}`;
                if (!disabled) button.onclick = () => { action(); hideContextMenu(); };
                return button;
            };

            if (type === 'plot') {
                const plot = farmState.plots[index];
                titleEl.textContent = `‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà ${index + 1}`;
                if (!plot.plantId) {
                     const plantableItems = Object.keys(playerState.inventory).filter(id => GAME_DATA[id].type === 'seed' && playerState.inventory[id] > 0);
                     actionsEl.appendChild(createButton('üå± ‡∏õ‡∏•‡∏π‡∏Å', () => showSubMenu('plant', index, plantableItems), plantableItems.length === 0));
                } else {
                    const plantData = GAME_DATA[plot.plantId];
                    const isGrown = plot.growth >= plantData.growTime;
                    
                    const remainingSeconds = Math.max(0, plantData.growTime - plot.growth);
                    detailsEl.innerHTML += `<p>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: <span class="font-semibold">${formatTime(remainingSeconds)}</span></p>`;
                    
                    if (plot.wateredBy && plot.wateredBy.length > 0) {
                        const waterers = plot.wateredBy.map(p => p.nickname).join(', ');
                        detailsEl.innerHTML += `<div class="mt-2"><p>‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢:</p><p class="font-semibold text-green-700">${waterers}</p></div>`;
                    }
                    actionsEl.before(detailsEl);
                    
                    if (isGrown) {
                        actionsEl.appendChild(createButton('üåæ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß', () => harvest(index)));
                    } else {
                         const hasWatered = plot.wateredBy && plot.wateredBy.some(p => p.uid === userId);
                         actionsEl.appendChild(createButton('üíß ‡∏£‡∏î‡∏ô‡πâ‡∏≥', () => water(index), hasWatered));
                         const fertilizers = Object.keys(playerState.inventory).filter(id => GAME_DATA[id].type === 'item' && playerState.inventory[id] > 0);
                         actionsEl.appendChild(createButton('üí© ‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢', () => showSubMenu('fertilize', index, fertilizers), fertilizers.length === 0));
                    }
                }
            } else if (type === 'animal') {
                 const animal = farmState.animals[index];
                 titleEl.textContent = `‡∏Ñ‡∏≠‡∏Å‡∏ó‡∏µ‡πà ${index + 1}`;
                 if (!animal.animalId) {
                     const buyableAnimals = Object.keys(playerState.inventory).filter(id => GAME_DATA[id].type === 'animal_deed' && playerState.inventory[id] > 0);
                     actionsEl.appendChild(createButton('‚ûï ‡∏ß‡∏≤‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå', () => showSubMenu('placeAnimal', index, buyableAnimals), buyableAnimals.length === 0));
                 } else {
                    const animalData = GAME_DATA[animal.animalId];
                    const isReady = (Date.now() - animal.startTime) >= (animalData.produceTime * 1000);
                    
                    const remainingMillis = Math.max(0, (animal.startTime + animalData.produceTime * 1000) - Date.now());
                    detailsEl.innerHTML = `<p>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô: <span class="font-semibold">${formatTime(remainingMillis / 1000)}</span></p>`;
                    actionsEl.before(detailsEl);
                    
                    if(isReady){
                        actionsEl.appendChild(createButton(`‡πÄ‡∏Å‡πá‡∏ö${GAME_DATA[animalData.produceId].name}`, () => collectProduct(index)));
                    } else {
                         actionsEl.appendChild(createButton('‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)', () => {}, true)); // Placeholder for future feature
                    }
                 }
            }
            
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }
        function hideContextMenu() {
            const modal = document.getElementById('context-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function showSubMenu(actionType, index, itemIds) {
            const modal = document.getElementById('submenu-modal');
            const titleEl = document.getElementById('submenu-modal-title');
            const itemsEl = document.getElementById('submenu-modal-items');
            itemsEl.innerHTML = '';
            titleEl.textContent = actionType === 'plant' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏•‡∏π‡∏Å' : actionType === 'fertilize' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏∏‡πã‡∏¢' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏á';

            itemIds.forEach(itemId => {
                const itemData = GAME_DATA[itemId];
                const itemButton = document.createElement('button');
                itemButton.className = 'p-2 bg-gray-100 rounded-lg hover:bg-green-100';
                itemButton.innerHTML = `<div class="text-3xl">${itemData.icon}</div><div class="text-xs">${itemData.name}</div>`;
                itemButton.onclick = () => {
                    if (actionType === 'plant') plant(index, itemId);
                    else if (actionType === 'fertilize') fertilize(index, itemId);
                    else if (actionType === 'placeAnimal') placeAnimal(index, itemId);
                    hideSubMenu();
                };
                itemsEl.appendChild(itemButton);
            });
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }
        function hideSubMenu() {
            const modal = document.getElementById('submenu-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        // --- Game Actions ---
        function plant(plotIndex, seedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const seedData = GAME_DATA[seedId];
            newFarmState.plots[plotIndex] = { plantId: seedData.plantId, growth: 0, water: 5, fertilizerLevel: 0, wateredBy: [] };
            newPlayerState.inventory[seedId]--;
            document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('pop-animation');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function water(plotIndex) {
             const newFarmState = { ...farmState };
             const plot = newFarmState.plots[plotIndex];
             if (plot.wateredBy && plot.wateredBy.some(p => p.uid === userId)) return; 

             plot.water = Math.min(plot.water + 5, 10);
             plot.wateredBy.push({ uid: userId, nickname: playerState.nickname });
             document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('watered');
             updateFarmState(newFarmState);
        }

        function fertilize(plotIndex, fertilizerId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const fertilizerData = GAME_DATA[fertilizerId];
            newFarmState.plots[plotIndex].fertilizerLevel += fertilizerData.qualityBonus;
            newPlayerState.inventory[fertilizerId]--;
            document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('fertilized');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function harvest(plotIndex) {
            const newPlayerState = { ...playerState };
            const newFarmState = { ...farmState };
            const plot = newFarmState.plots[plotIndex];
            const cropData = GAME_DATA[plot.plantId];

            let quality = 0;
            if (Math.random() < plot.fertilizerLevel) quality = 1;
            if (Math.random() < plot.fertilizerLevel - 1) quality = 2;

            newPlayerState.produceBin.push({ id: cropData.produceId, quality: quality });
            newFarmState.plots[plotIndex] = { plantId: null };
            updatePlayerState(newPlayerState);
            updateFarmState(newFarmState);
        }

        function placeAnimal(slotIndex, deedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const deedData = GAME_DATA[deedId];
            newFarmState.animals[slotIndex] = { animalId: deedData.animalId, startTime: Date.now() };
            newPlayerState.inventory[deedId]--;
            document.querySelector(`#animal-pen > div:nth-child(${slotIndex + 1})`).classList.add('pop-animation');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function collectProduct(slotIndex) {
            const newPlayerState = { ...playerState };
            const newFarmState = { ...farmState };
            const animal = newFarmState.animals[slotIndex];
            const animalData = GAME_DATA[animal.animalId];

            newPlayerState.produceBin.push({ id: animalData.produceId, quality: 0 });
            animal.startTime = Date.now();
            newFarmState.animals[slotIndex] = animal;
            
            updatePlayerState(newPlayerState);
            updateFarmState(newFarmState);
        }
        
        // --- Game Loop ---
        function gameTick() {
            let farmChanged = false;
            farmState.plots.forEach(plot => {
                if (plot.plantId) {
                    const plantData = GAME_DATA[plot.plantId];
                    if (plot.growth < plantData.growTime) {
                         let growthRate = 2;
                         if (plot.water > 0) {
                             growthRate += (plot.water / 5) + (plot.wateredBy.length || 0); 
                             plot.water -= 1; 
                         }
                         plot.growth += growthRate;
                         farmChanged = true;
                    }
                }
            });
            if (farmChanged) updateFarmState(farmState);
        }

        function displayError(message) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('game-container').innerHTML = message;
            document.getElementById('game-container').style.opacity = 1;
            document.getElementById('footer-nav').style.display = 'none';
        }

        // --- Init & Setup ---
        async function startGame(uid) {
            userId = uid;
            try {
                // These now return the unsubscribe function, but we don't need to store it here
                await Promise.all([initPlayerListeners(uid), initFarmListeners()]);
                
                document.getElementById('loading-screen').classList.add('loading-hidden');
                document.getElementById('game-container').style.opacity = 1;
                document.getElementById('footer-nav').style.opacity = 1;
                setInterval(gameTick, 2000);
            } catch(error) {
                handleFirestoreError(error);
            }
        }

        function initPlayerListeners(uid) {
            return new Promise((resolve, reject) => {
                const playerDocRef = doc(db, "players", uid);
                const unsubscribe = onSnapshot(playerDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        playerState = docSnap.data();
                        if (!playerState.produceBin) playerState.produceBin = [];
                    }
                    renderAll();
                    resolve(unsubscribe); // Resolve with the unsubscribe function
                }, (error) => reject(error));
            });
        }
        
        function initFarmListeners() {
             return new Promise((resolve, reject) => {
                const farmDocRef = doc(db, "publicFarmData", "farmState");
                const unsubscribe = onSnapshot(farmDocRef, (docSnap) => {
                    const defaultPlot = () => ({ plantId: null });
                    const defaultAnimalSlot = () => ({ animalId: null });
                    if (docSnap.exists()) {
                        farmState = docSnap.data();
                        if(!farmState.plots || farmState.plots.length !== FARM_GRID_SIZE) farmState.plots = Array(FARM_GRID_SIZE).fill(null).map(defaultPlot);
                        if(!farmState.animals || farmState.animals.length !== ANIMAL_PEN_SIZE) farmState.animals = Array(ANIMAL_PEN_SIZE).fill(null).map(defaultAnimalSlot);
                    }
                    renderAll();
                    resolve(unsubscribe); // Resolve with the unsubscribe function
                }, (error) => reject(error));
             });
        }
        
        function handleFirestoreError(error) {
            console.error("Firestore connection error:", error);
            displayError(`
                <div class="p-4 text-center text-red-700 bg-red-100 rounded-lg m-4 shadow-lg">
                    <strong class="text-lg block">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</strong>
                    <p class="mt-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firestore ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Rules ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
                    <div class="text-left mt-4 bg-red-50 p-3 rounded">
                        <strong class="block mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:</strong>
                        <ol class="list-decimal list-inside space-y-2">
                            <li><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <strong>Firebase Console > Build > Firestore Database</strong> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î <strong>"‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" (Create database)</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>"‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö" (Start in test mode)</strong></li>
                            <li><strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Rules:</strong> ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö <strong>Rules</strong> ‡πÉ‡∏ô Firestore Database ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Rules ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô <code>allow read, write: if request.auth != null;</code></li>
                        </ol>
                        <p class="mt-3">‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
                    </div>
                </div>
            `);
        }
        
        let isInitialNameSetup = false;
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        
        function setupControls() {
            // View Switching
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    document.querySelectorAll('#tab-content-area > div').forEach(div => div.classList.add('hidden'));
                    const viewEl = document.getElementById(`${view}-view`);
                    if (viewEl) viewEl.classList.remove('hidden');
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            document.querySelector('.nav-btn[data-view="farm"]').classList.add('active');
            
            // Modals
            document.getElementById('context-modal-close').onclick = hideContextMenu;
            document.getElementById('submenu-modal-close').onclick = hideSubMenu;

            // Shop Buying
            document.getElementById('shop-items').addEventListener('click', (e) => {
                if (e.target.classList.contains('buy-btn')) {
                    const itemId = e.target.dataset.itemid;
                    const itemData = GAME_DATA[itemId];
                    if (playerState.money >= itemData.cost) {
                        const newPlayerState = { ...playerState };
                        newPlayerState.money -= itemData.cost;
                        newPlayerState.inventory[itemId] = (newPlayerState.inventory[itemId] || 0) + 1;
                        updatePlayerState(newPlayerState);
                    }
                }
            });

            // Sell Button
            document.getElementById('sell-all-btn').addEventListener('click', () => {
                if (!playerState.produceBin || playerState.produceBin.length === 0) return;
                const newPlayerState = { ...playerState };
                let totalValue = 0;
                newPlayerState.produceBin.forEach(item => {
                    const itemData = GAME_DATA[item.id];
                    totalValue += itemData.sellPrice[item.quality];
                });
                newPlayerState.money += totalValue;
                newPlayerState.produceBin = [];
                updatePlayerState(newPlayerState);
            });

            // Name Change Modal
            playerNameEl.addEventListener('click', () => showNameModal(false));
            document.getElementById('save-name-btn').addEventListener('click', () => saveNameChange());
            document.getElementById('cancel-name-btn').addEventListener('click', hideNameModal);
            nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveNameChange(); });
        }
        
        const showNameModal = (isInitial = false) => {
            isInitialNameSetup = isInitial;
            nameInput.value = isInitial ? '' : playerState.nickname;
            nameModal.classList.remove('hidden');
            nameModal.querySelector('div').classList.remove('modal-leave');
            nameModal.querySelector('div').classList.add('modal-enter');
            nameInput.focus();

            if (isInitial) {
                document.getElementById('cancel-name-btn').style.display = 'none';
                document.getElementById('name-modal-title').textContent = "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
            } else {
                 document.getElementById('cancel-name-btn').style.display = 'inline-block';
                 document.getElementById('name-modal-title').textContent = "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô";
            }
        };
        const hideNameModal = () => {
            const modalContent = nameModal.querySelector('div');
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-leave');
            setTimeout(() => nameModal.classList.add('hidden'), 200);
        };
        const saveNameChange = async () => {
            const newName = nameInput.value.trim();
            if (newName.length > 0 && newName.length <= 15) {
                if (isInitialNameSetup) {
                    playerState = { money: 20, inventory: {}, produceBin: [], nickname: newName };
                    await setDoc(doc(db, "players", userId), playerState);
                    await startGame(userId);
                } else {
                    const newState = {...playerState, nickname: newName};
                    await updatePlayerState(newState);
                }
                hideNameModal();
            }
        };
        
        window.addEventListener('load', async () => {
            setupControls();
            try {
                 await setPersistence(auth, browserLocalPersistence);
                 onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const playerDocRef = doc(db, "players", userId);
                        
                        // We use onSnapshot here because it gracefully waits for the connection
                        // to be established before trying to get the document.
                        const unsubscribe = onSnapshot(playerDocRef, async (docSnap) => {
                            unsubscribe(); // We only need this check once at startup.
                            
                            if (docSnap.exists()) {
                                await startGame(userId);
                            } else {
                                document.getElementById('loading-screen').classList.add('loading-hidden');
                                showNameModal(true);
                            }
                        }, (error) => {
                             unsubscribe();
                             handleFirestoreError(error);
                        });

                    } else {
                        await signInAnonymously(auth);
                    }
                });

            } catch (error) { 
                console.error("Authentication failed:", error); 
                let errorMessage = `<div class="p-4 text-center text-red-700 bg-red-100">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>`;
                if (error.code === 'auth/configuration-not-found') {
                    errorMessage = `...`; // Error message content is correct from previous turn
                }
                displayError(errorMessage);
            }
        });
    </script>
</body>
</html>

