<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'IBM Plex Sans Thai', sans-serif; 
            touch-action: manipulation; 
            background: linear-gradient(to bottom, #a7f3d0, #f0fdf4);
        }
        .plot, .animal-slot, .factory-slot { 
            transition: all 0.2s ease-in-out; 
            background-size: contain; 
            background-position: center; 
            background-repeat: no-repeat; 
            image-rendering: pixelated; /* For pixel art style */
        }
        .plot:hover, .animal-slot:hover, .factory-slot:hover { transform: scale(1.05); }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .modal-enter { animation: fadeIn 0.2s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.2s ease-out forwards; }

        @keyframes pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .pop-animation { animation: pop 0.3s ease-out; }

        @keyframes water-effect {
            0% { background-color: rgba(59, 130, 246, 0); }
            50% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: rgba(59, 130, 246, 0); }
        }
        .watered { animation: water-effect 0.5s ease-out; }

        @keyframes fertilize-effect {
            0% { box-shadow: 0 0 0 0px rgba(139, 69, 19, 0); }
            50% { box-shadow: 0 0 15px 5px rgba(139, 69, 19, 0.5); }
            100% { box-shadow: 0 0 0 0px rgba(139, 69, 19, 0); }
        }
        .fertilized { animation: fertilize-effect 0.6s ease-out; }

        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animal.happy { animation: hop 0.5s infinite; }

        .nav-btn.active { background-color: #15803d; color: white; border-top: 4px solid #facc15; }
        .quality-star { color: #facc15; text-shadow: 0 0 2px black; }
        .loading-hidden { opacity: 0; pointer-events: none; }
        
        #bedroom-display, #pond-display, #kitchen-display {
            background-size: cover;
            background-position: center;
        }
        #pond-display {
            background-image: url('sea.png');
        }
        #kitchen-display {
            background-image: url('kitchen.png');
        }

        #fishing-minigame-track {
            height: 300px;
            width: 50px;
            background-color: rgba(100, 150, 255, 0.3);
            border: 2px solid #4A90E2;
            border-radius: 10px;
            position: relative;
        }
        #fishing-minigame-fish {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 20px;
            font-size: 20px;
            text-align: center;
            transition: top 0.1s linear;
        }
        #fishing-minigame-bar {
            position: absolute;
            left: 0;
            width: 100%;
            background-color: rgba(26, 179, 148, 0.5);
            border: 2px solid #1ab394;
            border-radius: 8px;
        }
        #fishing-minigame-progress {
            width: 20px;
            height: 100%;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        #fishing-minigame-progress-fill {
            width: 100%;
            background-color: #f8ac59;
            height: 0;
            transition: height 0.1s linear;
        }
         /* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Park */
         #park-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            overflow: hidden;
            background-color: #7fdefe; /* ‡∏™‡∏µ‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á */
        }
        #park-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            /* ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
            background-image: url('park_background.png');
        }
        #park-canvas {
            position: relative;
            z-index: 10;
			width: 100%;
			height: 100%;
        }
        #character-preview {
            image-rendering: pixelated;
        }
        .water-indicator {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 1.5rem; /* 24px */
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            animation: pop 0.5s ease-out;
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div id="loading-screen" class="fixed inset-0 bg-green-100 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-6xl animate-bounce">ü•ï</div>
        <p class="mt-4 text-2xl font-bold text-green-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°...</p>
    </div>

<div id="modal-container">
        <div id="info-modal" class="hidden fixed inset-0 bg-black/50 z-[52] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter text-center">
                <div id="info-modal-icon" class="text-6xl mb-4"></div>
                <h2 id="info-modal-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                <p id="info-modal-text" class="text-gray-600 mb-6"></p>
                <button id="info-modal-close" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
            </div>
        </div>
                <div id="quantity-modal" class="hidden fixed inset-0 bg-black/50 z-[53] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter">
                <h2 id="quantity-modal-title" class="text-2xl font-bold text-gray-800 mb-4">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h2>
                <div class="flex items-center gap-4 mb-4">
                    <div id="quantity-modal-icon" class="w-16 h-16 bg-contain bg-no-repeat bg-center flex-shrink-0"></div>
                    <div class="flex-grow">
                        <p id="quantity-modal-name" class="font-bold"></p>
                        <p id="quantity-modal-quality" class="text-sm text-gray-500"></p>
                    </div>
                </div>
                <div class="space-y-3">
                    <input type="range" id="quantity-modal-slider" min="1" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex items-center gap-2">
                        <input type="number" id="quantity-modal-input" min="1" value="1" class="w-full border rounded-lg px-3 py-2 text-center">
                        <button id="quantity-modal-max-btn" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-4 rounded-lg">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</button>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="quantity-modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="quantity-modal-ok" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </div>
        </div>
        <div id="name-modal" class="hidden fixed inset-0 bg-black/50 z-[52] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter">
                <h2 id="name-modal-title" class="text-2xl font-bold text-gray-800 mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</h2>
                <p class="text-gray-600 mb-4">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</p>
                <input type="text" id="name-input" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" maxlength="15">
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-name-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="save-name-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>

        <div id="update-required-modal" class="hidden fixed inset-0 bg-black/80 z-[999] flex items-center justify-center p-4 text-center">
			<div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm">
				<h2 class="text-3xl font-bold text-blue-600 mb-4">‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà!</h2>
				<p class="text-gray-700 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏°‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô</p>
				<button id="force-refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg w-full text-lg">
					‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ
				</button>
			</div>
		</div>

        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 z-[53] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏¢‡∏∑‡∏ô‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h2>
                <p id="confirm-modal-text" class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="confirm-modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="confirm-modal-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </div>
        </div>

        <div id="context-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div id="context-modal-content" class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-xs text-center">
                <h3 id="context-modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <div id="context-modal-actions" class="flex flex-col gap-3"></div>
                <button id="context-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>

        <div id="submenu-modal" class="hidden fixed inset-0 bg-black/60 z-[51] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-md">
                <h3 id="submenu-modal-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h3>
                <div id="submenu-modal-items" class="grid grid-cols-3 gap-3 text-center"></div>
                <button id="submenu-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
        </div>

        <div id="more-modal" class="hidden fixed inset-0 bg-black/50 z-[51] flex items-end justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-4 w-full max-w-md mb-20 modal-enter">
                <div id="more-modal-items" class="flex flex-col gap-3">
                </div>
            </div>
        </div>

        <div id="fish-catch-modal" class="hidden fixed inset-0 bg-black/60 z-[54] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center modal-enter">
                <h2 id="fish-catch-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                <div id="fish-catch-icon" class="text-5xl mb-4 h-16 w-16 mx-auto bg-contain bg-no-repeat bg-center"></div>
                <p class="text-gray-600 mb-4" id="fish-catch-rarity"></p>
                <button id="fish-catch-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</button>
            </div>
        </div>

        <div id="fishing-minigame-modal" class="hidden fixed inset-0 bg-black/60 z-[55] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 flex items-center justify-center gap-4 cursor-pointer" id="fishing-minigame-area">
                <div id="fishing-minigame-progress">
                    <div id="fishing-minigame-progress-fill"></div>
                </div>
                <div id="fishing-minigame-track">
                    <div id="fishing-minigame-bar"></div>
                    <div id="fishing-minigame-fish"></div>
                </div>
            </div>
        </div>

        <div id="cooking-modal" class="hidden fixed inset-0 bg-black/60 z-[52] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg modal-enter">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">‡∏ï‡∏≥‡∏£‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üìñ</h2>
                <div class="flex items-center justify-center mb-4">
                    <input type="checkbox" id="cookable-filter-toggle" class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                    <label for="cookable-filter-toggle" class="ml-2 block text-sm text-gray-900">
                        ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ
                    </label>
                </div>
                <div id="recipe-list" class="max-h-[60vh] overflow-y-auto space-y-3">
                    </div>
                 <button id="cooking-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>

        <div id="character-creator-modal" class="hidden fixed inset-0 bg-black/60 z-[52] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-xs modal-enter">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <div id="character-preview" class="mb-4 h-48 bg-contain bg-no-repeat bg-center"></div>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</span>
                        <div class="flex items-center gap-2">
                            <button id="prev-character" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&lt;</button>
                            <button id="next-character" class="px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300">&gt;</button>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="save-character-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-container" class="w-full max-w-5xl mx-auto p-4 md:p-6 opacity-0 transition-opacity duration-500 pb-24">
        <header class="text-center mb-4 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-4 relative">
            <button id="admin-reset-btn" class="hidden absolute top-2 right-2 bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-red-700">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≤‡∏£‡πå‡∏° (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</button>
            <button id="admin-force-sell-btn" class="hidden absolute top-2 right-[150px] bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-blue-700">‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</button>
			<button id="reset-player-btn" class="absolute bottom-1 right-2 bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-yellow-600">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏±‡∏ô</button>
            <h1 class="text-3xl md:text-4xl font-bold text-green-800">‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üíö</h1>
            <div class="mt-3 flex flex-wrap justify-center items-center gap-x-4 gap-y-2 text-sm text-gray-600">
                <div id="weather-display" class="flex items-center justify-center gap-2 bg-blue-100 px-3 py-1 rounded-full" title="‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ">
                    <span class="text-xl">‚òÄÔ∏è</span>
                    <span class="font-bold text-blue-900">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                </div>
				<div class="flex items-center justify-center gap-2 bg-green-100 px-3 py-1 rounded-full">
                    <span>‡∏ä‡∏∑‡πà‡∏≠:</span>
                    <span id="player-name" class="font-bold text-green-900 cursor-pointer hover:underline" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠">...</span>
                </div>
                <div id="admin-panel" class="hidden mt-4 p-3 bg-red-100 border-2 border-red-300 rounded-lg text-left text-sm space-y-2">
                <h3 class="font-bold text-red-800 text-center">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
                <div>
                    <label for="admin-player-select" class="font-semibold text-red-700">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢:</label>
                    <select id="admin-player-select" class="w-full border rounded px-2 py-1 mt-1"></select>
                </div>
                <div class="flex flex-wrap gap-2 items-center">
                    <select id="admin-item-select" class="flex-grow border rounded px-2 py-1"></select>
                    <input type="number" id="admin-item-quantity" value="1" min="1" class="w-20 border rounded px-2 py-1">
                    <button id="admin-add-item-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</button>
                </div>
            </div>
                <span class="font-semibold bg-yellow-100 px-3 py-1 rounded-full">üí∞: <span id="money-display" class="font-bold text-yellow-800">0</span></span>
                <div class="flex items-center justify-center gap-2 bg-blue-100 px-3 py-1 rounded-full text-sm">
                    <span>‚ö°:</span>
                    <div class="w-24 bg-gray-200 rounded-full h-4">
                        <div id="energy-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-500"></div>
                    </div>
                    <span id="energy-text" class="font-bold text-blue-800">0/0</span>
                </div>
            </div>
             <div id="inventory-display" class="mt-3 flex flex-wrap justify-center items-center gap-x-3 gap-y-1 text-xs text-gray-500"></div>
             <div id="user-id-display" class="mt-2 text-xs text-gray-400 break-all"></div>
        </header>

        <main id="tab-content-area" class="bg-white/60 backdrop-blur-sm rounded-2xl shadow-inner p-4 min-h-[400px]">
            <div id="farm-view">
                <div id="farm-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-2 md:gap-4 flex-grow"></div>
            </div>
            <div id="animals-view" class="hidden">
                 <div id="animal-pen" class="grid grid-cols-3 sm:grid-cols-4 gap-2 md:gap-4"></div>
            </div>
             <div id="factory-view" class="hidden">
                <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ üè≠</h2>
                <div id="factory-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-2 md:gap-4"></div>
            </div>
			<div id="bedroom-view" class="hidden">
                 <div class="w-full max-w-2xl mx-auto text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-4">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üõå</h2>
                    
                    <div id="bedroom-display" class="relative w-full aspect-[4/3] rounded-lg shadow-inner overflow-hidden"></div>
                    
                    <div id="bedroom-info" class="mt-4 space-y-2">
                        <p class="text-lg">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö <span id="house-level" class="font-bold">0</span></p>
                        <div>
                            <button id="upgrade-house-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                                ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î
                            </button>
                            <button id="nap-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                                ‡∏á‡∏µ‡∏ö‡∏´‡∏•‡∏±‡∏ö
                            </button>
                        </div>
                        <p id="nap-info" class="text-sm text-gray-600 h-5"></p>
                    </div>
                 </div>
            </div>          
			<div id="kitchen-view" class="hidden">
                 <div class="w-full max-w-2xl mx-auto text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-4">‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß üç≥</h2>
                    <div id="kitchen-display" class="relative w-full aspect-[4/3] rounded-lg shadow-inner overflow-hidden"></div>
                    <div id="cooking-queue-container" class="mt-4 space-y-3">
                        <h3 class="text-xl font-bold text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£...</h3>
                        <div id="cooking-queue-list" class="min-h-[50px]"></div>
                    </div>
                    <div class="mt-4">
                        <button id="cook-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-8 rounded-full transition">‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡∏£‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                    </div>
                 </div>
            </div>
             <div id="fishing-view" class="hidden">
                <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">‡∏ö‡πà‡∏≠‡∏õ‡∏•‡∏≤ üé£</h2>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div id="pond-display" class="w-full md:w-3/5 aspect-video rounded-lg shadow-inner"></div>

                    <div class="w-full md:w-2/5 flex flex-col items-center space-y-6">
                        <div class="w-full flex flex-col items-center">
                            <h3 class="font-bold text-lg">‡πÄ‡∏ö‡πá‡∏î‡∏ï‡∏Å‡∏õ‡∏•‡∏≤</h3>
                            <div id="rod-image" class="w-24 h-24 my-2 bg-contain bg-no-repeat bg-center"></div>
                            <p id="rod-level-text" class="text-sm font-semibold"></p>
                            <button id="upgrade-rod-btn" class="text-xs bg-green-500 text-white py-1 px-3 rounded-full mt-1 hover:bg-green-600 disabled:bg-gray-400"></button>
                            <button id="fish-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-full disabled:bg-gray-400">‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ (-8‚ö°)</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="quests-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">üìú ‡πÄ‡∏Ñ‡∏ß‡∏™‡∏Ç‡∏≠‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</h2>
                    <div id="daily-quests-container" class="mb-6">
                        <h3 class="text-xl font-bold text-blue-700 mb-2">‡πÄ‡∏Ñ‡∏ß‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                        <div id="daily-quests-list" class="space-y-2">
                            </div>
                    </div>
                    <div id="weekly-quests-container">
                        <h3 class="text-xl font-bold text-purple-700 mb-2">‡πÄ‡∏Ñ‡∏ß‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
                        <div id="weekly-quests-list" class="space-y-2">
                            </div>
                    </div>
                </div>
            </div>
            <div id="shop-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    
                    <div id="shop-items" class="space-y-4"></div>
                </div>
            </div>
            
			<div id="storage-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">üì¶ ‡∏Ñ‡∏•‡∏±‡∏á & ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</h2>
                    <div id="storage-container" class="mb-6">
                        <h3 class="text-xl font-bold text-green-700 mb-2 text-center">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á</h3>
                        <div id="storage-items" class="min-h-[100px] max-h-[200px] overflow-y-auto space-y-2 p-2 bg-yellow-50 rounded-lg">
                            <p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>
                        </div>
                    </div>
                    <div id="sell-box" class="mb-6 bg-yellow-100 p-4 rounded-xl border-2 border-dashed border-yellow-300">
                        <h3 class="text-xl font-bold text-yellow-800 mb-2 text-center">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á üì¨</h3>
                        <div id="sell-box-items" class="min-h-[50px] space-y-2">
                        </div>
                        <div class="mt-4 text-center">
                            <p class="font-semibold text-lg">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏£‡∏±‡∏ö: <span id="sell-box-total" class="font-bold">0</span>üí∞</p>
                            <p id="sell-countdown" class="text-sm text-gray-600 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤...</p>
                        </div>
                    </div>
                </div>
            </div>
			
            <div id="market-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üìà</h2>
                    <div id="market-items-list" class="space-y-2 max-h-[60vh] overflow-y-auto bg-white/80 p-3 rounded-lg">
                    </div>
                </div>
            </div>

            <div id="park-view" class="hidden">
               <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">üå≥ ‡∏™‡∏ß‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</h2>
               <div id="park-container" class="rounded-lg shadow-inner">
                  <div id="park-bg"></div>                 
                  <canvas id="park-canvas" width="800" height="450"></canvas>
               </div>
               <div id="park-actions" class="text-center mt-4">
                    <button id="rest-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                        ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô
                    </button>
                    <p id="rest-info" class="text-sm text-gray-600 mt-2"></p>
               </div>
          </div>

        </main>
    </div>
    
    <footer id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-[0_-4px_12px_rgba(0,0,0,0.05)] z-40 flex justify-around opacity-0 transition-opacity duration-500">
        <button data-view="farm" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏ü‡∏≤‡∏£‡πå‡∏°</button>
        <button data-view="animals" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏Ñ‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
        <button data-view="shop" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
		<button id="more-btn" data-view="more" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">... ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, deleteDoc, collection, getDocs, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyDAc4bOydh3x9OFMI-ocbAIXDQc61qRcnc",
          authDomain: "my-farm-game-556f5.firebaseapp.com",
          projectId: "my-farm-game-556f5",
          storageBucket: "my-farm-game-556f5.appspot.com",
          messagingSenderId: "725056841274",
          appId: "1:725056841274:web:a2b0d5b0cb913c2a10f703",
          measurementId: "G-R0DJJ5KWD0"
        };
        //  ++++++++++++++++++++++++++++++++++++++++++++++++++++

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const CLIENT_VERSION = "1.0.10"; // Updated version

        const FARM_GRID_SIZE = 24;
        const ANIMAL_PEN_SIZE = 8;
        const FACTORY_GRID_SIZE = 8;
        const ADMIN_UID = "p7Ujrm9dBZcL6bK5EHYEsrJOCvl2";

        // --- MASTER GAME DATA ---
        async function initAdminPanel(currentUserId, currentPlayerState) {
            if (currentUserId !== ADMIN_UID) return;

            const panel = document.getElementById('admin-panel');
            const playerSelect = document.getElementById('admin-player-select');
            const itemSelect = document.getElementById('admin-item-select');
            const quantityInput = document.getElementById('admin-item-quantity');
            const addButton = document.getElementById('admin-add-item-btn');

            panel.classList.remove('hidden');

            playerSelect.innerHTML = '';
            
            const selfOption = document.createElement('option');
            selfOption.value = currentUserId;
            selfOption.textContent = `‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (${currentPlayerState.nickname})`;
            playerSelect.appendChild(selfOption);

            try {
                const playersCollectionRef = collection(db, "players");
                const querySnapshot = await getDocs(playersCollectionRef); // <-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                querySnapshot.forEach((doc) => {
                    if (doc.id === currentUserId) return;

                    const playerData = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = playerData.nickname;
                    playerSelect.appendChild(option);
                });
            } catch (e) {
                console.error("Error fetching players for admin panel:", e);
            }

            itemSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° --</option>';
            const itemTypesToInclude = ['produce', 'seed', 'item', 'animal_deed', 'factory_deed'];
            Object.entries(GAME_DATA).forEach(([id, data]) => {
                if (itemTypesToInclude.includes(data.type)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${data.icon || ''} ${data.name}`;
                    itemSelect.appendChild(option);
                }
            });

            addButton.onclick = async () => {
                const targetUserId = playerSelect.value;
                const itemId = itemSelect.value;
                const quantity = parseInt(quantityInput.value, 10);

                if (!targetUserId || !itemId || !quantity || quantity < 1) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢, ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }

                if (targetUserId === currentUserId) {
                    const newPlayerState = { ...playerState };
                    if (!newPlayerState.storageBin) newPlayerState.storageBin = [];
                    for (let i = 0; i < quantity; i++) {
                        newPlayerState.storageBin.push({ id: itemId, quality: 0 });
                    }
                    await updatePlayerState(newPlayerState);
                    alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${GAME_DATA[itemId].name} x${quantity} ‡∏ä‡∏¥‡πâ‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                } else {
                    const playerDocRef = doc(db, "players", targetUserId);
                    try {
                        const playerDoc = await getDoc(playerDocRef);
                        if (playerDoc.exists()) {
                            const targetPlayerData = playerDoc.data();
                            if (!targetPlayerData.storageBin) targetPlayerData.storageBin = [];
                            
                            for (let i = 0; i < quantity; i++) {
                                targetPlayerData.storageBin.push({ id: itemId, quality: 0 });
                            }
                            
                            await setDoc(playerDocRef, targetPlayerData);
                            alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${GAME_DATA[itemId].name} x${quantity} ‡∏ä‡∏¥‡πâ‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á ${targetPlayerData.nickname} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                        } else {
                            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß!');
                        }
                    } catch (e) {
                        console.error("Error giving item to other player:", e);
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á!');
                    }
                }
            };
        }
        const WEATHER_DATA = {
            'sunny': { 
                name: '‡πÅ‡∏î‡∏î‡∏à‡πâ‡∏≤', 
                icon: '‚òÄÔ∏è', 
                description: '‡∏û‡∏∑‡∏ä‡πÇ‡∏ï‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 25%, ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 50%',
                cropMultiplier: 0.75, // ‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏î‡∏•‡∏á 25% (1 ‡∏ä‡∏°. -> 45 ‡∏ô‡∏≤‡∏ó‡∏µ)
                animalMultiplier: 0.5 // ‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏î‡∏•‡∏á 50% (1 ‡∏ä‡∏°. -> 30 ‡∏ô‡∏≤‡∏ó‡∏µ)
            },
            'rainy': { 
                name: '‡∏ù‡∏ô‡∏ï‡∏Å', 
                icon: 'üåßÔ∏è', 
                description: '‡∏û‡∏∑‡∏ä‡πÇ‡∏ï‡πÑ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô 50%, ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ä‡πâ‡∏≤‡∏•‡∏á 50%',
                cropMultiplier: 0.5, // ‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏î‡∏•‡∏á 50% (1 ‡∏ä‡∏°. -> 30 ‡∏ô‡∏≤‡∏ó‡∏µ)
                animalMultiplier: 1.5 // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 50% (1 ‡∏ä‡∏°. -> 1.30 ‡∏ä‡∏°.)
            },
            'cloudy': { 
                name: '‡πÄ‡∏°‡∏Ü‡∏Ñ‡∏£‡∏∂‡πâ‡∏°', 
                icon: '‚òÅÔ∏è', 
                description: '‡∏û‡∏∑‡∏ä‡πÇ‡∏ï‡∏ä‡πâ‡∏≤‡∏•‡∏á 25%, ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ä‡πâ‡∏≤‡∏•‡∏á 25%',
                cropMultiplier: 1.25, // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 25% (1 ‡∏ä‡∏°. -> 1.15 ‡∏ä‡∏°.)
                animalMultiplier: 1.25 // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 25% (1 ‡∏ä‡∏°. -> 1.15 ‡∏ä‡∏°.)
            },
            'stormy': { 
                name: '‡∏û‡∏≤‡∏¢‡∏∏‡∏ù‡∏ô', 
                icon: '‚õàÔ∏è', 
                description: '‡∏û‡∏∑‡∏ä‡πÇ‡∏ï‡∏ä‡πâ‡∏≤‡∏•‡∏á 50%, ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏ä‡πâ‡∏≤‡∏•‡∏á 50%',
                cropMultiplier: 1.5, // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 50% (1 ‡∏ä‡∏°. -> 1.30 ‡∏ä‡∏°.)
                animalMultiplier: 1.5 // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 50% (1 ‡∏ä‡∏°. -> 1.30 ‡∏ä‡∏°.)
            }
        };
		
		const GAME_DATA = {
            'house_upgrades': [
                { name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå', cost: 500, imageUrl: 'beadroom1.png' },
                { name: '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡πÑ‡∏°‡πâ', cost: 2500, imageUrl: 'beadroom2.png' },
                { name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏¥‡∏ê', cost: 10000, imageUrl: 'beadroom3.png' },
                { name: '‡∏Ñ‡∏§‡∏´‡∏≤‡∏™‡∏ô‡πå', cost: 50000, imageUrl: 'beadroom4.png' },
                { name: '‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó', cost: 0, imageUrl: 'beadroom5.png' }
            ],
            'fishing_rods': [
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÑ‡∏°‡πâ‡πÑ‡∏ú‡πà', cost: 0, imageUrl: 'rod1.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Å‡∏•‡∏≤‡∏™', cost: 2500, imageUrl: 'rod2.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏´‡∏•‡πá‡∏Å', cost: 7500, imageUrl: 'rod3.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡∏ó‡∏≠‡∏á', cost: 15000, imageUrl: 'rod4.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÉ‡∏ô‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', cost: 0, imageUrl: 'rod5.png' },
            ],
            'recipes': {
                'fried_egg': { resultId: 'fried_egg_food', ingredients: [{ category: 'egg' }], tool: 'kitchen_pan' },
                'sashimi': { resultId: 'sashimi_food', ingredients: [{ category: 'fish' }], tool: 'kitchen_knife' },
                'fruit_smoothie': { resultId: 'fruit_smoothie_food', ingredients: [{ category: 'fruit' }], tool: 'kitchen_blender' },
                'vegetable_juice': { resultId: 'vegetable_juice_food', ingredients: [{ category: 'vegetable' }], tool: 'kitchen_blender' },
                'salad': { resultId: 'salad_food', ingredients: [{ id: 'carrot_produce' }, { id: 'tomato_produce' }], tool: 'kitchen_knife' },
                'omelette': { resultId: 'omelette_food', ingredients: [{ id: 'egg' }, { id: 'milk' }], tool: 'kitchen_pan' },
                'fried_fish': { resultId: 'fried_fish_food', ingredients: [{ category: 'fish' }], tool: 'kitchen_pan' },
                'fruit_salad': { resultId: 'fruit_salad_food', ingredients: [{ category: 'fruit' }], tool: 'kitchen_knife' },
                'milkshake': { resultId: 'milkshake_food', ingredients: [{ id: 'milk' }, { category: 'fruit' }], tool: 'kitchen_blender' },
                'vegetable_soup': { resultId: 'vegetable_soup_food', ingredients: [{ category: 'vegetable' }, { category: 'vegetable' }], tool: 'kitchen_pot' },
                'spicy_fish_soup': { resultId: 'spicy_fish_soup_food', ingredients: [{ category: 'fish' }, { id: 'tomato_produce' }], tool: 'kitchen_pot' },
                'mango_sticky_rice': { resultId: 'mango_sticky_rice_food', ingredients: [{ id: 'mango_produce' }, { id: 'husked_rice' }], tool: 'kitchen_pot' },
                'fried_rice': { resultId: 'fried_rice_food', ingredients: [{ id: 'husked_rice' }, { category: 'egg' }], tool: 'kitchen_pan' },
                'tom_yum_goong': { resultId: 'tom_yum_goong_food', ingredients: [{ id: 'shrimp' }, { id: 'tomato_produce' }, { id: 'chili_produce' }, { id: 'lime_produce' }], tool: 'kitchen_pot' },
                'sushi': { resultId: 'sushi_food', ingredients: [{ category: 'fish' }, { id: 'husked_rice' }], tool: 'kitchen_knife' },
                'bread': { resultId: 'bread_food', ingredients: [{ id: 'rice_flour' }], tool: 'kitchen_oven' },
                'popcorn': { resultId: 'popcorn_food', ingredients: [{ id: 'corn_produce' }], tool: 'kitchen_oven' },
				'fish_burger_recipe': { resultId: 'fish_burger_food', ingredients: [{ id: 'bread_food' }, { category: 'fish' },{ id: 'tomato_produce' },{ id: 'lime_produce' },{ id: 'egg' },{ id: 'mayonnaise' },{ id: 'chili_produce' },{ id: 'cheese' }], tool: 'kitchen_pan' },
				'beef_steak_recipe': { resultId: 'beef_steak_food', ingredients: [{ id: 'beef' }], tool: 'kitchen_pan' },
                'pork_steak_recipe': { resultId: 'pork_steak_food', ingredients: [{ id: 'pig_meat' }], tool: 'kitchen_pan' },
                'chicken_steak_recipe': { resultId: 'chicken_steak_food', ingredients: [{ id: 'chicken_meat' }], tool: 'kitchen_pan' },
                'duck_steak_recipe': { resultId: 'duck_steak_food', ingredients: [{ id: 'duck_meat' }], tool: 'kitchen_pan' },
                'pork_rice_bowl_recipe': { resultId: 'pork_rice_bowl_food', ingredients: [{ id: 'husked_rice' }, { id: 'pig_meat' }], tool: 'kitchen_pan' },
                'beef_rice_bowl_recipe': { resultId: 'beef_rice_bowl_food', ingredients: [{ id: 'husked_rice' }, { id: 'beef' }], tool: 'kitchen_pan' },
                'beef_burger_recipe': { resultId: 'beef_burger_food', ingredients: [{ id: 'bread_food' }, { id: 'beef' }, { id: 'tomato_produce' },{ id: 'lime_produce' }, { id: 'egg' }, { id: 'mayonnaise' },{ id: 'chili_produce' }, { id: 'cheese' }], tool: 'kitchen_pan' },
                'pork_burger_recipe': { resultId: 'pork_burger_food', ingredients: [{ id: 'bread_food' }, { id: 'pig_meat' }, { id: 'tomato_produce' },{ id: 'lime_produce' }, { id: 'egg' }, { id: 'mayonnaise' },{ id: 'chili_produce' }, { id: 'cheese' }], tool: 'kitchen_pan' },
				'truffle_spaghetti_recipe': { resultId: 'truffle_spaghetti_food', ingredients: [{ id: 'pasta_dough' }, { id: 'truffle' }], tool: 'kitchen_pan' },
                'bolognese_spaghetti_recipe': { resultId: 'bolognese_spaghetti_food', ingredients: [{ id: 'pasta_dough' }, { id: 'pig_meat' }, { id: 'tomato_produce' }], tool: 'kitchen_pan' },
                'carbonara_spaghetti_recipe': { resultId: 'carbonara_spaghetti_food', ingredients: [{ id: 'pasta_dough' }, { id: 'bacon' }, { id: 'cheese' }, { id: 'milk' }], tool: 'kitchen_pan' },
                'beef_spaghetti_recipe': { resultId: 'beef_spaghetti_food', ingredients: [{ id: 'pasta_dough' }, { id: 'beef' }], tool: 'kitchen_pan' },
                'spicy_chicken_spaghetti_recipe': { resultId: 'spicy_chicken_spaghetti_food', ingredients: [{ id: 'pasta_dough' }, { id: 'chicken_meat' }, { id: 'chili_produce' }], tool: 'kitchen_pan' },
                'croissant_truffle_recipe': { resultId: 'croissant_truffle_food', ingredients: [{ id: 'pastry_dough' }, { id: 'truffle' }], tool: 'kitchen_oven' },
                'corn_pie_recipe': { resultId: 'corn_pie_food', ingredients: [{ id: 'pastry_dough' }, { id: 'corn_produce' }], tool: 'kitchen_oven' },
                'ham_cheese_sandwich_recipe': { resultId: 'ham_cheese_sandwich_food', ingredients: [{ id: 'bread_food' }, { id: 'ham' }, { id: 'cheese' }], tool: 'kitchen_oven' },
                'honey_toast_recipe': { resultId: 'honey_toast_food', ingredients: [{ id: 'pastry_dough' }, { id: 'honey' }, { id: 'milk' }], tool: 'kitchen_oven' },
                'grilled_cheese_sandwich_recipe': { resultId: 'grilled_cheese_sandwich_food', ingredients: [{ id: 'bread_food' }, { id: 'egg' }, { id: 'cheese' }], tool: 'kitchen_pan' },
                'fried_shrimp_recipe': { resultId: 'fried_shrimp_food', ingredients: [{ id: 'shrimp' }, { id: 'rice_flour' }, { id: 'egg' }], tool: 'kitchen_pan' },
                'roasted_duck_rice_recipe': { resultId: 'roasted_duck_rice_food', ingredients: [{ id: 'husked_rice' }, { id: 'duck_meat' }], tool: 'kitchen_oven' },
                'chicken_smoothie_recipe': { resultId: 'chicken_smoothie_food', ingredients: [{ id: 'chicken_meat' }, { id: 'milk' }], tool: 'kitchen_blender' },
                'corn_soup_recipe': { resultId: 'corn_soup_food', ingredients: [{ id: 'corn_produce' }], tool: 'kitchen_pot' },
                'truffle_soup_recipe': { resultId: 'truffle_soup_food', ingredients: [{ id: 'truffle' }], tool: 'kitchen_pot' },
                'jam_toast_recipe': { resultId: 'jam_toast_food', ingredients: [{ id: 'bread_food' }, { category: 'jam' }], tool: 'kitchen_oven' },
                'egg_tart_recipe': { resultId: 'egg_tart_food', ingredients: [{ id: 'pastry_dough' }, { id: 'milk' }, { id: 'egg' }], tool: 'kitchen_oven' },
            },
            'fried_egg_food': { name: '‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', icon: 'üç≥', type: 'produce', sellPrice: [25, 35, 45], energyRestore: 15, imageUrl: 'fried_egg_food.png' },
            'sashimi_food': { name: '‡∏ã‡∏≤‡∏ä‡∏¥‡∏°‡∏¥', icon: 'üç£', type: 'produce', sellPrice: [50, 75, 95], energyRestore: 25, imageUrl: 'sashimi_food.png' },
            'fruit_smoothie_food': { name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏õ‡∏±‡πà‡∏ô', icon: 'ü•§', type: 'produce', sellPrice: [80, 100, 120], energyRestore: 30, imageUrl: 'fruit_smoothie_food.png' },
            'vegetable_juice_food': { name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏±‡∏Å‡∏õ‡∏±‡πà‡∏ô', icon: 'üßÉ', type: 'produce', sellPrice: [40, 55, 70], energyRestore: 20, imageUrl: 'vegetable_juice_food.png' },
            'salad_food': { name: '‡∏™‡∏•‡∏±‡∏î', icon: 'ü•ó', type: 'produce', sellPrice: [50, 70, 90], energyRestore: 22, imageUrl: 'salad_food.png' },
            'omelette_food': { name: '‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', icon: 'üç≥', type: 'produce', sellPrice: [60, 80, 100], energyRestore: 28, imageUrl: 'omelette_food.png' },
            'fried_fish_food': { name: '‡∏õ‡∏•‡∏≤‡∏ó‡∏≠‡∏î', icon: 'üêü', type: 'produce', sellPrice: [50, 65, 80], energyRestore: 20, imageUrl: 'fried_fish_food.png' },
            'fruit_salad_food': { name: '‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ', icon: 'üçì', type: 'produce', sellPrice: [65, 85, 110], energyRestore: 25, imageUrl: 'fruit_salad_food.png' },
            'milkshake_food': { name: '‡∏°‡∏¥‡∏•‡∏Ñ‡πå‡πÄ‡∏ä‡∏Ñ', icon: 'ü•õ', type: 'produce', sellPrice: [100, 125, 150], energyRestore: 40, imageUrl: 'milkshake_food.png' },
            'vegetable_soup_food': { name: '‡∏ã‡∏∏‡∏õ‡∏ú‡∏±‡∏Å', icon: 'ü•£', type: 'produce', sellPrice: [60, 80, 100], energyRestore: 25, imageUrl: 'vegetable_soup_food.png' },
            'spicy_fish_soup_food': { name: '‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏õ‡∏•‡∏≤', icon: 'üå∂Ô∏è', type: 'produce', sellPrice: [180, 220, 260], energyRestore: 50, imageUrl: 'spicy_fish_soup_food.png' },
            'mango_sticky_rice_food': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏´‡∏ô‡∏µ‡∏¢‡∏ß‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', icon: 'ü•≠', type: 'produce', sellPrice: [250, 320, 400], energyRestore: 60, imageUrl: 'mango_sticky_rice.png' },
            'fried_rice_food': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î', icon: 'Î≥∂', type: 'produce', sellPrice: [120, 150, 180], energyRestore: 35, imageUrl: 'fried_rice.png' },
            'tom_yum_goong_food': { name: '‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏Å‡∏∏‡πâ‡∏á', icon: 'ü¶ê', type: 'produce', sellPrice: [800, 1000, 1250], energyRestore: 80, imageUrl: 'tom_yum_goong.png' },
            'sushi_food': { name: '‡∏ã‡∏π‡∏ä‡∏¥', icon: 'üç£', type: 'produce', sellPrice: [150, 190, 240], energyRestore: 40, imageUrl: 'sushi.png' },
            'bread_food': { name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', icon: 'üçû', type: 'produce', sellPrice: [80, 100, 125], energyRestore: 25, imageUrl: 'bread.png' },
            'popcorn_food': { name: '‡∏õ‡πá‡∏≠‡∏õ‡∏Ñ‡∏≠‡∏£‡πå‡∏ô', icon: 'üçø', type: 'produce', sellPrice: [70, 90, 110], energyRestore: 20, imageUrl: 'popcorn.png' },
			'fish_burger_food': { name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏õ‡∏•‡∏≤', icon: 'üçî', type: 'produce', sellPrice: [1500, 1600, 1650], energyRestore: 100, imageUrl: 'fish_burger.png' },
			'beef_steak_food': { name: '‡∏™‡πÄ‡∏ï‡πä‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', icon: 'ü•©', type: 'produce', sellPrice: [220, 240, 250], energyRestore: 35, imageUrl: 'beef_steak.png' },
            'pork_steak_food': { name: '‡∏™‡πÄ‡∏ï‡πä‡∏Å‡∏´‡∏°‡∏π', icon: 'üçñ', type: 'produce', sellPrice: [200, 210, 220], energyRestore: 35, imageUrl: 'pork_steak.png' },
            'chicken_steak_food': { name: '‡∏™‡πÄ‡∏ï‡πä‡∏Å‡πÑ‡∏Å‡πà', icon: 'üçó', type: 'produce', sellPrice: [100, 115, 120], energyRestore: 25, imageUrl: 'chicken_steak.png' },
            'duck_steak_food': { name: '‡∏™‡πÄ‡∏ï‡πä‡∏Å‡πÄ‡∏õ‡πá‡∏î', icon: 'üçó', type: 'produce', sellPrice: [105, 120, 130], energyRestore: 25, imageUrl: 'duck_steak.png' },
            'pork_rice_bowl_food': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏°‡∏π', icon: 'üçö', type: 'produce', sellPrice: [230, 240, 250], energyRestore: 40, imageUrl: 'pork_rice_bowl.png' },
            'beef_rice_bowl_food': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', icon: 'üçö', type: 'produce', sellPrice: [250, 260, 270], energyRestore: 40, imageUrl: 'beef_rice_bowl.png' },
            'beef_burger_food': { name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', icon: 'üçî', type: 'produce', sellPrice: [1700, 2000, 2400], energyRestore: 100, imageUrl: 'beef_burger.png' },
            'pork_burger_food': { name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏´‡∏°‡∏π', icon: 'üçî', type: 'produce', sellPrice: [1700, 2000, 2400], energyRestore: 100, imageUrl: 'pork_burger.png' },
			'truffle_spaghetti_food': { name: '‡∏™‡∏õ‡∏≤‡πÄ‡∏Å‡πá‡∏ï‡∏ï‡∏µ‡πâ‡∏ó‡∏£‡∏±‡∏ü‡πÄ‡∏ü‡∏¥‡∏•', icon: 'üçù', type: 'produce', sellPrice: [1300, 1500, 1800], energyRestore: 85, imageUrl: 'truffle_spaghetti.png' },
            'bolognese_spaghetti_food': { name: '‡∏™‡∏õ‡∏≤‡πÄ‡∏Å‡πá‡∏ï‡∏ï‡∏µ‡πâ‡∏ã‡∏≠‡∏™‡∏´‡∏°‡∏π', icon: 'üçù', type: 'produce', sellPrice: [450, 550, 650], energyRestore: 60, imageUrl: 'bolognese_spaghetti.png' },
            'carbonara_spaghetti_food': { name: '‡∏™‡∏õ‡∏≤‡πÄ‡∏Å‡πá‡∏ï‡∏ï‡∏µ‡πâ‡∏Ñ‡∏≤‡πÇ‡∏ö‡∏ô‡∏≤‡∏£‡πà‡∏≤', icon: 'üçù', type: 'produce', sellPrice: [1500, 1800, 2200], energyRestore: 95, imageUrl: 'carbonara_spaghetti.png' },
            'beef_spaghetti_food': { name: '‡∏™‡∏õ‡∏≤‡πÄ‡∏Å‡πá‡∏ï‡∏ï‡∏µ‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠', icon: 'üçù', type: 'produce', sellPrice: [400, 500, 600], energyRestore: 55, imageUrl: 'beef_spaghetti.png' },
            'spicy_chicken_spaghetti_food': { name: '‡∏™‡∏õ‡∏≤‡πÄ‡∏Å‡πá‡∏ï‡∏ï‡∏µ‡πâ‡∏Ç‡∏µ‡πâ‡πÄ‡∏°‡∏≤‡πÑ‡∏Å‡πà', icon: 'üçù', type: 'produce', sellPrice: [200, 250, 300], energyRestore: 50, imageUrl: 'spicy_chicken_spaghetti.png' },
            'croissant_truffle_food': { name: '‡∏Ñ‡∏£‡∏±‡∏ß‡∏ã‡∏≠‡∏á‡∏ï‡πå‡∏ó‡∏£‡∏±‡∏ü‡πÄ‡∏ü‡∏¥‡∏•', icon: 'ü•ê', type: 'produce', sellPrice: [1450, 1750, 2100], energyRestore: 90, imageUrl: 'croissant_truffle.png' },
            'corn_pie_food': { name: '‡∏û‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î', icon: 'ü•ß', type: 'produce', sellPrice: [200, 240, 280], energyRestore: 40, imageUrl: 'corn_pie.png' },
            'ham_cheese_sandwich_food': { name: '‡πÅ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ä‡πÅ‡∏Æ‡∏°‡∏ä‡∏µ‡∏™', icon: 'ü•™', type: 'produce', sellPrice: [1500, 1800, 2200], energyRestore: 100, imageUrl: 'ham_cheese_sandwich.png' },
            'honey_toast_food': { name: '‡∏Æ‡∏±‡∏ô‡∏ô‡∏µ‡πà‡πÇ‡∏ó‡∏™‡∏ï‡πå', icon: 'üçû', type: 'produce', sellPrice: [400, 500, 600], energyRestore: 65, imageUrl: 'honey_toast.png' },
            'grilled_cheese_sandwich_food': { name: '‡∏Å‡∏£‡∏¥‡∏•‡∏•‡πå‡∏ä‡∏µ‡∏™‡πÅ‡∏ã‡∏ô‡∏ß‡∏¥‡∏ä', icon: 'ü•™', type: 'produce', sellPrice: [800, 950, 1150], energyRestore: 75, imageUrl: 'grilled_cheese_sandwich.png' },
            'fried_shrimp_food': { name: '‡∏Å‡∏∏‡πâ‡∏á‡∏ä‡∏∏‡∏ö‡πÅ‡∏õ‡πâ‡∏á‡∏ó‡∏≠‡∏î', icon: 'üç§', type: 'produce', sellPrice: [650, 800, 1000], energyRestore: 70, imageUrl: 'fried_shrimp.png' },
            'roasted_duck_rice_food': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏î', icon: 'üçö', type: 'produce', sellPrice: [250, 300, 360], energyRestore: 50, imageUrl: 'roasted_duck_rice.png' },
            'chicken_smoothie_food': { name: '‡∏≠‡∏Å‡πÑ‡∏Å‡πà‡∏õ‡∏±‡πà‡∏ô', icon: 'ü•§', type: 'produce', sellPrice: [150, 180, 220], energyRestore: 40, imageUrl: 'chicken_smoothie.png' },
            'corn_soup_food': { name: '‡∏ã‡∏∏‡∏õ‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î', icon: 'ü•£', type: 'produce', sellPrice: [100, 120, 150], energyRestore: 30, imageUrl: 'corn_soup.png' },
            'truffle_soup_food': { name: '‡∏ã‡∏∏‡∏õ‡∏ó‡∏£‡∏±‡∏ü‡πÄ‡∏ü‡∏¥‡∏•', icon: 'ü•£', type: 'produce', sellPrice: [600, 700, 800], energyRestore: 80, imageUrl: 'truffle_soup.png' },
            'jam_toast_food': { name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏¢‡∏°', icon: 'üçû', type: 'produce', sellPrice: [650, 800, 950], energyRestore: 70, imageUrl: 'jam_toast.png' },
            'egg_tart_food': { name: '‡∏ó‡∏≤‡∏£‡πå‡∏ï‡πÑ‡∏Ç‡πà', icon: 'ü•ß', type: 'produce', sellPrice: [200, 240, 280], energyRestore: 45, imageUrl: 'egg_tart.png' },	
            // --- NEW KITCHEN TOOL ---
            'kitchen_knife': { name: '‡∏°‡∏µ‡∏î‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡∏ß', type: 'kitchen_tool', cost: 1000, icon: 'üî™', imageUrl: 'knife.png' },
            'kitchen_pan': { name: '‡∏Å‡∏£‡∏∞‡∏ó‡∏∞', type: 'kitchen_tool', cost: 1500, icon: 'üç≥', imageUrl: 'pan.png' },
            'kitchen_blender': { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô', type: 'kitchen_tool', cost: 2000, icon: 'üå™Ô∏è', imageUrl: 'mixer.png' },
            'kitchen_pot': { name: '‡∏´‡∏°‡πâ‡∏≠', type: 'kitchen_tool', cost: 2000, icon: 'üç≤', imageUrl: 'pot.png' },
            'kitchen_oven': { name: '‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö', type: 'kitchen_tool', cost: 5000, icon: 'üî•', imageUrl: 'oven.png' },

            'carp': { name: '‡∏õ‡∏•‡∏≤‡∏Ñ‡∏≤‡∏£‡πå‡∏õ', icon: 'üêü', rarity: 'Common', sellPrice: [15, 20, 25], type: 'produce', energyRestore: 3, imageUrl: 'carp.png', category: 'fish' },
            'sardine': { name: '‡∏õ‡∏•‡∏≤‡∏ã‡∏≤‡∏£‡πå‡∏î‡∏µ‡∏ô', icon: 'üê†', rarity: 'Common', sellPrice: [20, 25, 30], type: 'produce', energyRestore: 4, imageUrl: 'sardine.png', category: 'fish' },
            'tuna': { name: '‡∏õ‡∏•‡∏≤‡∏ó‡∏π‡∏ô‡πà‡∏≤', icon: 'üêü', rarity: 'Uncommon', sellPrice: [35, 50, 65], type: 'produce', energyRestore: 15, imageUrl: 'tuna.png', category: 'fish' },
            'salmon': { name: '‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô', icon: 'üê†', rarity: 'Uncommon', sellPrice: [45, 60, 80], type: 'produce', energyRestore: 18, imageUrl: 'salmon.png', category: 'fish' },
            'eel': { name: '‡∏õ‡∏•‡∏≤‡πÑ‡∏´‡∏•', icon: 'È∞ª', rarity: 'Rare', sellPrice: [150, 200, 250], type: 'produce', energyRestore: 30, imageUrl: 'eel.png', category: 'fish' },
            'pufferfish': { name: '‡∏õ‡∏•‡∏≤‡∏õ‡∏±‡∏Å‡πÄ‡∏õ‡πâ‡∏≤', icon: 'üê°', rarity: 'Rare', sellPrice: [200, 250, 300], type: 'produce', energyRestore: 35, imageUrl: 'pufferfish.png', category: 'fish' },
            'carrot_seed':   { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'seed', cost: 5, plantId: 'carrot', icon: 'ü•ï', imageUrl: 'carrot.png' },
            'carrot':        { name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'crop', growTime: 9600, produceId: 'carrot_produce', icon: 'ü•ï', imageUrl: 'carrot.png' },
            'carrot_produce':{ name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'produce', sellPrice: [8, 12, 16], icon: 'ü•ï', imageUrl: 'carrot.png', energyRestore: 2, category: 'vegetable' },
            'tomato_seed':   { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'seed', cost: 10, plantId: 'tomato', icon: 'üçÖ', imageUrl: 'tomato.png' },
            'tomato':        { name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'crop', growTime: 14400, produceId: 'tomato_produce', icon: 'üçÖ', imageUrl: 'tomato.png' },
            'tomato_produce':{ name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'produce', sellPrice: [18, 25, 35], icon: 'üçÖ', imageUrl: 'tomato.png', energyRestore: 3, category: 'vegetable' },
            'strawberry_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'seed', cost: 15, plantId: 'strawberry', icon: 'üçì', imageUrl: 'stawberry.png' },
            'strawberry':      { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'crop', growTime: 16800, produceId: 'strawberry_produce', icon: 'üçì', imageUrl: 'stawberry.png' },
            'strawberry_produce': { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'produce', sellPrice: [25, 35, 50], icon: 'üçì', imageUrl: 'stawberry.png', energyRestore: 4, category: 'fruit' },
            'grape_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'seed', cost: 20, plantId: 'grape', icon: 'üçá', imageUrl: 'grape.png' },
            'grape':      { name: '‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'crop', growTime: 21000, produceId: 'grape_produce', icon: 'üçá', imageUrl: 'grape.png' },
            'grape_produce': { name: '‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'produce', sellPrice: [35, 50, 70], icon: 'üçá', imageUrl: 'grape.png', energyRestore: 6, category: 'fruit' },
            'peach_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏µ‡∏ä', type: 'seed', cost: 25, plantId: 'peach', icon: 'üçë', imageUrl: 'peach.png' },
            'peach':      { name: '‡∏û‡∏µ‡∏ä', type: 'crop', growTime: 21600, produceId: 'peach_produce', icon: 'üçë', imageUrl: 'peach.png' },
            'peach_produce': { name: '‡∏û‡∏µ‡∏ä', type: 'produce', sellPrice: [45, 65, 90], icon: 'üçë', imageUrl: 'peach.png', energyRestore: 8, category: 'fruit' },
            'orange_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡πâ‡∏°', type: 'seed', cost: 30, plantId: 'orange', icon: 'üçä', imageUrl: 'orange.png' },
            'orange':      { name: '‡∏™‡πâ‡∏°', type: 'crop', growTime: 25200, produceId: 'orange_produce', icon: 'üçä', imageUrl: 'orange.png' },
            'orange_produce': { name: '‡∏™‡πâ‡∏°', type: 'produce', sellPrice: [55, 80, 110], icon: 'üçä', imageUrl: 'orange.png', energyRestore: 9, category: 'fruit' },
            'mango_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'seed', cost: 35, plantId: 'mango', icon: 'ü•≠', imageUrl: 'mango.png' },
            'mango':      { name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'crop', growTime: 28800, produceId: 'mango_produce', icon: 'ü•≠', imageUrl: 'mango.png' },
            'mango_produce': { name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'produce', sellPrice: [65, 95, 130], icon: 'ü•≠', imageUrl: 'mango.png', energyRestore: 11, category: 'fruit' },
            'pineapple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'seed', cost: 40, plantId: 'pineapple', icon: 'üçç', imageUrl: 'pineapple.png' },
            'pineapple':      { name: '‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'crop', growTime: 32400, produceId: 'pineapple_produce', icon: 'üçç', imageUrl: 'pineapple.png' },
            'pineapple_produce': { name: '‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'produce', sellPrice: [75, 110, 150], icon: 'üçç', imageUrl: 'pineapple.png', energyRestore: 12, category: 'fruit' },
            'guava_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'seed', cost: 18, plantId: 'guava', icon: 'üçà', imageUrl: 'guava.png' },
            'guava':      { name: '‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'crop', growTime: 22400, produceId: 'guava_produce', icon: 'üçà', imageUrl: 'guava.png' },
            'guava_produce': { name: '‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'produce', sellPrice: [30, 45, 65], icon: 'üçà', imageUrl: 'guava.png', energyRestore: 5, category: 'fruit' },
            'roseapple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'seed', cost: 22, plantId: 'roseapple', icon: 'üçê', imageUrl: 'chompu.png' },
            'roseapple':      { name: '‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'crop', growTime: 25600, produceId: 'roseapple_produce', icon: 'üçê', imageUrl: 'chompu.png' },
            'roseapple_produce': { name: '‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'produce', sellPrice: [40, 60, 85], icon: 'üçê', imageUrl: 'chompu.png', energyRestore: 7, category: 'fruit' },
            'apple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'seed', cost: 28, plantId: 'apple', icon: 'üçé', imageUrl: 'apple.png' },
            'apple':      { name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'crop', growTime: 32000, produceId: 'apple_produce', icon: 'üçé', imageUrl: 'apple.png' },
            'apple_produce': { name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'produce', sellPrice: [50, 75, 105], icon: 'üçé', imageUrl: 'apple.png', energyRestore: 10, category: 'fruit' },
            'fertilizer_1': { name: '‡∏õ‡∏∏‡πã‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤', type: 'item', cost: 10, qualityBonus: 0.3, icon: 'üí©', imageUrl: 'manure.png' },
            'fertilizer_2': { name: '‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ', type: 'item', cost: 25, qualityBonus: 0.6, icon: '‚ú®', imageUrl: 'fertilizer.png' },
            'chicken_deed': { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏Å‡πà', type: 'animal_deed', cost: 100, animalId: 'chicken', icon: 'üêî', imageUrl: 'chicken.png' },
            'chicken':      { name: '‡πÑ‡∏Å‡πà', type: 'animal_instance', produceTime: 600, produceId: 'egg', icon: 'üêî', imageUrl: 'chicken.png' },
            'egg':          { name: '‡πÑ‡∏Ç‡πà', type: 'produce', sellPrice: [12, 18, 25], icon: 'ü•ö', imageUrl: 'egg.png', energyRestore: 5, category: 'egg' },
            'cow_deed':     { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡∏±‡∏ß', type: 'animal_deed', cost: 500, animalId: 'cow', icon: 'üêÑ', imageUrl: 'cow.png' },
            'cow':          { name: '‡∏ß‡∏±‡∏ß', type: 'animal_instance', produceTime: 3600, produceId: 'milk', icon: 'üêÑ', imageUrl: 'cow.png' },
            'milk':         { name: '‡∏ô‡∏°', type: 'produce', sellPrice: [50, 70, 90], icon: 'ü•õ', imageUrl: 'milk.png', energyRestore: 10, category: 'milk' },
            'duck_deed':    { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏î', type: 'animal_deed', cost: 120, animalId: 'duck', icon: 'ü¶Ü', imageUrl: 'duck.png' },
            'duck':         { name: '‡πÄ‡∏õ‡πá‡∏î', type: 'animal_instance', produceTime: 900, produceId: 'duck_egg', icon: 'ü¶Ü', imageUrl: 'duck.png' },
            'duck_egg':     { name: '‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏î', type: 'produce', sellPrice: [15, 22, 30], icon: 'ü•ö', imageUrl: 'egg_duck.png', energyRestore: 6, category: 'egg' },
            'goose_deed':   { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡πà‡∏≤‡∏ô', type: 'animal_deed', cost: 150, animalId: 'goose', icon: 'ü¶¢', imageUrl: 'swan.png' },
            'goose':        { name: '‡∏´‡πà‡∏≤‡∏ô', type: 'animal_instance', produceTime: 1800, produceId: 'feather', icon: 'ü¶¢', imageUrl: 'swan.png' },
            'feather':      { name: '‡∏Ç‡∏ô‡∏ô‡∏Å', type: 'produce', sellPrice: [25, 38, 55], icon: 'ü™∂', imageUrl: 'feather.png', energyRestore: 0 },
            'turtle_deed':  { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ï‡πà‡∏≤', type: 'animal_deed', cost: 1000, animalId: 'turtle', icon: 'üê¢', imageUrl: 'turtle.png' },
            'turtle':       { name: '‡πÄ‡∏ï‡πà‡∏≤', type: 'animal_instance', produceTime: 86400, produceId: 'gem', icon: 'üê¢', imageUrl: 'turtle.png' },
            'gem':          { name: '‡∏≠‡∏±‡∏ç‡∏°‡∏ì‡∏µ', type: 'produce', sellPrice: [200, 300, 500], icon: 'üíé', imageUrl: 'gem.png', energyRestore: 0 },
            'pig_deed': 	{ name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏°‡∏π', type: 'animal_deed', cost: 400, animalId: 'pig', icon: 'üê∑', imageUrl: 'pig.png' },
            'pig':      	{ name: '‡∏´‡∏°‡∏π', type: 'animal_instance', produceTime: 14400, produceId: 'truffle', icon: 'üê∑', imageUrl: 'pig.png' },
            'truffle':      { name: '‡∏ó‡∏£‡∏±‡∏ü‡πÄ‡∏ü‡∏¥‡∏•', type: 'produce', sellPrice: [500, 600, 700], icon: 'üçÑ', imageUrl: 'truffle.png', energyRestore: 10, category: 'truffle' },
			'chicken_meat': { name: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÑ‡∏Å‡πà', icon: 'üçó', type: 'produce', sellPrice: [70, 75, 85], energyRestore: 15, imageUrl: 'chicken_meat.png' },
			'beef': 		{ name: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ß', icon: 'ü•©', type: 'produce', sellPrice: [170, 180, 190], energyRestore: 25, imageUrl: 'beef.png' },
			'pig_meat': 	{ name: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π', icon: 'ü•©', type: 'produce', sellPrice: [150, 170, 180], energyRestore: 25, imageUrl: 'pig_meat.png' },
			'duck_meat': 	{ name: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î', icon: 'üçó', type: 'produce', sellPrice: [75, 80, 90], energyRestore: 15, imageUrl: 'duck_meat.png' },
			'winery_deed': 	{ name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏´‡∏°‡∏±‡∏Å‡πÑ‡∏ß‡∏ô‡πå', type: 'factory_deed', cost: 15000, factoryId: 'winery', icon: 'üçá', imageUrl: 'winery.png' },
            'cheese_press_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏ó‡∏≥‡∏ä‡∏µ‡∏™', type: 'factory_deed', cost: 10000, factoryId: 'cheese_press', icon: 'üßÄ', imageUrl: 'cheese_press.png' },
            'preserves_jar_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏ó‡∏≥‡πÅ‡∏¢‡∏°', type: 'factory_deed', cost: 7500, factoryId: 'preserves_jar', icon: 'üçì', imageUrl: 'preserves_jar.png' },
            'mayonnaise_machine_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', type: 'factory_deed', cost: 5000, factoryId: 'mayonnaise_machine', icon: 'ü•ö', imageUrl: 'mayonnaise_machine.png' },
            'winery': {name: '‡πÇ‡∏£‡∏á‡∏´‡∏°‡∏±‡∏Å‡πÑ‡∏ß‡∏ô‡πå', type: 'factory_instance', imageUrl: 'winery.png',recipes: [ { id: 'grape_wine_recipe', name: '‡∏ó‡∏≥‡πÑ‡∏ß‡∏ô‡πå‡∏≠‡∏á‡∏∏‡πà‡∏ô', inputs: [{ id: 'grape_produce', count: 20 }], output: { id: 'grape_wine', count: 1 }, processTime: 7200 } ]},
            'cheese_press': {name: '‡πÇ‡∏£‡∏á‡∏ó‡∏≥‡∏ä‡∏µ‡∏™', type: 'factory_instance', imageUrl: 'cheese_press.png',recipes: [ { id: 'cheese_recipe', name: '‡∏ó‡∏≥‡∏ä‡∏µ‡∏™', inputs: [{ id: 'milk', count: 10 }], output: { id: 'cheese', count: 1 }, processTime: 6000 } ]},
            'preserves_jar': {
                name: '‡πÇ‡∏£‡∏á‡∏ó‡∏≥‡πÅ‡∏¢‡∏°', type: 'factory_instance', imageUrl: 'preserves_jar.png',
                recipes: [
                    { id: 'strawberry_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', inputs: [{ id: 'strawberry_produce', count: 5 }], output: { id: 'strawberry_jam', count: 1 }, processTime: 4800 },
                    { id: 'apple_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', inputs: [{ id: 'apple_produce', count: 5 }], output: { id: 'apple_jam', count: 1 }, processTime: 4800 },
                    { id: 'grape_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏≠‡∏á‡∏∏‡πà‡∏ô', inputs: [{ id: 'grape_produce', count: 5 }], output: { id: 'grape_jam', count: 1 }, processTime: 4800 },
                    { id: 'peach_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏û‡∏µ‡∏ä', inputs: [{ id: 'peach_produce', count: 5 }], output: { id: 'peach_jam', count: 1 }, processTime: 4800 },
                    { id: 'orange_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏™‡πâ‡∏°', inputs: [{ id: 'orange_produce', count: 5 }], output: { id: 'orange_jam', count: 1 }, processTime: 4800 },
                    { id: 'mango_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', inputs: [{ id: 'mango_produce', count: 5 }], output: { id: 'mango_jam', count: 1 }, processTime: 4800 },
                    { id: 'pineapple_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', inputs: [{ id: 'pineapple_produce', count: 5 }], output: { id: 'pineapple_jam', count: 1 }, processTime: 4800 },
                    { id: 'guava_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏ù‡∏£‡∏±‡πà‡∏á', inputs: [{ id: 'guava_produce', count: 5 }], output: { id: 'guava_jam', count: 1 }, processTime: 4800 },
                    { id: 'roseapple_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏ä‡∏°‡∏û‡∏π‡πà', inputs: [{ id: 'roseapple_produce', count: 5 }], output: { id: 'roseapple_jam', count: 1 }, processTime: 4800 },
                ]
            },
            'mayonnaise_machine': {
                name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', type: 'factory_instance', imageUrl: 'mayonnaise_machine.png',
                recipes: [
                    { id: 'mayonnaise_recipe', name: '‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', inputs: [{ id: 'egg', count: 5 }], output: { id: 'mayonnaise', count: 1 }, processTime: 1200 },
                    { id: 'duck_mayonnaise_recipe', name: '‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏î', inputs: [{ id: 'duck_egg', count: 5 }], output: { id: 'duck_mayonnaise', count: 1 }, processTime: 1200 }
                ]
            },
			'meat_processor_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', type: 'factory_deed', cost: 20000, factoryId: 'meat_processor', icon: 'ü•©', imageUrl: 'meat_processor.png' },
			'smokehouse_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏£‡∏°‡∏Ñ‡∏ß‡∏±‡∏ô', type: 'factory_deed', cost: 18000, factoryId: 'smokehouse', icon: 'ü•ì', imageUrl: 'smokehouse.png' },
			'meat_processor': {
				name: '‡πÇ‡∏£‡∏á‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå', type: 'factory_instance', imageUrl: 'meat_processor.png',
				recipes: [
					// ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ß‡πà‡∏≤ inputs ‡∏Ñ‡∏∑‡∏≠ 'chicken_deed' ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÑ‡∏Å‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
					{ id: 'process_chicken', name: '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÑ‡∏Å‡πà', inputs: [{ id: 'chicken_deed', count: 1 }], output: { id: 'chicken_meat', count: 5 }, processTime: 3600 },
					{ id: 'process_cow', name: '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ß', inputs: [{ id: 'cow_deed', count: 1 }], output: { id: 'beef', count: 5 }, processTime: 3600 },
					{ id: 'process_duck', name: '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏î', inputs: [{ id: 'duck_deed', count: 1 }], output: { id: 'duck_meat', count: 5 }, processTime: 3600 },
					{ id: 'process_pig', name: '‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏°‡∏π', inputs: [{ id: 'pig_deed', count: 1 }], output: { id: 'pig_meat', count: 5 }, processTime: 3600 }
				]
			},
			'smokehouse': {
            name: '‡πÇ‡∏£‡∏á‡∏£‡∏°‡∏Ñ‡∏ß‡∏±‡∏ô', type: 'factory_instance', imageUrl: 'smokehouse.png',
            recipes: [
                { id: 'process_bacon', name: '‡∏£‡∏°‡∏Ñ‡∏ß‡∏±‡∏ô‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô', inputs: [{ id: 'pig_meat', count: 1 }], output: { id: 'bacon', count: 2 }, processTime: 7200 },
                { id: 'process_ham', name: '‡∏£‡∏°‡∏Ñ‡∏ß‡∏±‡∏ô‡πÅ‡∏Æ‡∏°', inputs: [{ id: 'pig_meat', count: 1 }], output: { id: 'ham', count: 2 }, processTime: 7200 }
            ]
        },
            'grape_wine': { name: '‡πÑ‡∏ß‡∏ô‡πå‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'produce', sellPrice: [800, 1200, 1600], icon: 'üç∑', energyRestore: 20, imageUrl: 'wine.png' },
            'cheese': { name: '‡∏ä‡∏µ‡∏™', type: 'produce', sellPrice: [600, 850, 1100], icon: 'üßÄ', energyRestore: 30, imageUrl: 'cheese.png' },
            'strawberry_jam': { name: '‡πÅ‡∏¢‡∏°‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'produce', sellPrice: [450, 550, 650], icon: 'üçì', energyRestore: 15, imageUrl: 'jam.png', category: 'jam' },
            'apple_jam': { name: '‡πÅ‡∏¢‡∏°‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'produce', sellPrice: [500, 620, 750], icon: 'üçé', energyRestore: 18, imageUrl: 'jam_apple.png', category: 'jam' },
            'grape_jam': { name: '‡πÅ‡∏¢‡∏°‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'produce', sellPrice: [550, 680, 820], icon: 'üçá', energyRestore: 18, imageUrl: 'jam_grape.png', category: 'jam' },
            'peach_jam': { name: '‡πÅ‡∏¢‡∏°‡∏û‡∏µ‡∏ä', type: 'produce', sellPrice: [600, 750, 900], icon: 'üçë', energyRestore: 20, imageUrl: 'jam_peach.png', category: 'jam' },
            'orange_jam': { name: '‡πÅ‡∏¢‡∏°‡∏™‡πâ‡∏°', type: 'produce', sellPrice: [650, 800, 980], icon: 'üçä', energyRestore: 22, imageUrl: 'jam_orange.png', category: 'jam' },
            'mango_jam': { name: '‡πÅ‡∏¢‡∏°‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'produce', sellPrice: [700, 880, 1100], icon: 'ü•≠', energyRestore: 25, imageUrl: 'jam_mango.png', category: 'jam' },
            'pineapple_jam': { name: '‡πÅ‡∏¢‡∏°‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'produce', sellPrice: [750, 950, 1200], icon: 'üçç', energyRestore: 28, imageUrl: 'jam_pineapple.png', category: 'jam' },
            'guava_jam': { name: '‡πÅ‡∏¢‡∏°‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'produce', sellPrice: [520, 650, 780], icon: 'üçà', energyRestore: 17, imageUrl: 'jam_guava.png', category: 'jam' },
            'roseapple_jam': { name: '‡πÅ‡∏¢‡∏°‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'produce', sellPrice: [580, 720, 850], icon: 'üçê', energyRestore: 19, imageUrl: 'jam_roseapple.png', category: 'jam' },
            'mayonnaise': { name: '‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', type: 'produce', sellPrice: [150, 200, 250], icon: 'ü•ö', energyRestore: 10, imageUrl: 'mayonnaise.png' },
            'duck_mayonnaise': { name: '‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏î', type: 'produce', sellPrice: [180, 240, 300], icon: 'ü•ö', energyRestore: 12, imageUrl: 'mayonnaise_duck.png' },
            'pasta_dough': { name: '‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏õ‡πâ‡∏á', icon: 'üçù', type: 'produce', sellPrice: [100, 120, 140], energyRestore: 5, imageUrl: 'pasta_dough.png' },
            'pastry_dough': { name: '‡πÅ‡∏õ‡πâ‡∏á‡∏Ç‡∏ô‡∏°', icon: 'ü•ß', type: 'produce', sellPrice: [80, 100, 120], energyRestore: 5, imageUrl: 'pastry_dough.png' },
            'bacon': { name: '‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô', icon: 'ü•ì', type: 'produce', sellPrice: [700, 850, 1000], energyRestore: 30, imageUrl: 'bacon.png' },
            'ham': { name: '‡πÅ‡∏Æ‡∏°', icon: 'üçñ', type: 'produce', sellPrice: [700, 850, 1000], energyRestore: 30, imageUrl: 'ham.png' },
            'rice_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Ç‡πâ‡∏≤‡∏ß', type: 'seed', cost: 20, plantId: 'rice', icon: 'üåæ', imageUrl: 'rice.png' },
            'rice': { name: '‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß', type: 'crop', growTime: 21600, produceId: 'unhusked_rice', icon: 'üåæ', imageUrl: 'rice.png' }, 
            'unhusked_rice': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å', type: 'produce', sellPrice: [15, 20, 25], icon: 'üåæ', imageUrl: 'rice.png', energyRestore: 1, category: 'grain' },
            'husked_rice': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏£', type: 'produce', sellPrice: [30, 40, 50], icon: 'üçö', imageUrl: 'husked_rice.png', energyRestore: 4, category: 'grain' },
            'rice_flour': { name: '‡πÅ‡∏õ‡πâ‡∏á‡∏Ç‡πâ‡∏≤‡∏ß', type: 'produce', sellPrice: [45, 60, 75], icon: '‚ö™', imageUrl: 'rice_flour.png', energyRestore: 2 },
            
            'corn_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î', type: 'seed', cost: 25, plantId: 'corn', icon: 'üåΩ', imageUrl: 'corn.png' },
            'corn': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î', type: 'crop', growTime: 18000, produceId: 'corn_produce', icon: 'üåΩ', imageUrl: 'corn.png' }, 
            'corn_produce': { name: '‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î', type: 'produce', sellPrice: [40, 55, 70], icon: 'üåΩ', imageUrl: 'corn.png', energyRestore: 8, category: 'vegetable' },

            'chili_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏£‡∏¥‡∏Å', type: 'seed', cost: 15, plantId: 'chili', icon: 'üå∂Ô∏è', imageUrl: 'chili.png' },
            'chili': { name: '‡∏û‡∏£‡∏¥‡∏Å', type: 'crop', growTime: 14400, produceId: 'chili_produce', icon: 'üå∂Ô∏è', imageUrl: 'chili.png' }, 
            'chili_produce': { name: '‡∏û‡∏£‡∏¥‡∏Å', type: 'produce', sellPrice: [25, 35, 45], icon: 'üå∂Ô∏è', imageUrl: 'chili.png', energyRestore: 3, category: 'vegetable' },

            'lime_sapling': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', type: 'seed', cost: 20, plantId: 'lime', icon: 'üçã', imageUrl: 'lime.png' },
            'lime': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', type: 'crop', growTime: 14500, produceId: 'lime_produce', icon: 'üçã', imageUrl: 'lime.png' }, 
            'lime_produce': { name: '‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', type: 'produce', sellPrice: [30, 40, 55], icon: 'üçã', imageUrl: 'lime.png', energyRestore: 5, category: 'fruit' },

            'shrimp': { name: '‡∏Å‡∏∏‡πâ‡∏á', icon: 'ü¶ê', rarity: 'Legendary', sellPrice: [500, 600, 750], type: 'produce', energyRestore: 25, imageUrl: 'shrimp.png', category: 'fish' },

            'crocodile_deed': { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ', type: 'animal_deed', cost: 25000, animalId: 'crocodile', icon: 'üêä', imageUrl: 'crocodile.png' },
            'crocodile': { name: '‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ', type: 'animal_instance', produceTime: 172800, produceId: 'crocodile_skin', icon: 'üêä', imageUrl: 'crocodile.png' }, 
            'crocodile_skin': { name: '‡∏´‡∏ô‡∏±‡∏á‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ', type: 'produce', sellPrice: [1200, 1500, 1800], icon: 'üëú', imageUrl: 'crocodile_skin.png', energyRestore: 0 },

            'sheep_deed': { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡∏∞', type: 'animal_deed', cost: 8000, animalId: 'sheep', icon: 'üêë', imageUrl: 'sheep.png' },
            'sheep': { name: '‡πÅ‡∏Å‡∏∞', type: 'animal_instance', produceTime: 86400, produceId: 'wool', icon: 'üêë', imageUrl: 'sheep.png' }, 
            'wool': { name: '‡∏Ç‡∏ô‡πÅ‡∏Å‡∏∞', type: 'produce', sellPrice: [350, 450, 550], icon: 'üß∂', imageUrl: 'wool.png', energyRestore: 0 },

            'pearl_oyster_deed': { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏≠‡∏¢‡∏°‡∏∏‡∏Å', type: 'animal_deed', cost: 20000, animalId: 'pearl_oyster', icon: 'ü¶™', imageUrl: 'pearl_oyster.png' },
            'pearl_oyster': { name: '‡∏´‡∏≠‡∏¢‡∏°‡∏∏‡∏Å', type: 'animal_instance', produceTime: 259200, produceId: 'pearl', icon: 'ü¶™', imageUrl: 'pearl_oyster.png' }, 
            'pearl': { name: '‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å', type: 'produce', sellPrice: [2500, 3000, 4000], icon: '‚ö™', imageUrl: 'pearl.png', energyRestore: 0 },
            
            'beehive_deed': { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏±‡∏á‡∏ú‡∏∂‡πâ‡∏á', type: 'animal_deed', cost: 2500, animalId: 'beehive', icon: 'üêù', imageUrl: 'beehive.png' },
            'beehive': { name: '‡∏£‡∏±‡∏á‡∏ú‡∏∂‡πâ‡∏á', type: 'animal_instance', produceTime: 86400, produceId: 'honey', icon: 'üêù', imageUrl: 'beehive.png' }, 
            'honey': { name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á', type: 'produce', sellPrice: [200, 250, 320], icon: 'üçØ', imageUrl: 'honey.png', energyRestore: 20 },

            'leather_bag': { name: '‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏à‡∏£‡∏∞‡πÄ‡∏Ç‡πâ', type: 'produce', sellPrice: [5000, 6500, 8000], icon: 'üëú', imageUrl: 'leather_bag.png', energyRestore: 0 },
            'clothing': { name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤', type: 'produce', sellPrice: [1000, 1300, 1600], icon: 'üëï', imageUrl: 'clothing.png', energyRestore: 0 },
            'pearl_necklace': { name: '‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏°‡∏∏‡∏Å', type: 'produce', sellPrice: [7500, 9000, 11000], icon: 'üíç', imageUrl: 'pearl_necklace.png', energyRestore: 0 },
            
            'artisan_workshop_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', type: 'factory_deed', cost: 30000, factoryId: 'artisan_workshop', icon: 'üíé', imageUrl: 'artisan_workshop.png' },
            'artisan_workshop': {
                name: '‡πÇ‡∏£‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', type: 'factory_instance', imageUrl: 'artisan_workshop.png',
                recipes: [
                    { id: 'leather_bag_recipe', name: '‡∏ó‡∏≥‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏´‡∏ô‡∏±‡∏á', inputs: [{ id: 'crocodile_skin', count: 1 }], output: { id: 'leather_bag', count: 1 }, processTime: 43200 }, 
                    { id: 'pearl_necklace_recipe', name: '‡∏ó‡∏≥‡∏™‡∏£‡πâ‡∏≠‡∏¢‡∏°‡∏∏‡∏Å', inputs: [{ id: 'pearl', count: 1 }], output: { id: 'pearl_necklace', count: 1 }, processTime: 21600 } 
                ]
            },

            'clothing_mill_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏ó‡∏≠‡∏ú‡πâ‡∏≤', type: 'factory_deed', cost: 12000, factoryId: 'clothing_mill', icon: 'üëï', imageUrl: 'clothing_mill.png' },
            'clothing_mill': {
                name: '‡πÇ‡∏£‡∏á‡∏ó‡∏≠‡∏ú‡πâ‡∏≤', type: 'factory_instance', imageUrl: 'clothing_mill.png',
                recipes: [
                    { id: 'clothing_recipe', name: '‡∏ó‡∏≥‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤', inputs: [{ id: 'wool', count: 1 }], output: { id: 'clothing', count: 1 }, processTime: 14400 } 
                ]
            },
            
            'rice_mill_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏™‡∏µ', type: 'factory_deed', cost: 8000, factoryId: 'rice_mill', icon: 'üåæ', imageUrl: 'rice_mill.png' },
            'rice_mill': {
                name: '‡πÇ‡∏£‡∏á‡∏™‡∏µ', type: 'factory_instance', imageUrl: 'rice_mill.png',
                recipes: [
                    { id: 'husked_rice_recipe', name: '‡∏ó‡∏≥‡∏Ç‡πâ‡∏≤‡∏ß‡∏™‡∏≤‡∏£', inputs: [{ id: 'unhusked_rice', count: 1 }], output: { id: 'husked_rice', count: 1 }, processTime: 600 }, 
                    { id: 'rice_flour_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏õ‡πâ‡∏á‡∏Ç‡πâ‡∏≤‡∏ß', inputs: [{ id: 'husked_rice', count: 1 }], output: { id: 'rice_flour', count: 1 }, processTime: 900 },
					{ id: 'pasta_dough_recipe', name: '‡∏ó‡∏≥‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏õ‡πâ‡∏á', inputs: [{ id: 'rice_flour', count: 2 }], output: { id: 'pasta_dough', count: 1 }, processTime: 1200 },
					{ id: 'pastry_dough_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏õ‡πâ‡∏á‡∏Ç‡∏ô‡∏°', inputs: [{ id: 'rice_flour', count: 1 }, { id: 'egg', count: 1 }], output: { id: 'pastry_dough', count: 1 }, processTime: 1200 }	
                ]
            }
        };
        const QUEST_DATA = {
            daily: [
                { id: 'water_25', action: 'water', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ 25 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 25, reward: { type: 'item', id: 'fertilizer_1', count: 3 } },
                { id: 'harvest_15', action: 'harvest', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï 15 ‡∏ä‡∏¥‡πâ‡∏ô', target: 15, reward: { type: 'seed', id: 'carrot_seed', count: 15 } },
                { id: 'fish_10', action: 'fish', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ 10 ‡∏ï‡∏±‡∏ß', target: 10, reward: { type: 'seed', id: 'tomato_seed', count: 8 } },
                { id: 'collect_5', action: 'collect_product', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå 5 ‡∏ä‡∏¥‡πâ‡∏ô', target: 5, reward: { type: 'item', id: 'fertilizer_1', count: 2 } },
                { id: 'cook_3', action: 'cook', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', target: 3, reward: { type: 'produce', id: 'egg', count: 5 } },
                { id: 'plant_10', action: 'plant', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏∑‡∏ä 10 ‡∏ï‡πâ‡∏ô', target: 10, reward: { type: 'seed', id: 'carrot_seed', count: 10 } },
                { id: 'fertilize_5', action: 'fertilize', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ 5 ‡πÅ‡∏õ‡∏•‡∏á', target: 5, reward: { type: 'item', id: 'fertilizer_1', count: 2 } },
                { id: 'fish_15_more', action: 'fish', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏õ‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 15 ‡∏ï‡∏±‡∏ß', target: 15, reward: { type: 'produce', id: 'sardine', count: 5 } },
                { id: 'sell_item_10', action: 'sell_item', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡∏¢ 10 ‡∏ä‡∏¥‡πâ‡∏ô', target: 10, reward: { type: 'seed', id: 'strawberry_seed', count: 10 } },
                { id: 'collect_8_more', action: 'collect_product', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏û‡∏¥‡πà‡∏° 8 ‡∏ä‡∏¥‡πâ‡∏ô', target: 8, reward: { type: 'produce', id: 'duck_egg', count: 2 } },
                { id: 'cook_2_more', action: 'cook', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', target: 2, reward: { type: 'produce', id: 'sashimi_food', count: 1 } },
                { id: 'harvest_10_more', action: 'harvest', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏° 10 ‡∏ä‡∏¥‡πâ‡∏ô', target: 10, reward: { type: 'produce', id: 'carrot_produce', count: 5 } },
                { id: 'buy_item_5', action: 'buy_item', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ 5 ‡∏ä‡∏¥‡πâ‡∏ô', target: 5, reward: { type: 'seed', id: 'orange_seed', count: 5 } },
                { id: 'eat_2', action: 'eat', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏Å‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 2, reward: { type: 'produce', id: 'fried_egg_food', count: 1 } },
                { id: 'place_animal_1', action: 'place_animal', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ß‡∏≤‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏Å 1 ‡∏ï‡∏±‡∏ß', target: 1, reward: { type: 'seed', id: 'strawberry_seed', count: 15 } },
                { id: 'buy_seed_15', action: 'buy_seed', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå 15 ‡∏ñ‡∏∏‡∏á', target: 15, reward: { type: 'seed', id: 'grape_seed', count: 5 } },
                { id: 'buy_fertilizer_5', action: 'buy_fertilizer', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏∏‡πã‡∏¢ 5 ‡∏ä‡∏¥‡πâ‡∏ô', target: 5, reward: { type: 'seed', id: 'peach_seed', count: 5 } },
                { id: 'spend_250', action: 'spend_money', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô 250üí∞', target: 250, reward: { type: 'produce', id: 'tomato_produce', count: 5 } },
                { id: 'water_20_more', action: 'water', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏° 20 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 20, reward: { type: 'item', id: 'fertilizer_1', count: 3 } },
                { id: 'buy_animal_1', action: 'buy_animal', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå 1 ‡∏ï‡∏±‡∏ß', target: 1, reward: { type: 'seed', id: 'strawberry_seed', count: 5 } },
            ],
            weekly: [
                { id: 'harvest_100', action: 'harvest', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï 100 ‡∏ä‡∏¥‡πâ‡∏ô', target: 100, reward: { type: 'item', id: 'fertilizer_2', count: 5 } },
                { id: 'fish_50', action: 'fish', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ 100 ‡∏ï‡∏±‡∏ß', target: 100, reward: { type: 'seed', id: 'random', count: 30 } },
                { id: 'fertilize_30', action: 'fertilize', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ 70 ‡πÅ‡∏õ‡∏•‡∏á', target: 70, reward: { type: 'seed', id: 'mango_seed', count: 25 } },
                { id: 'cook_10', action: 'cook', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 50 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', target: 50, reward: { type: 'produce', id: 'milk', count: 15 } },
                { id: 'collect_30', action: 'collect_product', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå 200 ‡∏ä‡∏¥‡πâ‡∏ô', target: 200, reward: { type: 'produce', id: 'gem', count: 1 } },
                { id: 'harvest_80_more', action: 'harvest', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏° 300 ‡∏ä‡∏¥‡πâ‡∏ô', target: 300, reward: { type: 'seed', id: 'apple_seed', count: 15 } },
                { id: 'plant_80', action: 'plant', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏∑‡∏ä 200 ‡∏ï‡πâ‡∏ô', target: 200, reward: { type: 'item', id: 'fertilizer_2', count: 8 } },
                { id: 'sell_item_100', action: 'sell_item', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡∏¢ 100 ‡∏ä‡∏¥‡πâ‡∏ô', target: 100, reward: { type: 'item', id: 'fertilizer_2', count: 15 } },
                { id: 'fish_40_more', action: 'fish', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏õ‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 100 ‡∏ï‡∏±‡∏ß', target: 100, reward: { type: 'produce', id: 'salmon', count: 20 } },
                { id: 'collect_25_more', action: 'collect_product', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏û‡∏¥‡πà‡∏° 250 ‡∏ä‡∏¥‡πâ‡∏ô', target: 250, reward: { type: 'produce', id: 'gem', count: 4 } },
                { id: 'cook_8_more', action: 'cook', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° 50 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', target: 50, reward: { type: 'seed', id: 'chili_seed', count: 15 } },
                { id: 'spend_3000', action: 'spend_money', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô 30000üí∞', target: 30000, reward: { type: 'seed', id: 'rice_seed', count: 25 } },
                { id: 'upgrade_house_1', action: 'upgrade_house', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ö‡πâ‡∏≤‡∏ô 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, reward: { type: 'produce', id: 'gem', count: 4 } },
                { id: 'upgrade_rod_1', action: 'upgrade_rod', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ö‡πá‡∏î‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, reward: { type: 'seed', id: 'mango_seed', count: 15 } },
                { id: 'fertilize_20_more', action: 'fertilize', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° 50 ‡πÅ‡∏õ‡∏•‡∏á', target: 50, reward: { type: 'seed', id: 'pineapple_seed', count: 20 } },
                { id: 'eat_15', action: 'eat', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏Å‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 100, reward: { type: 'seed', id: 'guava_seed', count: 15 } },
                { id: 'place_animal_3', action: 'place_animal', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ß‡∏≤‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏Å 3 ‡∏ï‡∏±‡∏ß', target: 3, reward: { type: 'seed', id: 'guava_seed', count: 15 } },
                { id: 'buy_animal_5', action: 'buy_animal', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå 5 ‡∏ï‡∏±‡∏ß', target: 5, reward: { type: 'item', id: 'fertilizer_2', count: 10 } },
                { id: 'sell_hq_10', action: 'sell_high_quality', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ä‡∏¥‡πâ‡∏ô', target: 10, reward: { type: 'seed', id: 'chili_seed', count: 15 } },
            ]
        };
        let userId = null;
        let farmState = null;
        let playerState = null;
        const playerNameEl = document.getElementById('player-name');
        
        // --- START PARK LOGIC ---
        const parkPresenceRef = collection(db, "publicFarmData", "farmState", "parkPresence");
        const parkCanvas = document.getElementById('park-canvas');
        const parkCtx = parkCanvas.getContext('2d');
        let parkPlayers = {};
        let playerImages = {};
        let animationFrameId;

        // --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡∏ß (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ---
        const CHARACTER_ASSETS = [
            'char1.png', 
            'char2.png', 
            'char3.png', 
            'char4.png',
            'char5.png',
			'char6.png', 
            'char7.png', 
            'char8.png', 
            'char9.png',
            'char10.png'
        ];

        let selectedCharacterIndex = 0;
		function renderWeather() {
            const container = document.getElementById('weather-display');
            if (!container || !farmState || !farmState.currentWeather) return;

            const weather = WEATHER_DATA[farmState.currentWeather];
            if (!weather) {
                container.innerHTML = `<span>-</span><span>-</span>`;
                return;
            }

            container.innerHTML = `<span class="text-xl">${weather.icon}</span> <span class="font-bold text-blue-900">${weather.name}</span>`;
            container.title = weather.description;
        }
        function initParkSystem() {
            setupCharacterCreatorControls();
            listenForParkPlayers();
        }
        async function enterPark(userId, playerState) {
            if (playerState.avatar === undefined || playerState.avatar === null) {
                showCharacterCreator();
                return;
            }
            await setDoc(doc(parkPresenceRef, userId), {
                avatar: playerState.avatar,
                nickname: playerState.nickname,
                lastSeen: Date.now()
            });
            startParkAnimation();
        }
        async function leavePark(userId) {
            await deleteDoc(doc(parkPresenceRef, userId));
            stopParkAnimation();
            parkPlayers = {};
        }
        function showCharacterCreator() {
            document.getElementById('character-creator-modal').classList.remove('hidden');
            updateCharacterPreview();
        }
        function hideCharacterCreator() {
            document.getElementById('character-creator-modal').classList.add('hidden');
        }
        function updateCharacterPreview() {
            document.getElementById('character-preview').style.backgroundImage = `url(${CHARACTER_ASSETS[selectedCharacterIndex]})`;
        }
        function setupCharacterCreatorControls() {
            document.getElementById('save-character-btn').onclick = async () => {
                const userId = auth.currentUser.uid;
                if (!userId) return;
                
                const playerDocRef = doc(db, "players", userId);
                await setDoc(playerDocRef, { avatar: selectedCharacterIndex }, { merge: true });
                
                hideCharacterCreator();
                const playerDoc = await getDoc(playerDocRef);
                playerState = playerDoc.data(); // Update local player state immediately
                enterPark(userId, playerState);
            };
            document.getElementById(`prev-character`).onclick = () => {
                selectedCharacterIndex = (selectedCharacterIndex - 1 + CHARACTER_ASSETS.length) % CHARACTER_ASSETS.length;
                updateCharacterPreview();
            };
            document.getElementById(`next-character`).onclick = () => {
                selectedCharacterIndex = (selectedCharacterIndex + 1) % CHARACTER_ASSETS.length;
                updateCharacterPreview();
            };
        }
        function preloadPlayerImages(player) {
            if (player.avatar === undefined) return;
            const userId = player.uid;
            const img = new Image();
            img.src = CHARACTER_ASSETS[player.avatar];
            playerImages[userId] = img;
        }
        function listenForParkPlayers() {
            onSnapshot(parkPresenceRef, (snapshot) => {
                const currentActivePlayers = new Set();
                snapshot.docs.forEach(doc => {
                    const playerData = doc.data();
                    const userId = doc.id;
                    currentActivePlayers.add(userId);
                    
                    if (parkPlayers[userId]) {
                        parkPlayers[userId] = { ...parkPlayers[userId], ...playerData };
                    } else {
                        parkPlayers[userId] = {
                            uid: userId,
                            x: Math.random() * (parkCanvas.width - 64),
                            y: parkCanvas.height - 128,
                            direction: Math.random() < 0.5 ? 1 : -1,
                            speed: 0.5 + Math.random() * 0.5,
                            ...playerData
                        };
                        preloadPlayerImages(parkPlayers[userId]);
                    }
                });
                Object.keys(parkPlayers).forEach(uid => {
                    if (!currentActivePlayers.has(uid)) {
                        delete parkPlayers[uid];
                        delete playerImages[uid];
                    }
                });
            });
        }
        function startParkAnimation() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            function gameLoop() {
                parkCtx.clearRect(0, 0, parkCanvas.width, parkCanvas.height);
                Object.values(parkPlayers).forEach(player => {
                    player.x += player.speed * player.direction;
                    if (player.x <= 0 || player.x >= parkCanvas.width - 64) {
                        player.direction *= -1;
                    }
                    drawPlayer(player);
                });
                animationFrameId = requestAnimationFrame(gameLoop);
            }
            gameLoop();
        }
        function stopParkAnimation() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                parkCtx.clearRect(0, 0, parkCanvas.width, parkCanvas.height);
            }
        }
        function drawPlayer(player) {
            const image = playerImages[player.uid];
            if (!image || !image.complete) return;
            const drawWidth = 64;
            const drawHeight = 128;
            parkCtx.drawImage(image, player.x, player.y, drawWidth, drawHeight);
            
            parkCtx.fillStyle = 'white';
            parkCtx.strokeStyle = 'black';
            parkCtx.lineWidth = 2;
            parkCtx.font = '14px "IBM Plex Sans Thai"';
            parkCtx.textAlign = 'center';
            parkCtx.strokeText(player.nickname, player.x + drawWidth / 2, player.y - 5);
            parkCtx.fillText(player.nickname, player.x + drawWidth / 2, player.y - 5);
        }
        // --- END PARK LOGIC ---


        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            let parts = [];
            if (h > 0) parts.push(`${h} ‡∏ä‡∏°.`);
            if (m > 0) parts.push(`${m} ‡∏ô‡∏≤‡∏ó‡∏µ`);
            if (s > 0 || parts.length === 0) parts.push(`${s} ‡∏ß‡∏¥`);
            return parts.join(' ');
        }
        
		function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return [d.getUTCFullYear(), weekNo];
        }
		
        async function updateFarmState(newState) {
             if (!userId) return;
             farmState = newState;
             const farmDocRef = doc(db, "publicFarmData", "farmState");
             await setDoc(farmDocRef, newState, { merge: true });
        }
        async function updatePlayerState(newState) {
             if (!userId) return;
             playerState = newState;
             const playerDocRef = doc(db, "players", userId);
             await setDoc(playerDocRef, newState, { merge: true });
        }
        
        function deductEnergy(amount) {
            if (!playerState || (playerState.energy || 0) < amount) {
                console.log("‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!"); 
                return false;
            }
            const newPlayerState = { ...playerState };
            newPlayerState.energy -= amount;
            
            document.getElementById('energy-bar').style.width = `${(newPlayerState.energy / getMaxEnergy()) * 100}%`;
            document.getElementById('energy-text').textContent = `${newPlayerState.energy} / ${getMaxEnergy()}`;

            updatePlayerState(newPlayerState);
            return true;
        }

        function getMaxEnergy() {
            if (!playerState || !farmState) return 100;
            const baseEnergy = 100;
            const bonusPerLevel = 15;
            const houseBonus = ((farmState.sharedHouseLevel || 0) > 0 ? (farmState.sharedHouseLevel - 1) : 0) * bonusPerLevel;
            return baseEnergy + houseBonus;
        }

        function renderEnergy() {
            if (!playerState) return;
            const maxEnergy = getMaxEnergy();
            const currentEnergy = playerState.energy || 0;
            const energyBar = document.getElementById('energy-bar');
            const energyText = document.getElementById('energy-text');

            if (energyBar) energyBar.style.width = `${(currentEnergy / maxEnergy) * 100}%`;
            if (energyText) energyText.textContent = `${currentEnergy} / ${maxEnergy}`;
        }

        function renderAll() {
            if (!farmState || !playerState) return; 
            renderWeather();
			renderEnergy();
            renderFarm();
            renderAnimals();
            renderFactory();
            renderBedroom();
            renderPlayerUI();
            renderShop();
            renderSellBox();
            renderStorage();
            renderFishing();
            renderQuests();
            renderKitchen();
            renderMarket();
            renderParkActions();
        }
        
        function renderMarket() {
            if (!farmState) return;
            const container = document.getElementById('market-items-list');
            if (!container) return;
            container.innerHTML = '';
            
            const sellableItems = Object.entries(GAME_DATA).filter(([_, data]) => data.type === 'produce' && data.sellPrice);
            
            sellableItems.forEach(([id, data]) => {
                const basePrice = data.sellPrice[0];
                const currentPrice = farmState.marketPrices[id] || basePrice;
                
                let statusIcon = '<span class="font-bold w-6 text-center">-</span>';
                if (currentPrice > basePrice) {
                    statusIcon = '<span class="font-bold w-6 text-center text-green-600">‚ñ≤</span>';
                } else if (currentPrice < basePrice) {
                    statusIcon = '<span class="font-bold w-6 text-center text-red-600">‚ñº</span>';
                }

                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between p-2 bg-white/70 rounded-md';
                
                const iconHTML = data.imageUrl ? `<img src="${data.imageUrl}" class="w-8 h-8 object-contain">` : `<span>${data.icon}</span>`;

                itemEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        ${iconHTML}
                        <span class="font-semibold">${data.name}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        ${statusIcon}
                        <span class="font-bold text-right w-20">${currentPrice}üí∞</span>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        function calculateExpansionCost(type) {
            const baseCost = { farm: 250, animals: 500, factory: 1000 };
            const perSlotCost = { farm: 150, animals: 400, factory: 1200 };
            const initialSize = { farm: FARM_GRID_SIZE, animals: ANIMAL_PEN_SIZE, factory: FACTORY_GRID_SIZE };
            const currentSize = {
                farm: farmState.plots.length,
                animals: farmState.animals.length,
                factory: farmState.factories.length
            };
            const addedSlots = Math.max(0, currentSize[type] - initialSize[type]);
            return baseCost[type] + (addedSlots * perSlotCost[type]);
        }

        function renderFarm() {
            if (!farmState || !Array.isArray(farmState.plots)) return;
            const farmGrid = document.getElementById('farm-grid');
            farmGrid.innerHTML = '';

            const weatherMultiplier = WEATHER_DATA[farmState.currentWeather]?.cropMultiplier || 1;

            farmState.plots.forEach((plot, index) => {
                const plotEl = document.createElement('div');
                plotEl.className = 'plot aspect-square rounded-lg shadow-inner cursor-pointer flex items-center justify-center text-3xl relative';
                plotEl.style.backgroundColor = 'rgba(139, 69, 19, 0.4)';
                
                if (plot.plantId) {
                    const plantData = GAME_DATA[plot.plantId];
                    if (!plantData) {
                        plotEl.innerHTML = `‚ùì`;
                    } else {
                        let progress = 0;
                        if (plot.plantTime) { 
                            const elapsedSeconds = (Date.now() - plot.plantTime) / 1000;
                            const growthMultiplier = 1 + ((plot.wateredBy?.length || 0) * 0.5);
                            const effectiveGrowth = elapsedSeconds * growthMultiplier;
                            const adjustedGrowTime = plantData.growTime * weatherMultiplier;
                            progress = Math.min(effectiveGrowth / adjustedGrowTime, 1);
                        }

                        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥ ---
                        const isNotGrown = progress < 1;
                        const notWateredByMe = !plot.wateredBy?.some(p => p.uid === userId);

                        if (isNotGrown && notWateredByMe) {
                            const waterIcon = document.createElement('div');
                            waterIcon.className = 'water-indicator';
                            waterIcon.textContent = 'üíß';
                            plotEl.appendChild(waterIcon);
                        }
                        // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ---

                        plotEl.style.backgroundImage = `linear-gradient(to top, rgba(96, 165, 250, 0.5) 0%, rgba(96, 165, 250, 0.5) ${progress*100}%, transparent ${progress*100}%)`;
                        const content = document.createElement('div');
                        content.style.backgroundImage = `url(${plantData.imageUrl})`;
                        content.style.opacity = 0.5 + (progress * 0.5);
                        content.className = 'w-full h-full bg-contain bg-no-repeat bg-center';
                        plotEl.appendChild(content);
                    }
                }
                plotEl.onclick = () => showContextMenu('plot', index);
                farmGrid.appendChild(plotEl);
            });
            
            const cost = calculateExpansionCost('farm');
            const expandButton = document.createElement('div');
            expandButton.className = 'aspect-square rounded-lg shadow-inner cursor-pointer flex items-center justify-center p-2 bg-green-200/50 hover:bg-green-200/80 transition';
            expandButton.innerHTML = `
                <div class="text-center">
                    <span class="text-3xl font-bold text-green-800">‚ûï</span>
                    <p class="text-xs font-semibold mt-1">‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏õ‡∏•‡∏á</p>
                    <p class="text-xs font-bold text-yellow-900 bg-yellow-300 px-2 py-0.5 rounded-full mt-1">${cost}üí∞</p>
                </div>
            `;
            expandButton.onclick = () => expandGrid('farm');
            farmGrid.appendChild(expandButton);
        }
        function renderAnimals() {
             if (!farmState || !Array.isArray(farmState.animals)) return;
             const animalPen = document.getElementById('animal-pen');
             animalPen.innerHTML = '';
             const weatherMultiplier = WEATHER_DATA[farmState.currentWeather]?.animalMultiplier || 1;
             
             farmState.animals.forEach((animal, index) => {
                const slotEl = document.createElement('div');
                slotEl.className = 'animal-slot aspect-square rounded-2xl shadow-inner cursor-pointer flex flex-col items-center justify-center p-1 bg-green-200/50 relative';
                
                if (animal.animalId) {
                    const animalData = GAME_DATA[animal.animalId];
                    slotEl.style.backgroundImage = `url(${animalData.imageUrl})`;

                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'absolute bottom-1 left-1 right-1 h-2 bg-gray-300/70 rounded-full overflow-hidden';
                    const progressFill = document.createElement('div');
                    const adjustedProduceTime = (animalData.produceTime * 1000) * weatherMultiplier;
                    const progress = (Date.now() - animal.startTime) / adjustedProduceTime;

                    progressFill.className = 'h-full bg-yellow-400 rounded-full';
                    progressFill.style.width = `${Math.min(progress, 1) * 100}%`;
                    progressContainer.appendChild(progressFill);
                    slotEl.appendChild(progressContainer);

                    if (progress >= 1) {
                        slotEl.classList.add('animate-bounce');
                        const produceData = GAME_DATA[animalData.produceId];
                        const produceIcon = document.createElement('div');
                        produceIcon.className = 'absolute top-1 right-1 text-2xl z-10';
                        produceIcon.textContent = produceData.icon;
                        slotEl.appendChild(produceIcon);
                    }
                } else {
                    slotEl.textContent = '‚ûï';
                    slotEl.className += ' text-4xl text-gray-400 hover:bg-green-200/70';
                }
                slotEl.onclick = () => showContextMenu('animal', index);
                animalPen.appendChild(slotEl);
             });
             
            const cost = calculateExpansionCost('animals');
            const expandButton = document.createElement('div');
            expandButton.className = 'aspect-square rounded-2xl shadow-inner cursor-pointer flex items-center justify-center p-2 bg-green-200/50 hover:bg-green-200/80 transition';
            expandButton.innerHTML = `
                <div class="text-center">
                    <span class="text-3xl font-bold text-green-800">‚ûï</span>
                    <p class="text-xs font-semibold mt-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏Å</p>
                    <p class="text-xs font-bold text-yellow-900 bg-yellow-300 px-2 py-0.5 rounded-full mt-1">${cost}üí∞</p>
                </div>
            `;
            expandButton.onclick = () => expandGrid('animals');
            animalPen.appendChild(expandButton);
        }

		function renderFactory() {
			if (!farmState || !Array.isArray(farmState.factories)) return;
			const factoryGrid = document.getElementById('factory-grid');
			factoryGrid.innerHTML = '';

			farmState.factories.forEach((factory, index) => {
				const slotEl = document.createElement('div');
				slotEl.className = 'factory-slot aspect-square rounded-2xl shadow-inner cursor-pointer flex flex-col items-center justify-center p-1 bg-gray-300/50 relative';

				if (factory.factoryId) {
					const factoryData = GAME_DATA[factory.factoryId];
					slotEl.style.backgroundImage = `url(${factoryData.imageUrl})`;

					// --- NEW UI LOGIC ---
					// ‡πÅ‡∏™‡∏î‡∏á progress bar ‡∏Ç‡∏≠‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï
					if (factory.queue && factory.queue.length > 0 && factory.queue[0].startTime) {
						const currentJob = factory.queue[0];
						const recipe = factoryData.recipes.find(r => r.id === currentJob.recipeId);
						const progress = (Date.now() - currentJob.startTime) / (recipe.processTime * 1000);

						const progressContainer = document.createElement('div');
						progressContainer.className = 'absolute bottom-1 left-1 right-1 h-2 bg-gray-800/70 rounded-full overflow-hidden';
						const progressFill = document.createElement('div');
						progressFill.className = 'h-full bg-green-400 rounded-full';
						progressFill.style.width = `${Math.min(progress, 1) * 100}%`;
						progressContainer.appendChild(progressFill);
						slotEl.appendChild(progressContainer);
					}

					// ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô "‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á" ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á
					const myItemsInBin = factory.outputBin?.filter(item => item.owner === userId).length || 0;
					if (myItemsInBin > 0) {
						const binIcon = document.createElement('div');
						binIcon.className = 'absolute top-1 right-1 text-xs font-bold bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center animate-bounce';
						binIcon.textContent = myItemsInBin;
						slotEl.appendChild(binIcon);
					}
					// --- END OF NEW UI LOGIC ---

				} else {
					slotEl.textContent = '‚ûï';
					slotEl.className += ' text-4xl text-gray-500 hover:bg-gray-400/50';
				}
				slotEl.onclick = () => showContextMenu('factory', index);
				factoryGrid.appendChild(slotEl);
			});

			// ... ‡πÇ‡∏Ñ‡πâ‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
			const cost = calculateExpansionCost('factory');
			const expandButton = document.createElement('div');
			expandButton.className = 'aspect-square rounded-2xl shadow-inner cursor-pointer flex items-center justify-center p-2 bg-gray-300/50 hover:bg-gray-400/50 transition';
			expandButton.innerHTML = `
				<div class="text-center">
					<span class="text-3xl font-bold text-gray-700">‚ûï</span>
					<p class="text-xs font-semibold mt-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</p>
					<p class="text-xs font-bold text-yellow-900 bg-yellow-300 px-2 py-0.5 rounded-full mt-1">${cost}üí∞</p>
				</div>
			`;
			expandButton.onclick = () => expandGrid('factory');
			factoryGrid.appendChild(expandButton);
		}

        function renderPlayerUI() {
            if (!playerState) return;
            playerNameEl.textContent = playerState.nickname;
            document.getElementById('money-display').textContent = playerState.money || 0;
            const inventoryDisplay = document.getElementById('inventory-display');
            inventoryDisplay.innerHTML = '';
            Object.entries(playerState.inventory).forEach(([itemId, count]) => {
                if (count > 0) {
                    const itemData = GAME_DATA[itemId];
                    if (itemData) {
                        const itemEl = document.createElement('span');
                        itemEl.className = 'bg-white px-2 py-1 rounded-md shadow-sm flex items-center gap-1';
                        const iconHTML = itemData.imageUrl 
                            ? `<img src="${itemData.imageUrl}" class="w-5 h-5 object-contain">`
                            : `<span>${itemData.icon}</span>`;
                        itemEl.innerHTML = `${iconHTML} ${count}`;
                        inventoryDisplay.appendChild(itemEl);
                    }
                }
            });
            
            document.getElementById('user-id-display').textContent = `ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${userId}`;
            
            // --- START CORRECTION ---
            const adminResetBtn = document.getElementById('admin-reset-btn');
            const adminSellBtn = document.getElementById('admin-force-sell-btn'); // ‡∏î‡∏∂‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡πà‡∏≠‡∏ô
            
            if (userId === ADMIN_UID) {
                if (adminResetBtn) adminResetBtn.classList.remove('hidden');
                if (adminSellBtn) adminSellBtn.classList.remove('hidden');
            } else {
                if (adminResetBtn) adminResetBtn.classList.add('hidden');
                if (adminSellBtn) adminSellBtn.classList.add('hidden');
            }
            // --- END CORRECTION ---
        }

        function renderShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            ['seed', 'item', 'animal_deed', 'kitchen_tool', 'factory_deed'].forEach(category => {
                const itemsInCategory = Object.entries(GAME_DATA).filter(([_, data]) => data.type === category);
                if (itemsInCategory.length === 0) return;

                const categoryEl = document.createElement('div');
                const title = {
                    seed:'‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', 
                    item:'‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°', 
                    animal_deed:'‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á', 
                    kitchen_tool: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏£‡∏±‡∏ß',
                    factory_deed: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô'
                }[category];
                categoryEl.innerHTML = `<h3 class="text-xl font-bold text-green-700 mb-2">${title}</h3>`;
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-2';

                itemsInCategory.forEach(([id, data]) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-white/80 p-3 rounded-xl shadow-md flex flex-col items-center gap-2';
                    
                    const iconContainer = document.createElement('div');
                    iconContainer.className = 'text-3xl h-12 w-12 flex items-center justify-center';
                    if (data.imageUrl) {
                        iconContainer.innerHTML = `<img src="${data.imageUrl}" class="w-full h-full object-contain">`;
                    } else {
                        iconContainer.textContent = data.icon;
                    }

                    let buttonText = `‡∏ã‡∏∑‡πâ‡∏≠ ${data.cost}üí∞`;
                    let isDisabled = false;

                    if (data.type === 'kitchen_tool' && farmState.ownedKitchenTools?.includes(id)) {
                        buttonText = '‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß';
                        isDisabled = true;
                    }

                    itemEl.innerHTML = `
                        <div class="font-semibold text-center text-sm">${data.name}</div>
                        <button data-itemid="${id}" class="buy-btn bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-1 px-4 rounded-full w-full ${isDisabled ? 'bg-gray-400 text-gray-600 cursor-not-allowed hover:bg-gray-400' : ''}" ${isDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    `;
                    itemEl.prepend(iconContainer);
                    grid.appendChild(itemEl);
                });
                categoryEl.appendChild(grid);
                shopItems.appendChild(categoryEl);
            });
        }

        function renderSellBox() {
            const itemsEl = document.getElementById('sell-box-items');
            const totalEl = document.getElementById('sell-box-total');
            const countdownEl = document.getElementById('sell-countdown');
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            const timeRemaining = tomorrow.getTime() - now.getTime();
            countdownEl.textContent = `‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${formatTime(Math.floor(timeRemaining / 1000))}`;
            
            if (!playerState || !playerState.produceBin || playerState.produceBin.length === 0) {
                itemsEl.innerHTML = `<p class="text-center text-yellow-700">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</p>`;
                totalEl.textContent = '0';
                return;
            }

            itemsEl.innerHTML = '';
            let totalValue = 0;
            const groupedProduce = playerState.produceBin.reduce((acc, item) => {
                const key = `${item.id}_q${item.quality}`;
                if (!acc[key]) { acc[key] = { ...item, count: 0 }; }
                acc[key].count++;
                return acc;
            }, {});

            Object.values(groupedProduce).forEach(item => {
                const itemData = GAME_DATA[item.id];
                if (!itemData || !itemData.sellPrice) return;
				
                const marketBasePrice = farmState.marketPrices[item.id] || itemData.sellPrice[0];
                const qualityRatio = itemData.sellPrice[item.quality] / itemData.sellPrice[0];
                const finalSellPrice = Math.round(marketBasePrice * qualityRatio);
                totalValue += finalSellPrice * item.count;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white/50 p-2 rounded';
                const iconHTML = itemData.imageUrl 
                    ? `<div class="w-8 h-8 mr-2 bg-contain bg-no-repeat bg-center" style="background-image: url('${itemData.imageUrl}')"></div>`
                    : `<span class="text-lg">${itemData.icon}</span>`;
                itemDiv.innerHTML = `
                    <div class="flex items-center">
                        ${iconHTML}
                        <span>${itemData.name}</span>
                        <span class="quality-star ml-1">${'‚òÖ'.repeat(item.quality)}</span>
                        <span class="text-gray-600 text-sm ml-2">x${item.count}</span>
                    </div>
                    <span class="font-semibold">${finalSellPrice * item.count}üí∞</span>
                `;
                itemsEl.appendChild(itemDiv);
            });
            totalEl.textContent = totalValue;
        }
        
		function renderBedroom() {
			if (!playerState || !farmState) return;
			const container = document.getElementById('bedroom-display');
			const infoP = document.getElementById('bedroom-info').querySelector('p');
			const upgradeBtn = document.getElementById('upgrade-house-btn');
			const napBtn = document.getElementById('nap-btn');
			const napInfo = document.getElementById('nap-info');

			const houseLevel = farmState.sharedHouseLevel || 0;

			// Logic ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
			if (houseLevel === 0) {
				container.style.backgroundImage = 'none';
				container.style.backgroundColor = '#D2B48C';
				infoP.innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô`;
				const firstPurchaseData = GAME_DATA.house_upgrades[0];
				upgradeBtn.textContent = `‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô (${firstPurchaseData.cost}üí∞)`;
				upgradeBtn.disabled = playerState.money < firstPurchaseData.cost;
			} else {
				container.style.backgroundColor = 'transparent';
				const houseData = GAME_DATA.house_upgrades[houseLevel - 1];
				container.style.backgroundImage = `url(${houseData.imageUrl})`;
				infoP.innerHTML = `‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö <span id="house-level" class="font-bold">${houseLevel}</span>`;
				if (houseLevel >= GAME_DATA.house_upgrades.length) {
					upgradeBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß';
					upgradeBtn.disabled = true;
				} else {
					const nextUpgradeData = GAME_DATA.house_upgrades[houseLevel];
					upgradeBtn.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (${nextUpgradeData.cost}üí∞)`;
					upgradeBtn.disabled = playerState.money < nextUpgradeData.cost;
				}
			}

			// --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏á‡∏µ‡∏ö‡∏´‡∏•‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ---
			if (houseLevel === 0) {
				napBtn.classList.add('hidden');
				napInfo.classList.add('hidden');
			} else {
				napBtn.classList.remove('hidden');
				napInfo.classList.remove('hidden');

				const napsToday = playerState.dailyNapCount || 0;
				const timeSinceNap = Date.now() - (playerState.lastNapTime || 0);
				const cooldownDuration = 60 * 60 * 1000; // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
				const remainingCooldown = cooldownDuration - timeSinceNap;
				const isEnergyFull = playerState.energy >= getMaxEnergy();

				if (napsToday >= 5) {
					napBtn.disabled = true;
					napInfo.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏á‡∏µ‡∏ö‡∏´‡∏•‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß`;
				} else if (remainingCooldown > 0) {
					napBtn.disabled = true;
					napInfo.textContent = `‡∏á‡∏µ‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô ${formatTime(Math.ceil(remainingCooldown / 1000))}`;
				} else if (isEnergyFull) {
					napBtn.disabled = true;
					napInfo.textContent = `‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏á‡∏µ‡∏ö`;
				} else {
					const energyToRestore = 20 + ((houseLevel - 1) * 10);
					napBtn.disabled = false;
					napInfo.textContent = `‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π ${energyToRestore}‚ö° (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${5 - napsToday}/5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;
				}
			}
		}        
        function renderStorage() {
            const container = document.getElementById('storage-items');
            if (!playerState || !playerState.storageBin || playerState.storageBin.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>`;
                return;
            }

            container.innerHTML = '';
            const groupedStorage = playerState.storageBin.reduce((acc, item) => {
                const key = `${item.id}_q${item.quality}`;
                if (!acc[key]) {
                    acc[key] = { ...item, count: 0 };
                }
                acc[key].count++;
                return acc;
            }, {});

            Object.values(groupedStorage).forEach(item => {
                const itemData = GAME_DATA[item.id];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white/80 p-2 rounded-lg gap-2';
                let buttonsHTML = `<button class="sell-storage-btn bg-green-500 text-white font-bold py-1 px-3 rounded-full hover:bg-green-600 text-xs" data-item-id="${item.id}" data-quality="${item.quality}" data-max="${item.count}">‡∏Ç‡∏≤‡∏¢</button>`;
                if (itemData.energyRestore > 0) {
                    buttonsHTML += `<button class="eat-storage-btn bg-blue-500 text-white font-bold py-1 px-3 rounded-full hover:bg-blue-600 text-xs" data-item-id="${item.id}" data-quality="${item.quality}">‡∏Å‡∏¥‡∏ô (+${itemData.energyRestore}‚ö°)</button>`;
                }
				
				if (itemData.type === 'item' || itemData.type === 'factory_deed' || itemData.type === 'animal_deed') {
                     buttonsHTML += `<button class="move-to-inventory-btn bg-purple-500 text-white font-bold py-1 px-3 rounded-full hover:bg-purple-600 text-xs" data-item-id="${item.id}" data-quality="${item.quality}" data-max="${item.count}">‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß</button>`;
                }
                
                const iconHTML = itemData.imageUrl 
                    ? `<div class="w-10 h-10 mr-2 bg-contain bg-no-repeat bg-center" style="background-image: url('${itemData.imageUrl}')"></div>`
                    : `<span class="text-2xl">${itemData.icon}</span>`;

                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î ---
                let priceHTML = '';
                if (itemData && itemData.sellPrice) {
                    const basePriceForQuality = itemData.sellPrice[item.quality];
                    const basePriceForNormal = itemData.sellPrice[0];
                    
                    const marketBasePrice = farmState.marketPrices[item.id] || basePriceForNormal;
                    const qualityRatio = basePriceForQuality / basePriceForNormal;
                    const finalMarketPrice = Math.round(marketBasePrice * qualityRatio);

                    let priceColorClass = 'text-yellow-700'; // ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥
                    if (finalMarketPrice > basePriceForQuality) {
                        priceColorClass = 'text-green-600'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô
                    } else if (finalMarketPrice < basePriceForQuality) {
                        priceColorClass = 'text-red-600'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ñ‡πâ‡∏≤‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏Å
                    }
                    priceHTML = `<p class="text-xs ${priceColorClass} font-semibold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î: ${finalMarketPrice}üí∞</p>`;
                }
                // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

                itemDiv.innerHTML = `
                    <div class="flex-grow flex items-center">
                        ${iconHTML}
                        <div>
                            <span>${itemData.name}</span>
                            <span class="quality-star">${'‚òÖ'.repeat(item.quality)}</span>
                            <span class="text-gray-600 text-sm ml-2">x${item.count}</span>
                            ${priceHTML}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        ${buttonsHTML}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function renderFishing() {
            if (!playerState || !farmState) return;
            const fishBtn = document.getElementById('fish-btn');
            const rodImage = document.getElementById('rod-image');
            const rodLevelText = document.getElementById('rod-level-text');
            const upgradeRodBtn = document.getElementById('upgrade-rod-btn');

            fishBtn.disabled = (playerState.energy || 0) < 8;

            const rodLevel = farmState.sharedRodLevel || 0;
            const rodData = GAME_DATA.fishing_rods[rodLevel];
            rodImage.style.backgroundImage = `url(${rodData.imageUrl})`;
            rodLevelText.textContent = `${rodData.name} (Lv. ${rodLevel + 1})`;
            
            if (rodLevel >= GAME_DATA.fishing_rods.length - 1) {
                upgradeRodBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î';
                upgradeRodBtn.disabled = true;
            } else {
                const nextRodData = GAME_DATA.fishing_rods[rodLevel + 1];
                upgradeRodBtn.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (${nextRodData.cost}üí∞)`;
                upgradeRodBtn.disabled = playerState.money < nextRodData.cost;
            }
        }

        function renderQuests() {
            if (!farmState || !farmState.quests) return;

            const renderList = (type, containerId) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                const quests = farmState.quests[type];

                if (!quests || quests.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏ß‡∏™‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>`;
                    return;
                }
                
                quests.forEach(questProgress => {
                    const questData = QUEST_DATA[type].find(q => q.id === questProgress.id);
                    if (!questData) return;

                    const isComplete = questProgress.progress >= questData.target;
                    const hasClaimed = questProgress.claimedBy?.includes(userId);
                    
                    const questEl = document.createElement('div');
                    questEl.className = 'bg-white/70 p-3 rounded-lg flex items-center gap-3';

                    let claimButtonHTML = '';
                    if (isComplete) {
                        if (hasClaimed) {
                            claimButtonHTML = `<button class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>`;
                        } else {
                            claimButtonHTML = `<button class="claim-quest-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm" data-quest-type="${type}" data-quest-id="${questProgress.id}">‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>`;
                        }
                    } else {
                        claimButtonHTML = `<button class="bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg text-sm" disabled>${questProgress.progress}/${questData.target}</button>`;
                    }

                    const rewardData = questData.reward;
                    let rewardItemData;
                    if (rewardData.id === 'random') {
                       rewardItemData = { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏∏‡πà‡∏°', icon: '‚ùì' };
                    } else {
                       rewardItemData = GAME_DATA[rewardData.id];
                    }
                    const rewardIcon = rewardItemData.imageUrl ? `<img src="${rewardItemData.imageUrl}" class="w-6 h-6 object-contain inline-block">` : rewardItemData.icon;

                    questEl.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${questData.description}</p>
                            <p class="text-xs text-gray-600">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${rewardIcon} ${rewardItemData.name} x${rewardData.count}</p>
                        </div>
                        <div class="flex-shrink-0">
                            ${claimButtonHTML}
                        </div>
                    `;
                    container.appendChild(questEl);
                });
            };

            renderList('daily', 'daily-quests-list');
            renderList('weekly', 'weekly-quests-list');
        }

        function renderKitchen() {
            if (!farmState || !farmState.kitchen || !farmState.kitchen.queue) return;
            const container = document.getElementById('cooking-queue-list');
            container.innerHTML = '';

            if (farmState.kitchen.queue.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà</p>`;
                return;
            }

            farmState.kitchen.queue.forEach((job, index) => {
                const recipeData = GAME_DATA.recipes[job.recipeId];
                const resultData = GAME_DATA[recipeData.resultId];
                const COOK_TIME_PER_ITEM = 600;
                const totalCookTime = job.quantity * COOK_TIME_PER_ITEM * 1000;
                const elapsed = Date.now() - job.startTime;
                const progress = Math.min(elapsed / totalCookTime, 1);
                const remainingSeconds = Math.max(0, (totalCookTime - elapsed) / 1000);

                const jobEl = document.createElement('div');
                jobEl.className = 'bg-white/80 p-3 rounded-lg flex items-center gap-3';

                const iconHTML = `<div class="w-12 h-12 flex-shrink-0 bg-contain bg-no-repeat bg-center" style="background-image: url('${resultData.imageUrl}')"></div>`;
                const detailsHTML = `
                    <div class="flex-grow">
                        <p class="font-bold">${resultData.name} x${job.quantity}</p>
                        <p class="text-xs text-gray-500">‡πÇ‡∏î‡∏¢: ${job.cookedBy?.nickname || '??'}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                          <div class="bg-orange-500 h-2.5 rounded-full" style="width: ${progress * 100}%"></div>
                        </div>
                    </div>
                `;
                
                const actionContainer = document.createElement('div');
                actionContainer.className = 'flex-shrink-0 w-20 text-center';

                if (progress >= 1) {
                    const collectButton = document.createElement('button');
                    collectButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm';
                    collectButton.textContent = '‡∏£‡∏±‡∏ö';
                    collectButton.onclick = () => {
                        collectCookedFood(index);
                    };
                    actionContainer.appendChild(collectButton);
                } else {
                    actionContainer.innerHTML = `<div class="text-sm font-semibold">${formatTime(remainingSeconds)}</div>`;
                }
                
                jobEl.innerHTML = iconHTML + detailsHTML;
                jobEl.appendChild(actionContainer);
                container.appendChild(jobEl);
            });
        }
        
        function renderParkActions() {
            const button = document.getElementById('rest-btn');
            const infoEl = document.getElementById('rest-info');
            if (!button || !infoEl || !playerState) return;

            const numPlayers = Object.keys(parkPlayers).length;
            const restsToday = playerState.dailyRestCount || 0;
            const cooldownDuration = 5 * 60 * 1000;
            const timeSinceRest = Date.now() - (playerState.lastRestTime || 0);

            if (numPlayers < 2) {
                button.disabled = true;
                infoEl.textContent = `‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏Ñ‡∏ô ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ`;
            } else if (restsToday >= 5) {
                button.disabled = true;
                infoEl.textContent = `‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß`;
            } else if (timeSinceRest < cooldownDuration) {
                button.disabled = true;
                const remainingCooldown = cooldownDuration - timeSinceRest;
                infoEl.textContent = `‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô ${formatTime(Math.ceil(remainingCooldown / 1000))}`;
            } else {
                button.disabled = false;
                infoEl.textContent = `‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π 20‚ö° (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${5 - restsToday}/5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)`;
            }
        }
        
		async function showContextMenu(type, id) {
            // This function had a misplaced closing brace in the previous version.
            // This is the fully corrected version.
            const modal = document.getElementById('context-modal');
            const contentEl = document.getElementById('context-modal-content');
            const titleEl = document.getElementById('context-modal-title');
            const actionsEl = document.getElementById('context-modal-actions');
            actionsEl.innerHTML = '';
            contentEl.querySelectorAll('.context-details').forEach(el => el.remove());
            const detailsEl = document.createElement('div');
            detailsEl.className = 'context-details text-sm text-gray-600 mb-4 border-t pt-4 mt-4';

            const createButton = (text, action, disabled = false, extraClasses = 'bg-green-500 hover:bg-green-600 text-white') => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `w-full font-bold py-2 px-4 rounded-lg transition ${disabled ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : extraClasses}`;
                if (!disabled) button.onclick = () => { action(); hideContextMenu(); };
                return button;
            };

            if (type === 'plot') {
                const index = id;
                const plot = farmState.plots[index];
                titleEl.textContent = `‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà ${index + 1}`;
                if (!plot.plantId) {
                     const plantableItems = Object.keys(playerState.inventory).filter(id => GAME_DATA[id] && GAME_DATA[id].type === 'seed' && playerState.inventory[id] > 0);
                     actionsEl.appendChild(createButton('üå± ‡∏õ‡∏•‡∏π‡∏Å', () => showSubMenu('plant', index, plantableItems), plantableItems.length === 0));
                } else {
                    const weatherMultiplier = WEATHER_DATA[farmState.currentWeather]?.cropMultiplier || 1;
					const plantData = GAME_DATA[plot.plantId];
                    const elapsedSeconds = (Date.now() - plot.plantTime) / 1000;
                    const growthMultiplier = 1 + ((plot.wateredBy?.length || 0) * 0.5);
                    const effectiveGrowth = elapsedSeconds * growthMultiplier;
                    const adjustedGrowTime = plantData.growTime * weatherMultiplier;
                    const isGrown = effectiveGrowth >= adjustedGrowTime;
                    const remainingSeconds = Math.max(0, (adjustedGrowTime - effectiveGrowth) / (1 + ((plot.wateredBy?.length || 0) * 0.5)));
                    
                    detailsEl.innerHTML = `<p>‡∏õ‡∏•‡∏π‡∏Å‡πÇ‡∏î‡∏¢: ${plot.plantedBy?.nickname || '??'}</p><p>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${formatTime(remainingSeconds)}</p>`;
                    if (plot.wateredBy && plot.wateredBy.length > 0) {
                        const waterers = plot.wateredBy.map(p => p.nickname).join(', ');
                        detailsEl.innerHTML += `<div class="mt-2"><p>‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢:</p><p class="font-semibold text-green-700">${waterers}</p></div>`;
                    }
                    actionsEl.before(detailsEl);
                    
                    if (isGrown) {
                        const hasHarvested = plot.harvestedBy?.some(p => p.uid === userId);
                        actionsEl.appendChild(createButton('üåæ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (-1‚ö°)', () => harvest(index), hasHarvested));

                        const involvedUids = new Set([plot.plantedBy?.uid, ...(plot.wateredBy?.map(p => p.uid).filter(uid => uid) || [])]);
                        const harvestedUids = new Set(plot.harvestedBy?.map(p => p.uid) || []);
                        
                        let harvestStatusHTML = '<div class="mt-2 text-xs text-left border-t pt-2">';
                        harvestStatusHTML += '<p class="font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:</p>';

                        involvedUids.forEach(uid => {
                            const planterName = plot.plantedBy?.uid === uid ? plot.plantedBy.nickname : null;
                            const waterer = plot.wateredBy?.find(p => p.uid === uid);
                            const nickname = planterName || waterer?.nickname || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
                            const statusIcon = harvestedUids.has(uid) ? '‚úÖ' : '‚ùå';
                            harvestStatusHTML += `<p>${statusIcon} ${nickname}</p>`;
                        });
                        harvestStatusHTML += '</div>';
                        detailsEl.innerHTML += harvestStatusHTML;

                    } else {
                         const hasWatered = plot.wateredBy?.some(p => p.uid === userId);
                         actionsEl.appendChild(createButton('üíß ‡∏£‡∏î‡∏ô‡πâ‡∏≥ (-2‚ö°)', () => water(index), hasWatered));
                         const fertilizers = Object.keys(playerState.inventory).filter(id => GAME_DATA[id]?.type === 'item');
                         actionsEl.appendChild(createButton('üí© ‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢', () => showSubMenu('fertilize', index, fertilizers), fertilizers.length === 0));
                    }
                    actionsEl.appendChild(createButton('‚ùå ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡πÅ‡∏õ‡∏•‡∏á (-5‚ö°)', () => clearPlot(index), false, 'bg-red-500 hover:bg-red-600 text-white'));
                }
            } else if (type === 'animal') {
                const index = id;
                const animal = farmState.animals[index];
                titleEl.textContent = `‡∏Ñ‡∏≠‡∏Å‡∏ó‡∏µ‡πà ${index + 1}`;
                if (!animal.animalId) {
                     const deedsInStorage = playerState.storageBin
                        .filter(item => GAME_DATA[item.id]?.type === 'animal_deed')
                        .map(item => item.id);
                     const uniqueDeeds = [...new Set(deedsInStorage)];
                     actionsEl.appendChild(createButton('‚ûï ‡∏ß‡∏≤‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå', () => showSubMenu('placeAnimal', index, uniqueDeeds), uniqueDeeds.length === 0));
                } else {
                    const weatherMultiplier = WEATHER_DATA[farmState.currentWeather]?.animalMultiplier || 1;
					const animalData = GAME_DATA[animal.animalId];
                    const adjustedProduceTime = (animalData.produceTime * 1000) * weatherMultiplier;
                    const isReady = (Date.now() - animal.startTime) >= adjustedProduceTime;
                    const remainingMillis = Math.max(0, (animal.startTime + adjustedProduceTime) - Date.now());

                    detailsEl.innerHTML = `<p><b>${animalData.name}</b></p><p>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô: <span class="font-semibold">${formatTime(remainingMillis / 1000)}</span></p>`;
                    actionsEl.before(detailsEl);
                    if(isReady){
                        actionsEl.appendChild(createButton(`‡πÄ‡∏Å‡πá‡∏ö${GAME_DATA[animalData.produceId].name}`, () => collectAnimalProduct(index)));
                    }
                    actionsEl.appendChild(createButton('‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏™‡∏±‡∏ï‡∏ß‡πå', () => releaseAnimal(index), false, 'bg-red-500 hover:bg-red-600 text-white'));
                }
            } else if (type === 'factory') {
                const index = id;
                const factory = farmState.factories[index];
                titleEl.textContent = `‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${index + 1}`;

                if (!factory.factoryId) {
                    const deedsInStorage = playerState.storageBin
                        .filter(item => GAME_DATA[item.id]?.type === 'factory_deed')
                        .map(item => item.id);
                    const uniqueDeeds = [...new Set(deedsInStorage)];
                    actionsEl.appendChild(createButton('‚ûï ‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', () => showSubMenu('placeFactory', index, uniqueDeeds), uniqueDeeds.length === 0));
                } else {
                    const factoryData = GAME_DATA[factory.factoryId];

                    const myItemsInBinCount = factory.outputBin?.filter(item => item.owner === userId).length || 0;
                    if (myItemsInBinCount > 0) {
                        actionsEl.appendChild(createButton(`üéÅ ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á (${myItemsInBinCount} ‡∏ä‡∏¥‡πâ‡∏ô)`, () => collectMyFactoryGoods(index)));
                    }

                    const isQueueFull = (factory.queue?.length || 0) >= 5;
                    actionsEl.appendChild(createButton('‚öôÔ∏è ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß', () => showSubMenu('useFactory', index, factoryData.recipes.map(r => r.id)), isQueueFull));

                    let detailsText = `<p class="font-bold">${factoryData.name}</p>`;

                    if (factory.outputBin && factory.outputBin.length > 0) {
                        detailsText += `<p class="text-xs mt-2 font-semibold">‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß:</p><ul class="text-xs text-left list-disc list-inside">`;
                        factory.outputBin.forEach(output => {
                            const itemName = GAME_DATA[output.item.id]?.name || 'Unknown';
                            const ownerText = output.owner === userId ? ' (‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤)' : ` (${output.ownerNickname})`;
                            detailsText += `<li>${itemName}${ownerText}</li>`;
                        });
                        detailsText += `</ul>`;
                    }

                    if (factory.queue && factory.queue.length > 0) {
                        const currentJob = factory.queue[0];
                        const recipe = factoryData.recipes.find(r => r.id === currentJob.recipeId);
                        const remainingMillis = Math.max(0, (currentJob.startTime + recipe.processTime * 1000) - Date.now());
                        const remainingTimeText = currentJob.startTime ? formatTime(Math.ceil(remainingMillis / 1000)) : '‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...';
                        detailsText += `<p class="text-xs mt-2 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï:</p><p class="text-xs">${recipe.name} (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô ${remainingTimeText})</p>`;
                        if (factory.queue.length > 1) {
                            detailsText += `<p class="text-xs">‡∏£‡∏≠‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏µ‡∏Å: ${factory.queue.length - 1} ‡∏ä‡∏¥‡πâ‡∏ô</p>`;
                        }
                    }
                    detailsEl.innerHTML = detailsText;
                    actionsEl.before(detailsEl);
                }
            }
            
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }
        
        function showQuantityModal({ title, itemId, quality = 0, maxQuantity, onConfirm }) {
            const modal = document.getElementById('quantity-modal');
            const itemData = GAME_DATA[itemId];

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Title ‡∏Ç‡∏≠‡∏á Modal
            document.getElementById('quantity-modal-title').textContent = title;

            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°
            document.getElementById('quantity-modal-name').textContent = itemData.name;
            const qualityEl = document.getElementById('quantity-modal-quality');
            if (quality > 0) {
                qualityEl.textContent = `‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û: ${'‚òÖ'.repeat(quality)}`;
                qualityEl.classList.remove('hidden');
            } else {
                qualityEl.classList.add('hidden');
            }

            const iconEl = document.getElementById('quantity-modal-icon');
            iconEl.style.backgroundImage = itemData.imageUrl ? `url('${itemData.imageUrl}')` : 'none';
            iconEl.textContent = itemData.imageUrl ? '' : itemData.icon;

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ input ‡πÅ‡∏•‡∏∞ slider
            const slider = document.getElementById('quantity-modal-slider');
            const input = document.getElementById('quantity-modal-input');
            const maxBtn = document.getElementById('quantity-modal-max-btn');
            
            const effectiveMax = maxQuantity > 0 ? maxQuantity : 1;
            slider.max = effectiveMax;
            input.max = effectiveMax;
            slider.value = 1;
            input.value = 1;

            if (maxQuantity === 0) {
                slider.disabled = true;
                input.disabled = true;
            } else {
                slider.disabled = false;
                input.disabled = false;
            }

            // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ slider ‡∏Å‡∏±‡∏ö input ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ô
            slider.oninput = () => input.value = slider.value;
            input.oninput = () => {
                if (parseInt(input.value) > effectiveMax) input.value = effectiveMax;
                if (parseInt(input.value) < 1) input.value = 1;
                slider.value = input.value;
            };
            maxBtn.onclick = () => {
                input.value = effectiveMax;
                slider.value = effectiveMax;
            };

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
            document.getElementById('quantity-modal-cancel').onclick = hideQuantityModal;
            
            const okButton = document.getElementById('quantity-modal-ok');
            const newOkButton = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(newOkButton, okButton);

            if (maxQuantity > 0) {
                newOkButton.disabled = false;
                newOkButton.addEventListener('click', () => {
                    const quantity = parseInt(input.value, 10);
                    if (quantity > 0 && quantity <= maxQuantity) {
                        onConfirm(quantity);
                        hideQuantityModal();
                    }
                });
            } else {
                newOkButton.disabled = true;
            }


            // ‡πÅ‡∏™‡∏î‡∏á Modal
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        function hideQuantityModal() {
            const modal = document.getElementById('quantity-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

		function showInfoModal(icon, title, text) {
            document.getElementById('info-modal-icon').textContent = icon;
            document.getElementById('info-modal-title').textContent = title;
            document.getElementById('info-modal-text').textContent = text;
            const modal = document.getElementById('info-modal');

            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        function hideInfoModal() {
            const modal = document.getElementById('info-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function hideContextMenu() {
            const modal = document.getElementById('context-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function showSubMenu(actionType, index, itemIds) {
            const modal = document.getElementById('submenu-modal');
            const titleEl = document.getElementById('submenu-modal-title');
            const itemsEl = document.getElementById('submenu-modal-items');
            itemsEl.innerHTML = '';
            
            const titles = {
                plant: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏•‡∏π‡∏Å',
                fertilize: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏∏‡πã‡∏¢',
                placeAnimal: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏á',
                placeFactory: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á',
                useFactory: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï'
            };
            titleEl.textContent = titles[actionType] || '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';

            itemIds.forEach(itemId => {
                let itemData, clickAction, name, iconHTML;
                
                if (actionType === 'useFactory') {
                    const factoryData = GAME_DATA[farmState.factories[index].factoryId];
                    const recipe = factoryData.recipes.find(r => r.id === itemId);
                    const outputData = GAME_DATA[recipe.output.id];
                    
                    let ingredientsText = recipe.inputs.map(inp => `${GAME_DATA[inp.id].name} x${inp.count}`).join(', ');
                    
                    itemData = recipe;
                    name = `${recipe.name}<br><small class="font-normal text-gray-500">${ingredientsText}</small>`;
                    iconHTML = `<img src="${outputData.imageUrl}" class="w-10 h-10 object-contain">`;
                    clickAction = () => startProcessing(index, recipe.id);
                } else {
                    itemData = GAME_DATA[itemId];
                    name = itemData.name;
                    iconHTML = itemData.imageUrl 
                        ? `<img src="${itemData.imageUrl}" class="w-10 h-10 object-contain">`
                        : `<div class="text-3xl">${itemData.icon}</div>`;

                    const actions = {
                        plant: () => plant(index, itemId),
                        fertilize: () => fertilize(index, itemId),
                        placeAnimal: () => placeAnimal(index, itemId),
                        placeFactory: () => placeFactory(index, itemId),
                    };
                    clickAction = actions[actionType];
                }

                const itemButton = document.createElement('button');
                itemButton.className = 'p-2 bg-gray-100 rounded-lg hover:bg-green-100 flex flex-col items-center justify-center gap-1';
                itemButton.innerHTML = `${iconHTML}<div class="text-xs">${name}</div>`;
                itemButton.onclick = () => {
                    clickAction();
                    hideSubMenu();
                };
                itemsEl.appendChild(itemButton);
            });
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        function hideSubMenu() {
            const modal = document.getElementById('submenu-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function showCookingModal() {
            const modal = document.getElementById('cooking-modal');
            renderRecipeList();
            modal.classList.remove('hidden');
        }

        function hideCookingModal() {
            document.getElementById('cooking-modal').classList.add('hidden');
        }

        function renderRecipeList() {
            const container = document.getElementById('recipe-list');
            container.innerHTML = '';
            if(!farmState.ownedKitchenTools) farmState.ownedKitchenTools = [];
            
            const isFilterActive = document.getElementById('cookable-filter-toggle').checked;
            
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ itemData ‡∏à‡∏£‡∏¥‡∏á‡πÜ ---
            const storageCounts = playerState.storageBin.reduce((acc, item) => {
                const itemData = GAME_DATA[item.id];
                if (itemData) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                    acc[item.id] = (acc[item.id] || 0) + 1;
                    if (itemData.category) {
                         acc[`category_${itemData.category}`] = (acc[`category_${itemData.category}`] || 0) + 1;
                    }
                }
                return acc;
            }, {});
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

            let recipesToRender = Object.entries(GAME_DATA.recipes);

            if (isFilterActive) {
                recipesToRender = recipesToRender.filter(([recipeId, recipeData]) => {
                    if (!farmState.ownedKitchenTools.includes(recipeData.tool)) {
                        return false;
                    }
                    for (const ingredient of recipeData.ingredients) {
                        const requiredCount = ingredient.count || 1;
                        const key = ingredient.id ? ingredient.id : `category_${ingredient.category}`;
                        if ((storageCounts[key] || 0) < requiredCount) {
                            return false;
                        }
                    }
                    return true;
                });
            }

            recipesToRender.forEach(([recipeId, recipeData]) => {
                const resultData = GAME_DATA[recipeData.resultId];
                const recipeEl = document.createElement('div');
                recipeEl.className = 'bg-gray-50 p-3 rounded-lg flex items-center gap-4';

                let ingredientsHTML = '';
                const hasTool = farmState.ownedKitchenTools.includes(recipeData.tool);
                const toolData = GAME_DATA[recipeData.tool];
                const toolHTML = `<span class="text-sm ${hasTool ? 'text-green-600' : 'text-red-500'}">${toolData.icon} ${toolData.name} ${hasTool ? '‚úîÔ∏è' : ''}</span>`;
                
                let maxCookable = hasTool ? Infinity : 0;
                const ingredientChecks = [];

                for (const ingredient of recipeData.ingredients) {
                    const requiredCount = ingredient.count || 1;
                    const key = ingredient.id ? ingredient.id : `category_${ingredient.category}`;
                    const hasCount = storageCounts[key] || 0;
                    
                    ingredientChecks.push(Math.floor(hasCount / requiredCount));
                    
                    const name = ingredient.id ? GAME_DATA[ingredient.id].name : `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${ingredient.category}`;
                    const icon = ingredient.id ? GAME_DATA[ingredient.id].icon : {egg:'ü•ö',fish:'üêü',fruit:'üçì',vegetable:'ü•ï',milk:'ü•õ',jam:'üßÅ'}[ingredient.category];
                    ingredientsHTML += `<span class="text-sm ${hasCount >= requiredCount ? 'text-green-600' : 'text-red-500'}">${icon} ${name}</span>`;
                }
                
                maxCookable = ingredientChecks.length > 0 ? Math.min(...ingredientChecks, maxCookable) : 0;
                
                recipeEl.innerHTML = `
                    <div class="w-12 h-12 flex-shrink-0 bg-contain bg-no-repeat bg-center" style="background-image: url('${resultData.imageUrl}')"></div>
                    <div class="flex-grow text-left">
                        <p class="font-bold">${resultData.name}</p>
                        <p class="text-xs text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°: ${ingredientsHTML}</p>
                        <p class="text-xs text-gray-500">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${toolHTML}</p>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <input type="number" value="1" min="1" max="${maxCookable > 0 ? maxCookable : 1}" class="w-20 text-center border rounded-md p-1 recipe-quantity-input" ${maxCookable === 0 ? 'disabled' : ''}>
                        <button class="cook-recipe-btn bg-orange-500 text-white font-bold py-1 px-4 rounded-lg hover:bg-orange-600 disabled:bg-gray-400 text-sm" data-recipe-id="${recipeId}" ${maxCookable === 0 ? 'disabled' : ''}>‡∏ó‡∏≥</button>
                    </div>
                `;
                container.appendChild(recipeEl);
            });

            if (recipesToRender.length === 0 && isFilterActive) {
                container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>`;
            }
        }
        
        function plant(plotIndex, seedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const seedData = GAME_DATA[seedId];
            newFarmState.plots[plotIndex] = { 
                plantId: seedData.plantId, 
                plantTime: Date.now(), 
                fertilizerLevel: 0, 
                wateredBy: [],
                plantedBy: { uid: userId, nickname: playerState.nickname },
                harvestedBy: []
            };
            newPlayerState.inventory[seedId]--;
            document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('pop-animation');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
            updateQuestProgress('plant');
        }

        function water(plotIndex) {
             if (!deductEnergy(2)) return;

             const newFarmState = { ...farmState };
             const plot = newFarmState.plots[plotIndex];
             if (plot.wateredBy && plot.wateredBy.some(p => p.uid === userId)) return; 
             plot.wateredBy.push({ uid: userId, nickname: playerState.nickname });
             document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('watered');
             updateFarmState(newFarmState);
             updateQuestProgress('water');
        }

        function fertilize(plotIndex, fertilizerId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const fertilizerData = GAME_DATA[fertilizerId];
            newFarmState.plots[plotIndex].fertilizerLevel += fertilizerData.qualityBonus;
            newPlayerState.inventory[fertilizerId]--;
            document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('fertilized');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
            updateQuestProgress('fertilize');
        }
        
        function clearPlot(plotIndex) {
            const plot = farmState.plots[plotIndex];
            if (!plot) return;
            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ? ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ', () => {
                if (!deductEnergy(5)) return;

                const newFarmState = { ...farmState };
                newFarmState.plots[plotIndex] = { plantId: null };
                updateFarmState(newFarmState);
            });
        }

        function harvest(plotIndex) {
            const newFarmState = { ...farmState };
            const plot = newFarmState.plots[plotIndex];

            if (!plot || !plot.plantId || (plot.harvestedBy && plot.harvestedBy.some(p => p.uid === userId))) {
                console.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)");
                return; 
            }

            if (!deductEnergy(1)) return;
            
            const newPlayerState = { ...playerState };
            const cropData = GAME_DATA[plot.plantId];
            let quality = 0;
            if (Math.random() < plot.fertilizerLevel) quality = 1;
            if (Math.random() < plot.fertilizerLevel - 1) quality = 2;
            newPlayerState.storageBin.push({ id: cropData.produceId, quality: quality });
            if (!plot.harvestedBy) plot.harvestedBy = [];
            plot.harvestedBy.push({ uid: userId, nickname: playerState.nickname });
            const involvedUids = new Set([plot.plantedBy?.uid, ...(plot.wateredBy?.map(p => p.uid).filter(uid => uid) || [])]);
            const harvestedUids = new Set(plot.harvestedBy?.map(p => p.uid) || []);
            let allHarvested = true;
            for (const uid of involvedUids) {
                if (!harvestedUids.has(uid)) {
                    allHarvested = false;
                    break;
                }
            }
            if (allHarvested) {
                newFarmState.plots[plotIndex] = { plantId: null };
            }
            updatePlayerState(newPlayerState);
            updateFarmState(newFarmState);
            updateQuestProgress('harvest');
        }
        
        function placeAnimal(slotIndex, deedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const deedData = GAME_DATA[deedId];

            // ‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏ö Deed ‡∏à‡∏≤‡∏Å storageBin
            const deedIndex = newPlayerState.storageBin.findIndex(item => item.id === deedId);
            if (deedIndex > -1) {
                newPlayerState.storageBin.splice(deedIndex, 1);
            } else {
                return; // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ Deed ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            }

            newFarmState.animals[slotIndex] = { animalId: deedData.animalId, startTime: Date.now() };
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function collectAnimalProduct(slotIndex) {
            const newPlayerState = { ...playerState };
            const newFarmState = { ...farmState };
            const animal = newFarmState.animals[slotIndex];
            const animalData = GAME_DATA[animal.animalId];
            newPlayerState.storageBin.push({ id: animalData.produceId, quality: 0 });
            animal.startTime = Date.now();
            updatePlayerState(newPlayerState);
            updateFarmState(newFarmState);
            updateQuestProgress('collect_product');
        }

        function releaseAnimal(index) {
            const animal = farmState.animals[index];
            if (!animal || !animal.animalId) return;

            const animalData = GAME_DATA[animal.animalId];
            const deedId = Object.keys(GAME_DATA).find(id => GAME_DATA[id].type === 'animal_deed' && GAME_DATA[id].animalId === animal.animalId);
            
            if (!deedId) {
                console.error("Could not find deed for animal:", animal.animalId);
                return;
            }

            const deedData = GAME_DATA[deedId];
            const refundAmount = Math.floor(deedData.cost * 0.5);

            const confirmationText = `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢ ${animalData.name}? ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏∑‡∏ô ${refundAmount}üí∞`;
            
            showConfirmationModal(confirmationText, () => {
                const newFarmState = { ...farmState };
                const newPlayerState = { ...playerState };

                newPlayerState.money += refundAmount;
                newFarmState.animals[index] = { animalId: null }; // Reset the slot

                updatePlayerState(newPlayerState);
                updateFarmState(newFarmState);
            });
        }
        
        function placeFactory(slotIndex, deedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const deedData = GAME_DATA[deedId];
            
            // ‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏ö Deed ‡∏à‡∏≤‡∏Å storageBin
            const deedIndex = newPlayerState.storageBin.findIndex(item => item.id === deedId);
            if (deedIndex > -1) {
                newPlayerState.storageBin.splice(deedIndex, 1);
            } else {
                return; // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ Deed ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            }

            newFarmState.factories[slotIndex] = { factoryId: deedData.factoryId, queue: [], outputBin: [] };
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
            updateQuestProgress('place_factory');
        }
        
        function startProcessing(slotIndex, recipeId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const factory = newFarmState.factories[slotIndex];

            if ((factory.queue?.length || 0) >= 5) {
                alert("‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß!");
                return;
            }

            const factoryData = GAME_DATA[factory.factoryId];
            const recipe = factoryData.recipes.find(r => r.id === recipeId);
            
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö ---
            const tempStorageBin = [...newPlayerState.storageBin];
            const ingredientsUsed = [];
            let canProcess = true;

            for (const input of recipe.inputs) {
                const itemsNeeded = [];
                // ‡∏´‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                for (let i = 0; i < input.count; i++) {
                    const foundIndex = tempStorageBin.findIndex(item => item.id === input.id);
                    if (foundIndex > -1) {
                        itemsNeeded.push(tempStorageBin.splice(foundIndex, 1)[0]);
                    } else {
                        canProcess = false;
                        break;
                    }
                }
                if (!canProcess) break;
                ingredientsUsed.push(...itemsNeeded);
            }

            if (canProcess) {
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏•‡∏±‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏•‡∏±‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
                newPlayerState.storageBin = tempStorageBin;

                const newJob = { 
                    recipeId: recipeId,
                    processedBy: { uid: userId, nickname: playerState.nickname },
                    // ‡∏à‡∏î‡∏à‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ
                    ingredientQualities: ingredientsUsed.map(item => item.quality)
                };

                if (!factory.queue) factory.queue = [];
                if (factory.queue.length === 0) {
                    newJob.startTime = Date.now();
                }
                factory.queue.push(newJob);
                
                updateFarmState(newFarmState);
                updatePlayerState(newPlayerState);
            } else {
                alert("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠!");
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á (OutputBin)
        async function processFactoryQueuesToOutputBin() {
            if (!farmState || !farmState.factories) return;
            const now = Date.now();
            const MAX_OUTPUT_BIN_SIZE = 6; 

            try {
                await runTransaction(db, async (transaction) => {
                    const farmDocRef = doc(db, "publicFarmData", "farmState");
                    const farmDoc = await transaction.get(farmDocRef);
                    if (!farmDoc.exists()) throw "Farm document does not exist!";

                    const freshFarmState = farmDoc.data();
                    let hasChanges = false;

                    for (const factory of freshFarmState.factories) {
                        if (!factory.factoryId || !factory.queue || factory.queue.length === 0 || !factory.queue[0].startTime) continue;
                        if (!factory.outputBin) factory.outputBin = [];
                        
                        const currentJob = factory.queue[0];
                        const recipe = GAME_DATA[factory.factoryId].recipes.find(r => r.id === currentJob.recipeId);
                        const completionTime = currentJob.startTime + (recipe.processTime * 1000);

                        if (now >= completionTime && factory.outputBin.length < MAX_OUTPUT_BIN_SIZE) {
                            hasChanges = true;
                            const finishedJob = factory.queue.shift(); 
                            
                            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏á‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå ---
                            let outputQuality = 0; // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô 0

                            if (factory.factoryId === 'meat_processor') {
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏£‡∏á‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå ‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û
                                const rand = Math.random();
                                if (rand < 0.1) { // 10%
                                    outputQuality = 2;
                                } else if (rand < 0.4) { // 30% (0.1 + 0.3)
                                    outputQuality = 1;
                                } else { // 60% ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                                    outputQuality = 0;
                                }
                            } else {
                                // --- Logic ‡πÄ‡∏î‡∏¥‡∏°: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
                                const qualities = finishedJob.ingredientQualities || [];
                                if (qualities.length > 0) {
                                    const sum = qualities.reduce((a, b) => a + b, 0);
                                    outputQuality = Math.floor(sum / qualities.length);
                                }
                            }
                            
                            const outputCount = recipe.output.count || 1;
                            for (let i = 0; i < outputCount; i++) {
                                if (factory.outputBin.length < MAX_OUTPUT_BIN_SIZE) {
                                    factory.outputBin.push({
                                        item: { id: recipe.output.id, quality: outputQuality }, // ‡πÉ‡∏ä‡πâ outputQuality ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
                                        owner: finishedJob.processedBy.uid,
                                        ownerNickname: finishedJob.processedBy.nickname
                                    });
                                } else {
                                    break;
                                }
                            }
                            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

                            if (factory.queue.length > 0) {
                                factory.queue[0].startTime = completionTime;
                            }
                        }
                    }

                    if (hasChanges) {
                        transaction.update(farmDocRef, { factories: freshFarmState.factories });
                    }
                });
            } catch (e) {
                console.error("Factory processing to output bin failed: ", e);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        async function collectMyFactoryGoods(factoryIndex) {
            if (!farmState || !playerState) return;

            const newFarmState = JSON.parse(JSON.stringify(farmState));
            const newPlayerState = JSON.parse(JSON.stringify(playerState));
            const factory = newFarmState.factories[factoryIndex];
            
            if (!factory.outputBin || factory.outputBin.length === 0) return;

            const myItems = [];
            const remainingItems = [];
            
            // ‡πÅ‡∏¢‡∏Å‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô
            factory.outputBin.forEach(output => {
                if (output.owner === userId) {
                    myItems.push(output.item);
                } else {
                    remainingItems.push(output);
                }
            });

            if (myItems.length > 0) {
                if (!newPlayerState.storageBin) newPlayerState.storageBin = [];
                newPlayerState.storageBin.push(...myItems); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á
                
                factory.outputBin = remainingItems; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏≤‡∏á‡∏Ç‡∏≠‡∏á

                await updatePlayerState(newPlayerState);
                await updateFarmState(newFarmState);
            }
        }
        
        function upgradeHouse() {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState }; 
            
            const currentLevel = newFarmState.sharedHouseLevel || 0;
            if (currentLevel >= GAME_DATA.house_upgrades.length) return;

            const nextLevelData = GAME_DATA.house_upgrades[currentLevel];
            if (newPlayerState.money >= nextLevelData.cost) {
                newPlayerState.money -= nextLevelData.cost;
                newFarmState.sharedHouseLevel = currentLevel + 1;
                
                updatePlayerState(newPlayerState);
                updateFarmState(newFarmState);
                updateQuestProgress('upgrade_house');
            }
        }
        
        function sellFromStorage(itemId, quality, quantity) {
            const newPlayerState = { ...playerState };
            
            const itemsToSell = [];
            const remainingStorage = [];
            let itemsFound = 0;

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á
            for (const item of newPlayerState.storageBin) {
                if (item.id === itemId && item.quality === quality && itemsFound < quantity) {
                    itemsToSell.push(item);
                    itemsFound++;
                } else {
                    remainingStorage.push(item);
                }
            }

            // ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
            if (itemsFound === quantity) {
                newPlayerState.storageBin = remainingStorage;
                newPlayerState.produceBin.push(...itemsToSell);
                
                updatePlayerState(newPlayerState);
                updateQuestProgress('sell_item', quantity);
                if (quality === 2) {
                    updateQuestProgress('sell_high_quality', quantity);
                }
            }
        }

        function eatFromStorage(itemId, quality) {
            const newPlayerState = { ...playerState };
            const itemIndex = newPlayerState.storageBin.findIndex(item => item.id === itemId && item.quality === quality);
            if (itemIndex > -1) {
                const itemData = GAME_DATA[itemId];
                if (!itemData.energyRestore || itemData.energyRestore === 0) return;
                newPlayerState.storageBin.splice(itemIndex, 1);
                const MAX_ENERGY = getMaxEnergy();
                newPlayerState.energy = Math.min(MAX_ENERGY, (newPlayerState.energy || 0) + itemData.energyRestore);
                updatePlayerState(newPlayerState);
                updateQuestProgress('eat');
            }
        }
		
		function moveFromStorageToInventory(itemId, quality) {
            const newPlayerState = { ...playerState };
            const itemIndex = newPlayerState.storageBin.findIndex(item => item.id === itemId && item.quality === quality);
            if (itemIndex > -1) {
                newPlayerState.storageBin.splice(itemIndex, 1);
                newPlayerState.inventory[itemId] = (newPlayerState.inventory[itemId] || 0) + 1;
                updatePlayerState(newPlayerState);
            }
        }
        
        function generateRandomQuests(type, count) {
            const sourceQuests = QUEST_DATA[type];
            const shuffled = [...sourceQuests].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, count);
            return selected.map(q => ({ id: q.id, action: q.action, progress: 0, claimedBy: [] }));
        }
        async function runOneTimeWeeklyQuestFix() {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á
            if (!farmState || farmState.weeklyQuestFixApplied) {
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°
                return; 
            }

            console.log("ADMIN: Running ONE-TIME fix for stuck weekly quests...");
            alert("‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏Ñ‡∏ß‡∏™‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß...");

            const newFarmState = { ...farmState };
            
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏ß‡∏™‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà
            newFarmState.quests.weekly = generateRandomQuests('weekly', 5);
            
            // 2. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            newFarmState.quests.lastWeeklyReset = 0;
            
            // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å)
            newFarmState.weeklyQuestFixApplied = true;

            await updateFarmState(newFarmState);
            
            console.log("ADMIN: One-time fix complete. Please refresh the page.");
            alert("‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÄ‡∏Ñ‡∏ß‡∏™‡πÉ‡∏´‡∏°‡πà");
        }
		
		async function updateMarketPrices() {
            if (!farmState) return;
            const newFarmState = { ...farmState };
            const newMarketPrices = { ...newFarmState.marketPrices };
            const salesVolume = newFarmState.salesVolume || {};
            
            // --- NEW ECONOMIC PARAMETERS ---
            const INFLATION_RATE = 0.08; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô 8% ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏¢
            const VOLATILITY = 0.15;      // ‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏î‡∏±‡∏ô‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏¢‡∏¥‡πà‡∏á‡∏Ç‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏¢‡∏¥‡πà‡∏á‡∏ï‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞)

            for (const itemId in GAME_DATA) {
                const itemData = GAME_DATA[itemId];
                if (itemData.type !== 'produce' || !itemData.sellPrice) continue;

                const basePrice = itemData.sellPrice[0];
                const currentPrice = newMarketPrices[itemId] || basePrice;
                const soldAmount = salesVolume[itemId] || 0;
                let newPrice;

                // Scenario 1: ‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡∏•‡∏î‡∏•‡∏á
                if (soldAmount > 0) {
                    const pressure = Math.log10(soldAmount + 1);
                    const reduction = pressure * VOLATILITY;
                    newPrice = currentPrice * (1 - reduction);
                } 
                // Scenario 2: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
                else {
                    newPrice = currentPrice * (1 + INFLATION_RATE);
                }

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏û‡∏î‡∏≤‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏•‡∏∏‡∏î‡πÇ‡∏•‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
                const minPrice = basePrice * 0.2; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ (20% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥)
                const maxPrice = basePrice * 3.0; // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ (300% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥)
                
                newPrice = Math.max(minPrice, Math.min(newPrice, maxPrice));
                newMarketPrices[itemId] = Math.round(newPrice);
            }
            
            newFarmState.marketPrices = newMarketPrices;
            newFarmState.salesVolume = {}; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
            await updateFarmState(newFarmState);
        }
		
		async function checkForTimeResets() {
            if (!playerState || !farmState) return;
            const now = new Date();
            
            // --- STATE PREPARATION ---
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏°‡∏≤‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            let newFarmState = null;
            let newPlayerState = null;
            let dailyResetOccurred = false;

            // --- DAILY RESET CHECK ---
            const lastPlayerReset = new Date(playerState.lastResetTime || 0);
            if (lastPlayerReset.getDate() !== now.getDate() || lastPlayerReset.getMonth() !== now.getMonth()) {
                dailyResetOccurred = true;
                console.log("New day detected! Running daily reset...");
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏≤‡∏Å State ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                newFarmState = { ...farmState };
                newPlayerState = { ...playerState };
                if (!newFarmState.salesVolume) newFarmState.salesVolume = {};

                // Action 1: Sell items
                if (newPlayerState.produceBin && newPlayerState.produceBin.length > 0) {
                    let totalValue = 0;
                    newPlayerState.produceBin.forEach(item => {
                        const itemData = GAME_DATA[item.id];
                        if (itemData && itemData.sellPrice) {
                            const marketBasePrice = newFarmState.marketPrices[item.id] || itemData.sellPrice[0];
                            const qualityRatio = itemData.sellPrice[item.quality] / itemData.sellPrice[0];
                            const finalSellPrice = Math.round(marketBasePrice * qualityRatio);
                            totalValue += finalSellPrice;
                            newFarmState.salesVolume[item.id] = (newFarmState.salesVolume[item.id] || 0) + 1;
                        }
                    });
                    newPlayerState.money = (newPlayerState.money || 0) + totalValue;
                    newPlayerState.produceBin = [];
                }

                // Action 2: Reset Daily Quests
                newFarmState.quests.daily = generateRandomQuests('daily', 5);
                newFarmState.quests.lastDailyReset = now.getTime();

                // Action 3: Reset Player Stats
                newPlayerState.energy = getMaxEnergy();
                newPlayerState.dailyRestCount = 0;
				newPlayerState.dailyNapCount = 0;
                newPlayerState.lastResetTime = now.getTime();
				
				// Action 4: Set new weather <<<<<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ
                const weatherTypes = Object.keys(WEATHER_DATA);
                const randomWeather = weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
                newFarmState.currentWeather = randomWeather;
                console.log(`Today's weather is: ${randomWeather}`);
            }

            // --- WEEKLY RESET CHECK ---
            const lastWeeklyQuestReset = new Date(farmState.quests?.lastWeeklyReset || 0);
            const currentWeek = getWeekNumber(now);
            const lastResetWeek = getWeekNumber(lastWeeklyQuestReset);

            if (currentWeek[0] !== lastResetWeek[0] || currentWeek[1] !== lastResetWeek[1]) {
                console.log("New week detected! Resetting weekly quests.");
                
                // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á newFarmState ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
                if (!newFarmState) {
                    newFarmState = { ...farmState };
                }
                
                newFarmState.quests.weekly = generateRandomQuests('weekly', 5);
                newFarmState.quests.lastWeeklyReset = now.getTime();
            }

            // --- FINAL SAVE ---
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏î‡πÜ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            if (newPlayerState) {
                await updatePlayerState(newPlayerState);
            }
            if (newFarmState) {
                await updateFarmState(newFarmState);
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î
                if (dailyResetOccurred) {
                    await updateMarketPrices();
                }
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï state ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏ô server
                farmState = await getDoc(doc(db, "publicFarmData", "farmState")).then(d => d.data());
            }
        }
        
        function forceResetFarm() {
            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à 100% ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!', async () => {
                const farmDocRef = doc(db, "publicFarmData", "farmState");
                await deleteDoc(farmDocRef);
                window.location.reload();
            });
        }
        
		async function forceSellAllPlayersItems() {
            if (userId !== ADMIN_UID) {
                alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ");
                return;
            }
            if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ")) {
                return;
            }

            console.log("Admin command: Forcing sale for all players...");
            alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô...");

            const playersCollectionRef = collection(db, "players");
            const farmDocRef = doc(db, "publicFarmData", "farmState");
            
            try {
                const querySnapshot = await getDocs(playersCollectionRef);
                const batch = writeBatch(db);
                let playersProcessed = 0;
                let totalItemsSold = 0;
                const newSalesVolume = { ...(farmState.salesVolume || {}) };

                querySnapshot.forEach((playerDoc) => {
                    const playerData = playerDoc.data();
                    if (playerData.produceBin && playerData.produceBin.length > 0) {
                        let playerTotalValue = 0;
                        playerData.produceBin.forEach(item => {
                            const itemData = GAME_DATA[item.id];
                            if (itemData && itemData.sellPrice) {
                                const marketBasePrice = farmState.marketPrices[item.id] || itemData.sellPrice[0];
                                const qualityRatio = itemData.sellPrice[item.quality] / itemData.sellPrice[0];
                                const finalSellPrice = Math.round(marketBasePrice * qualityRatio);
                                playerTotalValue += finalSellPrice;
                                newSalesVolume[item.id] = (newSalesVolume[item.id] || 0) + 1;
                                totalItemsSold++;
                            }
                        });

                        const newMoney = (playerData.money || 0) + playerTotalValue;
                        batch.update(playerDoc.ref, { money: newMoney, produceBin: [] });
                        playersProcessed++;
                    }
                });
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°
                batch.update(farmDocRef, { salesVolume: newSalesVolume });

                await batch.commit();

                console.log(`Process complete. Processed ${playersProcessed} players. Sold ${totalItemsSold} items.`);
                alert(`‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô! ‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${playersProcessed} ‡∏Ñ‡∏ô ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à \n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô`);

            } catch (error) {
                console.error("Error forcing sell for all players:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á: " + error.message);
            }
        }
		
        function resetPlayerProgress() {
            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!', async () => {
                if (!userId) return;
                const playerDocRef = doc(db, "players", userId);
                await deleteDoc(playerDocRef);
                window.location.reload();
            });
        }
        
        function upgradeRod() {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };

            const currentLevel = newFarmState.sharedRodLevel || 0;
            if (currentLevel >= GAME_DATA.fishing_rods.length - 1) return;

            const nextLevelData = GAME_DATA.fishing_rods[currentLevel + 1];
            if (newPlayerState.money >= nextLevelData.cost) {
                newPlayerState.money -= nextLevelData.cost;
                newFarmState.sharedRodLevel = currentLevel + 1;

                updatePlayerState(newPlayerState);
                updateFarmState(newFarmState);
                updateQuestProgress('upgrade_rod');
            }
        }
        
        function fish() {
            if (!deductEnergy(8)) return;

            const rodLevel = farmState.sharedRodLevel || 0;
            const probabilities = [[0.8, 0.15, 0.05], [0.6, 0.3, 0.1], [0.4, 0.4, 0.2], [0.2, 0.5, 0.3], [0.1, 0.4, 0.5]];
            const fishTypes = {
                'Common': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].rarity === 'Common'),
                'Uncommon': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].rarity === 'Uncommon'),
                'Rare': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].rarity === 'Rare'),
                'Legendary': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].rarity === 'Legendary')
            };
            const rand = Math.random();
            if (rodLevel > 2 && rand > 0.995) { 
                const possibleFish = fishTypes['Legendary'];
                const caughtFishId = possibleFish[Math.floor(Math.random() * possibleFish.length)];
                startFishingMinigame(caughtFishId);
                return;
            }

            let caughtRarity = rand < probabilities[rodLevel][0] ? 'Common' : (rand < probabilities[rodLevel][0] + probabilities[rodLevel][1] ? 'Uncommon' : 'Rare');
            const possibleFish = fishTypes[caughtRarity];
            const caughtFishId = possibleFish[Math.floor(Math.random() * possibleFish.length)];
            startFishingMinigame(caughtFishId);
        }

        function showFishCatchModal(fishId) {
            const fishData = GAME_DATA[fishId];
            document.getElementById('fish-catch-title').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏Å‡πÑ‡∏î‡πâ ${fishData.name}!`;
            const iconEl = document.getElementById('fish-catch-icon');
            iconEl.style.backgroundImage = `url(${fishData.imageUrl})`;
            const rarityEl = document.getElementById('fish-catch-rarity');
            rarityEl.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏¢‡∏≤‡∏Å: ${fishData.rarity}`;
            let rarityColor = 'text-gray-600';
            if (fishData.rarity === 'Uncommon') rarityColor = 'text-green-600';
            if (fishData.rarity === 'Rare') rarityColor = 'text-purple-600';
            if (fishData.rarity === 'Legendary') rarityColor = 'text-yellow-500 font-bold';
            rarityEl.className = `${rarityColor} mb-4`;
            document.getElementById('fish-catch-modal').classList.remove('hidden');
        }
        
        let minigameLoopId = null;
        function startFishingMinigame(fishId) {
            const modal = document.getElementById('fishing-minigame-modal');
            modal.classList.remove('hidden');
            const track = document.getElementById('fishing-minigame-track'), fishEl = document.getElementById('fishing-minigame-fish'), barEl = document.getElementById('fishing-minigame-bar'), progressFill = document.getElementById('fishing-minigame-progress-fill');
            fishEl.textContent = 'üê†';
            const trackHeight = track.clientHeight, barHeight = 80;
            barEl.style.height = `${barHeight}px`;
            let fishPos = trackHeight / 2, barPos = trackHeight / 2, barVelocity = 0, progress = 30;
            let mouseDown = false;
            let fishTargetPos = Math.random() * (trackHeight - 20);
            const gameLoop = () => {
                if (mouseDown) barVelocity -= 1.2;
                barVelocity += 0.4; barVelocity *= 0.9; barPos += barVelocity;
                if (barPos < 0) barPos = 0; if (barPos > trackHeight - barHeight) barPos = trackHeight - barHeight;
                const fishData = GAME_DATA[fishId];
                let speed = 1.2;
                if(fishData.rarity === 'Uncommon') speed = 1.8;
                if(fishData.rarity === 'Rare') speed = 2.5;
                if(fishData.rarity === 'Legendary') speed = 3.5;

                if (Math.abs(fishTargetPos - fishPos) < 5 || Math.random() < 0.02) fishTargetPos = Math.random() * (trackHeight - 20);
                fishPos += (fishTargetPos - fishPos) * 0.1 * speed;
                if (fishPos > barPos && fishPos < barPos + barHeight) progress += 1.5; else progress -= 0.5;
                progress = Math.max(0, Math.min(100, progress));
                barEl.style.top = `${barPos}px`; fishEl.style.top = `${fishPos}px`; progressFill.style.height = `${progress}%`;
                if (progress >= 100) return endFishingMinigame(true, fishId);
                if (progress <= 0) return endFishingMinigame(false, null);
                minigameLoopId = requestAnimationFrame(gameLoop);
            };
            const area = document.getElementById('fishing-minigame-area');
            const startListener = () => mouseDown = true, endListener = () => mouseDown = false;
            area.addEventListener('mousedown', startListener); area.addEventListener('mouseup', endListener);
            area.addEventListener('touchstart', startListener, { passive: true }); area.addEventListener('touchend', endListener);
            const endFishingMinigame = (success, caughtFishId) => {
                cancelAnimationFrame(minigameLoopId);
                area.removeEventListener('mousedown', startListener); area.removeEventListener('mouseup', endListener);
                area.removeEventListener('touchstart', startListener); area.removeEventListener('touchend', endListener);
                modal.classList.add('hidden');
                if (success) {
                    const newPlayerState = { ...playerState };
                    newPlayerState.storageBin.push({ id: caughtFishId, quality: 0 });
                    updatePlayerState(newPlayerState);
                    showFishCatchModal(caughtFishId);
                    updateQuestProgress('fish');
                }
            };
            minigameLoopId = requestAnimationFrame(gameLoop);
        }
        
        function cook(recipeId, quantity) {
            const recipe = GAME_DATA.recipes[recipeId];
            if (!recipe || !farmState.ownedKitchenTools.includes(recipe.tool) || quantity <= 0) return;

            const newPlayerState = { ...playerState };
            
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö ---
            const tempStorageBin = [...newPlayerState.storageBin];
            const ingredientsUsed = [];
            let canCook = true;

            for (let i = 0; i < quantity; i++) {
                for (const ingredient of recipe.ingredients) {
                    const requiredKey = ingredient.id ? 'id' : 'category';
                    const requiredValue = ingredient.id || ingredient.category;
                    
                    const foundIndex = tempStorageBin.findIndex(item => {
                        const itemData = GAME_DATA[item.id];
                        return requiredKey === 'id' ? item.id === requiredValue : itemData?.category === requiredValue;
                    });

                    if (foundIndex > -1) {
                        ingredientsUsed.push(tempStorageBin.splice(foundIndex, 1)[0]);
                    } else {
                        canCook = false;
                        break;
                    }
                }
                if (!canCook) break;
            }
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

            if (canCook) {
                newPlayerState.storageBin = tempStorageBin; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏•‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠

                const newFarmState = { ...farmState };
                if (!newFarmState.kitchen) newFarmState.kitchen = { queue: [] };
                
                newFarmState.kitchen.queue.push({
                    recipeId: recipeId,
                    quantity: quantity,
                    startTime: Date.now(),
                    cookedBy: { uid: userId, nickname: playerState.nickname },
                    // ‡∏à‡∏î‡∏à‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ
                    ingredientQualities: ingredientsUsed.map(item => item.quality) 
                });

                updatePlayerState(newPlayerState);
                updateFarmState(newFarmState);
                hideCookingModal();
                updateQuestProgress('cook', quantity);
            } else {
                alert("‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠!");
            }
        }

        function collectCookedFood(queueIndex) {
            const newFarmState = JSON.parse(JSON.stringify(farmState));
            const newPlayerState = JSON.parse(JSON.stringify(playerState));
            if (!newFarmState.kitchen.queue[queueIndex]) return; 
            
            const job = newFarmState.kitchen.queue[queueIndex];
            const recipe = GAME_DATA.recipes[job.recipeId];

            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö ---
            const qualities = job.ingredientQualities || [];
            let averageQuality = 0;
            if (qualities.length > 0) {
                const totalIngredientsPerDish = recipe.ingredients.length;
                const totalQualitySum = qualities.reduce((a, b) => a + b, 0);
                // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ = ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏ô * ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏ô)
                averageQuality = Math.floor(totalQualitySum / (job.quantity * totalIngredientsPerDish));
            }
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
            
            for (let i = 0; i < job.quantity; i++) {
                // ‡πÉ‡∏ä‡πâ averageQuality ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ
                newPlayerState.storageBin.push({ id: recipe.resultId, quality: averageQuality });
            }

            newFarmState.kitchen.queue.splice(queueIndex, 1);
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }
        
        function restInPark() {
            if (!playerState) return;

            const numPlayers = Object.keys(parkPlayers).length;
            const restsToday = playerState.dailyRestCount || 0;
            const cooldownDuration = 5 * 60 * 1000;
            const timeSinceRest = Date.now() - (playerState.lastRestTime || 0);

            if (numPlayers >= 2 && restsToday < 5 && timeSinceRest >= cooldownDuration) {
                const newPlayerState = { ...playerState };
                newPlayerState.energy = Math.min(getMaxEnergy(), (newPlayerState.energy || 0) + 20);
                newPlayerState.dailyRestCount = (newPlayerState.dailyRestCount || 0) + 1;
                newPlayerState.lastRestTime = Date.now();
                updatePlayerState(newPlayerState);
            } else {
                console.log("Cannot rest now.");
            }
        }

		function takeNap() {
			if (!playerState || !farmState) return;

			const houseLevel = farmState.sharedHouseLevel || 0;
			if (houseLevel === 0) return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡πâ‡∏≤‡∏ô ‡∏á‡∏µ‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ

			const napsToday = playerState.dailyNapCount || 0;
			const timeSinceNap = Date.now() - (playerState.lastNapTime || 0);
			const cooldownDuration = 60 * 60 * 1000; // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
			const isEnergyFull = playerState.energy >= getMaxEnergy();

			if (napsToday < 5 && timeSinceNap >= cooldownDuration && !isEnergyFull) {
				const energyToRestore = 20 + ((houseLevel - 1) * 10);
				const newPlayerState = { ...playerState };

				newPlayerState.energy = Math.min(getMaxEnergy(), (newPlayerState.energy || 0) + energyToRestore);
				newPlayerState.dailyNapCount = napsToday + 1;
				newPlayerState.lastNapTime = Date.now();

				updatePlayerState(newPlayerState);
			}
		}

        function expandGrid(type) {
            const cost = calculateExpansionCost(type);
            const typeMap = {
                farm: { name: '‡πÅ‡∏õ‡∏•‡∏á', array: farmState.plots, newItem: { plantId: null } },
                animals: { name: '‡∏Ñ‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå', array: farmState.animals, newItem: { animalId: null } },
                factory: { name: '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', array: farmState.factories, newItem: { factoryId: null } }
            };
            const info = typeMap[type];
            if (!info) return;
            if (playerState.money >= cost) {
                showConfirmationModal(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠${info.name}‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${cost}üí∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
                    const newPlayerState = { ...playerState };
                    newPlayerState.money -= cost;
                    const newFarmState = { ...farmState };
                    info.array.push(info.newItem);
                    updatePlayerState(newPlayerState);
                    updateFarmState(newFarmState);
                });
            } else {
                alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            }
        }

        async function updateQuestProgress(action, amount = 1) {
            if (!farmState || !farmState.quests) return;
            const newFarmState = { ...farmState };
            let questsUpdated = false;
            ['daily', 'weekly'].forEach(type => {
                newFarmState.quests[type]?.forEach(quest => {
                    const questData = QUEST_DATA[type].find(q => q.id === quest.id);
                    if (questData?.action === action && quest.progress < questData.target) {
                        quest.progress = Math.min(quest.progress + amount, questData.target);
                        questsUpdated = true;
                    }
                });
            });
            if (questsUpdated) await updateFarmState(newFarmState);
        }

        async function claimQuestReward(type, id) {
            const quest = farmState.quests[type].find(q => q.id === id);
            const questData = QUEST_DATA[type].find(q => q.id === id);
            if (!quest || !questData || quest.claimedBy?.includes(userId) || quest.progress < questData.target) return;

            const newFarmState = { ...farmState };
            const questToUpdate = newFarmState.quests[type].find(q => q.id === id);
            if (!questToUpdate.claimedBy) questToUpdate.claimedBy = [];
            questToUpdate.claimedBy.push(userId);

            const newPlayerState = { ...playerState };
            const { reward } = questData;
            let rewardId = reward.id === 'random' && reward.type === 'seed' 
                ? Object.keys(GAME_DATA).filter(k => GAME_DATA[k].type === 'seed')[Math.floor(Math.random() * Object.keys(GAME_DATA).filter(k => GAME_DATA[k].type === 'seed').length)] 
                : reward.id;
            
			if (reward.type === 'produce') {
                 for (let i = 0; i < reward.count; i++) newPlayerState.storageBin.push({ id: rewardId, quality: 0 });
            } else { 
                newPlayerState.inventory[rewardId] = (newPlayerState.inventory[rewardId] || 0) + reward.count;
            }
            
            await updateFarmState(newFarmState);
            await updatePlayerState(newPlayerState);
        }
        
        let gameLoopInterval = null;
        let logicInterval = null;
        let resetSchedulerStarted = false;
        async function startGame(uid, initialPlayerState) {
            userId = uid;
            playerState = initialPlayerState; // <--- 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            initAdminPanel(uid, initialPlayerState); // <--- 3. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÉ‡∏´‡πâ initAdminPanel
            initPlayerListeners(uid);
            initFarmListeners();
			setTimeout(async () => {
                if (uid === ADMIN_UID) {
                    await runOneTimeWeeklyQuestFix();
                }
            }, 2000); 
            document.getElementById('loading-screen').classList.add('loading-hidden');
            document.getElementById('game-container').style.opacity = 1;
            document.getElementById('footer-nav').style.opacity = 1;

            if (gameLoopInterval) clearInterval(gameLoopInterval);
            if (logicInterval) clearInterval(logicInterval);

            gameLoopInterval = setInterval(renderAll, 2000);
            logicInterval = setInterval(() => {
                processFactoryQueuesToOutputBin(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
            }, 10000); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        }

        function initPlayerListeners(uid) {
            const playerDocRef = doc(db, "players", uid);
            onSnapshot(playerDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    playerState = docSnap.data();
                    if (!playerState.produceBin) playerState.produceBin = [];
                    if (!playerState.storageBin) playerState.storageBin = [];
                    if (typeof playerState.houseLevel === 'undefined') playerState.houseLevel = 0;
                    if (typeof playerState.fishingRodLevel === 'undefined') playerState.fishingRodLevel = 0;
                    if (typeof playerState.energy === 'undefined') playerState.energy = 100;
                }
            }, handleFirestoreError);
        }
        
        function initFarmListeners() {
            const farmDocRef = doc(db, "publicFarmData", "farmState");
            onSnapshot(farmDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    farmState = docSnap.data();
					if (!farmState.currentWeather) {
                        farmState.currentWeather = 'sunny';
					}
                    if (!farmState.quests) farmState.quests = { daily: [], weekly: [], lastDailyReset: 0, lastWeeklyReset: 0 };
                    if (!farmState.ownedKitchenTools) farmState.ownedKitchenTools = [];
                    if (!farmState.factories) farmState.factories = Array(FACTORY_GRID_SIZE).fill(null).map(() => ({ factoryId: null }));
                    if (!farmState.kitchen) farmState.kitchen = { queue: [] };
                    if (!farmState.marketPrices) farmState.marketPrices = {};
                    if (!farmState.salesVolume) farmState.salesVolume = {};
                }
            }, handleFirestoreError);
        }
        
        async function ensureFarmDataExists() {
            const farmDocRef = doc(db, "publicFarmData", "farmState");
            try {
                const farmSnap = await getDoc(farmDocRef);
                if (!farmSnap.exists()) {
                    console.log("Farm data not found, creating initial state...");
                    const initialFarmState = {
                        plots: Array(FARM_GRID_SIZE).fill(null).map(() => ({ plantId: null })),
                        animals: Array(ANIMAL_PEN_SIZE).fill(null).map(() => ({ animalId: null })),
                        factories: Array(FACTORY_GRID_SIZE).fill(null).map(() => ({ factoryId: null, queue: [], outputBin: [] })),
                        quests: { daily: generateRandomQuests('daily', 5), weekly: generateRandomQuests('weekly', 5), lastDailyReset: Date.now(), lastWeeklyReset: Date.now() },
                        ownedKitchenTools: [],
                        kitchen: { queue: [] },
                        marketPrices: {},
                        salesVolume: {},
                        sharedHouseLevel: 0,
                        sharedRodLevel: 0,
						currentWeather: 'sunny',
                    };
                    await setDoc(farmDocRef, initialFarmState);
                }
            } catch (error) {
                console.warn("Could not ensure farm data existence.", error.message);
                throw error;
            }
        }
        
        function handleFirestoreError(error) { console.error("Firestore connection error:", error); }
        
        let isInitialNameSetup = false;
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        
        async function initializeVersionChecker() {
            const versionDocRef = doc(db, "game_config", "version");
            onSnapshot(versionDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const latestVersion = docSnap.data().current_version;
                    console.log(`Client version: ${CLIENT_VERSION}, Latest version: ${latestVersion}`);
                    if (latestVersion !== CLIENT_VERSION) {
                        console.warn("Version mismatch! Forcing update.");
                        showUpdateRequiredModal();
                    }
                }
            }, (error) => {
                console.error("Could not check for game version:", error);
            });
        }

        function showUpdateRequiredModal() {
            const modal = document.getElementById('update-required-modal');
            if (modal) {
                modal.classList.remove('hidden');
            }
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('footer-nav').style.display = 'none';
        }

        function scheduleNextMidnightReset() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);

            const msUntilMidnight = tomorrow.getTime() - now.getTime();
            console.log(`Next reset scheduled in ${formatTime(msUntilMidnight / 1000)}`);

            setTimeout(() => {
                console.log("Midnight reset triggered!");
                checkForTimeResets();
                scheduleNextMidnightReset();
            }, msUntilMidnight);
        }

        function setupControls() {
            const moreModal = document.getElementById('more-modal');
            const moreBtn = document.getElementById('more-btn');
            const moreModalItems = document.getElementById('more-modal-items');
            const primaryViews = ['farm', 'animals', 'shop',];
            const secondaryViews = [
                { view: 'bedroom', name: '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô üõå' },
                { view: 'fishing', name: '‡∏ö‡πà‡∏≠‡∏õ‡∏•‡∏≤ üé£' },
                { view: 'kitchen', name: '‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß üç≥' },
                { view: 'factory', name: '‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô üè≠' },
                { view: 'quests', name: '‡πÄ‡∏Ñ‡∏ß‡∏™ üìú' },
                { view: 'market', name: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î üìà' },
                { view: 'park', name: '‡∏™‡∏ß‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ üå≥' },
				{ view: 'storage', name: '‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á üì¶' }
            ];

            moreModalItems.innerHTML = '';
            secondaryViews.forEach(secView => {
                const button = document.createElement('button');
                button.textContent = secView.name;
                button.dataset.view = secView.view;
                button.className = 'w-full text-left font-bold py-3 px-4 rounded-lg transition bg-gray-100 hover:bg-green-100 text-gray-800';
                moreModalItems.appendChild(button);
            });
            
            let currentView = 'farm';

            document.addEventListener('click', e => {
                const target = e.target.closest('[data-view]');
                if (!moreModal.classList.contains('hidden') && !e.target.closest('#more-modal > div') && !e.target.closest('#more-btn')) {
                    moreModal.classList.add('hidden');
                }
                if (!target) return;
                const view = target.dataset.view;
                
                if (currentView === 'park' && view !== 'park') {
                    if(userId) leavePark(userId);
                }

                if (view === 'more') {
                    moreModal.classList.toggle('hidden');
                    return;
                }
                document.querySelectorAll('#tab-content-area > div').forEach(div => div.classList.add('hidden'));
                const viewEl = document.getElementById(`${view}-view`);
                if (viewEl) viewEl.classList.remove('hidden');

                if (view === 'park') {
                    if(userId && playerState) enterPark(userId, playerState);
                }
                currentView = view;

                document.querySelectorAll('#footer-nav .nav-btn').forEach(b => b.classList.remove('active'));
                
                const primaryBtn = document.querySelector(`.nav-btn[data-view="${view}"]`);
                if (primaryViews.includes(view) && primaryBtn) {
                    primaryBtn.classList.add('active');
                } else if (secondaryViews.some(sv => sv.view === view)) {
                    moreBtn.classList.add('active');
                }
                if (view !== 'more') moreModal.classList.add('hidden');
            });
            document.querySelector('.nav-btn[data-view="farm"]').classList.add('active');
            
            document.getElementById('context-modal-close').onclick = hideContextMenu;
            document.getElementById('submenu-modal-close').onclick = hideSubMenu;

            const shopItemsEl = document.getElementById('shop-items');
            if (shopItemsEl) shopItemsEl.addEventListener('click', (e) => {
                const button = e.target.closest('.buy-btn');
                if (button && !button.disabled) {
                    const itemId = button.dataset.itemid;
                    const itemData = GAME_DATA[itemId];
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ
                    const maxAffordable = itemData.cost > 0 ? Math.floor(playerState.money / itemData.cost) : 999;

                    if (maxAffordable === 0) {
                        alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ");
                        return;
                    }

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Action ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    const buyAction = (quantityToBuy) => {
                        buyItem(itemId, quantityToBuy);
                    };
                    
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Modal
                    showQuantityModal({
                        title: `‡∏ã‡∏∑‡πâ‡∏≠ ${itemData.name}`,
                        itemId: itemId,
                        maxQuantity: maxAffordable,
                        onConfirm: buyAction
                    });
                }
            });

            const storageItemsEl = document.getElementById('storage-items');
            if(storageItemsEl) storageItemsEl.addEventListener('click', e => {
                const button = e.target.closest('button'); // <--- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ
                if (!button || !button.dataset.itemId) return; // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏î‡∏Å‡∏∏‡∏°‡∏Ç‡∏∂‡πâ‡∏ô

                const itemId = button.dataset.itemId;
                const quality = parseInt(button.dataset.quality, 10);

                if (button.classList.contains('sell-storage-btn')) {
                    const maxQuantity = parseInt(button.dataset.max, 10);
                    const sellAction = (quantityToSell) => {
                        sellFromStorage(itemId, quality, quantityToSell);
                    };
                    showQuantityModal({
                        title: `‡∏Ç‡∏≤‡∏¢ ${GAME_DATA[itemId].name}`,
                        itemId: itemId,
                        quality: quality,
                        maxQuantity: maxQuantity,
                        onConfirm: sellAction
                    });
                } 
                else if (button.classList.contains('eat-storage-btn')) {
                    eatFromStorage(itemId, quality);
                } 
                else if (button.classList.contains('move-to-inventory-btn')) {
                    moveFromStorageToInventory(itemId, quality);
                }
            });

            const recipeListEl = document.getElementById('recipe-list');
            if(recipeListEl) recipeListEl.addEventListener('click', e => {
                if (e.target.classList.contains('cook-recipe-btn')) {
                     const button = e.target;
                     const recipeId = button.dataset.recipeId;
                     const quantityInput = button.previousElementSibling;
                     const quantity = parseInt(quantityInput.value, 10);
                     cook(recipeId, quantity);
                }
            });
            
            document.getElementById('upgrade-house-btn').onclick = upgradeHouse;
            document.getElementById('admin-reset-btn').onclick = forceResetFarm;
			document.getElementById('admin-force-sell-btn').onclick = forceSellAllPlayersItems;
            document.getElementById('reset-player-btn').onclick = resetPlayerProgress;
            
            document.getElementById('fish-btn').onclick = () => {
                const fishBtn = document.getElementById('fish-btn');
                if (fishBtn.disabled) return;
                fishBtn.disabled = true;
                fish();
                setTimeout(() => {
                    if (playerState && playerState.energy >= 8) {
                        fishBtn.disabled = false;
                    }
                }, 1000);
            };

            document.getElementById('upgrade-rod-btn').onclick = upgradeRod;
            document.getElementById('fish-catch-ok').onclick = () => document.getElementById('fish-catch-modal').classList.add('hidden');
            document.getElementById('cook-btn').onclick = showCookingModal;
            document.getElementById('cooking-modal-close').onclick = hideCookingModal;
            document.getElementById('cookable-filter-toggle').addEventListener('change', renderRecipeList);
            document.getElementById('rest-btn').onclick = restInPark;
            document.getElementById('rest-btn').onclick = restInPark;
			document.getElementById('nap-btn').onclick = takeNap;
            playerNameEl.onclick = () => showNameModal(false);
            document.getElementById('save-name-btn').onclick = saveNameChange;
            document.getElementById('cancel-name-btn').onclick = hideNameModal;
            nameInput.onkeypress = (e) => { if (e.key === 'Enter') saveNameChange(); };
            document.getElementById('confirm-modal-cancel').onclick = hideConfirmationModal;
            document.body.addEventListener('click', e => {
                if (e.target.classList.contains('claim-quest-btn')) {
                    claimQuestReward(e.target.dataset.questType, e.target.dataset.questId);
                }
            });
            document.getElementById('info-modal-close').onclick = hideInfoModal;
            document.getElementById('info-modal').onclick = (e) => {
                // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏î‡∏≥‡πÅ‡∏•‡πâ‡∏ß Modal ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ
                if (e.target.id === 'info-modal') {
                    hideInfoModal();
                }
            };
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ---


            // --- ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏® ---
            const weatherDisplay = document.getElementById('weather-display');
            if (weatherDisplay) {
                weatherDisplay.onclick = () => {
                    if (farmState && farmState.currentWeather) {
                        const weather = WEATHER_DATA[farmState.currentWeather];
                        if (weather) {
                            showInfoModal(weather.icon, weather.name, weather.description);
                        }
                    }
                };
            }
			
            document.getElementById('force-refresh-btn').onclick = () => {
                document.getElementById('force-refresh-btn').disabled = true;
                document.getElementById('force-refresh-btn').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...";
                location.reload();
            };
        }
        
        function buyItem(itemId, quantity = 1) {
            const itemData = GAME_DATA[itemId];
            const totalCost = itemData.cost * quantity;

            if (playerState.money >= totalCost) {
                const newPlayerState = { ...playerState };
                newPlayerState.money -= totalCost;
                
                if (itemData.type === 'kitchen_tool') {
                    const newFarmState = { ...farmState };
                    if (!newFarmState.ownedKitchenTools) newFarmState.ownedKitchenTools = [];
                    if (!newFarmState.ownedKitchenTools.includes(itemId)) {
                        newFarmState.ownedKitchenTools.push(itemId);
                        updateFarmState(newFarmState);
                    }
                } else if (itemData.type === 'animal_deed' || itemData.type === 'factory_deed') {
                    if (!newPlayerState.storageBin) newPlayerState.storageBin = [];
                    for (let i = 0; i < quantity; i++) {
                        newPlayerState.storageBin.push({ id: itemId, quality: 0 });
                    }
                } else {
                   newPlayerState.inventory[itemId] = (newPlayerState.inventory[itemId] || 0) + quantity;
                }
                
                updateQuestProgress('buy_item', quantity);
                updateQuestProgress('spend_money', totalCost);
                if (itemData.type === 'seed') updateQuestProgress('buy_seed', quantity);
                if (itemData.type === 'item' && itemId.includes('fertilizer')) updateQuestProgress('buy_fertilizer', quantity);
                if (itemData.type === 'animal_deed') updateQuestProgress('buy_animal', quantity);
                if (itemData.type === 'kitchen_tool' || itemData.type === 'factory_deed') updateQuestProgress('buy_tool', quantity);

                updatePlayerState(newPlayerState);
            } else {
                alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            }
        }

        function showConfirmationModal(text, onConfirm) {
            const confirmModal = document.getElementById('confirm-modal');
            document.getElementById('confirm-modal-text').textContent = text;
            const okButton = document.getElementById('confirm-modal-ok');
            const newOkButton = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(newOkButton, okButton);
            newOkButton.addEventListener('click', () => {
                onConfirm();
                hideConfirmationModal();
            });
            confirmModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }
        
        const showNameModal = (isInitial = false) => {
            isInitialNameSetup = isInitial;
            nameInput.value = isInitial ? '' : playerState.nickname;
            nameModal.classList.remove('hidden');
            nameModal.querySelector('div').classList.add('modal-enter');
            nameInput.focus();
            document.getElementById('cancel-name-btn').style.display = isInitial ? 'none' : 'inline-block';
            document.getElementById('name-modal-title').textContent = isInitial ? "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" : "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô";
        };
        const hideNameModal = () => {
            const modalContent = nameModal.querySelector('div');
            modalContent.classList.add('modal-leave');
            setTimeout(() => nameModal.classList.add('hidden'), 200);
        };
        const saveNameChange = async () => {
            const newName = nameInput.value.trim();
            if (newName.length > 0 && newName.length <= 15) {
                if (isInitialNameSetup) {
                    playerState = { 
                        money: 20, inventory: {}, produceBin: [], storageBin: [],
                        nickname: newName, houseLevel: 0, lastResetTime: 0,
                        fishingRodLevel: 0, energy: 100,
                        dailyRestCount: 0, lastRestTime: 0,
						dailyNapCount: 0, lastNapTime: 0
                    };
                    await setDoc(doc(db, "players", userId), playerState);
                    await startGame(userId);
                } else {
                    await updatePlayerState({...playerState, nickname: newName});
                }
                hideNameModal();
            }
        };
        
        window.addEventListener('load', async () => {
            setupControls();
            initParkSystem();
            try {
                 await setPersistence(auth, browserLocalPersistence);
                 onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        initializeVersionChecker();
                        
                        const playerDocRef = doc(db, "players", userId);
                        try {
                            await ensureFarmDataExists();
                            const docSnap = await getDoc(playerDocRef);
                            if (docSnap.exists()) {
                                const initialPlayerState = docSnap.data(); // <-- 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
                                await startGame(userId, initialPlayerState); // <-- 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô startGame
                            } else {
                                document.getElementById('loading-screen').classList.add('loading-hidden');
                                showNameModal(true);
                            }
                            
                            if (!resetSchedulerStarted) {
                                checkForTimeResets();
                                scheduleNextMidnightReset();
                                resetSchedulerStarted = true;
                            }

                        } catch (error) { handleFirestoreError(error); }
                    } else { await signInAnonymously(auth); }
                });
            } catch (error) { 
                console.error("Authentication failed:", error); 
                document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>`;
            }
        });
    </script>
</body>
</html>