<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'IBM Plex Sans Thai', sans-serif; 
            touch-action: manipulation; 
            background: linear-gradient(to bottom, #a7f3d0, #f0fdf4);
        }
        .plot, .animal-slot, .factory-slot { 
            transition: all 0.2s ease-in-out; 
            background-size: contain; 
            background-position: center; 
            background-repeat: no-repeat; 
            image-rendering: pixelated; /* For pixel art style */
        }
        .plot:hover, .animal-slot:hover, .factory-slot:hover { transform: scale(1.05); }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .modal-enter { animation: fadeIn 0.2s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.2s ease-out forwards; }

        @keyframes pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .pop-animation { animation: pop 0.3s ease-out; }

        @keyframes water-effect {
            0% { background-color: rgba(59, 130, 246, 0); }
            50% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: rgba(59, 130, 246, 0); }
        }
        .watered { animation: water-effect 0.5s ease-out; }

        @keyframes fertilize-effect {
            0% { box-shadow: 0 0 0 0px rgba(139, 69, 19, 0); }
            50% { box-shadow: 0 0 15px 5px rgba(139, 69, 19, 0.5); }
            100% { box-shadow: 0 0 0 0px rgba(139, 69, 19, 0); }
        }
        .fertilized { animation: fertilize-effect 0.6s ease-out; }

        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animal.happy { animation: hop 0.5s infinite; }

        body { padding-bottom: 80px; }
        .nav-btn.active { background-color: #15803d; color: white; border-top: 4px solid #facc15; }
        .quality-star { color: #facc15; text-shadow: 0 0 2px black; }
        .loading-hidden { opacity: 0; pointer-events: none; }
        
        #bedroom-display, #pond-display, #kitchen-display {
            background-size: cover;
            background-position: center;
        }
        #pond-display {
            background-image: url('sea.png');
        }
        #kitchen-display {
            background-image: url('kitchen.png');
        }

        /* Fishing Minigame Styles */
        #fishing-minigame-track {
            height: 300px;
            width: 50px;
            background-color: rgba(100, 150, 255, 0.3);
            border: 2px solid #4A90E2;
            border-radius: 10px;
            position: relative;
        }
        #fishing-minigame-fish {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 20px;
            font-size: 20px;
            text-align: center;
            transition: top 0.1s linear;
        }
        #fishing-minigame-bar {
            position: absolute;
            left: 0;
            width: 100%;
            background-color: rgba(26, 179, 148, 0.5);
            border: 2px solid #1ab394;
            border-radius: 8px;
        }
        #fishing-minigame-progress {
            width: 20px;
            height: 100%;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        #fishing-minigame-progress-fill {
            width: 100%;
            background-color: #f8ac59;
            height: 0;
            transition: height 0.1s linear;
        }
    </style>
</head>
<body class="min-h-screen">
    
    <div id="loading-screen" class="fixed inset-0 bg-green-100 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-6xl animate-bounce">ü•ï</div>
        <p class="mt-4 text-2xl font-bold text-green-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°...</p>
    </div>

    <div id="modal-container">
        <div id="name-modal" class="hidden fixed inset-0 bg-black/50 z-[52] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter">
                <h2 id="name-modal-title" class="text-2xl font-bold text-gray-800 mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</h2>
                <p class="text-gray-600 mb-4">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</p>
                <input type="text" id="name-input" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" maxlength="15">
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-name-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="save-name-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>

        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 z-[53] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏¢‡∏∑‡∏ô‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h2>
                <p id="confirm-modal-text" class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="confirm-modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="confirm-modal-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </div>
        </div>

        <div id="context-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div id="context-modal-content" class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-xs text-center">
                <h3 id="context-modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <div id="context-modal-actions" class="flex flex-col gap-3"></div>
                <button id="context-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
         <div id="submenu-modal" class="hidden fixed inset-0 bg-black/60 z-[51] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-md">
                <h3 id="submenu-modal-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h3>
                <div id="submenu-modal-items" class="grid grid-cols-3 gap-3 text-center"></div>
                <button id="submenu-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
        </div>
        <div id="more-modal" class="hidden fixed inset-0 bg-black/50 z-[51] flex items-end justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-4 w-full max-w-md mb-20 modal-enter">
                <div id="more-modal-items" class="flex flex-col gap-3">
                    </div>
            </div>
        </div>
        <div id="fish-catch-modal" class="hidden fixed inset-0 bg-black/60 z-[54] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center modal-enter">
                <h2 id="fish-catch-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                <div id="fish-catch-icon" class="text-5xl mb-4 h-16 w-16 mx-auto bg-contain bg-no-repeat bg-center"></div>
                <p class="text-gray-600 mb-4" id="fish-catch-rarity"></p>
                <button id="fish-catch-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</button>
            </div>
        </div>
        <div id="fishing-minigame-modal" class="hidden fixed inset-0 bg-black/60 z-[55] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 flex items-center justify-center gap-4 cursor-pointer" id="fishing-minigame-area">
                <div id="fishing-minigame-progress">
                    <div id="fishing-minigame-progress-fill"></div>
                </div>
                <div id="fishing-minigame-track">
                    <div id="fishing-minigame-bar"></div>
                    <div id="fishing-minigame-fish"></div>
                </div>
            </div>
        </div>
        <div id="cooking-modal" class="hidden fixed inset-0 bg-black/60 z-[52] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg modal-enter">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">‡∏ï‡∏≥‡∏£‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ üìñ</h2>
                <div id="recipe-list" class="max-h-[60vh] overflow-y-auto space-y-3">
                    </div>
                 <button id="cooking-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <div id="game-container" class="w-full max-w-5xl mx-auto p-4 md:p-6 opacity-0 transition-opacity duration-500">
        <header class="text-center mb-4 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-4 relative">
            <button id="admin-reset-btn" class="hidden absolute top-2 right-2 bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-red-700">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≤‡∏£‡πå‡∏° (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</button>
             <button id="reset-player-btn" class="absolute bottom-1 right-2 bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-yellow-600">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏±‡∏ô</button>
            <h1 class="text-3xl md:text-4xl font-bold text-green-800">‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üíö</h1>
            <div class="mt-3 flex flex-wrap justify-center items-center gap-x-4 gap-y-2 text-sm text-gray-600">
                <div class="flex items-center justify-center gap-2 bg-green-100 px-3 py-1 rounded-full">
                    <span>‡∏ä‡∏∑‡πà‡∏≠:</span>
                    <span id="player-name" class="font-bold text-green-900 cursor-pointer hover:underline" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠">...</span>
                </div>
                <span class="font-semibold bg-yellow-100 px-3 py-1 rounded-full">üí∞: <span id="money-display" class="font-bold text-yellow-800">0</span></span>
                <div class="flex items-center justify-center gap-2 bg-blue-100 px-3 py-1 rounded-full text-sm">
                    <span>‚ö°:</span>
                    <div class="w-24 bg-gray-200 rounded-full h-4">
                        <div id="energy-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-500"></div>
                    </div>
                    <span id="energy-text" class="font-bold text-blue-800">0/0</span>
                </div>
            </div>
             <div id="inventory-display" class="mt-3 flex flex-wrap justify-center items-center gap-x-3 gap-y-1 text-xs text-gray-500"></div>
             <div id="user-id-display" class="mt-2 text-xs text-gray-400 break-all"></div>
        </header>

        <main id="tab-content-area" class="bg-white/60 backdrop-blur-sm rounded-2xl shadow-inner p-4 min-h-[400px]">
            <div id="farm-view">
                <div id="farm-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-2 md:gap-4 flex-grow"></div>
            </div>
            <div id="animals-view" class="hidden">
                 <div id="animal-pen" class="grid grid-cols-3 sm:grid-cols-4 gap-2 md:gap-4"></div>
            </div>
             <div id="factory-view" class="hidden">
                <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏õ‡∏£‡∏£‡∏π‡∏õ üè≠</h2>
                <div id="factory-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-2 md:gap-4"></div>
            </div>
            <div id="bedroom-view" class="hidden">
                 <div class="w-full max-w-2xl mx-auto text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-4">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üõå</h2>
                    <div id="bedroom-display" class="relative w-full aspect-[4/3] rounded-lg shadow-inner overflow-hidden"></div>
                    <div id="bedroom-info" class="mt-4">
                        <p class="text-lg">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö <span id="house-level" class="font-bold">0</span></p>
                        <button id="upgrade-house-btn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                            ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î
                        </button>
                    </div>
                 </div>
            </div>
             <div id="kitchen-view" class="hidden">
                 <div class="w-full max-w-2xl mx-auto text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-4">‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß üç≥</h2>
                    <div id="kitchen-display" class="relative w-full aspect-[4/3] rounded-lg shadow-inner overflow-hidden"></div>
                    <div id="cooking-queue-container" class="mt-4 space-y-3">
                        <h3 class="text-xl font-bold text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£...</h3>
                        <div id="cooking-queue-list" class="min-h-[50px]"></div>
                    </div>
                    <div class="mt-4">
                        <button id="cook-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-8 rounded-full transition">‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡∏£‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>
                    </div>
                 </div>
            </div>
             <div id="fishing-view" class="hidden">
                <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">‡∏ö‡πà‡∏≠‡∏õ‡∏•‡∏≤ üé£</h2>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div id="pond-display" class="w-full md:w-3/5 aspect-video rounded-lg shadow-inner"></div>

                    <div class="w-full md:w-2/5 flex flex-col items-center space-y-6">
                        <div class="w-full flex flex-col items-center">
                            <h3 class="font-bold text-lg">‡πÄ‡∏ö‡πá‡∏î‡∏ï‡∏Å‡∏õ‡∏•‡∏≤</h3>
                            <div id="rod-image" class="w-24 h-24 my-2 bg-contain bg-no-repeat bg-center"></div>
                            <p id="rod-level-text" class="text-sm font-semibold"></p>
                            <button id="upgrade-rod-btn" class="text-xs bg-green-500 text-white py-1 px-3 rounded-full mt-1 hover:bg-green-600 disabled:bg-gray-400"></button>
                            <button id="fish-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-full disabled:bg-gray-400">‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ (-8‚ö°)</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="quests-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">üìú ‡πÄ‡∏Ñ‡∏ß‡∏™‡∏Ç‡∏≠‡∏á‡∏ü‡∏≤‡∏£‡πå‡∏°</h2>
                    <div id="daily-quests-container" class="mb-6">
                        <h3 class="text-xl font-bold text-blue-700 mb-2">‡πÄ‡∏Ñ‡∏ß‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</h3>
                        <div id="daily-quests-list" class="space-y-2">
                            </div>
                    </div>
                    <div id="weekly-quests-container">
                        <h3 class="text-xl font-bold text-purple-700 mb-2">‡πÄ‡∏Ñ‡∏ß‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h3>
                        <div id="weekly-quests-list" class="space-y-2">
                            </div>
                    </div>
                </div>
            </div>
            <div id="shop-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á</h2>
                    <div id="storage-container" class="mb-6">
                        <h3 class="text-xl font-bold text-green-700 mb-2 text-center">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á üì¶</h3>
                        <div id="storage-items" class="min-h-[100px] max-h-[200px] overflow-y-auto space-y-2 p-2 bg-yellow-50 rounded-lg">
                            <p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>
                        </div>
                    </div>
                    <div id="sell-box" class="mb-6 bg-yellow-100 p-4 rounded-xl border-2 border-dashed border-yellow-300">
                        <h3 class="text-xl font-bold text-yellow-800 mb-2 text-center">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á üì¨</h3>
                        <div id="sell-box-items" class="min-h-[50px] space-y-2">
                        </div>
                        <div class="mt-4 text-center">
                            <p class="font-semibold text-lg">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏£‡∏±‡∏ö: <span id="sell-box-total" class="font-bold">0</span>üí∞</p>
                            <p id="sell-countdown" class="text-sm text-gray-600 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤...</p>
                        </div>
                    </div>
                    <div id="shop-items" class="space-y-4"></div>
                </div>
            </div>
            
            <div id="market-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üìà</h2>
                    <div id="market-items-list" class="space-y-2 max-h-[60vh] overflow-y-auto bg-white/80 p-3 rounded-lg">
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <footer id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-[0_-4px_12px_rgba(0,0,0,0.05)] z-40 flex justify-around opacity-0 transition-opacity duration-500">
        <button data-view="farm" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏ü‡∏≤‡∏£‡πå‡∏°</button>
        <button data-view="animals" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏Ñ‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
        <button data-view="shop" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <button id="more-btn" data-view="more" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">... ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyDAc4bOydh3x9OFMI-ocbAIXDQc61qRcnc",
          authDomain: "my-farm-game-556f5.firebaseapp.com",
          projectId: "my-farm-game-556f5",
          storageBucket: "my-farm-game-556f5.appspot.com",
          messagingSenderId: "725056841274",
          appId: "1:725056841274:web:a2b0d5b0cb913c2a10f703",
          measurementId: "G-R0DJJ5KWD0"
        };
        //  ++++++++++++++++++++++++++++++++++++++++++++++++++++

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const FARM_GRID_SIZE = 24;
        const ANIMAL_PEN_SIZE = 8;
        const FACTORY_GRID_SIZE = 8;
        const ADMIN_UID = "p7Ujrm9dBZcL6bK5EHYEsrJOCvl2";

        // --- MASTER GAME DATA ---
        const GAME_DATA = {
            'house_upgrades': [
                { name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå', cost: 500, imageUrl: 'beadroom1.png' },
                { name: '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡πÑ‡∏°‡πâ', cost: 2500, imageUrl: 'beadroom2.png' },
                { name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏¥‡∏ê', cost: 10000, imageUrl: 'beadroom3.png' },
                { name: '‡∏Ñ‡∏§‡∏´‡∏≤‡∏™‡∏ô‡πå', cost: 50000, imageUrl: 'beadroom4.png' },
                { name: '‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó', cost: 0, imageUrl: 'beadroom5.png' }
            ],
            'fishing_rods': [
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÑ‡∏°‡πâ‡πÑ‡∏ú‡πà', cost: 0, imageUrl: 'rod1.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Å‡∏•‡∏≤‡∏™', cost: 2500, imageUrl: 'rod2.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏´‡∏•‡πá‡∏Å', cost: 7500, imageUrl: 'rod3.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡∏ó‡∏≠‡∏á', cost: 15000, imageUrl: 'rod4.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÉ‡∏ô‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', cost: 0, imageUrl: 'rod5.png' },
            ],
            'recipes': {
                'fried_egg': { resultId: 'fried_egg_food', ingredients: [{ category: 'egg' }], tool: 'kitchen_pan' },
                'sashimi': { resultId: 'sashimi_food', ingredients: [{ category: 'fish' }], tool: 'kitchen_knife' },
                'fruit_smoothie': { resultId: 'fruit_smoothie_food', ingredients: [{ category: 'fruit' }], tool: 'kitchen_blender' },
                'vegetable_juice': { resultId: 'vegetable_juice_food', ingredients: [{ category: 'vegetable' }], tool: 'kitchen_blender' },
                'salad': { resultId: 'salad_food', ingredients: [{ id: 'carrot_produce' }, { id: 'tomato_produce' }], tool: 'kitchen_knife' },
                'omelette': { resultId: 'omelette_food', ingredients: [{ id: 'egg' }, { id: 'milk' }], tool: 'kitchen_pan' },
                'fried_fish': { resultId: 'fried_fish_food', ingredients: [{ category: 'fish' }], tool: 'kitchen_pan' },
                'fruit_salad': { resultId: 'fruit_salad_food', ingredients: [{ category: 'fruit' }], tool: 'kitchen_knife' },
                'milkshake': { resultId: 'milkshake_food', ingredients: [{ id: 'milk' }, { category: 'fruit' }], tool: 'kitchen_blender' },
                'vegetable_soup': { resultId: 'vegetable_soup_food', ingredients: [{ category: 'vegetable' }, { category: 'vegetable' }], tool: 'kitchen_pot' },
                'spicy_fish_soup': { resultId: 'spicy_fish_soup_food', ingredients: [{ category: 'fish' }, { id: 'tomato_produce' }], tool: 'kitchen_pot' },
            },
            'fried_egg_food': { name: '‡πÑ‡∏Ç‡πà‡∏î‡∏≤‡∏ß', icon: 'üç≥', type: 'produce', sellPrice: [25, 35, 45], energyRestore: 15, imageUrl: 'fried_egg_food.png' },
            'sashimi_food': { name: '‡∏ã‡∏≤‡∏ä‡∏¥‡∏°‡∏¥', icon: 'üç£', type: 'produce', sellPrice: [50, 75, 95], energyRestore: 25, imageUrl: 'sashimi_food.png' },
            'fruit_smoothie_food': { name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏õ‡∏±‡πà‡∏ô', icon: 'ü•§', type: 'produce', sellPrice: [80, 100, 120], energyRestore: 30, imageUrl: 'fruit_smoothie_food.png' },
            'vegetable_juice_food': { name: '‡∏ô‡πâ‡∏≥‡∏ú‡∏±‡∏Å‡∏õ‡∏±‡πà‡∏ô', icon: 'üßÉ', type: 'produce', sellPrice: [40, 55, 70], energyRestore: 20, imageUrl: 'vegetable_juice_food.png' },
            'salad_food': { name: '‡∏™‡∏•‡∏±‡∏î', icon: 'ü•ó', type: 'produce', sellPrice: [50, 70, 90], energyRestore: 22, imageUrl: 'salad_food.png' },
            'omelette_food': { name: '‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß', icon: 'üç≥', type: 'produce', sellPrice: [60, 80, 100], energyRestore: 28, imageUrl: 'omelette_food.png' },
            'fried_fish_food': { name: '‡∏õ‡∏•‡∏≤‡∏ó‡∏≠‡∏î', icon: 'üêü', type: 'produce', sellPrice: [50, 65, 80], energyRestore: 20, imageUrl: 'fried_fish_food.png' },
            'fruit_salad_food': { name: '‡∏™‡∏•‡∏±‡∏î‡∏ú‡∏•‡πÑ‡∏°‡πâ', icon: 'üçì', type: 'produce', sellPrice: [65, 85, 110], energyRestore: 25, imageUrl: 'fruit_salad_food.png' },
            'milkshake_food': { name: '‡∏°‡∏¥‡∏•‡∏Ñ‡πå‡πÄ‡∏ä‡∏Ñ', icon: 'ü•õ', type: 'produce', sellPrice: [100, 125, 150], energyRestore: 40, imageUrl: 'milkshake_food.png' },
            'vegetable_soup_food': { name: '‡∏ã‡∏∏‡∏õ‡∏ú‡∏±‡∏Å', icon: 'ü•£', type: 'produce', sellPrice: [60, 80, 100], energyRestore: 25, imageUrl: 'vegetable_soup_food.png' },
            'spicy_fish_soup_food': { name: '‡∏ï‡πâ‡∏°‡∏¢‡∏≥‡∏õ‡∏•‡∏≤', icon: 'üå∂Ô∏è', type: 'produce', sellPrice: [180, 220, 260], energyRestore: 50, imageUrl: 'spicy_fish_soup_food.png' },
            'kitchen_knife': { name: '‡∏°‡∏µ‡∏î‡∏ó‡∏≥‡∏Ñ‡∏£‡∏±‡∏ß', type: 'kitchen_tool', cost: 1000, icon: 'üî™', imageUrl: 'knife.png' },
            'kitchen_pan': { name: '‡∏Å‡∏£‡∏∞‡∏ó‡∏∞', type: 'kitchen_tool', cost: 1500, icon: 'üç≥', imageUrl: 'pan.png' },
            'kitchen_blender': { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô', type: 'kitchen_tool', cost: 2000, icon: 'üå™Ô∏è', imageUrl: 'mixer.png' },
            'kitchen_pot': { name: '‡∏´‡∏°‡πâ‡∏≠', type: 'kitchen_tool', cost: 2000, icon: 'üç≤', imageUrl: 'pot.png' },
            'carp': { name: '‡∏õ‡∏•‡∏≤‡∏Ñ‡∏≤‡∏£‡πå‡∏õ', icon: 'üêü', rarity: 'Common', sellPrice: [15, 20, 25], type: 'produce', energyRestore: 3, imageUrl: 'carp.png', category: 'fish' },
            'sardine': { name: '‡∏õ‡∏•‡∏≤‡∏ã‡∏≤‡∏£‡πå‡∏î‡∏µ‡∏ô', icon: 'üê†', rarity: 'Common', sellPrice: [20, 25, 30], type: 'produce', energyRestore: 4, imageUrl: 'sardine.png', category: 'fish' },
            'tuna': { name: '‡∏õ‡∏•‡∏≤‡∏ó‡∏π‡∏ô‡πà‡∏≤', icon: 'üêü', rarity: 'Uncommon', sellPrice: [35, 50, 65], type: 'produce', energyRestore: 15, imageUrl: 'tuna.png', category: 'fish' },
            'salmon': { name: '‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô', icon: 'üê†', rarity: 'Uncommon', sellPrice: [45, 60, 80], type: 'produce', energyRestore: 18, imageUrl: 'salmon.png', category: 'fish' },
            'eel': { name: '‡∏õ‡∏•‡∏≤‡πÑ‡∏´‡∏•', icon: 'È∞ª', rarity: 'Rare', sellPrice: [150, 200, 250], type: 'produce', energyRestore: 30, imageUrl: 'eel.png', category: 'fish' },
            'pufferfish': { name: '‡∏õ‡∏•‡∏≤‡∏õ‡∏±‡∏Å‡πÄ‡∏õ‡πâ‡∏≤', icon: 'üê°', rarity: 'Rare', sellPrice: [200, 250, 300], type: 'produce', energyRestore: 35, imageUrl: 'pufferfish.png', category: 'fish' },
            'carrot_seed':   { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'seed', cost: 5, plantId: 'carrot', icon: 'ü•ï', imageUrl: 'carrot.png' },
            'carrot':        { name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'crop', growTime: 9600, produceId: 'carrot_produce', icon: 'ü•ï', imageUrl: 'carrot.png' },
            'carrot_produce':{ name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'produce', sellPrice: [8, 12, 16], icon: 'ü•ï', imageUrl: 'carrot.png', energyRestore: 2, category: 'vegetable' },
            'tomato_seed':   { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'seed', cost: 10, plantId: 'tomato', icon: 'üçÖ', imageUrl: 'tomato.png' },
            'tomato':        { name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'crop', growTime: 14400, produceId: 'tomato_produce', icon: 'üçÖ', imageUrl: 'tomato.png' },
            'tomato_produce':{ name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'produce', sellPrice: [18, 25, 35], icon: 'üçÖ', imageUrl: 'tomato.png', energyRestore: 3, category: 'vegetable' },
            'strawberry_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'seed', cost: 15, plantId: 'strawberry', icon: 'üçì', imageUrl: 'stawberry.png' },
            'strawberry':      { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'crop', growTime: 16800, produceId: 'strawberry_produce', icon: 'üçì', imageUrl: 'stawberry.png' },
            'strawberry_produce': { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'produce', sellPrice: [25, 35, 50], icon: 'üçì', imageUrl: 'stawberry.png', energyRestore: 4, category: 'fruit' },
            'grape_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'seed', cost: 20, plantId: 'grape', icon: 'üçá', imageUrl: 'grape.png' },
            'grape':      { name: '‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'crop', growTime: 21000, produceId: 'grape_produce', icon: 'üçá', imageUrl: 'grape.png' },
            'grape_produce': { name: '‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'produce', sellPrice: [35, 50, 70], icon: 'üçá', imageUrl: 'grape.png', energyRestore: 6, category: 'fruit' },
            'peach_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏µ‡∏ä', type: 'seed', cost: 25, plantId: 'peach', icon: 'üçë', imageUrl: 'peach.png' },
            'peach':      { name: '‡∏û‡∏µ‡∏ä', type: 'crop', growTime: 21600, produceId: 'peach_produce', icon: 'üçë', imageUrl: 'peach.png' },
            'peach_produce': { name: '‡∏û‡∏µ‡∏ä', type: 'produce', sellPrice: [45, 65, 90], icon: 'üçë', imageUrl: 'peach.png', energyRestore: 8, category: 'fruit' },
            'orange_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡πâ‡∏°', type: 'seed', cost: 30, plantId: 'orange', icon: 'üçä', imageUrl: 'orange.png' },
            'orange':      { name: '‡∏™‡πâ‡∏°', type: 'crop', growTime: 25200, produceId: 'orange_produce', icon: 'üçä', imageUrl: 'orange.png' },
            'orange_produce': { name: '‡∏™‡πâ‡∏°', type: 'produce', sellPrice: [55, 80, 110], icon: 'üçä', imageUrl: 'orange.png', energyRestore: 9, category: 'fruit' },
            'mango_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'seed', cost: 35, plantId: 'mango', icon: 'ü•≠', imageUrl: 'mango.png' },
            'mango':      { name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'crop', growTime: 28800, produceId: 'mango_produce', icon: 'ü•≠', imageUrl: 'mango.png' },
            'mango_produce': { name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'produce', sellPrice: [65, 95, 130], icon: 'ü•≠', imageUrl: 'mango.png', energyRestore: 11, category: 'fruit' },
            'pineapple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'seed', cost: 40, plantId: 'pineapple', icon: 'üçç', imageUrl: 'pineapple.png' },
            'pineapple':      { name: '‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'crop', growTime: 32400, produceId: 'pineapple_produce', icon: 'üçç', imageUrl: 'pineapple.png' },
            'pineapple_produce': { name: '‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'produce', sellPrice: [75, 110, 150], icon: 'üçç', imageUrl: 'pineapple.png', energyRestore: 12, category: 'fruit' },
            'guava_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'seed', cost: 18, plantId: 'guava', icon: 'üçà', imageUrl: 'guava.png' },
            'guava':      { name: '‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'crop', growTime: 22400, produceId: 'guava_produce', icon: 'üçà', imageUrl: 'guava.png' },
            'guava_produce': { name: '‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'produce', sellPrice: [30, 45, 65], icon: 'üçà', imageUrl: 'guava.png', energyRestore: 5, category: 'fruit' },
            'roseapple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'seed', cost: 22, plantId: 'roseapple', icon: 'üçê', imageUrl: 'chompu.png' },
            'roseapple':      { name: '‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'crop', growTime: 25600, produceId: 'roseapple_produce', icon: 'üçê', imageUrl: 'chompu.png' },
            'roseapple_produce': { name: '‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'produce', sellPrice: [40, 60, 85], icon: 'üçê', imageUrl: 'chompu.png', energyRestore: 7, category: 'fruit' },
            'apple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'seed', cost: 28, plantId: 'apple', icon: 'üçé', imageUrl: 'apple.png' },
            'apple':      { name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'crop', growTime: 32000, produceId: 'apple_produce', icon: 'üçé', imageUrl: 'apple.png' },
            'apple_produce': { name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'produce', sellPrice: [50, 75, 105], icon: 'üçé', imageUrl: 'apple.png', energyRestore: 10, category: 'fruit' },
            'fertilizer_1': { name: '‡∏õ‡∏∏‡πã‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤', type: 'item', cost: 10, qualityBonus: 0.3, icon: 'üí©', imageUrl: 'manure.png' },
            'fertilizer_2': { name: '‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ', type: 'item', cost: 25, qualityBonus: 0.6, icon: '‚ú®', imageUrl: 'fertilizer.png' },
            'chicken_deed': { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏Å‡πà', type: 'animal_deed', cost: 100, animalId: 'chicken', icon: 'üêî', imageUrl: 'chicken.png' },
            'chicken':      { name: '‡πÑ‡∏Å‡πà', type: 'animal_instance', produceTime: 600, produceId: 'egg', icon: 'üêî', imageUrl: 'chicken.png' },
            'egg':          { name: '‡πÑ‡∏Ç‡πà', type: 'produce', sellPrice: [12, 18, 25], icon: 'ü•ö', imageUrl: 'egg.png', energyRestore: 5, category: 'egg' },
            'cow_deed':     { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡∏±‡∏ß', type: 'animal_deed', cost: 500, animalId: 'cow', icon: 'üêÑ', imageUrl: 'cow.png' },
            'cow':          { name: '‡∏ß‡∏±‡∏ß', type: 'animal_instance', produceTime: 3600, produceId: 'milk', icon: 'üêÑ', imageUrl: 'cow.png' },
            'milk':         { name: '‡∏ô‡∏°', type: 'produce', sellPrice: [50, 70, 90], icon: 'ü•õ', imageUrl: 'milk.png', energyRestore: 10, category: 'milk' },
            'duck_deed':    { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏î', type: 'animal_deed', cost: 120, animalId: 'duck', icon: 'ü¶Ü', imageUrl: 'duck.png' },
            'duck':         { name: '‡πÄ‡∏õ‡πá‡∏î', type: 'animal_instance', produceTime: 900, produceId: 'duck_egg', icon: 'ü¶Ü', imageUrl: 'duck.png' },
            'duck_egg':     { name: '‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏î', type: 'produce', sellPrice: [15, 22, 30], icon: 'ü•ö', imageUrl: 'egg_duck.png', energyRestore: 6, category: 'egg' },
            'goose_deed':   { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡πà‡∏≤‡∏ô', type: 'animal_deed', cost: 150, animalId: 'goose', icon: 'ü¶¢', imageUrl: 'swan.png' },
            'goose':        { name: '‡∏´‡πà‡∏≤‡∏ô', type: 'animal_instance', produceTime: 1800, produceId: 'feather', icon: 'ü¶¢', imageUrl: 'swan.png' },
            'feather':      { name: '‡∏Ç‡∏ô‡∏ô‡∏Å', type: 'produce', sellPrice: [25, 38, 55], icon: 'ü™∂', imageUrl: 'feather.png', energyRestore: 0 },
            'turtle_deed':  { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ï‡πà‡∏≤', type: 'animal_deed', cost: 1000, animalId: 'turtle', icon: 'üê¢', imageUrl: 'turtle.png' },
            'turtle':       { name: '‡πÄ‡∏ï‡πà‡∏≤', type: 'animal_instance', produceTime: 86400, produceId: 'gem', icon: 'üê¢', imageUrl: 'turtle.png' },
            'gem':          { name: '‡∏≠‡∏±‡∏ç‡∏°‡∏ì‡∏µ', type: 'produce', sellPrice: [200, 300, 500], icon: 'üíé', imageUrl: 'gem.png', energyRestore: 0 },
            'winery_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏´‡∏°‡∏±‡∏Å‡πÑ‡∏ß‡∏ô‡πå', type: 'factory_deed', cost: 15000, factoryId: 'winery', icon: 'üçá', imageUrl: 'winery.png' },
            'cheese_press_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏ó‡∏≥‡∏ä‡∏µ‡∏™', type: 'factory_deed', cost: 10000, factoryId: 'cheese_press', icon: 'üßÄ', imageUrl: 'cheese_press.png' },
            'preserves_jar_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏ó‡∏≥‡πÅ‡∏¢‡∏°', type: 'factory_deed', cost: 7500, factoryId: 'preserves_jar', icon: 'üçì', imageUrl: 'preserves_jar.png' },
            'mayonnaise_machine_deed': { name: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', type: 'factory_deed', cost: 5000, factoryId: 'mayonnaise_machine', icon: 'ü•ö', imageUrl: 'mayonnaise_machine.png' },
            'winery': {
                name: '‡πÇ‡∏£‡∏á‡∏´‡∏°‡∏±‡∏Å‡πÑ‡∏ß‡∏ô‡πå', type: 'factory_instance', imageUrl: 'winery.png',
                recipes: [ { id: 'grape_wine_recipe', name: '‡∏ó‡∏≥‡πÑ‡∏ß‡∏ô‡πå‡∏≠‡∏á‡∏∏‡πà‡∏ô', inputs: [{ id: 'grape_produce', count: 20 }], output: { id: 'grape_wine', count: 1 }, processTime: 7200 } ]
            },
            'cheese_press': {
                name: '‡πÇ‡∏£‡∏á‡∏ó‡∏≥‡∏ä‡∏µ‡∏™', type: 'factory_instance', imageUrl: 'cheese_press.png',
                recipes: [ { id: 'cheese_recipe', name: '‡∏ó‡∏≥‡∏ä‡∏µ‡∏™', inputs: [{ id: 'milk', count: 10 }], output: { id: 'cheese', count: 1 }, processTime: 6000 } ]
            },
            'preserves_jar': {
                name: '‡πÇ‡∏£‡∏á‡∏ó‡∏≥‡πÅ‡∏¢‡∏°', type: 'factory_instance', imageUrl: 'preserves_jar.png',
                recipes: [
                    { id: 'strawberry_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', inputs: [{ id: 'strawberry_produce', count: 15 }], output: { id: 'strawberry_jam', count: 1 }, processTime: 4800 },
                    { id: 'apple_jam_recipe', name: '‡∏ó‡∏≥‡πÅ‡∏¢‡∏°‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', inputs: [{ id: 'apple_produce', count: 15 }], output: { id: 'apple_jam', count: 1 }, processTime: 4800 }
                ]
            },
            'mayonnaise_machine': {
                name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', type: 'factory_instance', imageUrl: 'mayonnaise_machine.png',
                recipes: [
                    { id: 'mayonnaise_recipe', name: '‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', inputs: [{ id: 'egg', count: 5 }], output: { id: 'mayonnaise', count: 1 }, processTime: 3600 },
                    { id: 'duck_mayonnaise_recipe', name: '‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏î', inputs: [{ id: 'duck_egg', count: 5 }], output: { id: 'duck_mayonnaise', count: 1 }, processTime: 3600 }
                ]
            },
            'grape_wine': { name: '‡πÑ‡∏ß‡∏ô‡πå‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'produce', sellPrice: [800, 1200, 1600], icon: 'üç∑', energyRestore: 20, imageUrl: 'wine.png' },
            'cheese': { name: '‡∏ä‡∏µ‡∏™', type: 'produce', sellPrice: [600, 850, 1100], icon: 'üßÄ', energyRestore: 30, imageUrl: 'cheese.png' },
            'strawberry_jam': { name: '‡πÅ‡∏¢‡∏°‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'produce', sellPrice: [250, 350, 450], icon: 'üçì', energyRestore: 15, imageUrl: 'jam.png' },
            'apple_jam': { name: '‡πÅ‡∏¢‡∏°‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'produce', sellPrice: [300, 420, 550], icon: 'üçé', energyRestore: 18, imageUrl: 'jam_apple.png' },
            'mayonnaise': { name: '‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™', type: 'produce', sellPrice: [150, 200, 250], icon: 'ü•ö', energyRestore: 10, imageUrl: 'mayonnaise.png' },
            'duck_mayonnaise': { name: '‡∏°‡∏≤‡∏¢‡∏≠‡∏á‡πÄ‡∏ô‡∏™‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏î', type: 'produce', sellPrice: [180, 240, 300], icon: 'ü•ö', energyRestore: 12, imageUrl: 'mayonnaise_duck.png' },
        };
        const QUEST_DATA = {
            daily: [
                { id: 'water_25', action: 'water', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ 25 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 25, reward: { type: 'item', id: 'fertilizer_1', count: 3 } },
                { id: 'harvest_15', action: 'harvest', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï 15 ‡∏ä‡∏¥‡πâ‡∏ô', target: 15, reward: { type: 'seed', id: 'carrot_seed', count: 15 } },
                { id: 'fish_10', action: 'fish', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ 10 ‡∏ï‡∏±‡∏ß', target: 10, reward: { type: 'seed', id: 'tomato_seed', count: 8 } },
                { id: 'collect_5', action: 'collect_product', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå 5 ‡∏ä‡∏¥‡πâ‡∏ô', target: 5, reward: { type: 'item', id: 'fertilizer_1', count: 2 } },
                { id: 'cook_3', action: 'cook', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', target: 3, reward: { type: 'produce', id: 'egg', count: 5 } },
                { id: 'plant_10', action: 'plant', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏∑‡∏ä 10 ‡∏ï‡πâ‡∏ô', target: 10, reward: { type: 'seed', id: 'carrot_seed', count: 10 } },
                { id: 'fertilize_5', action: 'fertilize', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ 5 ‡πÅ‡∏õ‡∏•‡∏á', target: 5, reward: { type: 'item', id: 'fertilizer_1', count: 2 } },
                { id: 'fish_15_more', action: 'fish', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏õ‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å 15 ‡∏ï‡∏±‡∏ß', target: 15, reward: { type: 'produce', id: 'sardine', count: 5 } },
                { id: 'sell_item_10', action: 'sell_item', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡∏¢ 10 ‡∏ä‡∏¥‡πâ‡∏ô', target: 10, reward: { type: 'seed', id: 'strawberry_seed', count: 10 } },
                { id: 'collect_8_more', action: 'collect_product', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏û‡∏¥‡πà‡∏° 8 ‡∏ä‡∏¥‡πâ‡∏ô', target: 8, reward: { type: 'produce', id: 'duck_egg', count: 2 } },
                { id: 'cook_2_more', action: 'cook', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', target: 2, reward: { type: 'produce', id: 'sashimi_food', count: 1 } },
                { id: 'harvest_10_more', action: 'harvest', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏° 10 ‡∏ä‡∏¥‡πâ‡∏ô', target: 10, reward: { type: 'produce', id: 'carrot_produce', count: 5 } },
                { id: 'buy_item_5', action: 'buy_item', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ 5 ‡∏ä‡∏¥‡πâ‡∏ô', target: 5, reward: { type: 'seed', id: 'orange_seed', count: 5 } },
                { id: 'eat_2', action: 'eat', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏Å‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 2, reward: { type: 'produce', id: 'fried_egg_food', count: 1 } },
                { id: 'place_animal_1', action: 'place_animal', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ß‡∏≤‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏Å 1 ‡∏ï‡∏±‡∏ß', target: 1, reward: { type: 'seed', id: 'strawberry_seed', count: 15 } },
                { id: 'buy_seed_15', action: 'buy_seed', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå 15 ‡∏ñ‡∏∏‡∏á', target: 15, reward: { type: 'seed', id: 'grape_seed', count: 5 } },
                { id: 'buy_fertilizer_5', action: 'buy_fertilizer', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏õ‡∏∏‡πã‡∏¢ 5 ‡∏ä‡∏¥‡πâ‡∏ô', target: 5, reward: { type: 'seed', id: 'peach_seed', count: 5 } },
                { id: 'spend_250', action: 'spend_money', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô 250üí∞', target: 250, reward: { type: 'produce', id: 'tomato_produce', count: 5 } },
                { id: 'water_20_more', action: 'water', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏° 20 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 20, reward: { type: 'item', id: 'fertilizer_1', count: 3 } },
                { id: 'buy_animal_1', action: 'buy_animal', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå 1 ‡∏ï‡∏±‡∏ß', target: 1, reward: { type: 'seed', id: 'strawberry_seed', count: 5 } },
            ],
            weekly: [
                { id: 'harvest_100', action: 'harvest', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï 100 ‡∏ä‡∏¥‡πâ‡∏ô', target: 100, reward: { type: 'item', id: 'fertilizer_2', count: 5 } },
                { id: 'fish_50', action: 'fish', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ 50 ‡∏ï‡∏±‡∏ß', target: 50, reward: { type: 'seed', id: 'random', count: 20 } },
                { id: 'fertilize_30', action: 'fertilize', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢ 30 ‡πÅ‡∏õ‡∏•‡∏á', target: 30, reward: { type: 'seed', id: 'mango_seed', count: 15 } },
                { id: 'cook_10', action: 'cook', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 10 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', target: 10, reward: { type: 'produce', id: 'milk', count: 8 } },
                { id: 'collect_30', action: 'collect_product', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå 30 ‡∏ä‡∏¥‡πâ‡∏ô', target: 30, reward: { type: 'produce', id: 'gem', count: 1 } },
                { id: 'harvest_80_more', action: 'harvest', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏° 80 ‡∏ä‡∏¥‡πâ‡∏ô', target: 80, reward: { type: 'seed', id: 'apple_seed', count: 10 } },
                { id: 'plant_80', action: 'plant', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏∑‡∏ä 80 ‡∏ï‡πâ‡∏ô', target: 80, reward: { type: 'item', id: 'fertilizer_2', count: 8 } },
                { id: 'sell_item_100', action: 'sell_item', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏•‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡∏¢ 100 ‡∏ä‡∏¥‡πâ‡∏ô', target: 100, reward: { type: 'item', id: 'fertilizer_2', count: 15 } },
                { id: 'fish_40_more', action: 'fish', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ï‡∏Å‡∏õ‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 40 ‡∏ï‡∏±‡∏ß', target: 40, reward: { type: 'produce', id: 'salmon', count: 10 } },
                { id: 'collect_25_more', action: 'collect_product', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏û‡∏¥‡πà‡∏° 25 ‡∏ä‡∏¥‡πâ‡∏ô', target: 25, reward: { type: 'produce', id: 'gem', count: 2 } },
                { id: 'cook_8_more', action: 'cook', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° 8 ‡∏≠‡∏¢‡πà‡∏≤‡∏á', target: 8, reward: { type: 'kitchen_tool', id: 'kitchen_pot', count: 1 } },
                { id: 'spend_3000', action: 'spend_money', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô 3000üí∞', target: 3000, reward: { type: 'kitchen_tool', id: 'kitchen_knife', count: 1 } },
                { id: 'upgrade_house_1', action: 'upgrade_house', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ö‡πâ‡∏≤‡∏ô 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, reward: { type: 'produce', id: 'gem', count: 2 } },
                { id: 'upgrade_rod_1', action: 'upgrade_rod', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏ö‡πá‡∏î‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, reward: { type: 'seed', id: 'mango_seed', count: 10 } },
                { id: 'fertilize_20_more', action: 'fertilize', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° 20 ‡πÅ‡∏õ‡∏•‡∏á', target: 20, reward: { type: 'seed', id: 'pineapple_seed', count: 10 } },
                { id: 'eat_15', action: 'eat', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏Å‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 15 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 15, reward: { type: 'kitchen_tool', id: 'kitchen_blender', count: 1 } },
                { id: 'place_animal_3', action: 'place_animal', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ß‡∏≤‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏Å 3 ‡∏ï‡∏±‡∏ß', target: 3, reward: { type: 'seed', id: 'guava_seed', count: 15 } },
                { id: 'buy_animal_5', action: 'buy_animal', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå 5 ‡∏ï‡∏±‡∏ß', target: 5, reward: { type: 'item', id: 'fertilizer_2', count: 10 } },
                { id: 'sell_hq_10', action: 'sell_high_quality', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ä‡∏¥‡πâ‡∏ô', target: 10, reward: { type: 'kitchen_tool', id: 'kitchen_pan', count: 1 } },
                { id: 'buy_tool_1', action: 'buy_tool', description: '‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏£‡∏±‡∏ß 1 ‡∏ä‡∏¥‡πâ‡∏ô', target: 1, reward: { type: 'produce', id: 'gem', count: 2 } },
            ]
        };
        let userId = null;
        let farmState = null;
        let playerState = null;
        const playerNameEl = document.getElementById('player-name');
        
        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            let parts = [];
            if (h > 0) parts.push(`${h} ‡∏ä‡∏°.`);
            if (m > 0) parts.push(`${m} ‡∏ô‡∏≤‡∏ó‡∏µ`);
            if (s > 0 || parts.length === 0) parts.push(`${s} ‡∏ß‡∏¥`);
            return parts.join(' ');
        }
        
        async function updateFarmState(newState) {
             if (!userId) return;
             farmState = newState;
             const farmDocRef = doc(db, "publicFarmData", "farmState");
             await setDoc(farmDocRef, farmState, { merge: true });
        }
        async function updatePlayerState(newState) {
             if (!userId) return;
             playerState = newState;
             const playerDocRef = doc(db, "players", userId);
             await setDoc(playerDocRef, newState, { merge: true });
        }
        
        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ---
        function deductEnergy(amount) {
            if (!playerState || (playerState.energy || 0) < amount) {
                console.log("‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!"); 
                return false;
            }
            const newPlayerState = { ...playerState };
            newPlayerState.energy -= amount;
            
            document.getElementById('energy-bar').style.width = `${(newPlayerState.energy / getMaxEnergy()) * 100}%`;
            document.getElementById('energy-text').textContent = `${newPlayerState.energy} / ${getMaxEnergy()}`;

            updatePlayerState(newPlayerState);
            return true;
        }

        function getMaxEnergy() {
            if (!playerState) return 100;
            const baseEnergy = 100;
            const bonusPerLevel = 15;
            const houseBonus = ((playerState.houseLevel || 0) > 0 ? (playerState.houseLevel - 1) : 0) * bonusPerLevel;
            return baseEnergy + houseBonus;
        }

        function renderEnergy() {
            if (!playerState) return;
            const maxEnergy = getMaxEnergy();
            const currentEnergy = playerState.energy || 0;
            const energyBar = document.getElementById('energy-bar');
            const energyText = document.getElementById('energy-text');

            if (energyBar) energyBar.style.width = `${(currentEnergy / maxEnergy) * 100}%`;
            if (energyText) energyText.textContent = `${currentEnergy} / ${maxEnergy}`;
        }
        // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ---

        function renderAll() {
            if (!farmState || !playerState) return; 
            renderEnergy();
            renderFarm();
            renderAnimals();
            renderFactory();
            renderBedroom();
            renderPlayerUI();
            renderShop();
            renderSellBox();
            renderStorage();
            renderFishing();
            renderQuests();
            renderKitchen();
            renderMarket();
        }
        
        function renderMarket() {
            if (!farmState) return;
            const container = document.getElementById('market-items-list');
            if (!container) return;
            container.innerHTML = '';
            
            const sellableItems = Object.entries(GAME_DATA).filter(([_, data]) => data.type === 'produce' && data.sellPrice);
            
            sellableItems.forEach(([id, data]) => {
                const basePrice = data.sellPrice[0];
                const currentPrice = farmState.marketPrices[id] || basePrice;
                
                let statusIcon = '<span class="font-bold w-6 text-center">-</span>';
                if (currentPrice > basePrice) {
                    statusIcon = '<span class="font-bold w-6 text-center text-green-600">‚ñ≤</span>';
                } else if (currentPrice < basePrice) {
                    statusIcon = '<span class="font-bold w-6 text-center text-red-600">‚ñº</span>';
                }

                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center justify-between p-2 bg-white/70 rounded-md';
                
                const iconHTML = data.imageUrl ? `<img src="${data.imageUrl}" class="w-8 h-8 object-contain">` : `<span>${data.icon}</span>`;

                itemEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        ${iconHTML}
                        <span class="font-semibold">${data.name}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        ${statusIcon}
                        <span class="font-bold text-right w-20">${currentPrice}üí∞</span>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }

        function calculateExpansionCost(type) {
            const baseCost = { farm: 250, animals: 500, factory: 1000 };
            const perSlotCost = { farm: 150, animals: 400, factory: 1200 };
            const initialSize = { farm: FARM_GRID_SIZE, animals: ANIMAL_PEN_SIZE, factory: FACTORY_GRID_SIZE };
            const currentSize = {
                farm: farmState.plots.length,
                animals: farmState.animals.length,
                factory: farmState.factories.length
            };
            const addedSlots = Math.max(0, currentSize[type] - initialSize[type]);
            return baseCost[type] + (addedSlots * perSlotCost[type]);
        }

        function renderFarm() {
            if (!farmState || !Array.isArray(farmState.plots)) return;
            const farmGrid = document.getElementById('farm-grid');
            farmGrid.innerHTML = '';
            farmState.plots.forEach((plot, index) => {
                const plotEl = document.createElement('div');
                plotEl.className = 'plot aspect-square rounded-lg shadow-inner cursor-pointer flex items-center justify-center text-3xl relative';
                plotEl.style.backgroundColor = 'rgba(139, 69, 19, 0.4)';
                
                if (plot.plantId) {
                    const plantData = GAME_DATA[plot.plantId];
                    if (!plantData) {
                        plotEl.innerHTML = `‚ùì`;
                    } else {
                        let progress = 0;
                        if (plot.plantTime) { 
                            const elapsedSeconds = (Date.now() - plot.plantTime) / 1000;
                            const growthMultiplier = 1 + ((plot.wateredBy?.length || 0) * 0.5);
                            const effectiveGrowth = elapsedSeconds * growthMultiplier;
                            progress = Math.min(effectiveGrowth / plantData.growTime, 1);
                        }
                        plotEl.style.backgroundImage = `linear-gradient(to top, rgba(96, 165, 250, 0.5) 0%, rgba(96, 165, 250, 0.5) ${progress*100}%, transparent ${progress*100}%)`;
                        const content = document.createElement('div');
                        content.style.backgroundImage = `url(${plantData.imageUrl})`;
                        content.style.opacity = 0.5 + (progress * 0.5);
                        content.className = 'w-full h-full bg-contain bg-no-repeat bg-center';
                        plotEl.appendChild(content);
                    }
                }
                plotEl.onclick = () => showContextMenu('plot', index);
                farmGrid.appendChild(plotEl);
            });
            
            const cost = calculateExpansionCost('farm');
            const expandButton = document.createElement('div');
            expandButton.className = 'aspect-square rounded-lg shadow-inner cursor-pointer flex items-center justify-center p-2 bg-green-200/50 hover:bg-green-200/80 transition';
            expandButton.innerHTML = `
                <div class="text-center">
                    <span class="text-3xl font-bold text-green-800">‚ûï</span>
                    <p class="text-xs font-semibold mt-1">‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏õ‡∏•‡∏á</p>
                    <p class="text-xs font-bold text-yellow-900 bg-yellow-300 px-2 py-0.5 rounded-full mt-1">${cost}üí∞</p>
                </div>
            `;
            expandButton.onclick = () => expandGrid('farm');
            farmGrid.appendChild(expandButton);
        }

        function renderAnimals() {
             if (!farmState || !Array.isArray(farmState.animals)) return;
             const animalPen = document.getElementById('animal-pen');
             animalPen.innerHTML = '';
             farmState.animals.forEach((animal, index) => {
                const slotEl = document.createElement('div');
                slotEl.className = 'animal-slot aspect-square rounded-2xl shadow-inner cursor-pointer flex flex-col items-center justify-center p-1 bg-green-200/50 relative';
                
                if (animal.animalId) {
                    const animalData = GAME_DATA[animal.animalId];
                    slotEl.style.backgroundImage = `url(${animalData.imageUrl})`;

                    const progressContainer = document.createElement('div');
                    progressContainer.className = 'absolute bottom-1 left-1 right-1 h-2 bg-gray-300/70 rounded-full overflow-hidden';
                    const progressFill = document.createElement('div');
                    const progress = (Date.now() - animal.startTime) / (animalData.produceTime * 1000);
                    progressFill.className = 'h-full bg-yellow-400 rounded-full';
                    progressFill.style.width = `${Math.min(progress, 1) * 100}%`;
                    progressContainer.appendChild(progressFill);
                    slotEl.appendChild(progressContainer);

                    if (progress >= 1) {
                        slotEl.classList.add('animate-bounce');
                        const produceData = GAME_DATA[animalData.produceId];
                        const produceIcon = document.createElement('div');
                        produceIcon.className = 'absolute top-1 right-1 text-2xl z-10';
                        produceIcon.textContent = produceData.icon;
                        slotEl.appendChild(produceIcon);
                    }
                } else {
                    slotEl.textContent = '‚ûï';
                    slotEl.className += ' text-4xl text-gray-400 hover:bg-green-200/70';
                }
                slotEl.onclick = () => showContextMenu('animal', index);
                animalPen.appendChild(slotEl);
             });
             
            const cost = calculateExpansionCost('animals');
            const expandButton = document.createElement('div');
            expandButton.className = 'aspect-square rounded-2xl shadow-inner cursor-pointer flex items-center justify-center p-2 bg-green-200/50 hover:bg-green-200/80 transition';
            expandButton.innerHTML = `
                <div class="text-center">
                    <span class="text-3xl font-bold text-green-800">‚ûï</span>
                    <p class="text-xs font-semibold mt-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏Å</p>
                    <p class="text-xs font-bold text-yellow-900 bg-yellow-300 px-2 py-0.5 rounded-full mt-1">${cost}üí∞</p>
                </div>
            `;
            expandButton.onclick = () => expandGrid('animals');
            animalPen.appendChild(expandButton);
        }

        function renderFactory() {
            if (!farmState || !Array.isArray(farmState.factories)) return;
            const factoryGrid = document.getElementById('factory-grid');
            factoryGrid.innerHTML = '';
            farmState.factories.forEach((factory, index) => {
                const slotEl = document.createElement('div');
                slotEl.className = 'factory-slot aspect-square rounded-2xl shadow-inner cursor-pointer flex flex-col items-center justify-center p-1 bg-gray-300/50 relative';
                
                if (factory.factoryId) {
                    const factoryData = GAME_DATA[factory.factoryId];
                    slotEl.style.backgroundImage = `url(${factoryData.imageUrl})`;

                    if(factory.isProcessing) {
                        const recipe = factoryData.recipes.find(r => r.id === factory.recipeId);
                        const progress = (Date.now() - factory.startTime) / (recipe.processTime * 1000);
                        
                        const progressContainer = document.createElement('div');
                        progressContainer.className = 'absolute bottom-1 left-1 right-1 h-2 bg-gray-800/70 rounded-full overflow-hidden';
                        const progressFill = document.createElement('div');
                        progressFill.className = 'h-full bg-green-400 rounded-full';
                        progressFill.style.width = `${Math.min(progress, 1) * 100}%`;
                        progressContainer.appendChild(progressFill);
                        slotEl.appendChild(progressContainer);

                        if (progress >= 1) {
                            slotEl.classList.add('animate-bounce');
                            const produceData = GAME_DATA[recipe.output.id];
                            const produceIcon = document.createElement('div');
                            produceIcon.className = 'absolute top-1 right-1 text-2xl z-10';
                            produceIcon.style.backgroundImage = `url(${produceData.imageUrl})`;
                            produceIcon.className += ' w-8 h-8 bg-contain bg-no-repeat bg-center';
                            slotEl.appendChild(produceIcon);
                        }
                    }
                } else {
                    slotEl.textContent = '‚ûï';
                    slotEl.className += ' text-4xl text-gray-500 hover:bg-gray-400/50';
                }
                slotEl.onclick = () => showContextMenu('factory', index);
                factoryGrid.appendChild(slotEl);
            });

            const cost = calculateExpansionCost('factory');
            const expandButton = document.createElement('div');
            expandButton.className = 'aspect-square rounded-2xl shadow-inner cursor-pointer flex items-center justify-center p-2 bg-gray-300/50 hover:bg-gray-400/50 transition';
            expandButton.innerHTML = `
                <div class="text-center">
                    <span class="text-3xl font-bold text-gray-700">‚ûï</span>
                    <p class="text-xs font-semibold mt-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</p>
                    <p class="text-xs font-bold text-yellow-900 bg-yellow-300 px-2 py-0.5 rounded-full mt-1">${cost}üí∞</p>
                </div>
            `;
            expandButton.onclick = () => expandGrid('factory');
            factoryGrid.appendChild(expandButton);
        }

        function renderPlayerUI() {
            if (!playerState) return;
            playerNameEl.textContent = playerState.nickname;
            document.getElementById('money-display').textContent = playerState.money || 0;
            const inventoryDisplay = document.getElementById('inventory-display');
            inventoryDisplay.innerHTML = '';
            Object.entries(playerState.inventory).forEach(([itemId, count]) => {
                if (count > 0) {
                    const itemData = GAME_DATA[itemId];
                    if (itemData) {
                        const itemEl = document.createElement('span');
                        itemEl.className = 'bg-white px-2 py-1 rounded-md shadow-sm flex items-center gap-1';
                        const iconHTML = itemData.imageUrl 
                            ? `<img src="${itemData.imageUrl}" class="w-5 h-5 object-contain">`
                            : `<span>${itemData.icon}</span>`;
                        itemEl.innerHTML = `${iconHTML} ${count}`;
                        inventoryDisplay.appendChild(itemEl);
                    }
                }
            });
            
            document.getElementById('user-id-display').textContent = `ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${userId}`;
            
            const adminResetBtn = document.getElementById('admin-reset-btn');
            if (userId === ADMIN_UID) {
                adminResetBtn.classList.remove('hidden');
            } else {
                adminResetBtn.classList.add('hidden');
            }
        }

        function renderShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            ['seed', 'item', 'animal_deed', 'kitchen_tool', 'factory_deed'].forEach(category => {
                const itemsInCategory = Object.entries(GAME_DATA).filter(([_, data]) => data.type === category);
                if (itemsInCategory.length === 0) return;

                const categoryEl = document.createElement('div');
                const title = {
                    seed:'‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', 
                    item:'‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°', 
                    animal_deed:'‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á', 
                    kitchen_tool: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ñ‡∏£‡∏±‡∏ß',
                    factory_deed: '‡πÅ‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô'
                }[category];
                categoryEl.innerHTML = `<h3 class="text-xl font-bold text-green-700 mb-2">${title}</h3>`;
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-2';

                itemsInCategory.forEach(([id, data]) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-white/80 p-3 rounded-xl shadow-md flex flex-col items-center gap-2';
                    
                    const iconContainer = document.createElement('div');
                    iconContainer.className = 'text-3xl h-12 w-12 flex items-center justify-center';
                    if (data.imageUrl) {
                        iconContainer.innerHTML = `<img src="${data.imageUrl}" class="w-full h-full object-contain">`;
                    } else {
                        iconContainer.textContent = data.icon;
                    }

                    let buttonText = `‡∏ã‡∏∑‡πâ‡∏≠ ${data.cost}üí∞`;
                    let isDisabled = false;

                    if (data.type === 'kitchen_tool' && farmState.ownedKitchenTools?.includes(id)) {
                        buttonText = '‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß';
                        isDisabled = true;
                    }
                    if (data.type === 'factory_deed' && farmState.factories?.some(f => f.factoryId === data.factoryId)) {
                        buttonText = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß';
                        isDisabled = true;
                    }

                    itemEl.innerHTML = `
                        <div class="font-semibold text-center text-sm">${data.name}</div>
                        <button data-itemid="${id}" class="buy-btn bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-1 px-4 rounded-full w-full ${isDisabled ? 'bg-gray-400 text-gray-600 cursor-not-allowed hover:bg-gray-400' : ''}" ${isDisabled ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    `;
                    itemEl.prepend(iconContainer);
                    grid.appendChild(itemEl);
                });
                categoryEl.appendChild(grid);
                shopItems.appendChild(categoryEl);
            });
        }

        function renderSellBox() {
            const itemsEl = document.getElementById('sell-box-items');
            const totalEl = document.getElementById('sell-box-total');
            const countdownEl = document.getElementById('sell-countdown');
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            const timeRemaining = tomorrow.getTime() - now.getTime();
            countdownEl.textContent = `‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${formatTime(Math.floor(timeRemaining / 1000))}`;
            
            if (!playerState || !playerState.produceBin || playerState.produceBin.length === 0) {
                itemsEl.innerHTML = `<p class="text-center text-yellow-700">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</p>`;
                totalEl.textContent = '0';
                return;
            }

            itemsEl.innerHTML = '';
            let totalValue = 0;
            const groupedProduce = playerState.produceBin.reduce((acc, item) => {
                const key = `${item.id}_q${item.quality}`;
                if (!acc[key]) { acc[key] = { ...item, count: 0 }; }
                acc[key].count++;
                return acc;
            }, {});

            Object.values(groupedProduce).forEach(item => {
                const itemData = GAME_DATA[item.id];
                if (!itemData || !itemData.sellPrice) return;
				
                const marketBasePrice = farmState.marketPrices[item.id] || itemData.sellPrice[0];
                const qualityRatio = itemData.sellPrice[item.quality] / itemData.sellPrice[0];
                const finalSellPrice = Math.round(marketBasePrice * qualityRatio);
                totalValue += finalSellPrice * item.count;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white/50 p-2 rounded';
                const iconHTML = itemData.imageUrl 
                    ? `<div class="w-8 h-8 mr-2 bg-contain bg-no-repeat bg-center" style="background-image: url('${itemData.imageUrl}')"></div>`
                    : `<span class="text-lg">${itemData.icon}</span>`;
                itemDiv.innerHTML = `
                    <div class="flex items-center">
                        ${iconHTML}
                        <span>${itemData.name}</span>
                        <span class="quality-star ml-1">${'‚òÖ'.repeat(item.quality)}</span>
                        <span class="text-gray-600 text-sm ml-2">x${item.count}</span>
                    </div>
                    <span class="font-semibold">${finalSellPrice * item.count}üí∞</span>
                `;
                itemsEl.appendChild(itemDiv);
            });
            totalEl.textContent = totalValue;
        }
        
        function renderBedroom() {
            if (!playerState) return;
            const container = document.getElementById('bedroom-display');
            const infoP = document.getElementById('bedroom-info').querySelector('p');
            const upgradeBtn = document.getElementById('upgrade-house-btn');
            const houseLevel = playerState.houseLevel || 0;

            if (houseLevel === 0) {
                container.style.backgroundImage = 'none';
                container.style.backgroundColor = '#D2B48C';
                infoP.innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô`;
                
                const firstPurchaseData = GAME_DATA.house_upgrades[0];
                upgradeBtn.textContent = `‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô (${firstPurchaseData.cost}üí∞)`;
                upgradeBtn.disabled = playerState.money < firstPurchaseData.cost;
            } else {
                container.style.backgroundColor = 'transparent';
                const houseData = GAME_DATA.house_upgrades[houseLevel - 1];
                container.style.backgroundImage = `url(${houseData.imageUrl})`;
                infoP.innerHTML = `‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö <span id="house-level" class="font-bold">${houseLevel}</span>`;
                
                if (houseLevel >= GAME_DATA.house_upgrades.length) {
                    upgradeBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                    upgradeBtn.disabled = true;
                } else {
                    const nextUpgradeData = GAME_DATA.house_upgrades[houseLevel];
                    upgradeBtn.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (${nextUpgradeData.cost}üí∞)`;
                    upgradeBtn.disabled = playerState.money < nextUpgradeData.cost;
                }
            }
        }
        
        function renderStorage() {
            const container = document.getElementById('storage-items');
            if (!playerState || !playerState.storageBin || playerState.storageBin.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>`;
                return;
            }

            container.innerHTML = '';
            const groupedStorage = playerState.storageBin.reduce((acc, item) => {
                const key = `${item.id}_q${item.quality}`;
                if (!acc[key]) {
                    acc[key] = { ...item, count: 0 };
                }
                acc[key].count++;
                return acc;
            }, {});

            Object.values(groupedStorage).forEach(item => {
                const itemData = GAME_DATA[item.id];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white/80 p-2 rounded-lg gap-2';
                let buttonsHTML = `<button class="sell-storage-btn bg-green-500 text-white font-bold py-1 px-3 rounded-full hover:bg-green-600 text-xs" data-item-id="${item.id}" data-quality="${item.quality}">‡∏Ç‡∏≤‡∏¢</button>`;
                if (itemData.energyRestore > 0) {
                    buttonsHTML += `<button class="eat-storage-btn bg-blue-500 text-white font-bold py-1 px-3 rounded-full hover:bg-blue-600 text-xs" data-item-id="${item.id}" data-quality="${item.quality}">‡∏Å‡∏¥‡∏ô (+${itemData.energyRestore}‚ö°)</button>`;
                }
				
				if (itemData.type === 'item' || itemData.type === 'factory_deed' || itemData.type === 'animal_deed') {
                     buttonsHTML += `<button class="move-to-inventory-btn bg-purple-500 text-white font-bold py-1 px-3 rounded-full hover:bg-purple-600 text-xs" data-item-id="${item.id}" data-quality="${item.quality}">‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏±‡∏ß</button>`;
                }
                
                const iconHTML = itemData.imageUrl 
                    ? `<div class="w-10 h-10 mr-2 bg-contain bg-no-repeat bg-center" style="background-image: url('${itemData.imageUrl}')"></div>`
                    : `<span class="text-2xl">${itemData.icon}</span>`;

                itemDiv.innerHTML = `
                    <div class="flex-grow flex items-center">
                        ${iconHTML}
                        <div>
                            <span>${itemData.name}</span>
                            <span class="quality-star">${'‚òÖ'.repeat(item.quality)}</span>
                            <span class="text-gray-600 text-sm ml-2">x${item.count}</span>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        ${buttonsHTML}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function renderFishing() {
            if (!playerState) return;
            const fishBtn = document.getElementById('fish-btn');
            const rodImage = document.getElementById('rod-image');
            const rodLevelText = document.getElementById('rod-level-text');
            const upgradeRodBtn = document.getElementById('upgrade-rod-btn');

            fishBtn.disabled = (playerState.energy || 0) < 8; // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á

            const rodLevel = playerState.fishingRodLevel || 0;
            const rodData = GAME_DATA.fishing_rods[rodLevel];
            rodImage.style.backgroundImage = `url(${rodData.imageUrl})`;
            rodLevelText.textContent = `${rodData.name} (Lv. ${rodLevel + 1})`;
            
            if (rodLevel >= GAME_DATA.fishing_rods.length - 1) {
                upgradeRodBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î';
                upgradeRodBtn.disabled = true;
            } else {
                const nextRodData = GAME_DATA.fishing_rods[rodLevel + 1];
                upgradeRodBtn.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (${nextRodData.cost}üí∞)`;
                upgradeRodBtn.disabled = playerState.money < nextRodData.cost;
            }
        }

        function renderQuests() {
            if (!farmState || !farmState.quests) return;

            const renderList = (type, containerId) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                const quests = farmState.quests[type];

                if (!quests || quests.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏ß‡∏™‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>`;
                    return;
                }
                
                quests.forEach(questProgress => {
                    const questData = QUEST_DATA[type].find(q => q.id === questProgress.id);
                    if (!questData) return;

                    const isComplete = questProgress.progress >= questData.target;
                    const hasClaimed = questProgress.claimedBy?.includes(userId);
                    
                    const questEl = document.createElement('div');
                    questEl.className = 'bg-white/70 p-3 rounded-lg flex items-center gap-3';

                    let claimButtonHTML = '';
                    if (isComplete) {
                        if (hasClaimed) {
                            claimButtonHTML = `<button class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg text-sm cursor-not-allowed" disabled>‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>`;
                        } else {
                            claimButtonHTML = `<button class="claim-quest-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm" data-quest-type="${type}" data-quest-id="${questProgress.id}">‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>`;
                        }
                    } else {
                        claimButtonHTML = `<button class="bg-gray-300 text-gray-600 font-bold py-2 px-4 rounded-lg text-sm" disabled>${questProgress.progress}/${questData.target}</button>`;
                    }

                    const rewardData = questData.reward;
                    let rewardItemData;
                    if (rewardData.id === 'random') {
                       rewardItemData = { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏∏‡πà‡∏°', icon: '‚ùì' };
                    } else {
                       rewardItemData = GAME_DATA[rewardData.id];
                    }
                    const rewardIcon = rewardItemData.imageUrl ? `<img src="${rewardItemData.imageUrl}" class="w-6 h-6 object-contain inline-block">` : rewardItemData.icon;

                    questEl.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${questData.description}</p>
                            <p class="text-xs text-gray-600">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${rewardIcon} ${rewardItemData.name} x${rewardData.count}</p>
                        </div>
                        <div class="flex-shrink-0">
                            ${claimButtonHTML}
                        </div>
                    `;
                    container.appendChild(questEl);
                });
            };

            renderList('daily', 'daily-quests-list');
            renderList('weekly', 'weekly-quests-list');
        }

        function renderKitchen() {
            if (!farmState || !farmState.kitchen || !farmState.kitchen.queue) return;
            const container = document.getElementById('cooking-queue-list');
            container.innerHTML = '';

            if (farmState.kitchen.queue.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà</p>`;
                return;
            }

            farmState.kitchen.queue.forEach((job, index) => {
                const recipeData = GAME_DATA.recipes[job.recipeId];
                const resultData = GAME_DATA[recipeData.resultId];
                const COOK_TIME_PER_ITEM = 600;
                const totalCookTime = job.quantity * COOK_TIME_PER_ITEM * 1000;
                const elapsed = Date.now() - job.startTime;
                const progress = Math.min(elapsed / totalCookTime, 1);
                const remainingSeconds = Math.max(0, (totalCookTime - elapsed) / 1000);

                const jobEl = document.createElement('div');
                jobEl.className = 'bg-white/80 p-3 rounded-lg flex items-center gap-3';

                const iconHTML = `<div class="w-12 h-12 flex-shrink-0 bg-contain bg-no-repeat bg-center" style="background-image: url('${resultData.imageUrl}')"></div>`;
                const detailsHTML = `
                    <div class="flex-grow">
                        <p class="font-bold">${resultData.name} x${job.quantity}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                          <div class="bg-orange-500 h-2.5 rounded-full" style="width: ${progress * 100}%"></div>
                        </div>
                    </div>
                `;
                
                const actionContainer = document.createElement('div');
                actionContainer.className = 'flex-shrink-0 w-20 text-center';

                if (progress >= 1) {
                    const collectButton = document.createElement('button');
                    collectButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm';
                    collectButton.textContent = '‡∏£‡∏±‡∏ö';
                    collectButton.onclick = () => {
                        collectCookedFood(index);
                    };
                    actionContainer.appendChild(collectButton);
                } else {
                    actionContainer.innerHTML = `<div class="text-sm font-semibold">${formatTime(remainingSeconds)}</div>`;
                }
                
                jobEl.innerHTML = iconHTML + detailsHTML;
                jobEl.appendChild(actionContainer);
                container.appendChild(jobEl);
            });
        }
        
        function showContextMenu(type, id) {
            const modal = document.getElementById('context-modal');
            const contentEl = document.getElementById('context-modal-content');
            const titleEl = document.getElementById('context-modal-title');
            const actionsEl = document.getElementById('context-modal-actions');
            actionsEl.innerHTML = '';
            contentEl.querySelectorAll('.context-details').forEach(el => el.remove());
            const detailsEl = document.createElement('div');
            detailsEl.className = 'context-details text-sm text-gray-600 mb-4 border-t pt-4 mt-4';

            const createButton = (text, action, disabled = false, extraClasses = 'bg-green-500 hover:bg-green-600 text-white') => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `w-full font-bold py-2 px-4 rounded-lg transition ${disabled ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : extraClasses}`;
                if (!disabled) button.onclick = () => { action(); hideContextMenu(); };
                return button;
            };

            if (type === 'plot') {
                const index = id;
                const plot = farmState.plots[index];
                titleEl.textContent = `‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà ${index + 1}`;
                if (!plot.plantId) {
                     const plantableItems = Object.keys(playerState.inventory).filter(id => GAME_DATA[id] && GAME_DATA[id].type === 'seed' && playerState.inventory[id] > 0);
                     actionsEl.appendChild(createButton('üå± ‡∏õ‡∏•‡∏π‡∏Å', () => showSubMenu('plant', index, plantableItems), plantableItems.length === 0));
                } else {
                    const plantData = GAME_DATA[plot.plantId];
                    const elapsedSeconds = (Date.now() - plot.plantTime) / 1000;
                    const growthMultiplier = 1 + ((plot.wateredBy?.length || 0) * 0.5);
                    const effectiveGrowth = elapsedSeconds * growthMultiplier;
                    const isGrown = effectiveGrowth >= plantData.growTime;
                    const remainingSeconds = Math.max(0, (plantData.growTime - effectiveGrowth) / (1 + ((plot.wateredBy?.length || 0) * 0.5)));
                    
                    detailsEl.innerHTML = `<p>‡∏õ‡∏•‡∏π‡∏Å‡πÇ‡∏î‡∏¢: ${plot.plantedBy?.nickname || '??'}</p><p>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${formatTime(remainingSeconds)}</p>`;
                    if (plot.wateredBy && plot.wateredBy.length > 0) {
                        const waterers = plot.wateredBy.map(p => p.nickname).join(', ');
                        detailsEl.innerHTML += `<div class="mt-2"><p>‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢:</p><p class="font-semibold text-green-700">${waterers}</p></div>`;
                    }
                    actionsEl.before(detailsEl);
                    
                    if (isGrown) {
                        const hasHarvested = plot.harvestedBy?.some(p => p.uid === userId);
                        actionsEl.appendChild(createButton('üåæ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß (-1‚ö°)', () => harvest(index), hasHarvested));

                        const involvedUids = new Set([plot.plantedBy?.uid, ...(plot.wateredBy?.map(p => p.uid).filter(uid => uid) || [])]);
                        const harvestedUids = new Set(plot.harvestedBy?.map(p => p.uid) || []);
                        
                        let harvestStatusHTML = '<div class="mt-2 text-xs text-left border-t pt-2">';
                        harvestStatusHTML += '<p class="font-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:</p>';

                        involvedUids.forEach(uid => {
                            const planterName = plot.plantedBy?.uid === uid ? plot.plantedBy.nickname : null;
                            const waterer = plot.wateredBy?.find(p => p.uid === uid);
                            const nickname = planterName || waterer?.nickname || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô';
                            const statusIcon = harvestedUids.has(uid) ? '‚úÖ' : '‚ùå';
                            harvestStatusHTML += `<p>${statusIcon} ${nickname}</p>`;
                        });
                        harvestStatusHTML += '</div>';
                        detailsEl.innerHTML += harvestStatusHTML;

                    } else {
                         const hasWatered = plot.wateredBy?.some(p => p.uid === userId);
                         actionsEl.appendChild(createButton('üíß ‡∏£‡∏î‡∏ô‡πâ‡∏≥ (-2‚ö°)', () => water(index), hasWatered));
                         const fertilizers = Object.keys(playerState.inventory).filter(id => GAME_DATA[id]?.type === 'item');
                         actionsEl.appendChild(createButton('üí© ‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢', () => showSubMenu('fertilize', index, fertilizers), fertilizers.length === 0));
                    }
                    actionsEl.appendChild(createButton('‚ùå ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡πÅ‡∏õ‡∏•‡∏á (-5‚ö°)', () => clearPlot(index), false, 'bg-red-500 hover:bg-red-600 text-white'));
                }
            } else if (type === 'animal') {
                const index = id;
                const animal = farmState.animals[index];
                titleEl.textContent = `‡∏Ñ‡∏≠‡∏Å‡∏ó‡∏µ‡πà ${index + 1}`;
                if (!animal.animalId) {
                     const buyableItems = Object.keys(playerState.inventory).filter(id => GAME_DATA[id]?.type === 'animal_deed' && playerState.inventory[id] > 0);
                     actionsEl.appendChild(createButton('‚ûï ‡∏ß‡∏≤‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå', () => showSubMenu('placeAnimal', index, buyableItems), buyableItems.length === 0));
                } else {
                    const animalData = GAME_DATA[animal.animalId];
                    const isReady = (Date.now() - animal.startTime) >= (animalData.produceTime * 1000);
                    const remainingMillis = Math.max(0, (animal.startTime + animalData.produceTime * 1000) - Date.now());
                    detailsEl.innerHTML = `<p><b>${animalData.name}</b></p><p>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô: <span class="font-semibold">${formatTime(remainingMillis / 1000)}</span></p>`;
                    actionsEl.before(detailsEl);
                    if(isReady){
                        actionsEl.appendChild(createButton(`‡πÄ‡∏Å‡πá‡∏ö${GAME_DATA[animalData.produceId].name}`, () => collectAnimalProduct(index)));
                    }
                }
            } else if (type === 'factory') {
                const index = id;
                const factory = farmState.factories[index];
                titleEl.textContent = `‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà ${index + 1}`;
                if (!factory.factoryId) {
                    const placeableItems = Object.keys(playerState.inventory).filter(id => GAME_DATA[id]?.type === 'factory_deed' && playerState.inventory[id] > 0);
                    actionsEl.appendChild(createButton('‚ûï ‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', () => showSubMenu('placeFactory', index, placeableItems), placeableItems.length === 0));
                } else {
                    const factoryData = GAME_DATA[factory.factoryId];
                    if (!factory.isProcessing) {
                        detailsEl.innerHTML = `<p><b>${factoryData.name}</b> (‡∏ß‡πà‡∏≤‡∏á)</p>`;
                        actionsEl.before(detailsEl);
                        actionsEl.appendChild(createButton('‚öôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏¥‡∏ï', () => showSubMenu('useFactory', index, factoryData.recipes.map(r => r.id))));
                    } else {
                        const recipe = factoryData.recipes.find(r => r.id === factory.recipeId);
                        const isReady = (Date.now() - factory.startTime) >= (recipe.processTime * 1000);
                        const remainingMillis = Math.max(0, (factory.startTime + recipe.processTime * 1000) - Date.now());
                        detailsEl.innerHTML = `<p><b>${factoryData.name}</b></p><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï: ${recipe.name}</p><p>‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏ô: ${formatTime(remainingMillis / 1000)}</p>`;
                        actionsEl.before(detailsEl);

                        if(isReady) {
                            actionsEl.appendChild(createButton(`üì¶ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á`, () => collectFactoryProduct(index)));
                        }
                    }
                }
            }
            
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        function hideContextMenu() {
            const modal = document.getElementById('context-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function showSubMenu(actionType, index, itemIds) {
            const modal = document.getElementById('submenu-modal');
            const titleEl = document.getElementById('submenu-modal-title');
            const itemsEl = document.getElementById('submenu-modal-items');
            itemsEl.innerHTML = '';
            
            const titles = {
                plant: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏•‡∏π‡∏Å',
                fertilize: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏∏‡πã‡∏¢',
                placeAnimal: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏á',
                placeFactory: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á',
                useFactory: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï'
            };
            titleEl.textContent = titles[actionType] || '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';

            itemIds.forEach(itemId => {
                let itemData, clickAction, name, iconHTML;
                
                if (actionType === 'useFactory') {
                    const factoryData = GAME_DATA[farmState.factories[index].factoryId];
                    const recipe = factoryData.recipes.find(r => r.id === itemId);
                    const outputData = GAME_DATA[recipe.output.id];
                    
                    let ingredientsText = recipe.inputs.map(inp => `${GAME_DATA[inp.id].name} x${inp.count}`).join(', ');
                    
                    itemData = recipe;
                    name = `${recipe.name}<br><small class="font-normal text-gray-500">${ingredientsText}</small>`;
                    iconHTML = `<img src="${outputData.imageUrl}" class="w-10 h-10 object-contain">`;
                    clickAction = () => startProcessing(index, recipe.id);
                } else {
                    itemData = GAME_DATA[itemId];
                    name = itemData.name;
                    iconHTML = itemData.imageUrl 
                        ? `<img src="${itemData.imageUrl}" class="w-10 h-10 object-contain">`
                        : `<div class="text-3xl">${itemData.icon}</div>`;

                    const actions = {
                        plant: () => plant(index, itemId),
                        fertilize: () => fertilize(index, itemId),
                        placeAnimal: () => placeAnimal(index, itemId),
                        placeFactory: () => placeFactory(index, itemId),
                    };
                    clickAction = actions[actionType];
                }

                const itemButton = document.createElement('button');
                itemButton.className = 'p-2 bg-gray-100 rounded-lg hover:bg-green-100 flex flex-col items-center justify-center gap-1';
                itemButton.innerHTML = `${iconHTML}<div class="text-xs">${name}</div>`;
                itemButton.onclick = () => {
                    clickAction();
                    hideSubMenu();
                };
                itemsEl.appendChild(itemButton);
            });
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        function hideSubMenu() {
            const modal = document.getElementById('submenu-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function showCookingModal() {
            const modal = document.getElementById('cooking-modal');
            renderRecipeList();
            modal.classList.remove('hidden');
        }

        function hideCookingModal() {
            document.getElementById('cooking-modal').classList.add('hidden');
        }

        function renderRecipeList() {
            const container = document.getElementById('recipe-list');
            container.innerHTML = '';
            if(!farmState.ownedKitchenTools) farmState.ownedKitchenTools = [];
            
            const storageCounts = playerState.storageBin.reduce((acc, item) => {
                const itemData = GAME_DATA[item.id];
                acc[item.id] = (acc[item.id] || 0) + 1;
                if (itemData.category) {
                     acc[`category_${itemData.category}`] = (acc[`category_${itemData.category}`] || 0) + 1;
                }
                return acc;
            }, {});

            Object.entries(GAME_DATA.recipes).forEach(([recipeId, recipeData]) => {
                const resultData = GAME_DATA[recipeData.resultId];
                const recipeEl = document.createElement('div');
                recipeEl.className = 'bg-gray-50 p-3 rounded-lg flex items-center gap-4';

                let ingredientsHTML = '';
                const hasTool = farmState.ownedKitchenTools.includes(recipeData.tool);
                const toolData = GAME_DATA[recipeData.tool];
                const toolHTML = `<span class="text-sm ${hasTool ? 'text-green-600' : 'text-red-500'}">${toolData.icon} ${toolData.name} ${hasTool ? '‚úîÔ∏è' : ''}</span>`;
                
                let maxCookable = hasTool ? Infinity : 0;
                const ingredientChecks = [];

                for (const ingredient of recipeData.ingredients) {
                    const requiredCount = ingredient.count || 1;
                    const key = ingredient.id ? ingredient.id : `category_${ingredient.category}`;
                    const hasCount = storageCounts[key] || 0;
                    
                    ingredientChecks.push(Math.floor(hasCount / requiredCount));
                    
                    const name = ingredient.id ? GAME_DATA[ingredient.id].name : `‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${ingredient.category}`;
                    const icon = ingredient.id ? GAME_DATA[ingredient.id].icon : {egg:'ü•ö',fish:'üêü',fruit:'üçì',vegetable:'ü•ï',milk:'ü•õ'}[ingredient.category];
                    ingredientsHTML += `<span class="text-sm ${hasCount > 0 ? 'text-green-600' : 'text-red-500'}">${icon} ${name}</span>`;
                }
                
                maxCookable = ingredientChecks.length > 0 ? Math.min(...ingredientChecks, maxCookable) : 0;
                
                recipeEl.innerHTML = `
                    <div class="w-12 h-12 flex-shrink-0 bg-contain bg-no-repeat bg-center" style="background-image: url('${resultData.imageUrl}')"></div>
                    <div class="flex-grow text-left">
                        <p class="font-bold">${resultData.name}</p>
                        <p class="text-xs text-gray-500">‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°: ${ingredientsHTML}</p>
                        <p class="text-xs text-gray-500">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${toolHTML}</p>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <input type="number" value="1" min="1" max="${maxCookable}" class="w-20 text-center border rounded-md p-1 recipe-quantity-input" ${maxCookable === 0 ? 'disabled' : ''}>
                        <button class="cook-recipe-btn bg-orange-500 text-white font-bold py-1 px-4 rounded-lg hover:bg-orange-600 disabled:bg-gray-400 text-sm" data-recipe-id="${recipeId}" ${maxCookable === 0 ? 'disabled' : ''}>‡∏ó‡∏≥</button>
                    </div>
                `;
                container.appendChild(recipeEl);
            });
        }
        
        function plant(plotIndex, seedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const seedData = GAME_DATA[seedId];
            newFarmState.plots[plotIndex] = { 
                plantId: seedData.plantId, 
                plantTime: Date.now(), 
                fertilizerLevel: 0, 
                wateredBy: [],
                plantedBy: { uid: userId, nickname: playerState.nickname },
                harvestedBy: []
            };
            newPlayerState.inventory[seedId]--;
            document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('pop-animation');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
            updateQuestProgress('plant');
        }

        function water(plotIndex) {
             if (!deductEnergy(2)) return;

             const newFarmState = { ...farmState };
             const plot = newFarmState.plots[plotIndex];
             if (plot.wateredBy && plot.wateredBy.some(p => p.uid === userId)) return; 
             plot.wateredBy.push({ uid: userId, nickname: playerState.nickname });
             document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('watered');
             updateFarmState(newFarmState);
             updateQuestProgress('water');
        }

        function fertilize(plotIndex, fertilizerId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const fertilizerData = GAME_DATA[fertilizerId];
            newFarmState.plots[plotIndex].fertilizerLevel += fertilizerData.qualityBonus;
            newPlayerState.inventory[fertilizerId]--;
            document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('fertilized');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
            updateQuestProgress('fertilize');
        }
        
        function clearPlot(plotIndex) {
            const plot = farmState.plots[plotIndex];
            if (!plot) return;
            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ? ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ', () => {
                if (!deductEnergy(5)) return;

                const newFarmState = { ...farmState };
                newFarmState.plots[plotIndex] = { plantId: null };
                updateFarmState(newFarmState);
            });
        }

        function harvest(plotIndex) {
            if (!deductEnergy(1)) return;
            
            const newPlayerState = { ...playerState };
            const newFarmState = { ...farmState };
            const plot = newFarmState.plots[plotIndex];
            if (!plot || !plot.plantId || (plot.harvestedBy && plot.harvestedBy.some(p => p.uid === userId))) return;
            const cropData = GAME_DATA[plot.plantId];
            let quality = 0;
            if (Math.random() < plot.fertilizerLevel) quality = 1;
            if (Math.random() < plot.fertilizerLevel - 1) quality = 2;
            newPlayerState.storageBin.push({ id: cropData.produceId, quality: quality });
            if (!plot.harvestedBy) plot.harvestedBy = [];
            plot.harvestedBy.push({ uid: userId, nickname: playerState.nickname });
            const involvedUids = new Set([plot.plantedBy?.uid, ...(plot.wateredBy?.map(p => p.uid).filter(uid => uid) || [])]);
            const harvestedUids = new Set(plot.harvestedBy.map(p => p.uid));
            let allHarvested = true;
            for (const uid of involvedUids) {
                if (!harvestedUids.has(uid)) {
                    allHarvested = false;
                    break;
                }
            }
            if (allHarvested) {
                newFarmState.plots[plotIndex] = { plantId: null };
            }
            updatePlayerState(newPlayerState);
            updateFarmState(newFarmState);
            updateQuestProgress('harvest');
        }
        
        function placeAnimal(slotIndex, deedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const deedData = GAME_DATA[deedId];
            newFarmState.animals[slotIndex] = { animalId: deedData.animalId, startTime: Date.now() };
            newPlayerState.inventory[deedId]--;
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function collectAnimalProduct(slotIndex) {
            const newPlayerState = { ...playerState };
            const newFarmState = { ...farmState };
            const animal = newFarmState.animals[slotIndex];
            const animalData = GAME_DATA[animal.animalId];
            newPlayerState.storageBin.push({ id: animalData.produceId, quality: 0 });
            animal.startTime = Date.now();
            updatePlayerState(newPlayerState);
            updateFarmState(newFarmState);
            updateQuestProgress('collect_product');
        }
        
        function placeFactory(slotIndex, deedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const deedData = GAME_DATA[deedId];
            newFarmState.factories[slotIndex] = { factoryId: deedData.factoryId, isProcessing: false };
            newPlayerState.inventory[deedId]--;
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
            updateQuestProgress('place_factory');
        }
        
        function startProcessing(slotIndex, recipeId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const factory = newFarmState.factories[slotIndex];
            const factoryData = GAME_DATA[factory.factoryId];
            const recipe = factoryData.recipes.find(r => r.id === recipeId);
            const storageCounts = newPlayerState.storageBin.reduce((acc, item) => {
                acc[item.id] = (acc[item.id] || 0) + 1;
                return acc;
            }, {});
            let canProcess = true;
            for (const input of recipe.inputs) {
                if ((storageCounts[input.id] || 0) < input.count) {
                    canProcess = false;
                    break;
                }
            }
            if (canProcess) {
                for (const input of recipe.inputs) {
                    let countToRemove = input.count;
                    newPlayerState.storageBin = newPlayerState.storageBin.filter(item => {
                        if (item.id === input.id && countToRemove > 0) {
                            countToRemove--;
                            return false;
                        }
                        return true;
                    });
                }
                factory.isProcessing = true;
                factory.recipeId = recipeId;
                factory.startTime = Date.now();
                updateFarmState(newFarmState);
                updatePlayerState(newPlayerState);
            } else {
                alert("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠!");
            }
        }

        function collectFactoryProduct(slotIndex) {
            const newPlayerState = { ...playerState };
            const newFarmState = { ...farmState };
            const factory = newFarmState.factories[slotIndex];
            const recipe = GAME_DATA[factory.factoryId].recipes.find(r => r.id === factory.recipeId);
            for (let i = 0; i < recipe.output.count; i++) {
                newPlayerState.storageBin.push({ id: recipe.output.id, quality: 0 });
            }
            factory.isProcessing = false;
            delete factory.recipeId;
            delete factory.startTime;
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function upgradeHouse() {
            const newPlayerState = { ...playerState };
            const currentLevel = newPlayerState.houseLevel || 0;
            if (currentLevel >= GAME_DATA.house_upgrades.length) return;
            const nextLevelData = GAME_DATA.house_upgrades[currentLevel];
            if (newPlayerState.money >= nextLevelData.cost) {
                newPlayerState.money -= nextLevelData.cost;
                newPlayerState.houseLevel = currentLevel + 1;
                updatePlayerState(newPlayerState);
            }
        }
        
        function sellFromStorage(itemId, quality) {
            const newPlayerState = { ...playerState };
            const itemIndex = newPlayerState.storageBin.findIndex(item => item.id === itemId && item.quality === quality);
            if (itemIndex > -1) {
                const itemToSell = newPlayerState.storageBin.splice(itemIndex, 1)[0];
                newPlayerState.produceBin.push(itemToSell);
                updatePlayerState(newPlayerState);
                updateQuestProgress('sell_item');
                if (quality === 2) {
                    updateQuestProgress('sell_high_quality');
                }
            }
        }

        function eatFromStorage(itemId, quality) {
            const newPlayerState = { ...playerState };
            const itemIndex = newPlayerState.storageBin.findIndex(item => item.id === itemId && item.quality === quality);
            if (itemIndex > -1) {
                const itemData = GAME_DATA[itemId];
                if (!itemData.energyRestore || itemData.energyRestore === 0) return;
                newPlayerState.storageBin.splice(itemIndex, 1);
                const MAX_ENERGY = getMaxEnergy();
                newPlayerState.energy = Math.min(MAX_ENERGY, (newPlayerState.energy || 0) + itemData.energyRestore);
                updatePlayerState(newPlayerState);
                updateQuestProgress('eat');
            }
        }
		
		function moveFromStorageToInventory(itemId, quality) {
            const newPlayerState = { ...playerState };
            const itemIndex = newPlayerState.storageBin.findIndex(item => item.id === itemId && item.quality === quality);
            if (itemIndex > -1) {
                newPlayerState.storageBin.splice(itemIndex, 1);
                newPlayerState.inventory[itemId] = (newPlayerState.inventory[itemId] || 0) + 1;
                updatePlayerState(newPlayerState);
            }
        }
        
        function generateRandomQuests(type, count) {
            const sourceQuests = QUEST_DATA[type];
            const shuffled = [...sourceQuests].sort(() => 0.5 - Math.random());
            const selected = shuffled.slice(0, count);
            return selected.map(q => ({ id: q.id, action: q.action, progress: 0, claimedBy: [] }));
        }
        
        async function updateMarketPrices() {
            if (!farmState) return;
            const newFarmState = { ...farmState };
            const newMarketPrices = { ...newFarmState.marketPrices };
            const salesVolume = newFarmState.salesVolume || {};
            const VOLATILITY = 0.1; 
            const PRICE_RECOVERY_RATE = 0.05;

            for (const itemId in GAME_DATA) {
                const itemData = GAME_DATA[itemId];
                if (itemData.type !== 'produce' || !itemData.sellPrice) continue;
                const basePrice = itemData.sellPrice[0];
                const currentPrice = newMarketPrices[itemId] || basePrice;
                const soldAmount = salesVolume[itemId] || 0;
                let newPrice;

                if (soldAmount > 0) {
                    const pressure = Math.log10(soldAmount + 1);
                    const reduction = pressure * VOLATILITY;
                    newPrice = currentPrice * (1 - reduction);
                } else {
                    if (currentPrice < basePrice) {
                        newPrice = currentPrice * (1 + PRICE_RECOVERY_RATE);
                        if (newPrice > basePrice) newPrice = basePrice;
                    } else {
                        newPrice = currentPrice * (1 - PRICE_RECOVERY_RATE);
                        if (newPrice < basePrice) newPrice = basePrice;
                    }
                }
                const minPrice = basePrice * 0.2;
                const maxPrice = basePrice * 2.5;
                newPrice = Math.max(minPrice, Math.min(newPrice, maxPrice));
                newMarketPrices[itemId] = Math.round(newPrice);
            }
            newFarmState.marketPrices = newMarketPrices;
            newFarmState.salesVolume = {};
            await updateFarmState(newFarmState);
        }

        async function checkForTimeResets() {
            if (!playerState || !farmState) return;
            const now = new Date();
            const lastPlayerReset = new Date(playerState.lastResetTime || 0);
            if (lastPlayerReset.getDate() !== now.getDate() || lastPlayerReset.getMonth() !== now.getMonth()) {
                const tempFarmState = { ...farmState };
                if (!tempFarmState.salesVolume) tempFarmState.salesVolume = {};
                const newPlayerState = { ...playerState };
                if (newPlayerState.produceBin && newPlayerState.produceBin.length > 0) {
                    let totalValue = 0;
                    newPlayerState.produceBin.forEach(item => {
                        const itemData = GAME_DATA[item.id];
                        const marketBasePrice = tempFarmState.marketPrices[item.id] || itemData.sellPrice[0];
                        const qualityRatio = itemData.sellPrice[item.quality] / itemData.sellPrice[0];
                        const finalSellPrice = Math.round(marketBasePrice * qualityRatio);
                        totalValue += finalSellPrice;
                        tempFarmState.salesVolume[item.id] = (tempFarmState.salesVolume[item.id] || 0) + 1;
                    });
                    newPlayerState.money = (newPlayerState.money || 0) + totalValue;
                    newPlayerState.produceBin = [];
                }
                newPlayerState.energy = getMaxEnergy();
                newPlayerState.lastResetTime = now.getTime();
                await updatePlayerState(newPlayerState);
                await updateFarmState(tempFarmState);
                await updateMarketPrices(); 
            }
            const lastDailyQuestReset = new Date(farmState.quests?.lastDailyReset || 0);
            if (lastDailyQuestReset.getDate() !== now.getDate() || lastDailyQuestReset.getMonth() !== now.getMonth()) {
                 const newFarmState = { ...farmState };
                 newFarmState.quests.daily = generateRandomQuests('daily', 5);
                 newFarmState.quests.lastDailyReset = now.getTime();
                 await updateFarmState(newFarmState);
            }
        }
        
        function forceResetFarm() {
            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à 100% ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≤‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!', async () => {
                const farmDocRef = doc(db, "publicFarmData", "farmState");
                await deleteDoc(farmDocRef);
                window.location.reload();
            });
        }
        
        function resetPlayerProgress() {
            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!', async () => {
                if (!userId) return;
                const playerDocRef = doc(db, "players", userId);
                await deleteDoc(playerDocRef);
                window.location.reload();
            });
        }
        
        function upgradeRod() {
            const newPlayerState = { ...playerState };
            const currentLevel = newPlayerState.fishingRodLevel || 0;
            if (currentLevel >= GAME_DATA.fishing_rods.length - 1) return;
            const nextLevelData = GAME_DATA.fishing_rods[currentLevel + 1];
            if (newPlayerState.money >= nextLevelData.cost) {
                newPlayerState.money -= nextLevelData.cost;
                newPlayerState.fishingRodLevel = currentLevel + 1;
                updatePlayerState(newPlayerState);
            }
        }
        
        function fish() {
            if (!deductEnergy(8)) return;

            const rodLevel = playerState.fishingRodLevel || 0;
            const probabilities = [[0.8, 0.15, 0.05], [0.6, 0.3, 0.1], [0.4, 0.4, 0.2], [0.2, 0.5, 0.3], [0.1, 0.4, 0.5]];
            const fishTypes = {
                'Common': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].rarity === 'Common'),
                'Uncommon': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].rarity === 'Uncommon'),
                'Rare': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].rarity === 'Rare')
            };
            const rand = Math.random();
            let caughtRarity = rand < probabilities[rodLevel][0] ? 'Common' : (rand < probabilities[rodLevel][0] + probabilities[rodLevel][1] ? 'Uncommon' : 'Rare');
            const possibleFish = fishTypes[caughtRarity];
            const caughtFishId = possibleFish[Math.floor(Math.random() * possibleFish.length)];
            startFishingMinigame(caughtFishId);
        }

        function showFishCatchModal(fishId) {
            const fishData = GAME_DATA[fishId];
            document.getElementById('fish-catch-title').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏Å‡πÑ‡∏î‡πâ ${fishData.name}!`;
            const iconEl = document.getElementById('fish-catch-icon');
            iconEl.style.backgroundImage = `url(${fishData.imageUrl})`;
            const rarityEl = document.getElementById('fish-catch-rarity');
            rarityEl.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏¢‡∏≤‡∏Å: ${fishData.rarity}`;
            rarityEl.className = fishData.rarity === 'Uncommon' ? 'text-green-600 mb-4' : (fishData.rarity === 'Rare' ? 'text-purple-600 mb-4' : 'text-gray-600 mb-4');
            document.getElementById('fish-catch-modal').classList.remove('hidden');
        }
        
        let minigameLoopId = null;
        function startFishingMinigame(fishId) {
            const modal = document.getElementById('fishing-minigame-modal');
            modal.classList.remove('hidden');
            const track = document.getElementById('fishing-minigame-track'), fishEl = document.getElementById('fishing-minigame-fish'), barEl = document.getElementById('fishing-minigame-bar'), progressFill = document.getElementById('fishing-minigame-progress-fill');
            fishEl.textContent = 'üê†';
            const trackHeight = track.clientHeight, barHeight = 80;
            barEl.style.height = `${barHeight}px`;
            let fishPos = trackHeight / 2, barPos = trackHeight / 2, barVelocity = 0, progress = 30;
            let mouseDown = false;
            let fishTargetPos = Math.random() * (trackHeight - 20);
            const gameLoop = () => {
                if (mouseDown) barVelocity -= 1.2;
                barVelocity += 0.4; barVelocity *= 0.9; barPos += barVelocity;
                if (barPos < 0) barPos = 0; if (barPos > trackHeight - barHeight) barPos = trackHeight - barHeight;
                const fishData = GAME_DATA[fishId];
                const speed = fishData.rarity === 'Rare' ? 2.5 : (fishData.rarity === 'Uncommon' ? 1.8 : 1.2);
                if (Math.abs(fishTargetPos - fishPos) < 5 || Math.random() < 0.02) fishTargetPos = Math.random() * (trackHeight - 20);
                fishPos += (fishTargetPos - fishPos) * 0.1 * speed;
                if (fishPos > barPos && fishPos < barPos + barHeight) progress += 1.5; else progress -= 0.5;
                progress = Math.max(0, Math.min(100, progress));
                barEl.style.top = `${barPos}px`; fishEl.style.top = `${fishPos}px`; progressFill.style.height = `${progress}%`;
                if (progress >= 100) return endFishingMinigame(true, fishId);
                if (progress <= 0) return endFishingMinigame(false, null);
                minigameLoopId = requestAnimationFrame(gameLoop);
            };
            const area = document.getElementById('fishing-minigame-area');
            const startListener = () => mouseDown = true, endListener = () => mouseDown = false;
            area.addEventListener('mousedown', startListener); area.addEventListener('mouseup', endListener);
            area.addEventListener('touchstart', startListener, { passive: true }); area.addEventListener('touchend', endListener);
            const endFishingMinigame = (success, caughtFishId) => {
                cancelAnimationFrame(minigameLoopId);
                area.removeEventListener('mousedown', startListener); area.removeEventListener('mouseup', endListener);
                area.removeEventListener('touchstart', startListener); area.removeEventListener('touchend', endListener);
                modal.classList.add('hidden');
                if (success) {
                    const newPlayerState = { ...playerState };
                    newPlayerState.storageBin.push({ id: caughtFishId, quality: 0 });
                    updatePlayerState(newPlayerState);
                    showFishCatchModal(caughtFishId);
                    updateQuestProgress('fish');
                }
            };
            minigameLoopId = requestAnimationFrame(gameLoop);
        }
        
        function cook(recipeId, quantity) {
            const recipe = GAME_DATA.recipes[recipeId];
            if (!recipe || !farmState.ownedKitchenTools.includes(recipe.tool) || quantity <= 0) return;
            const newPlayerState = { ...playerState };
            let canCook = true;
            const tempStorageCounts = [...newPlayerState.storageBin].reduce((acc, item) => {
                const itemData = GAME_DATA[item.id];
                acc[item.id] = (acc[item.id] || 0) + 1;
                if (itemData.category) { acc[`category_${itemData.category}`] = (acc[`category_${itemData.category}`] || 0) + 1; }
                return acc;
            }, {});
            for (const ingredient of recipe.ingredients) {
                 const requiredCount = (ingredient.count || 1) * quantity;
                 const key = ingredient.id ? ingredient.id : `category_${ingredient.category}`;
                 if ((tempStorageCounts[key] || 0) < requiredCount) {
                    canCook = false;
                    break;
                 }
            }
            if (canCook) {
                for (let i = 0; i < quantity; i++) {
                    for (const ingredient of recipe.ingredients) {
                        const foundIndex = newPlayerState.storageBin.findIndex(item => item.id === ingredient.id || GAME_DATA[item.id]?.category === ingredient.category);
                        if (foundIndex > -1) newPlayerState.storageBin.splice(foundIndex, 1);
                    }
                }
                const newFarmState = { ...farmState };
                if (!newFarmState.kitchen) newFarmState.kitchen = { queue: [] };
                newFarmState.kitchen.queue.push({
                    recipeId: recipeId,
                    quantity: quantity,
                    startTime: Date.now(),
                    cookedBy: { uid: userId, nickname: playerState.nickname }
                });
                updatePlayerState(newPlayerState);
                updateFarmState(newFarmState);
                hideCookingModal();
                updateQuestProgress('cook', quantity);
            } else {
                alert("‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠!");
            }
        }

        function collectCookedFood(queueIndex) {
            const newFarmState = JSON.parse(JSON.stringify(farmState));
            const newPlayerState = JSON.parse(JSON.stringify(playerState));
            if (!newFarmState.kitchen.queue[queueIndex]) return; 
            const job = newFarmState.kitchen.queue[queueIndex];
            const recipe = GAME_DATA.recipes[job.recipeId];
            for (let i = 0; i < job.quantity; i++) {
                newPlayerState.storageBin.push({ id: recipe.resultId, quality: 0 });
            }
            newFarmState.kitchen.queue.splice(queueIndex, 1);
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function expandGrid(type) {
            const cost = calculateExpansionCost(type);
            const typeMap = {
                farm: { name: '‡πÅ‡∏õ‡∏•‡∏á', array: farmState.plots, newItem: { plantId: null } },
                animals: { name: '‡∏Ñ‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå', array: farmState.animals, newItem: { animalId: null } },
                factory: { name: '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', array: farmState.factories, newItem: { factoryId: null } }
            };
            const info = typeMap[type];
            if (!info) return;
            if (playerState.money >= cost) {
                showConfirmationModal(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠${info.name}‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${cost}üí∞ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
                    const newPlayerState = { ...playerState };
                    newPlayerState.money -= cost;
                    const newFarmState = { ...farmState };
                    info.array.push(info.newItem);
                    updatePlayerState(newPlayerState);
                    updateFarmState(newFarmState);
                });
            } else {
                alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
            }
        }

        async function updateQuestProgress(action, amount = 1) {
            if (!farmState || !farmState.quests) return;
            const newFarmState = { ...farmState };
            let questsUpdated = false;
            ['daily', 'weekly'].forEach(type => {
                newFarmState.quests[type]?.forEach(quest => {
                    const questData = QUEST_DATA[type].find(q => q.id === quest.id);
                    if (questData?.action === action && quest.progress < questData.target) {
                        quest.progress = Math.min(quest.progress + amount, questData.target);
                        questsUpdated = true;
                    }
                });
            });
            if (questsUpdated) await updateFarmState(newFarmState);
        }

        async function claimQuestReward(type, id) {
            const quest = farmState.quests[type].find(q => q.id === id);
            const questData = QUEST_DATA[type].find(q => q.id === id);
            if (!quest || !questData || quest.claimedBy?.includes(userId) || quest.progress < questData.target) return;

            const newFarmState = { ...farmState };
            const questToUpdate = newFarmState.quests[type].find(q => q.id === id);
            if (!questToUpdate.claimedBy) questToUpdate.claimedBy = [];
            questToUpdate.claimedBy.push(userId);

            const newPlayerState = { ...playerState };
            const { reward } = questData;
            let rewardId = reward.id === 'random' && reward.type === 'seed' 
                ? Object.keys(GAME_DATA).filter(k => GAME_DATA[k].type === 'seed')[Math.floor(Math.random() * Object.keys(GAME_DATA).filter(k => GAME_DATA[k].type === 'seed').length)] 
                : reward.id;
            
			if (reward.type === 'produce') {
                 for (let i = 0; i < reward.count; i++) newPlayerState.storageBin.push({ id: rewardId, quality: 0 });
            } else { 
                newPlayerState.inventory[rewardId] = (newPlayerState.inventory[rewardId] || 0) + reward.count;
            }
            
            await updateFarmState(newFarmState);
            await updatePlayerState(newPlayerState);
        }
        
        let gameLoopInterval = null;
        async function startGame(uid) {
            userId = uid;
            initPlayerListeners(uid);
            initFarmListeners();
            document.getElementById('loading-screen').classList.add('loading-hidden');
            document.getElementById('game-container').style.opacity = 1;
            document.getElementById('footer-nav').style.opacity = 1;
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(() => { renderAll(); }, 2000); 
            setInterval(() => { checkForTimeResets(); }, 60000); // Check for day reset every minute
        }

        function initPlayerListeners(uid) {
            const playerDocRef = doc(db, "players", uid);
            onSnapshot(playerDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    playerState = docSnap.data();
                    if (!playerState.produceBin) playerState.produceBin = [];
                    if (!playerState.storageBin) playerState.storageBin = [];
                    if (typeof playerState.houseLevel === 'undefined') playerState.houseLevel = 0;
                    if (typeof playerState.fishingRodLevel === 'undefined') playerState.fishingRodLevel = 0;
                    if (typeof playerState.energy === 'undefined') playerState.energy = 100;
                }
            }, handleFirestoreError);
        }
        
        function initFarmListeners() {
            const farmDocRef = doc(db, "publicFarmData", "farmState");
            onSnapshot(farmDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    farmState = docSnap.data();
                    if (!farmState.quests) farmState.quests = { daily: [], weekly: [], lastDailyReset: 0, lastWeeklyReset: 0 };
                    if (!farmState.ownedKitchenTools) farmState.ownedKitchenTools = [];
                    if (!farmState.factories) farmState.factories = Array(FACTORY_GRID_SIZE).fill(null).map(() => ({ factoryId: null }));
                    if (!farmState.kitchen) farmState.kitchen = { queue: [] };
                    if (!farmState.marketPrices) farmState.marketPrices = {};
                    if (!farmState.salesVolume) farmState.salesVolume = {};
                }
            }, handleFirestoreError);
        }
        
        async function ensureFarmDataExists() {
            const farmDocRef = doc(db, "publicFarmData", "farmState");
            try {
                const farmSnap = await getDoc(farmDocRef);
                if (!farmSnap.exists()) {
                    console.log("Farm data not found, creating initial state...");
                    const initialFarmState = {
                        plots: Array(FARM_GRID_SIZE).fill(null).map(() => ({ plantId: null })),
                        animals: Array(ANIMAL_PEN_SIZE).fill(null).map(() => ({ animalId: null })),
                        factories: Array(FACTORY_GRID_SIZE).fill(null).map(() => ({ factoryId: null })),
                        quests: { daily: generateRandomQuests('daily', 5), weekly: generateRandomQuests('weekly', 5), lastDailyReset: Date.now(), lastWeeklyReset: Date.now() },
                        ownedKitchenTools: [],
                        kitchen: { queue: [] },
                        marketPrices: {},
                        salesVolume: {}
                    };
                    await setDoc(farmDocRef, initialFarmState);
                }
            } catch (error) {
                console.warn("Could not ensure farm data existence.", error.message);
                throw error;
            }
        }
        
        function handleFirestoreError(error) { console.error("Firestore connection error:", error); }
        
        let isInitialNameSetup = false;
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        
        function setupControls() {
            const moreModal = document.getElementById('more-modal');
            const moreBtn = document.getElementById('more-btn');
            const moreModalItems = document.getElementById('more-modal-items');
            const primaryViews = ['farm', 'animals', 'shop'];
            const secondaryViews = [
                { view: 'bedroom', name: '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô üõå' },
                { view: 'fishing', name: '‡∏ö‡πà‡∏≠‡∏õ‡∏•‡∏≤ üé£' },
                { view: 'kitchen', name: '‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ß üç≥' },
                { view: 'factory', name: '‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô üè≠' },
                { view: 'quests', name: '‡πÄ‡∏Ñ‡∏ß‡∏™ üìú' },
                { view: 'market', name: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î üìà' }
            ];

            moreModalItems.innerHTML = '';
            secondaryViews.forEach(secView => {
                const button = document.createElement('button');
                button.textContent = secView.name;
                button.dataset.view = secView.view;
                button.className = 'w-full text-left font-bold py-3 px-4 rounded-lg transition bg-gray-100 hover:bg-green-100 text-gray-800';
                moreModalItems.appendChild(button);
            });
            
            document.addEventListener('click', e => {
                const target = e.target.closest('[data-view]');
                if (!moreModal.classList.contains('hidden') && !e.target.closest('#more-modal > div') && !e.target.closest('#more-btn')) {
                    moreModal.classList.add('hidden');
                }
                if (!target) return;
                const view = target.dataset.view;
                if (view === 'more') {
                    moreModal.classList.toggle('hidden');
                    return;
                }
                document.querySelectorAll('#tab-content-area > div').forEach(div => div.classList.add('hidden'));
                const viewEl = document.getElementById(`${view}-view`);
                if (viewEl) viewEl.classList.remove('hidden');

                document.querySelectorAll('#footer-nav .nav-btn').forEach(b => b.classList.remove('active'));
                
                const primaryBtn = document.querySelector(`.nav-btn[data-view="${view}"]`);
                if (primaryViews.includes(view) && primaryBtn) {
                    primaryBtn.classList.add('active');
                } else if (secondaryViews.some(sv => sv.view === view)) {
                    moreBtn.classList.add('active');
                }
                if (view !== 'more') moreModal.classList.add('hidden');
            });
            document.querySelector('.nav-btn[data-view="farm"]').classList.add('active');
            
            document.getElementById('context-modal-close').onclick = hideContextMenu;
            document.getElementById('submenu-modal-close').onclick = hideSubMenu;

            const shopItemsEl = document.getElementById('shop-items');
            if (shopItemsEl) shopItemsEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('buy-btn')) buyItem(e.target.dataset.itemid);
            });

            const storageItemsEl = document.getElementById('storage-items');
            if(storageItemsEl) storageItemsEl.addEventListener('click', e => {
                const button = e.target;
                const itemId = button.dataset.itemId;
                const quality = parseInt(button.dataset.quality, 10);
                if (button.classList.contains('sell-storage-btn')) sellFromStorage(itemId, quality);
                else if (button.classList.contains('eat-storage-btn')) eatFromStorage(itemId, quality);
                else if (button.classList.contains('move-to-inventory-btn')) moveFromStorageToInventory(itemId, quality);
            });

            const recipeListEl = document.getElementById('recipe-list');
            if(recipeListEl) recipeListEl.addEventListener('click', e => {
                if (e.target.classList.contains('cook-recipe-btn')) {
                     const button = e.target;
                     const recipeId = button.dataset.recipeId;
                     const quantityInput = button.previousElementSibling;
                     const quantity = parseInt(quantityInput.value, 10);
                     cook(recipeId, quantity);
                }
            });
            
            document.getElementById('upgrade-house-btn').onclick = upgradeHouse;
            document.getElementById('admin-reset-btn').onclick = forceResetFarm;
            document.getElementById('reset-player-btn').onclick = resetPlayerProgress;
            document.getElementById('fish-btn').onclick = fish;
            document.getElementById('upgrade-rod-btn').onclick = upgradeRod;
            document.getElementById('fish-catch-ok').onclick = () => document.getElementById('fish-catch-modal').classList.add('hidden');
            document.getElementById('cook-btn').onclick = showCookingModal;
            document.getElementById('cooking-modal-close').onclick = hideCookingModal;
            playerNameEl.onclick = () => showNameModal(false);
            document.getElementById('save-name-btn').onclick = saveNameChange;
            document.getElementById('cancel-name-btn').onclick = hideNameModal;
            nameInput.onkeypress = (e) => { if (e.key === 'Enter') saveNameChange(); };
            document.getElementById('confirm-modal-cancel').onclick = hideConfirmationModal;
            document.body.addEventListener('click', e => {
                if (e.target.classList.contains('claim-quest-btn')) {
                    claimQuestReward(e.target.dataset.questType, e.target.dataset.questId);
                }
            });
        }
        
        function buyItem(itemId) {
            const itemData = GAME_DATA[itemId];
            if (playerState.money >= itemData.cost) {
                const newPlayerState = { ...playerState };
                newPlayerState.money -= itemData.cost;
                
                if (itemData.type === 'kitchen_tool') {
                    const newFarmState = { ...farmState };
                    if (!newFarmState.ownedKitchenTools) newFarmState.ownedKitchenTools = [];
                    if (!newFarmState.ownedKitchenTools.includes(itemId)) {
                        newFarmState.ownedKitchenTools.push(itemId);
                        updateFarmState(newFarmState);
                    }
                } else {
                   newPlayerState.inventory[itemId] = (newPlayerState.inventory[itemId] || 0) + 1;
                }
                
                updateQuestProgress('buy_item');
                updateQuestProgress('spend_money', itemData.cost);
                if (itemData.type === 'seed') updateQuestProgress('buy_seed');
                if (itemData.type === 'item' && itemId.includes('fertilizer')) updateQuestProgress('buy_fertilizer');
                if (itemData.type === 'animal_deed') updateQuestProgress('buy_animal');
                if (itemData.type === 'kitchen_tool' || itemData.type === 'factory_deed') updateQuestProgress('buy_tool');

                updatePlayerState(newPlayerState);
            }
        }

        function showConfirmationModal(text, onConfirm) {
            const confirmModal = document.getElementById('confirm-modal');
            document.getElementById('confirm-modal-text').textContent = text;
            const okButton = document.getElementById('confirm-modal-ok');
            const newOkButton = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(newOkButton, okButton);
            newOkButton.addEventListener('click', () => {
                onConfirm();
                hideConfirmationModal();
            });
            confirmModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }
        
        const showNameModal = (isInitial = false) => {
            isInitialNameSetup = isInitial;
            nameInput.value = isInitial ? '' : playerState.nickname;
            nameModal.classList.remove('hidden');
            nameModal.querySelector('div').classList.add('modal-enter');
            nameInput.focus();
            document.getElementById('cancel-name-btn').style.display = isInitial ? 'none' : 'inline-block';
            document.getElementById('name-modal-title').textContent = isInitial ? "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" : "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô";
        };
        const hideNameModal = () => {
            const modalContent = nameModal.querySelector('div');
            modalContent.classList.add('modal-leave');
            setTimeout(() => nameModal.classList.add('hidden'), 200);
        };
        const saveNameChange = async () => {
            const newName = nameInput.value.trim();
            if (newName.length > 0 && newName.length <= 15) {
                if (isInitialNameSetup) {
                    playerState = { 
                        money: 20, inventory: {}, produceBin: [], storageBin: [],
                        nickname: newName, houseLevel: 0, lastResetTime: 0,
                        fishingRodLevel: 0, energy: 100,
                    };
                    await setDoc(doc(db, "players", userId), playerState);
                    await startGame(userId);
                } else {
                    await updatePlayerState({...playerState, nickname: newName});
                }
                hideNameModal();
            }
        };
        
        window.addEventListener('load', async () => {
            setupControls();
            try {
                 await setPersistence(auth, browserLocalPersistence);
                 onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const playerDocRef = doc(db, "players", userId);
                        try {
                            await ensureFarmDataExists();
                            const docSnap = await getDoc(playerDocRef);
                            if (docSnap.exists()) {
                                await startGame(userId);
                            } else {
                                document.getElementById('loading-screen').classList.add('loading-hidden');
                                showNameModal(true);
                            }
                        } catch (error) { handleFirestoreError(error); }
                    } else { await signInAnonymously(auth); }
                });
            } catch (error) { 
                console.error("Authentication failed:", error); 
                document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>`;
            }
        });
    </script>
</body>
</html>