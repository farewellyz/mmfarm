<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'IBM Plex Sans Thai', sans-serif; 
            touch-action: manipulation; 
            background: linear-gradient(to bottom, #a7f3d0, #f0fdf4);
        }
        .plot, .animal-slot { 
            transition: all 0.2s ease-in-out; 
            background-size: contain; 
            background-position: center; 
            background-repeat: no-repeat; 
        }
        .plot:hover, .animal-slot:hover { transform: scale(1.05); }

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .modal-enter { animation: fadeIn 0.2s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.2s ease-out forwards; }

        @keyframes pop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .pop-animation { animation: pop 0.3s ease-out; }

        @keyframes water-effect {
            0% { background-color: rgba(59, 130, 246, 0); }
            50% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: rgba(59, 130, 246, 0); }
        }
        .watered { animation: water-effect 0.5s ease-out; }

        @keyframes fertilize-effect {
            0% { box-shadow: 0 0 0 0px rgba(139, 69, 19, 0); }
            50% { box-shadow: 0 0 15px 5px rgba(139, 69, 19, 0.5); }
            100% { box-shadow: 0 0 0 0px rgba(139, 69, 19, 0); }
        }
        .fertilized { animation: fertilize-effect 0.6s ease-out; }

        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animal.happy { animation: hop 0.5s infinite; }

        body { padding-bottom: 80px; }
        .nav-btn.active { background-color: #15803d; color: white; border-top: 4px solid #facc15; }
        .quality-star { color: #facc15; text-shadow: 0 0 2px black; }
        .loading-hidden { opacity: 0; pointer-events: none; }
        
        #bedroom-display {
            background-size: cover;
            background-position: center;
        }
        #pond-display {
            background-image: url('sea.png');
            background-size: cover;
            background-position: center;
        }

        /* Fishing Minigame Styles */
        #fishing-minigame-track {
            height: 300px;
            width: 50px;
            background-color: rgba(100, 150, 255, 0.3);
            border: 2px solid #4A90E2;
            border-radius: 10px;
            position: relative;
        }
        #fishing-minigame-fish {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 20px;
            font-size: 20px;
            text-align: center;
            transition: top 0.1s linear;
        }
        #fishing-minigame-bar {
            position: absolute;
            left: 0;
            width: 100%;
            background-color: rgba(26, 179, 148, 0.5);
            border: 2px solid #1ab394;
            border-radius: 8px;
        }
        #fishing-minigame-progress {
            width: 20px;
            height: 100%;
            background-color: #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        #fishing-minigame-progress-fill {
            width: 100%;
            background-color: #f8ac59;
            height: 0;
            transition: height 0.1s linear;
        }

    </style>
</head>
<body class="min-h-screen">
    
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-green-100 z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="text-6xl animate-bounce">ü•ï</div>
        <p class="mt-4 text-2xl font-bold text-green-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ü‡∏≤‡∏£‡πå‡∏°...</p>
    </div>

    <!-- All Modals -->
    <div id="modal-container">
        <!-- Name Change Modal -->
        <div id="name-modal" class="hidden fixed inset-0 bg-black/50 z-[52] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter">
                <h2 id="name-modal-title" class="text-2xl font-bold text-gray-800 mb-4">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</h2>
                <p class="text-gray-600 mb-4">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 15 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</p>
                <input type="text" id="name-input" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500" maxlength="15">
                <div class="mt-6 flex justify-end gap-3">
                    <button id="cancel-name-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="save-name-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 z-[53] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm modal-enter">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏¢‡∏∑‡∏ô‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h2>
                <p id="confirm-modal-text" class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="confirm-modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="confirm-modal-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </div>
        </div>

        <!-- Context Menu Modal -->
        <div id="context-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div id="context-modal-content" class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-xs text-center">
                <h3 id="context-modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <div id="context-modal-actions" class="flex flex-col gap-3"></div>
                <button id="context-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
         <!-- Sub-menu Modal -->
        <div id="submenu-modal" class="hidden fixed inset-0 bg-black/60 z-[51] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-5 w-full max-w-xs">
                <h3 id="submenu-modal-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h3>
                <div id="submenu-modal-items" class="grid grid-cols-3 gap-3 text-center"></div>
                <button id="submenu-modal-close" class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg w-full">‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
        </div>
        <!-- More Menu Modal -->
        <div id="more-modal" class="hidden fixed inset-0 bg-black/50 z-[51] flex items-end justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-4 w-full max-w-md mb-20 modal-enter">
                <div id="more-modal-items" class="flex flex-col gap-3">
                    <!-- Buttons will be generated by JS -->
                </div>
            </div>
        </div>
        <!-- Fish Catch Modal -->
        <div id="fish-catch-modal" class="hidden fixed inset-0 bg-black/60 z-[54] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center modal-enter">
                <h2 id="fish-catch-title" class="text-2xl font-bold text-gray-800 mb-2"></h2>
                <div id="fish-catch-icon" class="text-5xl mb-4 h-16 w-16 mx-auto bg-contain bg-no-repeat bg-center"></div>
                <p class="text-gray-600 mb-4" id="fish-catch-rarity"></p>
                <button id="fish-catch-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°!</button>
            </div>
        </div>
        <!-- Fishing Minigame Modal -->
        <div id="fishing-minigame-modal" class="hidden fixed inset-0 bg-black/60 z-[55] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-6 flex items-center justify-center gap-4 cursor-pointer" id="fishing-minigame-area">
                <div id="fishing-minigame-progress">
                    <div id="fishing-minigame-progress-fill"></div>
                </div>
                <div id="fishing-minigame-track">
                    <div id="fishing-minigame-bar"></div>
                    <div id="fishing-minigame-fish"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Game Area -->
    <div id="game-container" class="w-full max-w-5xl mx-auto p-4 md:p-6 opacity-0 transition-opacity duration-500">
        <header class="text-center mb-4 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-4 relative">
            <button id="admin-reset-btn" class="hidden absolute top-2 right-2 bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-red-700">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≤‡∏£‡πå‡∏° (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</button>
             <button id="reset-player-btn" class="absolute bottom-1 right-2 bg-yellow-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-yellow-600">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏â‡∏±‡∏ô</button>
            <h1 class="text-3xl md:text-4xl font-bold text-green-800">‡∏™‡∏ß‡∏ô‡∏ú‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üíö</h1>
            <div class="mt-3 flex flex-wrap justify-center items-center gap-x-4 gap-y-2 text-sm text-gray-600">
                <div class="flex items-center justify-center gap-2 bg-green-100 px-3 py-1 rounded-full">
                    <span>‡∏ä‡∏∑‡πà‡∏≠:</span>
                    <span id="player-name" class="font-bold text-green-900 cursor-pointer hover:underline" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠">...</span>
                </div>
                <span class="font-semibold bg-yellow-100 px-3 py-1 rounded-full">üí∞: <span id="money-display" class="font-bold text-yellow-800">0</span></span>
            </div>
             <div id="inventory-display" class="mt-3 flex flex-wrap justify-center items-center gap-x-3 gap-y-1 text-xs text-gray-500"></div>
             <div id="user-id-display" class="mt-2 text-xs text-gray-400 break-all"></div>
        </header>

        <main id="tab-content-area" class="bg-white/60 backdrop-blur-sm rounded-2xl shadow-inner p-4 min-h-[400px]">
            <div id="farm-view">
                <div id="farm-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-2 md:gap-4 flex-grow"></div>
            </div>
            <div id="animals-view" class="hidden">
                 <div id="animal-pen" class="grid grid-cols-3 sm:grid-cols-4 gap-2 md:gap-4"></div>
            </div>
            <!-- Bedroom View -->
            <div id="bedroom-view" class="hidden">
                 <div class="w-full max-w-2xl mx-auto text-center">
                    <h2 class="text-3xl font-bold text-green-800 mb-4">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ üõå</h2>
                    <div id="bedroom-display" class="relative w-full aspect-[4/3] rounded-lg shadow-inner overflow-hidden"></div>
                    <div id="bedroom-info" class="mt-4">
                        <p class="text-lg">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö <span id="house-level" class="font-bold">0</span></p>
                        <button id="upgrade-house-btn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                            ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î
                        </button>
                    </div>
                 </div>
            </div>
             <!-- Fishing View -->
            <div id="fishing-view" class="hidden">
                <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">‡∏ö‡πà‡∏≠‡∏õ‡∏•‡∏≤ üé£</h2>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <!-- Pond -->
                    <div id="pond-display" class="w-full md:w-3/5 aspect-video rounded-lg shadow-inner"></div>

                    <!-- Controls -->
                    <div class="w-full md:w-2/5 flex flex-col items-center space-y-6">
                        <!-- Energy -->
                        <div class="w-full flex flex-col items-center">
                            <h3 class="font-bold text-lg">‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</h3>
                            <div class="w-full max-w-xs bg-gray-200 rounded-full h-6 mt-2">
                                <div id="energy-bar" class="bg-blue-500 h-6 rounded-full text-white text-sm flex items-center justify-center transition-all duration-500"></div>
                            </div>
                            <p id="energy-text" class="text-sm mt-1"></p>
                        </div>
                        <!-- Rod -->
                        <div class="w-full flex flex-col items-center">
                            <h3 class="font-bold text-lg">‡πÄ‡∏ö‡πá‡∏î‡∏ï‡∏Å‡∏õ‡∏•‡∏≤</h3>
                            <div id="rod-image" class="w-24 h-24 my-2 bg-contain bg-no-repeat bg-center"></div>
                            <p id="rod-level-text" class="text-sm font-semibold"></p>
                            <button id="upgrade-rod-btn" class="text-xs bg-green-500 text-white py-1 px-3 rounded-full mt-1 hover:bg-green-600 disabled:bg-gray-400"></button>
                            <button id="fish-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-full disabled:bg-gray-400">‡∏ï‡∏Å‡∏õ‡∏•‡∏≤ (-5‚ö°)</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="shop-view" class="hidden">
                <div class="w-full max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold text-green-800 mb-4 text-center">üè™ ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ & ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á</h2>
                    <div id="storage-container" class="mb-6">
                        <h3 class="text-xl font-bold text-green-700 mb-2 text-center">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á üì¶</h3>
                        <div id="storage-items" class="min-h-[100px] max-h-[200px] overflow-y-auto space-y-2 p-2 bg-yellow-50 rounded-lg">
                            <p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>
                        </div>
                    </div>
                    <div id="sell-box" class="mb-6 bg-yellow-100 p-4 rounded-xl border-2 border-dashed border-yellow-300">
                        <h3 class="text-xl font-bold text-yellow-800 mb-2 text-center">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á üì¨</h3>
                        <div id="sell-box-items" class="min-h-[50px] space-y-2">
                        </div>
                        <div class="mt-4 text-center">
                            <p class="font-semibold text-lg">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏£‡∏±‡∏ö: <span id="sell-box-total" class="font-bold">0</span>üí∞</p>
                            <p id="sell-countdown" class="text-sm text-gray-600 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤...</p>
                        </div>
                    </div>
                    <div id="shop-items" class="space-y-4"></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Bottom Navigation Bar -->
    <footer id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-[0_-4px_12px_rgba(0,0,0,0.05)] z-40 flex justify-around opacity-0 transition-opacity duration-500">
        <button data-view="farm" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏ü‡∏≤‡∏£‡πå‡∏°</button>
        <button data-view="animals" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏Ñ‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå</button>
        <button data-view="shop" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <button id="more-btn" data-view="more" class="nav-btn flex-1 py-3 text-green-800 font-bold text-lg hover:bg-green-100 transition">... ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
          apiKey: "AIzaSyDAc4bOydh3x9OFMI-ocbAIXDQc61qRcnc",
          authDomain: "my-farm-game-556f5.firebaseapp.com",
          projectId: "my-farm-game-556f5",
          storageBucket: "my-farm-game-556f5.appspot.com",
          messagingSenderId: "725056841274",
          appId: "1:725056841274:web:a2b0d5b0cb913c2a10f703",
          measurementId: "G-R0DJJ5KWD0"
        };
        //  ++++++++++++++++++++++++++++++++++++++++++++++++++++

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const FARM_GRID_SIZE = 24;
        const ANIMAL_PEN_SIZE = 8;
        const ADMIN_UID = "p7Ujrm9dBZcL6bK5EHYEsrJOCvl2";

        // --- MASTER GAME DATA ---
        const GAME_DATA = {
            'house_upgrades': [
                { name: '‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå', cost: 500, imageUrl: 'beadroom1.png' },
                { name: '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡πÑ‡∏°‡πâ', cost: 2500, imageUrl: 'beadroom2.png' },
                { name: '‡∏ö‡πâ‡∏≤‡∏ô‡∏≠‡∏¥‡∏ê', cost: 10000, imageUrl: 'beadroom3.png' },
                { name: '‡∏Ñ‡∏§‡∏´‡∏≤‡∏™‡∏ô‡πå', cost: 50000, imageUrl: 'beadroom4.png' },
                { name: '‡∏õ‡∏£‡∏≤‡∏™‡∏≤‡∏ó', cost: 0, imageUrl: 'beadroom5.png' }
            ],
            'fishing_rods': [
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÑ‡∏°‡πâ‡πÑ‡∏ú‡πà', cost: 0, imageUrl: 'rod1.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏Å‡∏•‡∏≤‡∏™', cost: 2500, imageUrl: 'rod2.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÄ‡∏´‡∏•‡πá‡∏Å', cost: 7500, imageUrl: 'rod3.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡∏ó‡∏≠‡∏á', cost: 15000, imageUrl: 'rod4.png' },
                { name: '‡πÄ‡∏ö‡πá‡∏î‡πÉ‡∏ô‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô', cost: 0, imageUrl: 'rod5.png' },
            ],
            'carp': { name: '‡∏õ‡∏•‡∏≤‡∏Ñ‡∏≤‡∏£‡πå‡∏õ', icon: 'üêü', rarity: 'Common', sellPrice: [15, 20, 25], type: 'produce', energyRestore: 3, imageUrl: 'carp.png' },
            'sardine': { name: '‡∏õ‡∏•‡∏≤‡∏ã‡∏≤‡∏£‡πå‡∏î‡∏µ‡∏ô', icon: 'üê†', rarity: 'Common', sellPrice: [20, 25, 30], type: 'produce', energyRestore: 4, imageUrl: 'sardine.png' },
            'tuna': { name: '‡∏õ‡∏•‡∏≤‡∏ó‡∏π‡∏ô‡πà‡∏≤', icon: 'üêü', rarity: 'Uncommon', sellPrice: [35, 50, 65], type: 'produce', energyRestore: 15, imageUrl: 'tuna.png' },
            'salmon': { name: '‡∏õ‡∏•‡∏≤‡πÅ‡∏ã‡∏•‡∏°‡∏≠‡∏ô', icon: 'üê†', rarity: 'Uncommon', sellPrice: [45, 60, 80], type: 'produce', energyRestore: 18, imageUrl: 'salmon.png' },
            'eel': { name: '‡∏õ‡∏•‡∏≤‡πÑ‡∏´‡∏•', icon: 'È∞ª', rarity: 'Rare', sellPrice: [150, 200, 250], type: 'produce', energyRestore: 30, imageUrl: 'eel.png' },
            'pufferfish': { name: '‡∏õ‡∏•‡∏≤‡∏õ‡∏±‡∏Å‡πÄ‡∏õ‡πâ‡∏≤', icon: 'üê°', rarity: 'Rare', sellPrice: [200, 250, 300], type: 'produce', energyRestore: 35, imageUrl: 'pufferfish.png' },
            'carrot_seed':   { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'seed', cost: 5, plantId: 'carrot', icon: 'ü•ï', imageUrl: 'carrot.png' },
            'carrot':        { name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'crop', growTime: 9600, produceId: 'carrot_produce', icon: 'ü•ï', imageUrl: 'carrot.png' },
            'carrot_produce':{ name: '‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó', type: 'produce', sellPrice: [8, 12, 16], icon: 'ü•ï', energyRestore: 2 },
            
            'tomato_seed':   { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'seed', cost: 10, plantId: 'tomato', icon: 'üçÖ', imageUrl: 'tomato.png' },
            'tomato':        { name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'crop', growTime: 14400, produceId: 'tomato_produce', icon: 'üçÖ', imageUrl: 'tomato.png' },
            'tomato_produce':{ name: '‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®', type: 'produce', sellPrice: [18, 25, 35], icon: 'üçÖ', energyRestore: 3 },

            'strawberry_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'seed', cost: 15, plantId: 'strawberry', icon: 'üçì', imageUrl: 'stawberry.png' },
            'strawberry':      { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'crop', growTime: 16800, produceId: 'strawberry_produce', icon: 'üçì', imageUrl: 'stawberry.png' },
            'strawberry_produce': { name: '‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ', type: 'produce', sellPrice: [25, 35, 50], icon: 'üçì', energyRestore: 4 },

            'grape_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'seed', cost: 20, plantId: 'grape', icon: 'üçá', imageUrl: 'grape.png' },
            'grape':      { name: '‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'crop', growTime: 21000, produceId: 'grape_produce', icon: 'üçá', imageUrl: 'grape.png' },
            'grape_produce': { name: '‡∏≠‡∏á‡∏∏‡πà‡∏ô', type: 'produce', sellPrice: [35, 50, 70], icon: 'üçá', energyRestore: 6 },

            'peach_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏µ‡∏ä', type: 'seed', cost: 25, plantId: 'peach', icon: 'üçë', imageUrl: 'peach.png' },
            'peach':      { name: '‡∏û‡∏µ‡∏ä', type: 'crop', growTime: 21600, produceId: 'peach_produce', icon: 'üçë', imageUrl: 'peach.png' },
            'peach_produce': { name: '‡∏û‡∏µ‡∏ä', type: 'produce', sellPrice: [45, 65, 90], icon: 'üçë', energyRestore: 8 },

            'orange_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡πâ‡∏°', type: 'seed', cost: 30, plantId: 'orange', icon: 'üçä', imageUrl: 'orange.png' },
            'orange':      { name: '‡∏™‡πâ‡∏°', type: 'crop', growTime: 25200, produceId: 'orange_produce', icon: 'üçä', imageUrl: 'orange.png' },
            'orange_produce': { name: '‡∏™‡πâ‡∏°', type: 'produce', sellPrice: [55, 80, 110], icon: 'üçä', energyRestore: 9 },

            'mango_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'seed', cost: 35, plantId: 'mango', icon: 'ü•≠', imageUrl: 'mango.png' },
            'mango':      { name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'crop', growTime: 28800, produceId: 'mango_produce', icon: 'ü•≠', imageUrl: 'mango.png' },
            'mango_produce': { name: '‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', type: 'produce', sellPrice: [65, 95, 130], icon: 'ü•≠', energyRestore: 11 },

            'pineapple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'seed', cost: 40, plantId: 'pineapple', icon: 'üçç', imageUrl: 'pineapple.png' },
            'pineapple':      { name: '‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'crop', growTime: 32400, produceId: 'pineapple_produce', icon: 'üçç', imageUrl: 'pineapple.png' },
            'pineapple_produce': { name: '‡∏™‡∏±‡∏ö‡∏õ‡∏∞‡∏£‡∏î', type: 'produce', sellPrice: [75, 110, 150], icon: 'üçç', energyRestore: 12 },

            'guava_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'seed', cost: 18, plantId: 'guava', icon: 'üçà', imageUrl: 'guava.png' },
            'guava':      { name: '‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'crop', growTime: 22400, produceId: 'guava_produce', icon: 'üçà', imageUrl: 'guava.png' },
            'guava_produce': { name: '‡∏ù‡∏£‡∏±‡πà‡∏á', type: 'produce', sellPrice: [30, 45, 65], icon: 'üçà', energyRestore: 5 },

            'roseapple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'seed', cost: 22, plantId: 'roseapple', icon: 'üçê', imageUrl: 'chompu.png' },
            'roseapple':      { name: '‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'crop', growTime: 25600, produceId: 'roseapple_produce', icon: 'üçê', imageUrl: 'chompu.png' },
            'roseapple_produce': { name: '‡∏ä‡∏°‡∏û‡∏π‡πà', type: 'produce', sellPrice: [40, 60, 85], icon: 'üçê', energyRestore: 7 },

            'apple_seed': { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'seed', cost: 28, plantId: 'apple', icon: 'üçé', imageUrl: 'apple.png' },
            'apple':      { name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'crop', growTime: 32000, produceId: 'apple_produce', icon: 'üçé', imageUrl: 'apple.png' },
            'apple_produce': { name: '‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡πâ‡∏•', type: 'produce', sellPrice: [50, 75, 105], icon: 'üçé', energyRestore: 10 },
            
            'fertilizer_1': { name: '‡∏õ‡∏∏‡πã‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤', type: 'item', cost: 10, qualityBonus: 0.3, icon: 'üí©' },
            'fertilizer_2': { name: '‡∏õ‡∏∏‡πã‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ', type: 'item', cost: 25, qualityBonus: 0.6, icon: '‚ú®' },
            
            'chicken_deed': { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏Å‡πà', type: 'animal_deed', cost: 100, animalId: 'chicken', icon: 'üêî', imageUrl: 'chicken.png' },
            'chicken':      { name: '‡πÑ‡∏Å‡πà', type: 'animal_instance', produceTime: 600, produceId: 'egg', icon: 'üêî', imageUrl: 'chicken.png' },
            'egg':          { name: '‡πÑ‡∏Ç‡πà', type: 'produce', sellPrice: [12, 18, 25], icon: 'ü•ö', energyRestore: 5 },

            'cow_deed':     { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡∏±‡∏ß', type: 'animal_deed', cost: 500, animalId: 'cow', icon: 'üêÑ', imageUrl: 'cow.png' },
            'cow':          { name: '‡∏ß‡∏±‡∏ß', type: 'animal_instance', produceTime: 3600, produceId: 'milk', icon: 'üêÑ', imageUrl: 'cow.png' },
            'milk':         { name: '‡∏ô‡∏°', type: 'produce', sellPrice: [50, 70, 90], icon: 'ü•õ', energyRestore: 10 },

            'pig_deed':     { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡∏°‡∏π', type: 'animal_deed', cost: 300, animalId: 'pig', icon: 'üêñ', imageUrl: 'pig.png' },
            'pig':          { name: '‡∏´‡∏°‡∏π', type: 'animal_instance', produceTime: 4800, produceId: 'truffle', icon: 'üêñ', imageUrl: 'pig.png' },
            'truffle':      { name: '‡πÄ‡∏´‡πá‡∏î‡∏ó‡∏£‡∏±‡∏ü‡πÄ‡∏ü‡∏¥‡∏•', type: 'produce', sellPrice: [80, 110, 150], icon: 'üçÑ', energyRestore: 15 },

            'duck_deed':    { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏î', type: 'animal_deed', cost: 120, animalId: 'duck', icon: 'ü¶Ü', imageUrl: 'duck.png' },
            'duck':         { name: '‡πÄ‡∏õ‡πá‡∏î', type: 'animal_instance', produceTime: 900, produceId: 'duck_egg', icon: 'ü¶Ü', imageUrl: 'duck.png' },
            'duck_egg':     { name: '‡πÑ‡∏Ç‡πà‡πÄ‡∏õ‡πá‡∏î', type: 'produce', sellPrice: [15, 22, 30], icon: 'ü•ö', energyRestore: 6 },

            'goose_deed':   { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡πà‡∏≤‡∏ô', type: 'animal_deed', cost: 150, animalId: 'goose', icon: 'ü¶¢', imageUrl: 'swan.png' },
            'goose':        { name: '‡∏´‡πà‡∏≤‡∏ô', type: 'animal_instance', produceTime: 1800, produceId: 'feather', icon: 'ü¶¢', imageUrl: 'swan.png' },
            'feather':      { name: '‡∏Ç‡∏ô‡∏ô‡∏Å', type: 'produce', sellPrice: [25, 38, 55], icon: 'ü™∂', energyRestore: 0 }, // Feathers can't be eaten

            'turtle_deed':  { name: '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ï‡πà‡∏≤', type: 'animal_deed', cost: 1000, animalId: 'turtle', icon: 'üê¢', imageUrl: 'turtle.png' },
            'turtle':       { name: '‡πÄ‡∏ï‡πà‡∏≤', type: 'animal_instance', produceTime: 86400, produceId: 'gem', icon: 'üê¢', imageUrl: 'turtle.png' },
            'gem':          { name: '‡∏≠‡∏±‡∏ç‡∏°‡∏ì‡∏µ', type: 'produce', sellPrice: [200, 300, 500], icon: 'üíé', energyRestore: 0 }, // Gems can't be eaten
        };

        // --- Game State ---
        let userId = null;
        let farmState = null;
        let playerState = null;
        
        // --- UI Elements ---
        const playerNameEl = document.getElementById('player-name');
        
        // --- Helper Functions ---
        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            let parts = [];
            if (h > 0) parts.push(`${h} ‡∏ä‡∏°.`);
            if (m > 0) parts.push(`${m} ‡∏ô‡∏≤‡∏ó‡∏µ`);
            if (s > 0 || parts.length === 0) parts.push(`${s} ‡∏ß‡∏¥`);
            return parts.join(' ');
        }
        
        // --- State Management ---
        async function updateFarmState(newState) {
             if (!userId) return;
             farmState = newState;
             const farmDocRef = doc(db, "publicFarmData", "farmState");
             await setDoc(farmDocRef, farmState, { merge: true });
        }
        async function updatePlayerState(newState) {
             if (!userId) return;
             playerState = newState;
             const playerDocRef = doc(db, "players", userId);
             await setDoc(playerDocRef, newState, { merge: true });
        }
        
        // --- Rendering ---
        function renderAll() {
            if (!farmState || !playerState) return; 
            renderFarm();
            renderAnimals();
            renderBedroom();
            renderPlayerUI();
            renderShop();
            renderSellBox();
            renderStorage();
            renderFishing();
        }
        
        function renderFarm() {
            if (!farmState || !Array.isArray(farmState.plots)) return;
            const farmGrid = document.getElementById('farm-grid');
            farmGrid.innerHTML = '';
            farmState.plots.forEach((plot, index) => {
                const plotEl = document.createElement('div');
                plotEl.className = 'plot aspect-square rounded-lg shadow-inner cursor-pointer flex items-center justify-center text-3xl relative';
                plotEl.style.backgroundColor = 'rgba(139, 69, 19, 0.4)';
                
                if (plot.plantId) {
                    const plantData = GAME_DATA[plot.plantId];
                    if (!plantData) {
                        plotEl.innerHTML = `‚ùì`;
                    } else {
                        let progress = 0;
                        if (plot.plantTime) { 
                            const elapsedSeconds = (Date.now() - plot.plantTime) / 1000;
                            const growthMultiplier = 1 + ((plot.wateredBy?.length || 0) * 0.5);
                            const effectiveGrowth = elapsedSeconds * growthMultiplier;
                            progress = Math.min(effectiveGrowth / plantData.growTime, 1);
                        }
                        plotEl.style.backgroundImage = `linear-gradient(to top, rgba(96, 165, 250, 0.5) 0%, rgba(96, 165, 250, 0.5) ${progress*100}%, transparent ${progress*100}%)`;
                        const content = document.createElement('div');
                        content.style.backgroundImage = `url(${plantData.imageUrl})`;
                        content.style.opacity = 0.5 + (progress * 0.5);
                        content.className = 'w-full h-full bg-contain bg-no-repeat bg-center';
                        plotEl.appendChild(content);
                    }
                }
                plotEl.onclick = () => showContextMenu('plot', index);
                farmGrid.appendChild(plotEl);
            });
        }

        function renderAnimals() {
             if (!farmState || !Array.isArray(farmState.animals)) return;
             const animalPen = document.getElementById('animal-pen');
             animalPen.innerHTML = '';
             farmState.animals.forEach((animal, index) => {
                const slotEl = document.createElement('div');
                slotEl.className = 'animal-slot aspect-square rounded-2xl shadow-inner cursor-pointer flex flex-col items-center justify-center p-1 bg-green-200/50';
                
                if (animal.animalId) {
                    const animalData = GAME_DATA[animal.animalId];
                    if (!animalData) {
                        console.error(`Invalid animalId "${animal.animalId}" found for slot ${index}.`);
                        slotEl.innerHTML = `‚ùì`;
                        slotEl.style.backgroundColor = 'rgba(255, 100, 100, 0.5)';
                    } else {
                        const content = document.createElement('div');
                        content.style.backgroundImage = `url(${animalData.imageUrl})`;
                        content.className = 'w-full h-full bg-contain bg-no-repeat bg-center';

                        const progressEl = document.createElement('div');
                        progressEl.className = 'w-full h-1 bg-gray-300 rounded-full mt-1';
                        const progressFill = document.createElement('div');
                        const progress = (Date.now() - animal.startTime) / (animalData.produceTime * 1000);
                        progressFill.className = 'h-1 bg-yellow-400 rounded-full';
                        progressFill.style.width = `${Math.min(progress, 1) * 100}%`;
                        progressEl.appendChild(progressFill);

                        slotEl.appendChild(content);
                        slotEl.appendChild(progressEl);

                        if (progress >= 1) {
                            slotEl.classList.add('animate-bounce');
                        }
                    }
                } else {
                    slotEl.textContent = '+';
                    slotEl.className += ' text-3xl text-gray-400';
                }

                slotEl.onclick = () => showContextMenu('animal', index);
                animalPen.appendChild(slotEl);
             });
        }

        function renderPlayerUI() {
            if (!playerState) return;
            playerNameEl.textContent = playerState.nickname;
            document.getElementById('money-display').textContent = playerState.money || 0;
            const inventoryDisplay = document.getElementById('inventory-display');
            inventoryDisplay.innerHTML = '';
            Object.entries(playerState.inventory).forEach(([itemId, count]) => {
                if (count > 0) {
                    const itemData = GAME_DATA[itemId];
                    if (itemData) {
                        const itemEl = document.createElement('span');
                        itemEl.className = 'bg-white px-2 py-1 rounded-md shadow-sm';
                        itemEl.textContent = `${itemData.icon} ${count}`;
                        inventoryDisplay.appendChild(itemEl);
                    }
                }
            });
            
            document.getElementById('user-id-display').textContent = `ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${userId}`;
            
            const adminResetBtn = document.getElementById('admin-reset-btn');
            if (userId === ADMIN_UID) {
                adminResetBtn.classList.remove('hidden');
            } else {
                adminResetBtn.classList.add('hidden');
            }
        }

        function renderShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            ['seed', 'item', 'animal_deed'].forEach(category => {
                const categoryEl = document.createElement('div');
                const title = {seed:'‡πÄ‡∏°‡∏•‡πá‡∏î‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå', item:'‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°', animal_deed:'‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á'}[category];
                categoryEl.innerHTML = `<h3 class="text-xl font-bold text-green-700 mb-2">${title}</h3>`;
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 md:grid-cols-3 gap-2';

                Object.entries(GAME_DATA).filter(([_, data]) => data.type === category).forEach(([id, data]) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'bg-white/80 p-3 rounded-xl shadow-md flex flex-col items-center gap-2';
                    
                    const iconContainer = document.createElement('div');
                    iconContainer.className = 'text-3xl h-12 w-12 flex items-center justify-center';
                    if (data.imageUrl) {
                        iconContainer.innerHTML = `<img src="${data.imageUrl}" class="w-full h-full object-contain">`;
                    } else {
                        iconContainer.textContent = data.icon;
                    }

                    itemEl.innerHTML = `
                        <div class="font-semibold text-center text-sm">${data.name}</div>
                        <button data-itemid="${id}" class="buy-btn bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-1 px-4 rounded-full w-full">‡∏ã‡∏∑‡πâ‡∏≠ ${data.cost}üí∞</button>
                    `;
                    itemEl.prepend(iconContainer);
                    grid.appendChild(itemEl);
                });
                categoryEl.appendChild(grid);
                shopItems.appendChild(categoryEl);
            });
        }

        function renderSellBox() {
            const itemsEl = document.getElementById('sell-box-items');
            const totalEl = document.getElementById('sell-box-total');
            const countdownEl = document.getElementById('sell-countdown');

            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            const timeRemaining = tomorrow.getTime() - now.getTime();
            countdownEl.textContent = `‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${formatTime(Math.floor(timeRemaining / 1000))}`;
            
            if (!playerState || !playerState.produceBin || playerState.produceBin.length === 0) {
                itemsEl.innerHTML = `<p class="text-center text-yellow-700">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á</p>`;
                totalEl.textContent = '0';
                return;
            }

            itemsEl.innerHTML = '';
            let totalValue = 0;
            const groupedProduce = playerState.produceBin.reduce((acc, item) => {
                const key = `${item.id}_q${item.quality}`;
                if (!acc[key]) {
                    acc[key] = { ...item, count: 0 };
                }
                acc[key].count++;
                return acc;
            }, {});

            Object.values(groupedProduce).forEach(item => {
                const itemData = GAME_DATA[item.id];
                const sellPrice = itemData.sellPrice[item.quality];
                totalValue += sellPrice * item.count;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white/50 p-2 rounded';
                
                const iconHTML = itemData.imageUrl 
                    ? `<div class="w-8 h-8 mr-2 bg-contain bg-no-repeat bg-center" style="background-image: url('${itemData.imageUrl}')"></div>`
                    : `<span class="text-lg">${itemData.icon}</span>`;

                itemDiv.innerHTML = `
                    <div class="flex items-center">
                        ${iconHTML}
                        <span>${itemData.name}</span>
                        <span class="quality-star ml-1">${'‚òÖ'.repeat(item.quality)}</span>
                        <span class="text-gray-600 text-sm ml-2">x${item.count}</span>
                    </div>
                    <span class="font-semibold">${sellPrice * item.count}üí∞</span>
                `;
                itemsEl.appendChild(itemDiv);
            });

            totalEl.textContent = totalValue;
        }
        
        function renderBedroom() {
            if (!playerState) return;
            const container = document.getElementById('bedroom-display');
            const infoP = document.getElementById('bedroom-info').querySelector('p');
            const upgradeBtn = document.getElementById('upgrade-house-btn');

            const houseLevel = playerState.houseLevel || 0;

            if (houseLevel === 0) {
                container.style.backgroundImage = 'none';
                container.style.backgroundColor = '#D2B48C';
                infoP.innerHTML = `‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô`;
                
                const firstPurchaseData = GAME_DATA.house_upgrades[0];
                upgradeBtn.textContent = `‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô (${firstPurchaseData.cost}üí∞)`;
                upgradeBtn.disabled = playerState.money < firstPurchaseData.cost;
            } else {
                container.style.backgroundColor = 'transparent';
                const houseData = GAME_DATA.house_upgrades[houseLevel - 1];
                container.style.backgroundImage = `url(${houseData.imageUrl})`;
                infoP.innerHTML = `‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö <span id="house-level" class="font-bold">${houseLevel}</span>`;
                
                if (houseLevel >= GAME_DATA.house_upgrades.length) {
                    upgradeBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                    upgradeBtn.disabled = true;
                } else {
                    const nextUpgradeData = GAME_DATA.house_upgrades[houseLevel];
                    upgradeBtn.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (${nextUpgradeData.cost}üí∞)`;
                    upgradeBtn.disabled = playerState.money < nextUpgradeData.cost;
                }
            }
        }
        
        function renderStorage() {
            const container = document.getElementById('storage-items');
            if (!playerState || !playerState.storageBin || playerState.storageBin.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>`;
                return;
            }

            container.innerHTML = '';
            const groupedStorage = playerState.storageBin.reduce((acc, item) => {
                const key = `${item.id}_q${item.quality}`;
                if (!acc[key]) {
                    acc[key] = { ...item, count: 0 };
                }
                acc[key].count++;
                return acc;
            }, {});

            Object.values(groupedStorage).forEach(item => {
                const itemData = GAME_DATA[item.id];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-white/80 p-2 rounded-lg gap-2';
                let buttonsHTML = `<button class="sell-storage-btn bg-green-500 text-white font-bold py-1 px-3 rounded-full hover:bg-green-600 text-xs" data-item-id="${item.id}" data-quality="${item.quality}">‡∏Ç‡∏≤‡∏¢</button>`;
                if (itemData.energyRestore > 0) {
                    buttonsHTML += `<button class="eat-storage-btn bg-blue-500 text-white font-bold py-1 px-3 rounded-full hover:bg-blue-600 text-xs" data-item-id="${item.id}" data-quality="${item.quality}">‡∏Å‡∏¥‡∏ô (+${itemData.energyRestore}‚ö°)</button>`;
                }
                
                const iconHTML = itemData.imageUrl 
                    ? `<div class="w-10 h-10 mr-2 bg-contain bg-no-repeat bg-center" style="background-image: url('${itemData.imageUrl}')"></div>`
                    : `<span class="text-2xl">${itemData.icon}</span>`;

                itemDiv.innerHTML = `
                    <div class="flex-grow flex items-center">
                        ${iconHTML}
                        <div>
                            <span>${itemData.name}</span>
                            <span class="quality-star">${'‚òÖ'.repeat(item.quality)}</span>
                            <span class="text-gray-600 text-sm ml-2">x${item.count}</span>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        ${buttonsHTML}
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }
        
        function renderFishing() {
            if (!playerState) return;
            const MAX_ENERGY = 100;

            const energyBar = document.getElementById('energy-bar');
            const energyText = document.getElementById('energy-text');
            const fishBtn = document.getElementById('fish-btn');
            const rodImage = document.getElementById('rod-image');
            const rodLevelText = document.getElementById('rod-level-text');
            const upgradeRodBtn = document.getElementById('upgrade-rod-btn');

            energyBar.style.width = `${((playerState.energy || 0) / MAX_ENERGY) * 100}%`;
            energyText.textContent = `${playerState.energy || 0} / ${MAX_ENERGY}`;
            
            fishBtn.disabled = (playerState.energy || 0) < 5;

            const rodLevel = playerState.fishingRodLevel || 0;
            const rodData = GAME_DATA.fishing_rods[rodLevel];
            rodImage.style.backgroundImage = `url(${rodData.imageUrl})`;
            rodLevelText.textContent = `${rodData.name} (Lv. ${rodLevel + 1})`;
            
            if (rodLevel >= GAME_DATA.fishing_rods.length - 1) {
                upgradeRodBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î';
                upgradeRodBtn.disabled = true;
            } else {
                const nextRodData = GAME_DATA.fishing_rods[rodLevel + 1];
                upgradeRodBtn.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î (${nextRodData.cost}üí∞)`;
                upgradeRodBtn.disabled = playerState.money < nextRodData.cost;
            }
        }
        
        function showContextMenu(type, id) {
            const modal = document.getElementById('context-modal');
            const contentEl = document.getElementById('context-modal-content');
            const titleEl = document.getElementById('context-modal-title');
            const actionsEl = document.getElementById('context-modal-actions');
            actionsEl.innerHTML = '';
            contentEl.querySelectorAll('.context-details').forEach(el => el.remove());
            const detailsEl = document.createElement('div');
            detailsEl.className = 'context-details text-sm text-gray-600 mb-4 border-t pt-4 mt-4';

            const createButton = (text, action, disabled = false, extraClasses = 'bg-green-500 hover:bg-green-600 text-white') => {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = `w-full font-bold py-2 px-4 rounded-lg transition ${disabled ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : extraClasses}`;
                if (!disabled) button.onclick = () => { action(); hideContextMenu(); };
                return button;
            };

            if (type === 'plot') {
                const index = id;
                const plot = farmState.plots[index];
                titleEl.textContent = `‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà ${index + 1}`;
                if (!plot.plantId) {
                     const plantableItems = Object.keys(playerState.inventory).filter(id => GAME_DATA[id] && GAME_DATA[id].type === 'seed' && playerState.inventory[id] > 0);
                     actionsEl.appendChild(createButton('üå± ‡∏õ‡∏•‡∏π‡∏Å', () => showSubMenu('plant', index, plantableItems), plantableItems.length === 0));
                } else {
                    const plantData = GAME_DATA[plot.plantId];
                    if (!plantData) {
                        detailsEl.innerHTML = `<p class="text-red-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡∏ä‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</p>`;
                        actionsEl.before(detailsEl);
                        actionsEl.appendChild(createButton('‚ùå ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡πÅ‡∏õ‡∏•‡∏á (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', () => clearPlot(index), false, 'bg-red-500 hover:bg-red-600 text-white'));
                    } else {
                        let effectiveGrowth = 0;
                        if (plot.plantTime) {
                            const elapsedSeconds = (Date.now() - plot.plantTime) / 1000;
                            const growthMultiplier = 1 + ((plot.wateredBy?.length || 0) * 0.5);
                            effectiveGrowth = elapsedSeconds * growthMultiplier;
                        }

                        const isGrown = effectiveGrowth >= plantData.growTime;
                        const growthMultiplierForRemainingTime = 1 + ((plot.wateredBy?.length || 0) * 0.5);
                        const remainingSeconds = Math.max(0, (plantData.growTime - effectiveGrowth) / growthMultiplierForRemainingTime);
                        
                        if(plot.plantedBy && plot.plantedBy.nickname){
                             detailsEl.innerHTML += `<p>‡∏õ‡∏•‡∏π‡∏Å‡πÇ‡∏î‡∏¢: <span class="font-semibold">${plot.plantedBy.nickname}</span></p>`;
                        }
                        detailsEl.innerHTML += `<p>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: <span class="font-semibold">${formatTime(remainingSeconds)}</span></p>`;
                        
                        if (plot.wateredBy && plot.wateredBy.length > 0) {
                            const waterers = plot.wateredBy.filter(p => p && p.nickname).map(p => p.nickname).join(', ');
                            detailsEl.innerHTML += `<div class="mt-2"><p>‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏î‡∏¢:</p><p class="font-semibold text-green-700">${waterers}</p></div>`;
                        }
                        actionsEl.before(detailsEl);
                        
                        if (isGrown) {
                            const involvedUids = new Set([plot.plantedBy?.uid, ...(plot.wateredBy?.map(p => p.uid).filter(uid => uid) || [])]);
                            const harvestedUids = new Set(plot.harvestedBy?.map(p => p.uid) || []);
                            const hasHarvested = harvestedUids.has(userId);

                            actionsEl.appendChild(createButton('üåæ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß', () => harvest(index), hasHarvested));
                            actionsEl.appendChild(createButton('‚ùå ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡πÅ‡∏õ‡∏•‡∏á (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)', () => clearPlot(index), false, 'bg-red-500 hover:bg-red-600 text-white'));
                            
                            const playerMap = new Map();
                            if (plot.plantedBy && plot.plantedBy.uid) {
                                playerMap.set(plot.plantedBy.uid, plot.plantedBy.nickname);
                            }
                            if (plot.wateredBy) {
                                plot.wateredBy.forEach(p => {
                                    if (p && p.uid) playerMap.set(p.uid, p.nickname);
                                });
                            }

                            let harvestStatusHTML = '<div class="mt-2 text-xs"><p>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß:</p>';
                            involvedUids.forEach(uid => {
                                const status = harvestedUids.has(uid) ? '‚úÖ' : '‡∏£‡∏≠...';
                                const playerNickname = playerMap.get(uid) || '‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
                                harvestStatusHTML += `<p>${status} ${playerNickname}</p>`;
                            });
                            harvestStatusHTML += '</div>';
                            detailsEl.innerHTML += harvestStatusHTML;

                        } else {
                             const hasWatered = plot.wateredBy && plot.wateredBy.some(p => p.uid === userId);
                             actionsEl.appendChild(createButton('üíß ‡∏£‡∏î‡∏ô‡πâ‡∏≥', () => water(index), hasWatered));
                             const fertilizers = Object.keys(playerState.inventory).filter(id => GAME_DATA[id] && GAME_DATA[id].type === 'item' && playerState.inventory[id] > 0);
                             actionsEl.appendChild(createButton('üí© ‡πÉ‡∏™‡πà‡∏õ‡∏∏‡πã‡∏¢', () => showSubMenu('fertilize', index, fertilizers), fertilizers.length === 0));
                             actionsEl.appendChild(createButton('‚ùå ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡πÅ‡∏õ‡∏•‡∏á', () => clearPlot(index), false, 'bg-red-500 hover:bg-red-600 text-white'));
                        }
                    }
                }
            } else if (type === 'animal') {
                const index = id;
                const animal = farmState.animals[index];
                titleEl.textContent = `‡∏Ñ‡∏≠‡∏Å‡∏ó‡∏µ‡πà ${index + 1}`;
                if (!animal.animalId) {
                     const buyableItems = Object.keys(playerState.inventory).filter(id => GAME_DATA[id] && GAME_DATA[id].type === 'animal_deed' && playerState.inventory[id] > 0);
                     actionsEl.appendChild(createButton('‚ûï ‡∏ß‡∏≤‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå', () => showSubMenu('placeAnimal', index, buyableItems), buyableItems.length === 0));
                } else {
                    const animalData = GAME_DATA[animal.animalId];
                    if(!animalData){
                        detailsEl.innerHTML = `<p class="text-red-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</p>`;
                        actionsEl.before(detailsEl);
                    } else {
                        const isReady = (Date.now() - animal.startTime) >= (animalData.produceTime * 1000);
                        const remainingMillis = Math.max(0, (animal.startTime + animalData.produceTime * 1000) - Date.now());
                        detailsEl.innerHTML = `<p>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô: <span class="font-semibold">${formatTime(remainingMillis / 1000)}</span></p>`;
                        actionsEl.before(detailsEl);
                        
                        if(isReady){
                            actionsEl.appendChild(createButton(`‡πÄ‡∏Å‡πá‡∏ö${GAME_DATA[animalData.produceId].name}`, () => collectProduct(index)));
                        } else {
                             actionsEl.appendChild(createButton('‡πÉ‡∏´‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô)', () => {}, true));
                        }
                    }
                }
            } 
            
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        function hideContextMenu() {
            const modal = document.getElementById('context-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function showSubMenu(actionType, index, itemIds) {
            const modal = document.getElementById('submenu-modal');
            const titleEl = document.getElementById('submenu-modal-title');
            const itemsEl = document.getElementById('submenu-modal-items');
            itemsEl.innerHTML = '';
            titleEl.textContent = actionType === 'plant' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏•‡∏π‡∏Å' : actionType === 'fertilize' ? '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏∏‡πã‡∏¢' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏á';

            itemIds.forEach(itemId => {
                const itemData = GAME_DATA[itemId];
                const itemButton = document.createElement('button');
                itemButton.className = 'p-2 bg-gray-100 rounded-lg hover:bg-green-100';
                itemButton.innerHTML = `<div class="text-3xl">${itemData.icon}</div><div class="text-xs">${itemData.name}</div>`;
                itemButton.onclick = () => {
                    if (actionType === 'plant') plant(index, itemId);
                    else if (actionType === 'fertilize') fertilize(index, itemId);
                    else if (actionType === 'placeAnimal') placeAnimal(index, itemId);
                    hideSubMenu();
                };
                itemsEl.appendChild(itemButton);
            });
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }
        function hideSubMenu() {
            const modal = document.getElementById('submenu-modal');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        // --- Game Actions ---
        function plant(plotIndex, seedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const seedData = GAME_DATA[seedId];
            newFarmState.plots[plotIndex] = { 
                plantId: seedData.plantId, 
                plantTime: Date.now(), 
                fertilizerLevel: 0, 
                wateredBy: [],
                plantedBy: { uid: userId, nickname: playerState.nickname },
                harvestedBy: []
            };
            newPlayerState.inventory[seedId]--;
            document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('pop-animation');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function water(plotIndex) {
             const newFarmState = { ...farmState };
             const plot = newFarmState.plots[plotIndex];
             if (plot.wateredBy && plot.wateredBy.some(p => p.uid === userId)) return; 

             plot.wateredBy.push({ uid: userId, nickname: playerState.nickname });
             document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('watered');
             updateFarmState(newFarmState);
        }

        function fertilize(plotIndex, fertilizerId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const fertilizerData = GAME_DATA[fertilizerId];
            newFarmState.plots[plotIndex].fertilizerLevel += fertilizerData.qualityBonus;
            newPlayerState.inventory[fertilizerId]--;
            document.querySelector(`#farm-grid > div:nth-child(${plotIndex + 1})`).classList.add('fertilized');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }
        
        function clearPlot(plotIndex) {
            const plot = farmState.plots[plotIndex];
            if (!plot) return;

            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ? ‡∏û‡∏∑‡∏ä‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏π‡∏Å‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ', () => {
                const newFarmState = { ...farmState };
                newFarmState.plots[plotIndex] = { plantId: null };
                updateFarmState(newFarmState);
            });
        }

        function harvest(plotIndex) {
            const newPlayerState = { ...playerState };
            const newFarmState = { ...farmState };
            const plot = newFarmState.plots[plotIndex];
            if (!plot || !plot.plantId || (plot.harvestedBy && plot.harvestedBy.some(p => p.uid === userId))) {
                return;
            }
            const cropData = GAME_DATA[plot.plantId];

            let quality = 0;
            if (Math.random() < plot.fertilizerLevel) quality = 1;
            if (Math.random() < plot.fertilizerLevel - 1) quality = 2;

            newPlayerState.storageBin.push({ id: cropData.produceId, quality: quality });
            
            if (!plot.harvestedBy) plot.harvestedBy = [];
            plot.harvestedBy.push({ uid: userId, nickname: playerState.nickname });
            
            const involvedUids = new Set([plot.plantedBy?.uid, ...(plot.wateredBy?.map(p => p.uid).filter(uid => uid) || [])]);
            const harvestedUids = new Set(plot.harvestedBy.map(p => p.uid));
            
            let allHarvested = true;
            for (const uid of involvedUids) {
                if (!harvestedUids.has(uid)) {
                    allHarvested = false;
                    break;
                }
            }

            if (allHarvested) {
                newFarmState.plots[plotIndex] = { plantId: null };
            } else {
                newFarmState.plots[plotIndex] = plot;
            }

            updatePlayerState(newPlayerState);
            updateFarmState(newFarmState);
        }
        
        function placeAnimal(slotIndex, deedId) {
            const newFarmState = { ...farmState };
            const newPlayerState = { ...playerState };
            const deedData = GAME_DATA[deedId];
            newFarmState.animals[slotIndex] = { animalId: deedData.animalId, startTime: Date.now() };
            newPlayerState.inventory[deedId]--;
            document.querySelector(`#animal-pen > div:nth-child(${slotIndex + 1})`).classList.add('pop-animation');
            updateFarmState(newFarmState);
            updatePlayerState(newPlayerState);
        }

        function collectProduct(slotIndex) {
            const newPlayerState = { ...playerState };
            const newFarmState = { ...farmState };
            const animal = newFarmState.animals[slotIndex];
            const animalData = GAME_DATA[animal.animalId];

            newPlayerState.storageBin.push({ id: animalData.produceId, quality: 0 });
            animal.startTime = Date.now();
            newFarmState.animals[slotIndex] = animal;
            
            updatePlayerState(newPlayerState);
            updateFarmState(newFarmState);
        }
        
        function upgradeHouse() {
            const newPlayerState = { ...playerState };
            const currentLevel = newPlayerState.houseLevel || 0;
            if (currentLevel >= GAME_DATA.house_upgrades.length) return;

            const nextLevelData = GAME_DATA.house_upgrades[currentLevel];
            if (newPlayerState.money >= nextLevelData.cost) {
                newPlayerState.money -= nextLevelData.cost;
                newPlayerState.houseLevel = currentLevel + 1;
                updatePlayerState(newPlayerState);
            }
        }
        
        function sellFromStorage(itemId, quality) {
            const newPlayerState = { ...playerState };
            const itemIndex = newPlayerState.storageBin.findIndex(item => item.id === itemId && item.quality === quality);
            
            if (itemIndex > -1) {
                const itemToSell = newPlayerState.storageBin.splice(itemIndex, 1)[0];
                newPlayerState.produceBin.push(itemToSell);
                updatePlayerState(newPlayerState);
            }
        }

        function eatFromStorage(itemId, quality) {
            const newPlayerState = { ...playerState };
            const itemIndex = newPlayerState.storageBin.findIndex(item => item.id === itemId && item.quality === quality);
            
            if (itemIndex > -1) {
                const itemData = GAME_DATA[itemId];
                if (!itemData.energyRestore || itemData.energyRestore === 0) return;

                newPlayerState.storageBin.splice(itemIndex, 1);
                
                const MAX_ENERGY = 100;
                newPlayerState.energy = Math.min(MAX_ENERGY, (newPlayerState.energy || 0) + itemData.energyRestore);
                
                updatePlayerState(newPlayerState);
            }
        }
        
        async function checkForMidnightReset() {
            if (!playerState) return;

            const now = new Date();
            const lastReset = new Date(playerState.lastResetTime || 0);
            
            if (lastReset.getFullYear() < now.getFullYear() ||
                lastReset.getMonth() < now.getMonth() ||
                lastReset.getDate() < now.getDate()) {

                console.log("Processing daily midnight reset...");
                
                const newPlayerState = { ...playerState };
                let processedPayout = false;

                if (newPlayerState.produceBin && newPlayerState.produceBin.length > 0) {
                    let totalValue = 0;
                    newPlayerState.produceBin.forEach(item => {
                        const itemData = GAME_DATA[item.id];
                        if (itemData && itemData.sellPrice) {
                            totalValue += itemData.sellPrice[item.quality];
                        }
                    });
                    newPlayerState.money = (newPlayerState.money || 0) + totalValue;
                    newPlayerState.produceBin = [];
                    console.log(`Paid out ${totalValue}üí∞.`);
                    processedPayout = true;
                }

                newPlayerState.energy = 100;
                newPlayerState.lastResetTime = now.getTime();
                console.log("Energy reset to full.");
                
                await updatePlayerState(newPlayerState);
            }
        }
        
        function forceResetFarm() {
            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à 100% ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!', async () => {
                console.log("Admin is resetting the farm...");
                const defaultPlot = () => ({ plantId: null });
                const defaultAnimalSlot = () => ({ animalId: null });
                const initialFarmState = {
                    plots: Array(FARM_GRID_SIZE).fill(null).map(defaultPlot),
                    animals: Array(ANIMAL_PEN_SIZE).fill(null).map(defaultAnimalSlot),
                };
                const farmDocRef = doc(db, "publicFarmData", "farmState");
                await setDoc(farmDocRef, initialFarmState);
                console.log("Farm has been reset by admin.");
            });
        }
        
        function resetPlayerProgress() {
            showConfirmationModal('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÄ‡∏á‡∏¥‡∏ô, ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏±‡∏ß, ‡∏ö‡πâ‡∏≤‡∏ô) ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!', async () => {
                if (!userId) return;
                console.log("Resetting player progress for user:", userId);
                const playerDocRef = doc(db, "players", userId);
                await deleteDoc(playerDocRef);
                window.location.reload();
            });
        }
        
        function upgradeRod() {
            const newPlayerState = { ...playerState };
            const currentLevel = newPlayerState.fishingRodLevel || 0;
            if (currentLevel >= GAME_DATA.fishing_rods.length - 1) return;

            const nextLevelData = GAME_DATA.fishing_rods[currentLevel + 1];
            if (newPlayerState.money >= nextLevelData.cost) {
                newPlayerState.money -= nextLevelData.cost;
                newPlayerState.fishingRodLevel = currentLevel + 1;
                updatePlayerState(newPlayerState);
            }
        }
        
        function fish() {
            if (playerState.energy < 5) return;
            
            const newPlayerState = { ...playerState };
            newPlayerState.energy -= 5;
            updatePlayerState(newPlayerState); // Update energy immediately

            const rodLevel = newPlayerState.fishingRodLevel || 0;
            
            const probabilities = [
                [0.8, 0.15, 0.05], // Level 1
                [0.6, 0.3, 0.1],   // Level 2
                [0.4, 0.4, 0.2],   // Level 3
                [0.2, 0.5, 0.3],   // Level 4
                [0.1, 0.4, 0.5],   // Level 5
            ];
            
            const fishTypes = {
                'Common': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].type === 'produce' && GAME_DATA[id].rarity === 'Common'),
                'Uncommon': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].type === 'produce' && GAME_DATA[id].rarity === 'Uncommon'),
                'Rare': Object.keys(GAME_DATA).filter(id => GAME_DATA[id].type === 'produce' && GAME_DATA[id].rarity === 'Rare')
            };

            const rand = Math.random();
            let caughtRarity;
            if (rand < probabilities[rodLevel][0]) {
                caughtRarity = 'Common';
            } else if (rand < probabilities[rodLevel][0] + probabilities[rodLevel][1]) {
                caughtRarity = 'Uncommon';
            } else {
                caughtRarity = 'Rare';
            }
            
            const possibleFish = fishTypes[caughtRarity];
            const caughtFishId = possibleFish[Math.floor(Math.random() * possibleFish.length)];
            
            startFishingMinigame(caughtFishId);
        }

        function showFishCatchModal(fishId) {
            const fishData = GAME_DATA[fishId];
            document.getElementById('fish-catch-title').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏Å‡πÑ‡∏î‡πâ ${fishData.name}!`;
            const iconEl = document.getElementById('fish-catch-icon');
            iconEl.style.backgroundImage = `url(${fishData.imageUrl})`;
            
            const rarityEl = document.getElementById('fish-catch-rarity');
            rarityEl.textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡∏¢‡∏≤‡∏Å: ${fishData.rarity}`;
            if(fishData.rarity === 'Uncommon') rarityEl.className = 'text-green-600 mb-4';
            else if (fishData.rarity === 'Rare') rarityEl.className = 'text-purple-600 mb-4';
            else rarityEl.className = 'text-gray-600 mb-4';

            document.getElementById('fish-catch-modal').classList.remove('hidden');
        }
        
        let minigameLoopId = null;
        function startFishingMinigame(fishId) {
            const modal = document.getElementById('fishing-minigame-modal');
            modal.classList.remove('hidden');

            const track = document.getElementById('fishing-minigame-track');
            const fishEl = document.getElementById('fishing-minigame-fish');
            const barEl = document.getElementById('fishing-minigame-bar');
            const progressFill = document.getElementById('fishing-minigame-progress-fill');

            fishEl.textContent = 'üê†'; // Always use the same emoji in-game

            const trackHeight = track.clientHeight;
            const barHeight = 80; // Make bar a bit bigger
            barEl.style.height = `${barHeight}px`;

            let fishPos = trackHeight / 2;
            let fishTargetPos = Math.random() * (trackHeight - 20);

            let barPos = trackHeight / 2;
            let barVelocity = 0;
            const gravity = 0.4; // Softer gravity
            const lift = -1.2; // Less aggressive lift
            let mouseDown = false;

            let progress = 30; // Start with a bit more progress

            function gameLoop() {
                // Bar physics
                if (mouseDown) barVelocity += lift;
                barVelocity += gravity;
                barVelocity *= 0.9; // Damping
                barPos += barVelocity;
                
                // Clamp bar position
                if (barPos < 0) barPos = 0;
                if (barPos > trackHeight - barHeight) barPos = trackHeight - barHeight;

                // Fish AI (slower and smoother)
                const fishData = GAME_DATA[fishId];
                const speedMultiplier = fishData.rarity === 'Rare' ? 2.5 : (fishData.rarity === 'Uncommon' ? 1.8 : 1.2);
                if (Math.abs(fishTargetPos - fishPos) < 5 || Math.random() < 0.01) { // Add some randomness
                    fishTargetPos = Math.random() * (trackHeight - 20);
                }
                fishPos += (fishTargetPos - fishPos) * 0.05 * speedMultiplier;

                // Check for catch (more forgiving)
                const barTop = barPos;
                const barBottom = barPos + barHeight;
                if (fishPos > barTop && fishPos < barBottom) {
                    progress += 1.5; // Catch a bit faster
                } else {
                    progress -= 0.5; // Escape slower
                }
                progress = Math.max(0, Math.min(100, progress));

                // Update UI
                barEl.style.top = `${barPos}px`;
                fishEl.style.top = `${fishPos}px`;
                progressFill.style.height = `${progress}%`;

                // Check for win/loss
                if (progress >= 100) {
                    endFishingMinigame(true, fishId);
                    return;
                }
                if (progress <= 0) {
                    endFishingMinigame(false, null);
                    return;
                }

                minigameLoopId = requestAnimationFrame(gameLoop);
            }
            
            const area = document.getElementById('fishing-minigame-area');
            const startListener = () => mouseDown = true;
            const endListener = () => mouseDown = false;
            
            area.addEventListener('mousedown', startListener);
            area.addEventListener('mouseup', endListener);
            area.addEventListener('touchstart', startListener, { passive: true });
            area.addEventListener('touchend', endListener);
            
            function endFishingMinigame(success, caughtFishId) {
                cancelAnimationFrame(minigameLoopId);
                area.removeEventListener('mousedown', startListener);
                area.removeEventListener('mouseup', endListener);
                area.removeEventListener('touchstart', startListener);
                area.removeEventListener('touchend', endListener);
                modal.classList.add('hidden');
                
                if (success) {
                    const newPlayerState = { ...playerState };
                    newPlayerState.storageBin.push({ id: caughtFishId, quality: 0 });
                    updatePlayerState(newPlayerState);
                    showFishCatchModal(caughtFishId);
                }
            }

            minigameLoopId = requestAnimationFrame(gameLoop);
        }
        
        let gameLoopInterval = null;
        async function startGame(uid) {
            userId = uid;
            
            initPlayerListeners(uid);
            initFarmListeners();
            
            document.getElementById('loading-screen').classList.add('loading-hidden');
            document.getElementById('game-container').style.opacity = 1;
            document.getElementById('footer-nav').style.opacity = 1;
            
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(() => {
                checkForMidnightReset();
                renderAll();
            }, 2000); 
        }

        function initPlayerListeners(uid) {
            const playerDocRef = doc(db, "players", uid);
            onSnapshot(playerDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    playerState = docSnap.data();
                    if (!playerState.produceBin) playerState.produceBin = [];
                    if (!playerState.storageBin) playerState.storageBin = [];
                    if (typeof playerState.houseLevel === 'undefined') playerState.houseLevel = 0;
                    if (typeof playerState.lastResetTime === 'undefined') playerState.lastResetTime = 0;
                    if (typeof playerState.fishingRodLevel === 'undefined') playerState.fishingRodLevel = 0;
                    if (typeof playerState.energy === 'undefined') playerState.energy = 100;
                    checkForMidnightReset();
                }
            }, handleFirestoreError);
        }
        
        function initFarmListeners() {
            const farmDocRef = doc(db, "publicFarmData", "farmState");
            onSnapshot(farmDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    farmState = docSnap.data();
                }
            }, handleFirestoreError);
        }
        
        async function ensureFarmDataExists() {
            const farmDocRef = doc(db, "publicFarmData", "farmState");
            try {
                const farmSnap = await getDoc(farmDocRef);
                if (!farmSnap.exists()) {
                    console.log("Farm data not found, creating initial state...");
                    const defaultPlot = () => ({ plantId: null });
                    const defaultAnimalSlot = () => ({ animalId: null });
                    const initialFarmState = {
                        plots: Array(FARM_GRID_SIZE).fill(null).map(defaultPlot),
                        animals: Array(ANIMAL_PEN_SIZE).fill(null).map(defaultAnimalSlot),
                    };
                    await setDoc(farmDocRef, initialFarmState);
                }
            } catch (error) {
                console.warn("Could not ensure farm data existence.", error.message);
                throw error;
            }
        }
        
        function handleFirestoreError(error) {
            console.error("Firestore connection error:", error);
        }
        
        let isInitialNameSetup = false;
        const nameModal = document.getElementById('name-modal');
        const nameInput = document.getElementById('name-input');
        
        function setupControls() {
            const moreModal = document.getElementById('more-modal');
            const moreBtn = document.getElementById('more-btn');
            const moreModalItems = document.getElementById('more-modal-items');

            const primaryViews = ['farm', 'animals', 'shop'];
            const secondaryViews = [
                { view: 'bedroom', name: '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô üõå' },
                { view: 'fishing', name: '‡∏ö‡πà‡∏≠‡∏õ‡∏•‡∏≤ üé£' },
            ];

            moreModalItems.innerHTML = ''; // Clear any existing items
            secondaryViews.forEach(secView => {
                const button = document.createElement('button');
                button.textContent = secView.name;
                button.dataset.view = secView.view;
                button.className = 'w-full text-left font-bold py-3 px-4 rounded-lg transition bg-gray-100 hover:bg-green-100 text-gray-800';
                moreModalItems.appendChild(button);
            });
            
            document.addEventListener('click', e => {
                const target = e.target.closest('[data-view]');

                // Handle closing modal
                if (!moreModal.classList.contains('hidden') && !e.target.closest('#more-modal > div') && !e.target.closest('#more-btn')) {
                    moreModal.classList.add('hidden');
                }

                if (!target) return;

                const view = target.dataset.view;

                if (view === 'more') {
                    moreModal.classList.toggle('hidden');
                    return;
                }

                document.querySelectorAll('#tab-content-area > div').forEach(div => div.classList.add('hidden'));
                const viewEl = document.getElementById(`${view}-view`);
                if (viewEl) viewEl.classList.remove('hidden');

                document.querySelectorAll('#footer-nav .nav-btn').forEach(b => b.classList.remove('active'));
                
                if (primaryViews.includes(view)) {
                    document.querySelector(`.nav-btn[data-view="${view}"]`).classList.add('active');
                } else if (secondaryViews.some(sv => sv.view === view)) {
                    moreBtn.classList.add('active');
                }
                
                if (view !== 'more') {
                    moreModal.classList.add('hidden');
                }
            });
            document.querySelector('.nav-btn[data-view="farm"]').classList.add('active');
            
            document.getElementById('context-modal-close').onclick = hideContextMenu;
            document.getElementById('submenu-modal-close').onclick = hideSubMenu;

            document.getElementById('shop-items').addEventListener('click', (e) => {
                if (e.target.classList.contains('buy-btn')) {
                    const itemId = e.target.dataset.itemid;
                    const itemData = GAME_DATA[itemId];
                    if (playerState.money >= itemData.cost) {
                        const newPlayerState = { ...playerState };
                        newPlayerState.money -= itemData.cost;
                        newPlayerState.inventory[itemId] = (newPlayerState.inventory[itemId] || 0) + 1;
                        updatePlayerState(newPlayerState);
                    }
                }
            });

            document.getElementById('storage-items').addEventListener('click', e => {
                if (e.target.classList.contains('sell-storage-btn')) {
                    const itemId = e.target.dataset.itemId;
                    const quality = parseInt(e.target.dataset.quality, 10);
                    sellFromStorage(itemId, quality);
                } else if (e.target.classList.contains('eat-storage-btn')) {
                    const itemId = e.target.dataset.itemId;
                    const quality = parseInt(e.target.dataset.quality, 10);
                    eatFromStorage(itemId, quality);
                }
            });

            document.getElementById('upgrade-house-btn').addEventListener('click', upgradeHouse);
            document.getElementById('admin-reset-btn').addEventListener('click', forceResetFarm);
            document.getElementById('reset-player-btn').addEventListener('click', resetPlayerProgress);
            
            document.getElementById('fish-btn').addEventListener('click', fish);
            document.getElementById('upgrade-rod-btn').addEventListener('click', upgradeRod);
            document.getElementById('fish-catch-ok').addEventListener('click', () => {
                document.getElementById('fish-catch-modal').classList.add('hidden');
            });


            playerNameEl.addEventListener('click', () => showNameModal(false));
            document.getElementById('save-name-btn').addEventListener('click', () => saveNameChange());
            document.getElementById('cancel-name-btn').addEventListener('click', hideNameModal);
            nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') saveNameChange(); });
            document.getElementById('confirm-modal-cancel').addEventListener('click', hideConfirmationModal);
        }
        
        function showConfirmationModal(text, onConfirm) {
            const confirmModal = document.getElementById('confirm-modal');
            document.getElementById('confirm-modal-text').textContent = text;
            const okButton = document.getElementById('confirm-modal-ok');
            
            const newOkButton = okButton.cloneNode(true);
            okButton.parentNode.replaceChild(newOkButton, okButton);

            newOkButton.addEventListener('click', () => {
                onConfirm();
                hideConfirmationModal();
            });
            confirmModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
        }
        
        const showNameModal = (isInitial = false) => {
            isInitialNameSetup = isInitial;
            nameInput.value = isInitial ? '' : playerState.nickname;
            nameModal.classList.remove('hidden');
            nameModal.querySelector('div').classList.remove('modal-leave');
            nameModal.querySelector('div').classList.add('modal-enter');
            nameInput.focus();

            if (isInitial) {
                document.getElementById('cancel-name-btn').style.display = 'none';
                document.getElementById('name-modal-title').textContent = "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
            } else {
                 document.getElementById('cancel-name-btn').style.display = 'inline-block';
                 document.getElementById('name-modal-title').textContent = "‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô";
            }
        };
        const hideNameModal = () => {
            const modalContent = nameModal.querySelector('div');
            modalContent.classList.remove('modal-enter');
            modalContent.classList.add('modal-leave');
            setTimeout(() => nameModal.classList.add('hidden'), 200);
        };
        const saveNameChange = async () => {
            const newName = nameInput.value.trim();
            if (newName.length > 0 && newName.length <= 15) {
                if (isInitialNameSetup) {
                    playerState = { 
                        money: 20, 
                        inventory: {}, 
                        produceBin: [],
                        storageBin: [],
                        nickname: newName,
                        houseLevel: 0,
                        lastResetTime: 0,
                        fishingRodLevel: 0,
                        energy: 100
                    };
                    await setDoc(doc(db, "players", userId), playerState);
                    await startGame(userId);
                } else {
                    const newState = {...playerState, nickname: newName};
                    await updatePlayerState(newState);
                }
                hideNameModal();
            }
        };
        
        window.addEventListener('load', async () => {
            setupControls();
            try {
                 await setPersistence(auth, browserLocalPersistence);
                 onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const playerDocRef = doc(db, "players", userId);
                        
                        try {
                            await ensureFarmDataExists();
                            const docSnap = await getDoc(playerDocRef);
                            
                            if (docSnap.exists()) {
                                await startGame(userId);
                            } else {
                                document.getElementById('loading-screen').classList.add('loading-hidden');
                                showNameModal(true);
                            }
                        } catch (error) {
                            handleFirestoreError(error);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                });

            } catch (error) { 
                console.error("Authentication failed:", error); 
                document.body.innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>`;
            }
        });
    </script>
</body>
</html>

